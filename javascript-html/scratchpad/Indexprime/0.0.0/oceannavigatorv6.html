<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Factor Hunter: Ocean Navigator v6</title>
    <style>
        :root {
            --bg: #050a14;
            --wall: #000000;
            --t1: #1e3a8a;   /* Brighter Blue */
            --t2: #7f1d1d;   /* Brighter Red */
            --hit: #f59e0b;  /* Gold */
            --accent: #3b82f6;
            --panel-bg: #0f172a;
            --border: #334155;
            --rho-color: #10b981;
            
            /* TEXT COLORS */
            --text-wall: #ffffff; /* FORCE WHITE ON BLACK BOXES */
            --text-cell: #ffffff; /* White on Colored Boxes */
            --header-bg: #1e293b;
            --header-text: #f8fafc;
        }

        body { 
            margin: 0; 
            background: var(--bg); 
            color: #94a3b8; 
            font-family: -apple-system, 'Courier New', monospace;
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            user-select: none; 
            touch-action: none; 
        }

        /* --- CONTROLS (Mobile Optimized) --- */
        #controls { 
            background: var(--panel-bg); 
            border-bottom: 2px solid var(--accent); 
            display: flex; 
            flex-wrap: wrap; /* Allows wrapping on small phones */
            align-items: center; 
            padding: 8px; 
            gap: 8px; 
            z-index: 50; 
            flex-shrink: 0;
        }

        .input-box { 
            flex: 2 1 120px; /* Flexible width */
            background: #020617; 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            padding: 0 10px; 
        }

        input { 
            background: transparent; border: none; 
            color: var(--accent); font-family: monospace; 
            font-size: 1.1rem; width: 100%; font-weight: bold; 
            outline: none; padding: 0;
        }

        .btn-group { 
            display: flex; 
            gap: 6px; 
            flex: 3 1 auto; 
            min-width: 200px; /* Ensure buttons don't squash too small */
        }

        button { 
            flex: 1; height: 40px; padding: 0 4px; 
            background: var(--accent); color: white; 
            border: none; border-radius: 6px; font-weight: 700; 
            cursor: pointer; text-transform: uppercase; font-size: 0.8rem; 
            white-space: nowrap;
        }
        button.active { background: var(--hit); color: black; box-shadow: 0 0 10px var(--hit); }

        /* --- VIEWPORT --- */
        #viewport { flex-grow: 1; position: relative; background: var(--bg); overflow: hidden; width: 100%; }
        canvas { display: block; width: 100%; height: 100%; touch-action: none; }

        /* --- INSPECTOR PANEL (Restored) --- */
        #inspector-panel {
            position: absolute; bottom: -300px; left: 0; width: 100%; height: 240px;
            background: rgba(15, 23, 42, 0.98);
            border-top: 2px solid var(--hit);
            border-radius: 12px 12px 0 0;
            transition: bottom 0.3s cubic-bezier(0.1, 0.7, 0.1, 1);
            z-index: 100;
            display: flex; flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
        }
        #inspector-panel.open { bottom: 0; }
        
        .panel-header {
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.3);
        }
        .panel-title { color: var(--hit); font-weight: bold; font-size: 1rem; }
        .close-btn { background: none; border: none; color: #fff; font-size: 1.5rem; padding: 0 10px; cursor: pointer; }
        
        .panel-content { padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .data-row { display: flex; justify-content: space-between; border-bottom: 1px solid #334155; padding-bottom: 5px; }
        .lbl { color: #64748b; font-size: 0.8rem; text-transform: uppercase; }
        .val { color: #fff; font-size: 1.1rem; font-weight: bold; font-family: monospace; }
        .val-big { font-size: 1.0rem; color: var(--accent); font-weight: bold; font-family: monospace; word-break: break-all; }

        /* --- NOTIFICATIONS --- */
        #notification {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 2rem; font-weight: 900; color: #fff; text-shadow: 0 0 20px var(--hit);
            pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 200; text-align: center; width: 100%;
        }
        #notification.show { opacity: 1; }

        /* --- STATUS BAR --- */
        #status-bar { 
            height: 24px; background: #0f172a; border-top: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 15px; font-size: 0.7rem; z-index: 20; flex-shrink: 0;
        }
    </style>
</head>
<body>

<div id="controls">
    <div class="input-box">
        <input type="text" id="inp-target" value="10^20 + 19" placeholder="Target">
    </div>
    <div class="btn-group">
        <button id="btn-go">JUMP</button>
        <button id="btn-crawl">HUNT</button>
        <button id="btn-rho" style="background:var(--t1)">RHO</button>
    </div>
</div>

<div id="viewport">
    <canvas id="gridCanvas"></canvas>
    
    <div id="inspector-panel">
        <div class="panel-header">
            <div class="panel-title">INSPECTOR</div>
            <button class="close-btn" id="btn-close">&times;</button>
        </div>
        <div class="panel-content">
            <div class="data-row"><span class="lbl">Row (A)</span><span class="val" id="ins-a">--</span></div>
            <div class="data-row"><span class="lbl">Col (B)</span><span class="val" id="ins-b">--</span></div>
            <div class="data-row"><span class="lbl">Product</span><span class="val-big" id="ins-res">--</span></div>
            <div style="text-align:center; color:#64748b; font-size:0.8rem;" id="ins-stat">--</div>
        </div>
    </div>
    
    <div id="notification">FACTOR FOUND!</div>
</div>

<div id="status-bar">
    <div>ZOOM: <span id="st-zoom" style="color:#e2e8f0">1.0x</span></div>
    <div id="mode-ind" style="color:#10b981">READY</div>
</div>

<script>
    // --- WORKER ---
    const workerCode = `
    self.onmessage = function(e) {
        if (e.data.cmd === 'stop') { self.close(); return; }
        const { centerR, centerC, target } = e.data;
        const R = BigInt(centerR), C = BigInt(centerC), T = BigInt(target);
        let range = 1n;
        while(true) {
            for (let c = C - range; c <= C + range; c += 2n) { check(R - range, c, T); check(R + range, c, T); }
            for (let r = R - range + 2n; r <= R + range - 2n; r += 2n) { check(r, C - range, T); check(r, C + range, T); }
            range += 2n;
            if (range % 20n === 0n) postMessage({ type: 'scan', range: range.toString() });
        }
        function check(r, c, t) {
            if (r < 3n || c < 3n) return;
            if (r * c === t) postMessage({ type: 'found', r: r.toString(), c: c.toString() });
        }
    };`;
    const blob = new Blob([workerCode], {type: 'application/javascript'});
    const workerURL = URL.createObjectURL(blob);

    // --- CONFIG ---
    const COLORS = {
        bg: '#050a14', wall: '#000000', 
        t1: '#1e3a8a', t2: '#7f1d1d', 
        hit: '#f59e0b',
        textWall: '#ffffff',  // WHITE TEXT on Black
        textCell: '#ffffff',  // WHITE TEXT on Color
        grid: '#1e293b', 
        header: '#1e293b', headerText: '#f1f5f9'
    };

    let state = {
        startRow: 3n, startCol: 3n,
        panX: 0, panY: 0, zoom: 0.8,
        cellSize: 140, headerSize: 50,
        targetVal: 0n, targetMod: 0,
        isPanning: false, needsRender: true,
        crawling: false
    };

    let particles = [];
    const canvas = document.getElementById('gridCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });

    // --- HIGH DPI SCALING ---
    function resizeCanvas() {
        const dpr = window.devicePixelRatio || 1;
        const rect = document.getElementById('viewport').getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        canvas.style.width = `${rect.width}px`;
        canvas.style.height = `${rect.height}px`;
        state.needsRender = true;
    }

    // --- MATH & SQRT FINDER ---
    
    function parseInputSafe(str) {
        str = str.replace(/\s/g, '').toLowerCase();
        try {
            if (str.includes('^')) {
                let parts = str.split('+');
                let bParts = parts[0].split('^');
                let base = BigInt(bParts[0]);
                let exp = BigInt(bParts[1]);
                let add = parts[1] ? BigInt(parts[1]) : 0n;
                // Exponentiation by squaring for BigInt
                let val = 1n;
                for (let i = 0; i < Number(exp); i++) val *= base; 
                return { type: 'BIG', val: val + add };
            }
            return { type: 'BIG', val: BigInt(str) };
        } catch(e) { return { type: 'BIG', val: 1007n }; }
    }

    function getMod3(n) { return Number(n % 3n); }
    function fmtNum(n) { let s=n.toString(); return s.length>6 ? ".."+s.slice(-5) : s; }

    // ==========================================
    // THE SQUARE ROOT FINDER (NEWTON'S METHOD)
    // ==========================================
    // This matches the logic in your Java file
    function sqrtBigInt(n) {
        if (n < 0n) throw new Error("Negative Number");
        if (n < 2n) return n;
        
        let x = n;
        let y = (x + 1n) >> 1n; // Initial guess
        
        while (y < x) {
            x = y;
            // x_new = (x + n/x) / 2
            y = (x + n / x) >> 1n;
        }
        return x;
    }

    function gcd(a, b) { while(b > 0n) { let t = b; b = a % b; a = t; } return a; }

    // --- RENDERER ---
    function render() {
        if (!state.needsRender && particles.length === 0) return;
        state.needsRender = false;
        
        const w = canvas.style.width.replace('px','') * 1; 
        const h = canvas.style.height.replace('px','') * 1;
        const cs = state.cellSize * state.zoom;
        const hs = state.headerSize;
        const sx = state.panX, sy = state.panY;

        ctx.fillStyle = COLORS.bg; ctx.fillRect(0, 0, w, h);
        const cols = Math.ceil((w - hs) / cs) + 1;
        const rows = Math.ceil((h - hs) / cs) + 1;
        let lod = (state.zoom < 0.4 || state.isPanning) ? 1 : 0;
        
        if (lod===0) { 
            ctx.font = `bold ${Math.max(12, 16*state.zoom)}px 'Courier New', monospace`; 
            ctx.textAlign="center"; ctx.textBaseline="middle"; 
        }

        // GRID LOOP
        for (let r=0; r<rows; r++) {
            let y = hs + sy + (r * cs);
            if (y < hs - cs) continue; if (y > h) break;
            let rowVal = state.startRow + BigInt(r * 2);
            let rMod = getMod3(rowVal);

            for (let c=0; c<cols; c++) {
                let x = hs + sx + (c * cs);
                if (x < hs - cs) continue; if (x > w) break;
                let colVal = state.startCol + BigInt(c * 2);
                let cMod = getMod3(colVal);

                let isWall = (rMod===0 || cMod===0);
                let pMod = (rMod * cMod) % 3;
                let isHit = (!isWall && pMod === state.targetMod);
                let isExact = (rowVal * colVal === state.targetVal);

                // Draw Box
                ctx.fillStyle = isWall ? COLORS.wall : (rMod===cMod ? COLORS.t1 : COLORS.t2);
                ctx.fillRect(x, y, cs, cs);
                ctx.strokeStyle = COLORS.grid; ctx.lineWidth = 1; ctx.strokeRect(x, y, cs, cs);

                if (isHit) { ctx.strokeStyle = COLORS.hit; ctx.lineWidth = 4*state.zoom; ctx.strokeRect(x+2, y+2, cs-4, cs-4); }
                if (isExact) {
                    ctx.fillStyle = "rgba(255, 255, 255, 0.3)"; ctx.fillRect(x, y, cs, cs);
                    ctx.strokeStyle = "#fff"; ctx.lineWidth = 4; ctx.strokeRect(x,y,cs,cs);
                    if(Math.random()<0.1) triggerExplosion(x+cs/2, y+cs/2);
                }
                
                // Draw Text
                if (lod===0) {
                    ctx.fillStyle = isWall ? COLORS.textWall : COLORS.textCell;
                    ctx.fillText(`${fmtNum(rowVal)}Ã—${fmtNum(colVal)}`, x + cs/2, y + cs/2);
                }
            }
        }

        // DRAW HEADERS (ON TOP)
        ctx.fillStyle = COLORS.header; ctx.fillRect(hs, 0, w, hs); ctx.fillRect(0, hs, hs, h);
        ctx.fillStyle = COLORS.accent; ctx.fillRect(0, 0, hs, hs);

        if (lod===0) {
            ctx.fillStyle = COLORS.headerText; ctx.font = 'bold 13px sans-serif';
            for (let c=0; c<cols; c++) {
                let x = hs + sx + (c * cs); if (x < hs) continue; if (x > w) break;
                ctx.fillText(fmtNum(state.startCol + BigInt(c * 2)), x + cs/2, hs/2);
            }
            for (let r=0; r<rows; r++) {
                let y = hs + sy + (r * cs); if (y < hs) continue; if (y > h) break;
                ctx.fillText(fmtNum(state.startRow + BigInt(r * 2)), hs/2, y + cs/2);
            }
        }
        drawParticles();
    }

    // --- PARTICLES ---
    function triggerExplosion(x, y) {
        for(let i=0; i<50; i++) particles.push({ x:x, y:y, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15, life:1.0, color: Math.random()>0.5?'#f59e0b':'#ffffff' });
        document.getElementById('notification').classList.add('show');
        setTimeout(() => document.getElementById('notification').classList.remove('show'), 2000);
    }
    function updateParticles() {
        if(particles.length===0) return;
        state.needsRender = true;
        for(let i=particles.length-1; i>=0; i--) { let p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.life-=0.05; if(p.life<=0) particles.splice(i,1); }
    }
    function drawParticles() {
        ctx.save(); particles.forEach(p => { ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 4*p.life, 0, Math.PI*2); ctx.fill(); }); ctx.restore();
    }

    // --- INPUT & TOUCH ---
    let evCache = []; let prevDiff = -1; let tapStart = {x:0, y:0};

    canvas.addEventListener('pointerdown', e => {
        state.isPanning = true; evCache.push(e); canvas.setPointerCapture(e.pointerId);
        tapStart = {x: e.clientX, y: e.clientY};
    });
    canvas.addEventListener('pointermove', e => {
        const index = evCache.findIndex(ev => ev.pointerId === e.pointerId);
        if (index > -1) evCache[index] = e;
        if (evCache.length === 2) {
            const curDiff = Math.hypot(evCache[0].clientX - evCache[1].clientX, evCache[0].clientY - evCache[1].clientY);
            if (prevDiff > 0) applyZoom(state.zoom * (curDiff / prevDiff), (evCache[0].clientX+evCache[1].clientX)/2, (evCache[0].clientY+evCache[1].clientY)/2);
            prevDiff = curDiff;
        } else if (evCache.length === 1) {
            state.panX += e.movementX; state.panY += e.movementY; updateScroll();
        }
    });
    canvas.addEventListener('pointerup', e => {
        const index = evCache.findIndex(ev => ev.pointerId === e.pointerId);
        if (index > -1) evCache.splice(index, 1);
        if (evCache.length < 2) prevDiff = -1;
        if (evCache.length === 0) { 
            state.isPanning = false; state.needsRender = true; 
            if (Math.hypot(e.clientX - tapStart.x, e.clientY - tapStart.y) < 10) handleTap(e.clientX, e.clientY);
        }
    });

    function updateScroll() {
        const cs = state.cellSize * state.zoom;
        while(state.panX > 0) { state.startCol -= 2n; state.panX -= cs; }
        while(state.panX < -cs) { state.startCol += 2n; state.panX += cs; }
        while(state.panY > 0) { state.startRow -= 2n; state.panY -= cs; }
        while(state.panY < -cs) { state.startRow += 2n; state.panY += cs; }
        if(state.startRow < 3n) { state.startRow = 3n; state.panY = Math.min(0, state.panY); }
        if(state.startCol < 3n) { state.startCol = 3n; state.panX = Math.min(0, state.panX); }
        state.needsRender = true;
    }

    function applyZoom(newZoom, cx, cy) {
        const oldZoom = state.zoom;
        const relX = (cx - state.headerSize - state.panX) / oldZoom;
        const relY = (cy - state.headerSize - state.panY) / oldZoom;
        state.zoom = Math.max(0.2, Math.min(newZoom, 3.0));
        state.panX = cx - state.headerSize - (relX * state.zoom);
        state.panY = cy - state.headerSize - (relY * state.zoom);
        updateScroll();
        document.getElementById('st-zoom').innerText = state.zoom.toFixed(2) + "x";
    }

    function handleTap(x, y) {
        const rect = document.getElementById('viewport').getBoundingClientRect();
        const cx = x - rect.left; const cy = y - rect.top;
        if (cx < state.headerSize || cy < state.headerSize) return;

        const cs = state.cellSize * state.zoom;
        const cIdx = Math.floor((cx - state.headerSize - state.panX) / cs);
        const rIdx = Math.floor((cy - state.headerSize - state.panY) / cs);
        
        const rVal = state.startRow + BigInt(rIdx * 2);
        const cVal = state.startCol + BigInt(cIdx * 2);
        
        document.getElementById('ins-a').innerText = rVal.toString();
        document.getElementById('ins-b').innerText = cVal.toString();
        document.getElementById('ins-res').innerText = (rVal * cVal).toString();
        
        let status = "NORMAL";
        if (rVal * cVal === state.targetVal) status = "EXACT MATCH!";
        else if ((rVal*cVal)%3n === BigInt(state.targetMod)) status = "MODULO MATCH";
        document.getElementById('ins-stat').innerText = status;
        document.getElementById('inspector-panel').classList.add('open');
    }

    function teleport(inputStr) {
        let res = parseInputSafe(inputStr);
        state.targetVal = res.val;
        state.targetMod = getMod3(res.val);
        // USE THE SQRT FINDER HERE
        let root = sqrtBigInt(res.val);
        if(root%2n===0n) root+=1n;
        state.startCol = root; state.startRow = root; 
        state.panX = 0; state.panY = 0; state.needsRender = true;
    }

    let crawler = null;
    function toggleCrawl() {
        if (state.crawling) { if(crawler) crawler.terminate(); state.crawling=false; document.getElementById('btn-crawl').classList.remove('active'); return; }
        state.crawling = true; document.getElementById('btn-crawl').classList.add('active');
        crawler = new Worker(workerURL);
        crawler.postMessage({ centerR: state.startRow.toString(), centerC: state.startCol.toString(), target: state.targetVal.toString() });
        crawler.onmessage = function(e) { 
            if(e.data.type==='found') { 
                state.startRow = BigInt(e.data.r); state.startCol = BigInt(e.data.c); state.panX=0; state.panY=0; state.needsRender=true;
                toggleCrawl(); triggerExplosion(state.headerSize + (state.cellSize*state.zoom)/2, state.headerSize + (state.cellSize*state.zoom)/2);
            }
        };
    }

    document.getElementById('btn-close').addEventListener('click', () => document.getElementById('inspector-panel').classList.remove('open'));
    document.getElementById('btn-go').addEventListener('click', () => teleport(document.getElementById('inp-target').value));
    document.getElementById('btn-crawl').addEventListener('click', toggleCrawl);

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    teleport("10^20 + 19");
    function loop() { updateParticles(); if(state.needsRender) render(); requestAnimationFrame(loop); }
    loop();

</script>
</body>
</html>
