<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hunter v7: Fermat Filter</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    :root {
        --bg: #050505;
        --panel: #0a0a0a;
        --accent: #f59e0b; /* Amber for Filter */
        --hit: #10b981;    /* Emerald for Success */
        --reject: #ef4444; /* Red for Filtered */
        --text: #e5e5e5;
    }
    
    body { background-color: var(--bg); color: var(--text); font-family: 'Courier New', monospace; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    
    .dashboard { width: 100%; max-width: 900px; display: grid; gap: 20px; }
    
    .card { background: var(--panel); border: 1px solid #222; padding: 20px; box-shadow: 0 0 40px rgba(245, 158, 11, 0.05); }
    .card-header { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding-bottom: 10px; margin-bottom: 15px; }
    .card-title { font-weight: 900; color: var(--accent); letter-spacing: 2px; }
    
    .input-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    label { font-size: 0.6rem; color: #666; display: block; margin-bottom: 4px; text-transform: uppercase; }
    input { width: 100%; background: #000; border: 1px solid #333; color: var(--accent); padding: 10px; font-family: monospace; text-align: center; font-size: 1.1rem; outline: none; transition: border 0.3s; }
    input:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }

    /* FILTER VISUALIZER */
    .filter-viz { 
        display: flex; align-items: center; justify-content: center; 
        padding: 30px 20px; background: #000; 
        border-top: 2px solid #222; border-bottom: 2px solid #222; 
        position: relative; overflow: hidden; margin: 20px 0; height: 120px;
    }
    
    .stream-line {
        position: absolute; right: 0; display: flex; gap: 5px;
        animation: stream 2s linear infinite;
    }
    @keyframes stream { 0% { transform: translateX(0); } 100% { transform: translateX(-200px); } }

    .block { width: 40px; height: 40px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: #444; }
    .block.pass { border-color: var(--accent); color: var(--accent); background: rgba(245, 158, 11, 0.1); }
    .block.kill { border-color: var(--reject); color: var(--reject); opacity: 0.3; }

    .filter-gate {
        position: absolute; left: 100px; height: 100%; width: 4px; background: var(--accent);
        box-shadow: 0 0 20px var(--accent); z-index: 10;
    }
    .gate-label { position: absolute; left: 90px; top: 10px; font-size: 0.6rem; color: var(--accent); transform: rotate(-90deg); }

    /* CORE GRID */
    .core-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; }
    .core-item { background: #080808; border: 1px solid #222; padding: 8px; border-radius: 4px; font-size: 0.7rem; color: #666; }
    .core-val { font-size: 0.9rem; font-weight: bold; color: var(--accent); display: block; }

    .stats { display: flex; justify-content: space-between; font-size: 0.75rem; color: #666; margin-top: 10px; }
    .stat-val { color: var(--text); font-weight: bold; }

    .btn { width: 100%; padding: 15px; font-weight: 900; letter-spacing: 2px; background: #111; color: var(--accent); border: 1px solid var(--accent); cursor: pointer; transition: all 0.2s; margin-top: 15px; }
    .btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 30px var(--accent); }
    .btn.stop { border-color: var(--hit); color: var(--hit); }
    .btn.stop:hover { background: var(--hit); color: #fff; }

    .log-box { height: 120px; overflow-y: auto; font-size: 0.7rem; color: #555; margin-top: 15px; border-top: 1px solid #222; padding-top: 10px; }
    .log-hit { color: var(--hit); font-weight: bold; font-size: 1rem; }
    .log-rej { color: var(--reject); }
</style>
</head>
<body>

<div class="dashboard">
    <div class="card">
        <div class="card-header">
            <span class="card-title">HUNTER v7</span>
            <span style="font-size:0.7rem; color:#666">FERMAT FILTER (4096)</span>
        </div>
        
        <div class="input-grid">
            <div><label>Base</label><input id="inpBase" value="10"></div>
            <div><label>Exponent</label><input id="inpExp" value="18"></div>
            <div><label>Add</label><input id="inpAdd" value="1"></div>
        </div>

        <div class="filter-viz">
            <div class="filter-gate"></div>
            <div class="gate-label">MOD 4096</div>
            <div class="stream-line" id="vizStream">
                </div>
        </div>

        <div id="coreContainer" class="core-grid"></div>

        <div class="stats">
            <span>Candidates Checked: <span id="checkedVal" class="stat-val">0</span></span>
            <span>Filtered Out: <span id="filteredVal" class="stat-val" style="color:var(--reject)">0</span></span>
        </div>

        <button id="btnRun" class="btn" onclick="toggleEngine()">START FERMAT DRIVE</button>

        <div id="logBox" class="log-box">System Ready. 4096-bit mask loaded.</div>
    </div>
</div>

<script>
// --- WORKER: FERMAT FILTER ---
const workerBlob = new Blob([`
    // 1. Precompute the 4096 Filter (The Bouncer)
    const SQ_MOD_4096 = new Uint8Array(4096);
    for (let i = 0; i < 4096; i++) {
        SQ_MOD_4096[(i * i) % 4096] = 1;
    }

    self.onmessage = function(e) {
        const { cmd, N_str, startOffset, stride } = e.data;
        
        if (cmd === 'start') {
            const N = BigInt(N_str);
            
            // Fermat Setup: N = A^2 - B^2
            // We search for A starting at ceil(sqrt(N))
            // We call A the "Gnomon Anchor"
            
            // Approximate sqrt(N)
            // For massive N, we use a simple Newton loop or BigInt sqrt
            function isqrt(n) {
                if (n < 0n) throw "negative";
                if (n < 2n) return n;
                let x0 = n;
                let x1 = (x0 + n / x0) >> 1n;
                while (x1 < x0) {
                    x0 = x1;
                    x1 = (x0 + n / x0) >> 1n;
                }
                return x0;
            }

            const root = isqrt(N);
            let A = root + BigInt(startOffset); 
            const step = BigInt(stride);
            
            let checked = 0;
            let filtered = 0;
            let lastUpdate = Date.now();

            while(true) {
                // A is our candidate "Upper Square"
                // If A^2 - N is a perfect square (B^2), we win.
                // Q = A^2 - N
                
                const Q = A*A - N;
                
                // --- THE 4096 FILTER ---
                // We check if Q is a quadratic residue mod 4096.
                // We only need the last 12 bits of Q.
                // Number(Q & 4095n) gives us Q % 4096 very fast.
                
                if (SQ_MOD_4096[Number(Q & 4095n)] === 1) {
                    // Passed the bouncer! Now check strictly.
                    const B = isqrt(Q);
                    if (B*B === Q) {
                        // HIT!
                        const factor1 = A - B;
                        const factor2 = A + B;
                        postMessage({ type: 'hit', f1: factor1.toString(), f2: factor2.toString() });
                        return; // Stop this worker
                    }
                } else {
                    filtered++;
                }

                checked++;
                A += step;

                // Reporting
                if (checked % 50000 === 0) {
                    const now = Date.now();
                    if (now - lastUpdate > 100) {
                        postMessage({ type: 'prog', c: checked, f: filtered });
                        checked = 0;
                        filtered = 0;
                        lastUpdate = now;
                    }
                }
            }
        }
    }
`], { type: 'application/javascript' });

// --- MAIN THREAD ---
let workers = [];
let isRunning = false;
let totalChecked = 0;
let totalFiltered = 0;
let coreStats = [];

const el = (id) => document.getElementById(id);
const log = (msg, type='sys') => {
    const d = document.createElement('div');
    d.textContent = `> ${msg}`;
    d.className = `log-${type}`;
    el('logBox').prepend(d);
}

// Visualizer Animation Loop
function updateViz() {
    if(!isRunning) return;
    const cont = el('vizStream');
    
    // Add random blocks
    if(Math.random() > 0.8) {
        const b = document.createElement('div');
        const pass = Math.random() > 0.83; // 17% chance to pass (simulating the filter)
        b.className = `block ${pass ? 'pass' : 'kill'}`;
        b.innerText = pass ? 'SQ' : 'X';
        cont.appendChild(b);
        
        // Cleanup
        if(cont.children.length > 20) cont.removeChild(cont.firstChild);
    }
    requestAnimationFrame(updateViz);
}

// Core Management
const threadCount = navigator.hardwareConcurrency || 4;
function initCores() {
    const c = el('coreContainer');
    c.innerHTML = '';
    for(let i=0; i<threadCount; i++) {
        c.innerHTML += `
            <div class="core-item">
                <div>CORE ${i+1}</div>
                <span id="cStat-${i}" class="core-val">IDLE</span>
            </div>`;
    }
}
initCores();

function toggleEngine() {
    if(isRunning) return stopEngine();
    
    // Calculate N
    const base = BigInt(el('inpBase').value);
    const exp = BigInt(el('inpExp').value);
    const add = BigInt(el('inpAdd').value);
    const N = (base ** exp) + add;
    
    log(`Target N: ${N.toString().substring(0, 20)}...`, 'sys');
    log(`Strategy: Fermat Difference of Squares`, 'sys');
    log(`Optimization: 4096-bit Bloom Filter`, 'sys');

    isRunning = true;
    totalChecked = 0;
    totalFiltered = 0;
    el('btnRun').innerText = "ABORT SEARCH";
    el('btnRun').classList.add('stop');
    
    const workerUrl = URL.createObjectURL(workerBlob);
    
    // Launch Workers (Staggered offsets)
    // We check A, A+1, A+2...
    // Core 0 checks A, A+4, A+8...
    // Core 1 checks A+1, A+5...
    
    for(let i=0; i<threadCount; i++) {
        const w = new Worker(workerUrl);
        w.onmessage = function(e) { handleWorker(e, i); };
        w.postMessage({ 
            cmd: 'start', 
            N_str: N.toString(), 
            startOffset: i, // Offset from sqrt(N)
            stride: threadCount 
        });
        workers.push(w);
    }
    
    updateViz();
}

function handleWorker(e, id) {
    const d = e.data;
    
    if(d.type === 'prog') {
        totalChecked += d.c;
        totalFiltered += d.f;
        
        el('checkedVal').innerText = totalChecked.toLocaleString();
        el('filteredVal').innerText = totalFiltered.toLocaleString();
        
        // Update Core UI
        el(`cStat-${id}`).innerText = `${(d.f/d.c*100).toFixed(1)}% Rej`;
    }
    
    if(d.type === 'hit') {
        log(`FACTOR FOUND!`, 'hit');
        log(`${d.f1} x ${d.f2}`, 'hit');
        stopEngine();
    }
}

function stopEngine() {
    workers.forEach(w => w.terminate());
    workers = [];
    isRunning = false;
    el('btnRun').innerText = "START FERMAT DRIVE";
    el('btnRun').classList.remove('stop');
}
</script>
</body>
</html>
