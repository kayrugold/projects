<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gnomon Ultimate</title>
    <style>
        :root {
            --bg-color: #0b1120;
            --text-color: #e2e8f0;
            --accent-color: #38bdf8;
            --panel-bg: #1e293b;
            --cell-bg: #1e293b;
            --cell-hover: #334155;
            --wall-dim: rgba(251, 191, 36, 0.08);
            --wall-border: rgba(251, 191, 36, 0.3);
            --gnomon-pink: #f472b6;
            --header-bg: #0f172a;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Bar Controls */
        .controls {
            padding: 10px;
            background: #151e32;
            border-bottom: 1px solid #334155;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .row-inputs {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-group {
            display: flex;
            align-items: center;
            background: #0b1120;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 5px;
            flex-grow: 1;
        }
        
        input {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1rem;
            width: 100%;
            text-align: center;
            outline: none;
            font-family: monospace;
        }

        /* Engine Switcher */
        .switch-container {
            display: flex;
            background: #0b1120;
            border-radius: 8px;
            padding: 2px;
            border: 1px solid #334155;
        }
        .switch-opt {
            flex: 1;
            text-align: center;
            padding: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            border-radius: 6px;
            color: #64748b;
            font-weight: bold;
        }
        .switch-opt.active {
            background: var(--accent-color);
            color: #0f172a;
        }

        button.go-btn {
            background-color: var(--gnomon-pink);
            color: #0f172a;
            border: none;
            padding: 0 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
        }

        /* Scrollable Grid Area */
        .grid-wrapper {
            flex-grow: 1;
            overflow: auto;
            position: relative;
            background: #000;
            -webkit-overflow-scrolling: touch;
        }

        .grid-container {
            display: grid;
            gap: 1px;
            padding-bottom: 150px; /* Space for panel */
        }

        /* The Cell */
        .cell {
            background-color: var(--cell-bg);
            min-width: 75px;
            height: 75px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            user-select: none;
        }

        /* Mod 3 Wall Styling - DIMMED */
        .mod3-wall {
            background-color: var(--wall-dim) !important;
            border: 1px solid var(--wall-border);
        }
        .mod3-wall .value { opacity: 0.7; }
        .mod3-wall .eq { color: #fbbf24 !important; opacity: 0.8; }

        /* Headers */
        .header-cell {
            background-color: var(--header-bg);
            color: var(--accent-color);
            font-weight: bold;
            position: sticky;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #334155;
            font-size: 0.9rem;
        }
        .header-row { top: 0; height: 40px; }
        .header-col { left: 0; width: 50px; z-index: 21; }
        .corner { top: 0; left: 0; z-index: 30; width: 50px; height: 40px; border: 2px solid var(--accent-color); }

        .header-cell.mod3-wall { color: #fbbf24; }

        /* Content */
        .value { font-size: 1rem; font-weight: bold; color: #fff; z-index: 2; }
        .eq { font-size: 0.65rem; color: #94a3b8; margin-top: 2px; font-family: monospace; display: block; }
        .gnomon-badge {
            position: absolute;
            top: 2px; right: 2px;
            font-size: 0.6rem;
            color: var(--gnomon-pink);
            background: rgba(244, 114, 182, 0.15);
            padding: 1px 3px;
            border-radius: 3px;
        }

        /* Highlights */
        .highlight-target { 
            background-color: rgba(56, 189, 248, 0.3) !important; 
            border: 2px solid #fff !important; 
            z-index: 25;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.5);
        }

        /* Bottom Panel */
        #infoPanel {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--panel-bg);
            border-top: 2px solid var(--accent-color);
            border-radius: 15px 15px 0 0;
            padding: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            transform: translateY(110%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1000;
            max-height: 60vh; overflow-y: auto;
        }
        #infoPanel.active { transform: translateY(0); }

        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #334155;
        }
        .close-btn { background: transparent; color: #fff; font-size: 1.5rem; border:none; padding: 0 10px; }

        .corridor-box {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            text-align: center;
        }
        .c-item { display: flex; flex-direction: column; align-items: center; }
        .c-label { font-size: 0.6rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
        .c-val { font-size: 0.9rem; font-weight: bold; color: #fff; }
        .c-wall { color: #fbbf24; }
        .c-target { color: #f472b6; text-decoration: underline; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item label { display: block; color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; }
        .stat-item div { color: #fff; font-size: 1.1rem; font-weight: bold; font-family: monospace; }
        
        .engine-tag { font-size: 0.7rem; color: #64748b; text-align: right; margin-top: 5px; font-style: italic;}

    </style>
</head>
<body>

    <div class="controls">
        <div class="switch-container">
            <div class="switch-opt active" id="engRow" onclick="setEngine('row')">Row Scan (Gap)</div>
            <div class="switch-opt" id="engS" onclick="setEngine('s')">S-Search (Perimeter)</div>
        </div>
        <div class="row-inputs">
            <div class="input-group" style="flex: 0 0 60px;">
                <input type="number" id="gridSize" value="25" placeholder="Size" onchange="drawGrid()">
            </div>
            <div class="input-group">
                <input type="number" id="targetInput" placeholder="Find Odd Number">
            </div>
            <button class="go-btn" onclick="runLocate()">Go</button>
        </div>
    </div>

    <div class="grid-wrapper" id="scrollContainer">
        <div id="grid" class="grid-container"></div>
    </div>

    <div id="infoPanel">
        <div class="panel-header">
            <h3 style="margin:0; color:var(--accent-color)">Unpacked Data</h3>
            <button class="close-btn" onclick="closePanel()">&times;</button>
        </div>
        
        <div class="stat-grid">
            <div class="stat-item">
                <label>Value</label>
                <div id="pVal" style="color:var(--accent-color)">--</div>
            </div>
            <div class="stat-item">
                <label>Equation</label>
                <div id="pEq">--</div>
            </div>
            <div class="stat-item">
                <label>Row Factor</label>
                <div id="pRFact">--</div>
            </div>
            <div class="stat-item">
                <label>Col Factor</label>
                <div id="pCFact">--</div>
            </div>
        </div>

        <div style="margin-top:20px; font-size:0.8rem; color:#94a3b8; font-weight:bold">Row Corridor (2 Walls Method)</div>
        <div class="corridor-box" id="corrBox">
            </div>

        <div class="engine-tag" id="engDisplay">Engine used: --</div>
    </div>

    <script>
        const gridEl = document.getElementById('grid');
        let currentSize = 25;
        let currentEngine = 'row'; // 'row' or 's'

        function getOdd(i) { return BigInt(i) * 2n - 1n; }
        
        function setEngine(mode) {
            currentEngine = mode;
            document.getElementById('engRow').className = mode === 'row' ? 'switch-opt active' : 'switch-opt';
            document.getElementById('engS').className = mode === 's' ? 'switch-opt active' : 'switch-opt';
        }

        function drawGrid() {
            let size = parseInt(document.getElementById('gridSize').value) || 25;
            if(size > 200) size = 200;
            currentSize = size;
            
            gridEl.innerHTML = '';
            gridEl.style.gridTemplateColumns = `50px repeat(${size}, 75px)`;

            // Corner
            let corner = document.createElement('div');
            corner.className = 'cell corner header-cell';
            corner.innerText = 'x';
            gridEl.appendChild(corner);

            // Col Headers
            for(let c=1; c<=size; c++) {
                let d = document.createElement('div');
                let odd = getOdd(c);
                let isWall = (odd % 3n === 0n);
                d.className = isWall ? 'cell header-cell header-row mod3-wall' : 'cell header-cell header-row';
                d.innerText = odd;
                d.id = `col-${c}`;
                gridEl.appendChild(d);
            }

            // Rows
            for(let r=1; r<=size; r++) {
                let oddR = getOdd(r);
                let isRowWall = (oddR % 3n === 0n);
                
                // Row Header
                let rh = document.createElement('div');
                rh.className = isRowWall ? 'cell header-cell header-col mod3-wall' : 'cell header-cell header-col';
                rh.innerText = oddR;
                rh.id = `row-${r}`;
                gridEl.appendChild(rh);

                // Cells
                for(let c=1; c<=size; c++) {
                    let oddC = getOdd(c);
                    let isColWall = (oddC % 3n === 0n);
                    let val = oddR * oddC;
                    let isSquare = (r === c);
                    
                    let cell = document.createElement('div');
                    // Add mod3-wall class if Row OR Col is wall
                    let classes = 'cell';
                    if (isRowWall || isColWall) classes += ' mod3-wall';
                    if (isSquare) classes += ' perfect-square';
                    
                    cell.className = classes;
                    cell.id = `cell-${r}-${c}`;
                    
                    let sVal = val.toString();
                    if(sVal.length > 5) sVal = sVal.substring(0,4) + '..';
                    let gnomonVal = (2n * oddR) - 1n; 

                    cell.innerHTML = `
                        <span class="value">${sVal}</span>
                        <span class="eq">${oddR}×${oddC}</span>
                        ${isSquare ? `<div class="gnomon-badge">${gnomonVal}</div>` : ''}
                    `;
                    
                    cell.onclick = () => showPanel(val, oddR, oddC, r, c);
                    gridEl.appendChild(cell);
                }
            }
        }

        // --- ENGINE 1: ROW SCAN (Gap) ---
        function engineRowScan(T) {
            let ceiling = bigSqrt(T);
            if(ceiling % 2n === 0n) ceiling--;
            let limit = 20000;
            
            for(let r = ceiling; r >= 1n; r -= 2n) {
                if(limit-- < 0) break;
                if(T % r === 0n) return { r: r, c: T/r };
            }
            return { r: 1n, c: T };
        }

        // --- ENGINE 2: S-SEARCH (Perimeter) ---
        // Based on ssearch5.txt: S_min = 2*sqrt(N), check S^2 - 4N
        function engineSSearch(T) {
            let T4 = T * 4n;
            let sqrtT = bigSqrt(T);
            let S = 2n * sqrtT;
            while (S*S <= T4) S += 1n; // Ensure S^2 > 4N

            let limit = 20000;
            
            for(let k=0; k<limit; k++) {
                let D_sq = S*S - T4;
                let D = bigSqrt(D_sq);
                
                if (D*D === D_sq) {
                    // Found! Factors are (S-D)/2 and (S+D)/2
                    let f1 = (S - D) / 2n;
                    let f2 = (S + D) / 2n;
                    return { r: f1, c: f2 }; // f1 is smaller
                }
                S += 1n;
            }
            return { r: 1n, c: T };
        }

        function bigSqrt(n) {
            if (n < 0n) return 0n;
            if (n < 2n) return n;
            let x = n, y = (x + n / x) / 2n;
            while (y < x) { x = y; y = (x + n / x) / 2n; }
            return x;
        }

        function runLocate() {
            let raw = document.getElementById('targetInput').value;
            if(!raw) return;
            let T = BigInt(raw.replace(/,/g,''));
            if(T % 2n === 0n) { alert("Odd numbers only"); return; }

            let start = performance.now();
            let factors;
            
            if (currentEngine === 'row') factors = engineRowScan(T);
            else factors = engineSSearch(T);
            
            let end = performance.now();
            let time = (end - start).toFixed(2);
            document.getElementById('engDisplay').innerText = `Engine: ${currentEngine === 'row' ? 'Row Scan' : 'S-Search'} (${time}ms)`;

            // Convert to Indices
            let rIdx = Number((factors.r + 1n) / 2n);
            let cIdx = Number((factors.c + 1n) / 2n);

            highlightCell(rIdx, cIdx);
            showPanel(T, factors.r, factors.c, rIdx, cIdx);
        }

        function highlightCell(r, c) {
            document.querySelectorAll('.highlight-target').forEach(e=>e.classList.remove('highlight-target'));
            if(r <= currentSize && c <= currentSize) {
                let cell = document.getElementById(`cell-${r}-${c}`);
                if(cell) {
                    cell.classList.add('highlight-target');
                    cell.scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
                }
            } else {
                alert(`Found: ${r} × ${c} (Outside View)`);
            }
        }

        function showPanel(val, rVal, cVal, rIdx, cIdx) {
            document.getElementById('infoPanel').classList.add('active');
            document.getElementById('pVal').innerText = val;
            document.getElementById('pEq').innerText = `${rVal} × ${cVal}`;
            document.getElementById('pRFact').innerText = rVal;
            document.getElementById('pCFact').innerText = cVal;

            // Build Corridor Visual (The 2 Walls) for the Row Factor
            // We want to show: (rVal aligned to mod 3)
            // Sequence: Wall - In - In - Wall
            let rem = rVal % 3n;
            let start = 0n;
            if (rem === 0n) start = rVal; // It is a wall
            else if (rem === 2n) start = rVal - 2n; // First inner
            else start = rVal - 4n; // Second inner

            let html = '';
            for(let i=0; i<4; i++) {
                let curr = start + (BigInt(i)*2n);
                let isWall = (curr % 3n === 0n);
                let isTarget = (curr === rVal);
                
                let label = isWall ? "WALL" : "CANDIDATE";
                let cls = isWall ? "c-val c-wall" : (isTarget ? "c-val c-target" : "c-val");
                
                html += `
                    <div class="c-item">
                        <span class="c-label">${label}</span>
                        <span class="${cls}">${curr}</span>
                    </div>
                `;
            }
            document.getElementById('corrBox').innerHTML = html;
        }

        function closePanel() {
            document.getElementById('infoPanel').classList.remove('active');
        }

        drawGrid();

        document.getElementById('targetInput').addEventListener('keyup', e => {
            if(e.key === 'Enter') runLocate();
        });

    </script>
</body>
</html>
