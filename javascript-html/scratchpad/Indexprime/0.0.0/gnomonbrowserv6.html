<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gnomon Supersonic</title>
    <style>
        :root {
            --bg-color: #050914; /* Darker space black */
            --panel-bg: rgba(30, 41, 59, 0.95);
            --accent-cyan: #06b6d4;
            --neon-blue: #22d3ee;
            --neon-glow: rgba(34, 211, 238, 0.6);
            --gnomon-pink: #f472b6;
            --wall-amber: #fbbf24;
            --wall-dim: rgba(251, 191, 36, 0.05);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: #e2e8f0;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- Top Controls --- */
        .controls {
            padding: 15px;
            background: #0f172a;
            border-bottom: 1px solid #334155;
            display: flex; flex-direction: column; gap: 10px;
            z-index: 50;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .input-row { display: flex; gap: 10px; width: 100%; }
        
        input {
            background: #1e293b; border: 1px solid #475569;
            color: #fff; font-size: 1.1rem; padding: 8px;
            text-align: center; border-radius: 8px;
            flex-grow: 1; outline: none; font-family: monospace;
        }
        input:focus { border-color: var(--neon-blue); box-shadow: 0 0 10px var(--neon-glow); }

        button.scan-btn {
            background: linear-gradient(135deg, #0ea5e9, #22d3ee);
            color: #000; border: none; padding: 0 25px;
            border-radius: 8px; font-weight: 800; font-size: 1rem;
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 0 15px var(--neon-glow);
            transition: all 0.2s;
        }
        button.scan-btn:active { transform: scale(0.95); }

        /* --- The Grid --- */
        .grid-wrapper {
            flex-grow: 1; overflow: auto; position: relative;
            background: #000;
            -webkit-overflow-scrolling: touch;
        }
        .grid-container {
            display: grid; gap: 1px; padding-bottom: 200px;
        }

        /* Cells */
        .cell {
            background-color: #0f172a;
            min-width: 70px; height: 70px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            position: relative; user-select: none;
        }

        /* Headers */
        .header-cell {
            background: #1e293b; color: #94a3b8; font-weight: bold;
            position: sticky; z-index: 20; font-size: 0.8rem;
            border: 1px solid #334155;
        }
        .header-row { top: 0; height: 35px; z-index: 22; }
        .header-col { left: 0; width: 45px; z-index: 22; }
        .corner { top: 0; left: 0; z-index: 30; width: 45px; height: 35px; border-color: var(--neon-blue); }

        /* NEON SQUARES */
        .perfect-square {
            background: rgba(6, 182, 212, 0.1) !important;
            border: 1px solid var(--neon-blue) !important;
            box-shadow: 0 0 15px var(--neon-glow), inset 0 0 10px rgba(34, 211, 238, 0.2);
            z-index: 5;
        }
        .perfect-square .value { color: #fff; text-shadow: 0 0 5px var(--neon-blue); }
        .perfect-square .gnomon-badge { 
            background: var(--neon-blue); color: #000; font-weight: bold; 
            box-shadow: 0 0 8px var(--neon-glow);
        }

        /* Walls */
        .mod3-wall { background-color: var(--wall-dim); }
        .mod3-wall .eq { color: #fbbf24; opacity: 0.5; }

        /* Content */
        .value { font-size: 0.9rem; font-weight: bold; color: #cbd5e1; z-index: 2; }
        .eq { font-size: 0.6rem; color: #64748b; margin-top: 2px; font-family: monospace; }
        .gnomon-badge {
            position: absolute; top: 2px; right: 2px;
            font-size: 0.55rem; color: var(--gnomon-pink);
            background: rgba(244, 114, 182, 0.1); padding: 1px 3px; border-radius: 2px;
        }

        /* --- SCANNER ANIMATION --- */
        .scan-line {
            position: absolute; left: 0; right: 0; height: 4px;
            background: var(--neon-blue);
            box-shadow: 0 0 20px 5px var(--neon-blue);
            z-index: 100; opacity: 0; pointer-events: none;
            transition: top 0.1s linear;
        }
        .scanning-row {
            background: rgba(34, 211, 238, 0.15) !important;
            transition: background 0.1s;
        }
        .found-target {
            background: rgba(244, 114, 182, 0.3) !important;
            border: 2px solid var(--gnomon-pink) !important;
            box-shadow: 0 0 30px rgba(244, 114, 182, 0.6);
            z-index: 50; transform: scale(1.1);
        }

        /* --- BOTTOM PANEL --- */
        #infoPanel {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border-top: 3px solid var(--neon-blue);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            transform: translateY(110%);
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 1000; box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
        }
        #infoPanel.active { transform: translateY(0); }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .panel-title { color: var(--neon-blue); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; }
        .close-btn { background: none; border: none; color: #fff; font-size: 1.5rem; }

        .corridor-viz {
            display: flex; gap: 8px; margin-top: 15px;
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 12px;
            justify-content: space-around;
        }
        .c-col { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .c-tag { font-size: 0.6rem; font-weight: bold; padding: 2px 6px; border-radius: 4px; }
        .tag-wall { color: #000; background: var(--wall-amber); }
        .tag-target { color: #fff; background: var(--gnomon-pink); box-shadow: 0 0 10px rgba(244, 114, 182, 0.4); }
        .tag-inner { color: #94a3b8; border: 1px solid #475569; }
        .c-val { font-family: monospace; font-size: 1rem; font-weight: bold; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        .stat-label { color: #64748b; font-size: 0.7rem; text-transform: uppercase; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: #fff; }

    </style>
</head>
<body>

    <div class="controls">
        <div class="input-row">
            <input type="number" id="gridSize" value="30" placeholder="Grid Size" style="flex: 0 0 80px;" onchange="drawGrid()">
            <input type="number" id="targetInput" placeholder="Target (e.g. 1007)">
        </div>
        <button class="scan-btn" onclick="startSupersonicScan()">Supersonic Scan</button>
    </div>

    <div id="scanLine" class="scan-line"></div>

    <div class="grid-wrapper" id="scrollContainer">
        <div id="grid" class="grid-container"></div>
    </div>

    <div id="infoPanel">
        <div class="panel-header">
            <div class="panel-title">Structure Unpacked</div>
            <button class="close-btn" onclick="closePanel()">&times;</button>
        </div>
        
        <div class="stat-grid">
            <div>
                <div class="stat-label">Equation</div>
                <div class="stat-val" style="color:var(--neon-blue)" id="pEq">--</div>
            </div>
            <div>
                <div class="stat-label">Gnomon Index (Row)</div>
                <div class="stat-val" style="color:var(--gnomon-pink)" id="pRow">--</div>
            </div>
        </div>

        <div style="font-size:0.7rem; color:#94a3b8; margin-top:10px; text-transform:uppercase;">Corridor Alignment</div>
        <div class="corridor-viz" id="corridorBox">
            </div>
    </div>

    <script>
        const gridEl = document.getElementById('grid');
        let currentSize = 30;

        // BigInt Math
        function getOdd(i) { return BigInt(i) * 2n - 1n; }
        function bigSqrt(n) {
            if (n < 0n) return 0n; if (n < 2n) return n;
            let x = n, y = (x + n / x) / 2n;
            while (y < x) { x = y; y = (x + n / x) / 2n; }
            return x;
        }

        // --- DRAW GRID ---
        function drawGrid() {
            let size = parseInt(document.getElementById('gridSize').value) || 30;
            if(size > 200) size = 200;
            currentSize = size;
            
            gridEl.innerHTML = '';
            gridEl.style.gridTemplateColumns = `45px repeat(${size}, 75px)`;

            // Corner
            let corner = document.createElement('div');
            corner.className = 'cell corner header-cell';
            corner.innerText = 'x';
            gridEl.appendChild(corner);

            // Col Headers
            for(let c=1; c<=size; c++) {
                let odd = getOdd(c);
                let d = document.createElement('div');
                d.className = 'cell header-cell header-row';
                d.innerText = odd;
                d.id = `col-${c}`;
                gridEl.appendChild(d);
            }

            // Rows
            for(let r=1; r<=size; r++) {
                let oddR = getOdd(r);
                let isWall = (oddR % 3n === 0n);
                
                let rh = document.createElement('div');
                rh.className = 'cell header-cell header-col';
                rh.innerText = oddR;
                rh.id = `row-${r}`;
                if(isWall) rh.style.color = '#fbbf24';
                gridEl.appendChild(rh);

                for(let c=1; c<=size; c++) {
                    let oddC = getOdd(c);
                    let val = oddR * oddC;
                    let isSquare = (r === c);
                    let isColWall = (oddC % 3n === 0n);

                    let cell = document.createElement('div');
                    let classes = 'cell';
                    if(isSquare) classes += ' perfect-square';
                    if(isWall || isColWall) classes += ' mod3-wall';
                    
                    cell.className = classes;
                    cell.id = `cell-${r}-${c}`;
                    
                    // Display Val
                    let sVal = val.toString();
                    if(sVal.length > 5) sVal = sVal.substring(0,4) + '..';
                    
                    // Gnomon Badge: 2*Row - 1 (Value based) OR 4*RowIdx - 3 (Index based)
                    // Let's use Index Based (Pink Badge logic from chat)
                    // Badge = 4*r - 3
                    let badge = (4 * r) - 3;

                    cell.innerHTML = `
                        <span class="value">${sVal}</span>
                        <span class="eq">${oddR}×${oddC}</span>
                        ${isSquare ? `<div class="gnomon-badge">${badge}</div>` : ''}
                    `;
                    
                    cell.onclick = () => showPanel(val, oddR, oddC);
                    gridEl.appendChild(cell);
                }
            }
        }

        // --- SUPERSONIC SCANNER ---
        async function startSupersonicScan() {
            let raw = document.getElementById('targetInput').value;
            if(!raw) return;
            let T = BigInt(raw.replace(/,/g,''));
            if(T % 2n === 0n) { alert("Odd Only"); return; }

            // 1. Calculate Ceiling (Start Point)
            let ceiling = bigSqrt(T);
            if(ceiling % 2n === 0n) ceiling--;
            
            // Convert Value ceiling to Row Index
            // Index = (Val + 1) / 2
            let startIdx = Number((ceiling + 1n) / 2n);
            
            // 2. Prepare Visuals
            let scanLine = document.getElementById('scanLine');
            scanLine.style.opacity = 1;
            
            // Clear previous
            document.querySelectorAll('.found-target').forEach(e => e.classList.remove('found-target'));
            document.querySelectorAll('.scanning-row').forEach(e => e.classList.remove('scanning-row'));

            // 3. The "Race" Logic
            // We run the math instantly, but animate the "Search"
            let foundR = 1n, foundC = T; 
            let scanRow = ceiling;
            
            // Fast Math (S-Search + Gap Hybrid)
            let limit = 50000;
            while(scanRow >= 1n && limit-- > 0) {
                if(T % scanRow === 0n) {
                    foundR = scanRow; foundC = T/scanRow;
                    break;
                }
                scanRow -= 2n;
            }

            // 4. Animate the "Supersonic" visual
            // We visualize scanning from startIdx down to foundIdx
            let endIdx = Number((foundR + 1n) / 2n);
            let currentIdx = startIdx;
            
            // Visual Speed
            let step = Math.max(1, Math.floor((startIdx - endIdx) / 20)); 
            
            function animateFrame() {
                if(currentIdx < endIdx) currentIdx = endIdx; // Stop at target

                // Update Scan Line Position
                // If row is in view...
                let rowEl = document.getElementById(`row-${currentIdx}`);
                if(rowEl) {
                    let rect = rowEl.getBoundingClientRect();
                    // scanLine.style.top = (rect.top + window.scrollY + rect.height/2) + 'px';
                    // Scroll to it
                    rowEl.scrollIntoView({block: "center", behavior: "auto"});
                    
                    // Highlight Row
                    rowEl.classList.add('scanning-row');
                    setTimeout(() => rowEl.classList.remove('scanning-row'), 100);
                }

                if(currentIdx > endIdx) {
                    currentIdx -= step;
                    requestAnimationFrame(animateFrame);
                } else {
                    // FOUND!
                    scanLine.style.opacity = 0;
                    finishScan(T, foundR, foundC);
                }
            }
            
            animateFrame();
        }

        function finishScan(T, rVal, cVal) {
            // Highlight Cell
            let rIdx = Number((rVal + 1n) / 2n);
            let cIdx = Number((cVal + 1n) / 2n);
            
            if(rIdx <= currentSize && cIdx <= currentSize) {
                let cell = document.getElementById(`cell-${rIdx}-${cIdx}`);
                if(cell) {
                    cell.classList.add('found-target');
                    cell.scrollIntoView({block: "center", inline: "center"});
                }
            }
            
            showPanel(T, rVal, cVal);
        }

        function showPanel(val, rVal, cVal) {
            let p = document.getElementById('infoPanel');
            p.classList.add('active');
            
            document.getElementById('pEq').innerText = `${rVal} × ${cVal}`;
            document.getElementById('pRow').innerText = rVal;

            // Corridor Logic (2 Walls)
            // rVal is the key. Mod 3 logic.
            let rem = rVal % 3n;
            let start = (rem === 0n) ? rVal : (rem === 2n ? rVal - 2n : rVal - 4n);
            
            let html = '';
            for(let i=0; i<4; i++) {
                let curr = start + (BigInt(i)*2n);
                let isWall = (curr % 3n === 0n);
                let isTarget = (curr === rVal);
                
                let tagClass = isWall ? 'tag-wall' : (isTarget ? 'tag-target' : 'tag-inner');
                let tagText = isWall ? 'WALL' : (isTarget ? 'TARGET' : 'INNER');

                html += `
                    <div class="c-col">
                        <div class="c-tag ${tagClass}">${tagText}</div>
                        <div class="c-val" style="color:${isWall ? '#fbbf24' : '#fff'}">${curr}</div>
                    </div>
                `;
            }
            document.getElementById('corridorBox').innerHTML = html;
        }

        function closePanel() {
            document.getElementById('infoPanel').classList.remove('active');
        }

        // Init
        drawGrid();

    </script>
</body>
</html>
