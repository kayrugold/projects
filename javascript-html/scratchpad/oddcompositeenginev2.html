<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Odd Composite Engine v2</title>
<style>
  :root{
    --bg:#0b1220; --panel:#071025; --muted:#94a3b8; --accent:#f6c84c;
    --prime:#0b5f3b; --comp:#5a1212; --cell:#111827; --glass: rgba(255,255,255,0.03);
    --g-inner:#1e293b; /* Color of the inner square (k-1)^2 */
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#020617);color:#e6eef6;font-family:Inter,ui-sans-serif,system-ui,monospace}
  .wrap{max-width:1200px;margin:18px auto;padding:16px;display:flex;flex-direction:column;gap:14px}
  header{display:flex;align-items:center;gap:12px}
  h1{margin:0;font-size:1.1rem;color:#9ad0ff}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type=number]{width:120px;padding:8px;border-radius:6px;border:1px solid #223046;background:var(--panel);color:#e6eef6}
  button{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:white;cursor:pointer;transition:background 0.2s}
  button:hover{background:#1d4ed8}
  button.secondary{background:#334155}
  button.secondary:hover{background:#475569}
  
  .layout{display:grid;grid-template-columns:2fr 1fr;gap:12px;height:70vh}
  .panel{background:var(--panel);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.6);overflow:auto;border:1px solid #1e293b}
  
  /* Grid Styles */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(50px,1fr));gap:6px;padding:8px}
  .cell{background:var(--cell);padding:10px;border-radius:6px;text-align:center;cursor:pointer;user-select:none;border:1px solid transparent;transition:transform .1s, border-color .1s; font-size:0.9rem}
  .cell.small{padding:4px;font-size:0.75rem}
  .cell.prime{background:var(--prime);color:#d8fbe1;border-color:#059669}
  .cell.comp{background:var(--comp);color:#ffd7d7;border-color:#7f1d1d}
  .cell:hover{transform:translateY(-2px); z-index:10}
  .cell.selected{outline:3px solid var(--accent);transform:scale(1.05);z-index:20;box-shadow:0 0 15px rgba(246,200,76,0.3)}
  
  /* Info Panel */
  .info{display:flex;flex-direction:column;gap:12px}
  .small-muted{color:var(--muted);font-size:0.75rem;text-transform:uppercase;letter-spacing:0.5px;font-weight:600}
  .big-stat{font-size:1.4rem;font-weight:700;margin-top:2px}
  
  .vis-container{
    background:#020617; border:1px solid #334155; border-radius:8px;
    padding:10px; display:flex; justify-content:center; align-items:center;
    min-height:220px;
  }
  canvas{background:transparent; max-width:100%; height:auto; display:block}
  
  .chip{display:inline-block; background:var(--glass);padding:4px 8px;border-radius:4px;border:1px solid rgba(255,255,255,0.1);font-size:0.85rem;margin:2px}
  
  footer{font-size:0.8rem;color:var(--muted);margin-top:8px;display:flex;justify-content:space-between;opacity:0.8}
  
  @media (max-width:900px){.layout{grid-template-columns:1fr;height:auto}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Odd Composite Engine v2</h1>
    <div style="flex:1"></div>
    <div class="controls">
      <input id="inpLimit" type="number" min="11" step="2" value="401"/>
      <button id="btnRun">Generate</button>
      <button id="btnExport" class="secondary">Export CSV</button>
    </div>
  </header>

  <div class="layout">
    <div class="panel" id="leftPanel">
      <div class="small-muted" id="summary">Ready.</div>
      <div id="grid" class="grid" style="margin-top:8px"></div>
    </div>

    <div class="panel info" id="rightPanel">
      
      <div style="display:flex;justify-content:space-between;align-items:flex-end">
        <div>
          <div class="small-muted">Selected Number</div>
          <div id="selNum" class="big-stat" style="color:var(--accent)">—</div>
        </div>
        <div style="text-align:right">
          <div class="small-muted">Type</div>
          <div id="selType" style="font-weight:bold">—</div>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid #334155;width:100%;margin:0"/>

      <div>
        <div class="small-muted" style="margin-bottom:6px">Gnomon Visualizer (n = k² - (k-1)²)</div>
        <div class="vis-container">
          <canvas id="gCanvas" width="300" height="300"></canvas>
        </div>
        <div id="gnomonInfo" style="text-align:center;font-size:0.85rem;color:var(--muted);margin-top:6px">
          Select a number to visualize geometry.
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>
          <div class="small-muted">Smallest Odd Factor</div>
          <div id="lblFactor" style="font-size:1.1rem">—</div>
        </div>
        <div>
          <div class="small-muted">Square Index (k)</div>
          <div id="lblK" style="font-size:1.1rem">—</div>
        </div>
      </div>

      <div>
        <div class="small-muted">Odd Factor Pairs</div>
        <div id="factorsBox" style="margin-top:4px;line-height:1.4">—</div>
      </div>

    </div>
  </div>

  <footer>
    <div id="perf">Waiting for run...</div>
  </footer>
</div>

<script>
/*
  Odd Composite Engine v2 + Gnomon Visualizer
*/

// --- DOM Elements ---
const el = id => document.getElementById(id);
const gridEl = el('grid'), summaryEl = el('summary'), selNumEl = el('selNum');
const selTypeEl = el('selType'), factorsBox = el('factorsBox');
const lblFactor = el('lblFactor'), lblK = el('lblK'), gInfo = el('gnomonInfo');
const canvas = el('gCanvas');
const ctx = canvas.getContext('2d');

// --- State ---
let limit = 401;
let smallestOddFactor = null; // Int32Array
let selected = null;

// --- Engine ---
function generate(limitVal){
  const t0 = performance.now();
  limit = Math.floor(limitVal);
  if (limit % 2 === 0) limit--; 
  
  // 1. Init Array
  smallestOddFactor = new Int32Array(limit + 1);
  
  // 2. Sieve Logic (Count & Multiply)
  // iterate odd factors a = 3..sqrt(N)
  const maxA = Math.floor(Math.sqrt(limit));
  for (let a = 3; a <= maxA; a += 2) {
    // iterate odd b >= a
    for (let b = a; ; b += 2) {
      const prod = a * b;
      if (prod > limit) break;
      // Mark composite (store smallest factor 'a' if not set)
      if (smallestOddFactor[prod] === 0) smallestOddFactor[prod] = a;
    }
  }

  const t1 = performance.now();
  renderGrid();
  
  // Stats
  let comps = 0;
  for(let i=3; i<=limit; i+=2) if(smallestOddFactor[i] !== 0) comps++;
  summaryEl.innerText = `Generated 1 to ${limit}. Composites: ${comps}. Time: ${(t1-t0).toFixed(1)}ms`;
  el('perf').innerText = `Engine: Multiplication Sieve (No Division). √limit ≈ ${maxA}`;
  
  // Auto-select first meaningful number
  selectNumber(3);
}

// --- Grid Rendering ---
function renderGrid(){
  gridEl.innerHTML = '';
  // Determine if we need "small mode" based on volume
  const isCompact = limit > 800;
  
  for (let i = 1; i <= limit; i += 2){
    const div = document.createElement('div');
    div.className = 'cell' + (isCompact ? ' small' : '');
    div.innerText = i;
    div.dataset.val = i;
    
    // Styling classes
    if (i === 1) {
      div.classList.add('prime'); div.title = "Unit";
    } else if (smallestOddFactor[i] === 0) {
      div.classList.add('prime'); div.title = "Prime";
    } else {
      div.classList.add('comp'); div.title = "Composite";
    }
    
    div.onclick = () => selectNumber(i);
    gridEl.appendChild(div);
  }
}

// --- Interaction ---
function selectNumber(n){
  // 1. Highlight Grid
  const prev = document.querySelector('.cell.selected');
  if(prev) prev.classList.remove('selected');
  const next = document.querySelector(`.cell[data-val='${n}']`);
  if(next) next.classList.add('selected');
  
  selected = n;
  selNumEl.innerText = n;
  
  // 2. Determine Props
  const k = (n + 1) / 2;
  lblK.innerText = k;
  
  let isComp = false;
  if(n === 1) {
    selTypeEl.innerText = 'Unit';
    selTypeEl.style.color = '#fff';
    lblFactor.innerText = '—';
    factorsBox.innerText = '—';
  } else if (smallestOddFactor[n] === 0) {
    selTypeEl.innerText = 'Prime';
    selTypeEl.style.color = '#4ade80'; // tailwind green-400
    lblFactor.innerText = '—';
    factorsBox.innerHTML = '<span class="chip" style="border-color:#059669">Prime</span>';
  } else {
    isComp = true;
    selTypeEl.innerText = 'Composite';
    selTypeEl.style.color = '#f87171'; // tailwind red-400
    const sf = smallestOddFactor[n];
    lblFactor.innerText = sf;
    
    // Find all odd pairs for display
    let html = '';
    // We already know 'sf' is a factor. Let's find pairs by brute force 3..sqrt(n) for display
    const pairs = [];
    for(let d=3; d*d<=n; d+=2){
      if(n % d === 0){
        pairs.push([d, n/d]);
      }
    }
    // If no pairs found in loop, it must be sf * something checked logic... 
    // actually our engine guarantees sf is recorded.
    
    html = pairs.map(p => `<span class="chip">${p[0]} × ${p[1]}</span>`).join(' ');
    factorsBox.innerHTML = html;
  }
  
  // 3. Render Visualization
  renderGnomon(n, k, isComp, n===1);
}

// --- Canvas Gnomon Visualization ---
function renderGnomon(n, k, isComp, isUnit){
  // Clear
  const w = canvas.width;
  const h = canvas.height;
  ctx.clearRect(0, 0, w, h);
  
  if(isUnit){
    // Just draw a single block
    const pad = 100;
    ctx.fillStyle = '#4ade80';
    ctx.fillRect(pad, pad, w-2*pad, h-2*pad);
    gInfo.innerText = "n=1 is the first square (1x1).";
    return;
  }

  // Logic: The total grid is k x k.
  // The 'Inner Square' is (k-1) x (k-1).
  // The 'Gnomon' is the difference.
  
  // Margins
  const margin = 20;
  const availW = w - 2*margin;
  const cellSize = availW / k;
  
  // Draw Inner Square (Muted)
  ctx.fillStyle = '#1e293b'; // var(--g-inner)
  const innerSize = (k-1) * cellSize;
  // Offset to center
  const startX = margin;
  const startY = margin;
  
  // If k=1 (n=1), inner is 0 size. Handled above.
  if(k > 1){
    ctx.fillRect(startX, startY, innerSize, innerSize);
  }
  
  // Draw Gnomon (The outer rim)
  // Two rectangles: 
  // 1. The Bottom Row (width k, height 1)
  // 2. The Right Column (width 1, height k-1) (minus the corner which is included in bottom row)
  
  ctx.fillStyle = isComp ? '#ef4444' : '#22c55e'; // Red vs Green
  
  // Bottom Row (Full width)
  ctx.fillRect(startX, startY + innerSize, k * cellSize, cellSize);
  
  // Right Column (Height of inner square)
  ctx.fillRect(startX + innerSize, startY, cellSize, innerSize);
  
  // Optional: Stroke grid lines if k is small enough to see them
  if (k < 40) {
    ctx.strokeStyle = 'rgba(0,0,0,0.3)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    // Verticals
    for(let i=0; i<=k; i++){
      ctx.moveTo(startX + i*cellSize, startY);
      ctx.lineTo(startX + i*cellSize, startY + k*cellSize);
    }
    // Horizontals
    for(let i=0; i<=k; i++){
      ctx.moveTo(startX, startY + i*cellSize);
      ctx.lineTo(startX + k*cellSize, startY + i*cellSize);
    }
    ctx.stroke();
  }
  
  // Update Info Text
  gInfo.innerHTML = `
    <span style="color:#94a3b8">Inner Square:</span> ${(k-1)}² = ${(k-1)**2} 
    <span style="color:#555; margin:0 6px">|</span>
    <span style="color:${isComp?'#f87171':'#4ade80'}">Gnomon:</span> ${n}
    <span style="color:#555; margin:0 6px">|</span>
    <span style="color:#e2e8f0">Total:</span> ${k}² = ${k*k}
  `;
}

// --- Init ---
el('btnRun').onclick = () => generate(parseInt(el('inpLimit').value));
el('btnExport').onclick = () => {
  // Simple CSV export
  let csv = "n,type,smallest_odd_factor\n";
  for(let i=1; i<=limit; i+=2){
    let t = smallestOddFactor[i]===0 ? (i===1?'unit':'prime') : 'composite';
    csv += `${i},${t},${smallestOddFactor[i]}\n`;
  }
  const b = new Blob([csv],{type:'text/csv'});
  const u = URL.createObjectURL(b);
  const a = document.createElement('a'); a.href=u; a.download='odd_composites.csv'; document.body.appendChild(a); a.click();
};

// Start
generate(401);

</script>
</body>
</html>
