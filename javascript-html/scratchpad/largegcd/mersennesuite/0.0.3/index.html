<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mersenne Deterministic Suite</title>
<script src="https://unpkg.com/big-integer@1.6.48/BigInteger.min.js"></script>
<!-- MathJax is required to render LaTeX math symbols correctly -->
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<style>
:root {
    --bg-color: #f3f4f6; --text-color: #1f2937; --card-bg: #fff; --header-color: #8b5cf6; 
    --llt-bg: #10b981; --eea-bg: #1d4ed8; --modpow-bg: #f59e0b; --log-bg: #e2e8f0; --progress-bg: #f59e0b;
}
body { font-family: system-ui, sans-serif; background: var(--bg-color); color: var(--text-color); display:flex; justify-content:center; align-items:center; min-height:100vh; flex-direction:column; padding:1rem; }
.container { max-width: 600px; width: 100%; background: var(--card-bg); border-radius: .75rem; box-shadow: 0 10px 20px rgba(0,0,0,.15); padding: 2rem; }
h2 { text-align:center; color: var(--header-color); margin-bottom: 2rem; font-size:1.75rem; font-weight:700; }
h3 { margin-top: 1.5rem; margin-bottom: 0.75rem; color:var(--text-color); border-bottom:1px solid #d1d5db; padding-bottom:.25rem; }
.input-group { display:flex; flex-direction:column; margin-bottom: 1rem; }
label { margin-bottom:.5rem; font-weight:600; }
input[type="text"] { padding:.75rem; border:1px solid #d1d5db; border-radius:.5rem; background:#f9fafb; font-size:1rem; }
.button-group { display:flex; flex-wrap:wrap; gap:.75rem; margin-top:1rem; }
button { padding:.75rem 1.25rem; border:none; border-radius:.5rem; color:#fff; font-weight:600; cursor:pointer; font-size: 0.9rem; transition: background-color 0.2s; }
button:disabled { background:#9ca3af; cursor:not-allowed; }

#runLltButton { background: var(--llt-bg); }
#runLltButton:hover:not(:disabled) { background: #059669; }
#calculateEeaButton { background: var(--eea-bg); }
#calculateEeaButton:hover:not(:disabled) { background: #1e40af; }
#runModPowButton { background: var(--modpow-bg); }
#runModPowButton:hover:not(:disabled) { background: #d97706; }

#progressBarContainer { width:100%; background:#e0e0e0; border-radius:.5rem; margin-top:1.5rem; overflow:hidden; }
#progressBar { height:25px; width:0%; background:var(--progress-bg); text-align:center; line-height:25px; color:white; font-weight:bold; transition: width .2s ease; }
#results { margin-top:1.5rem; font-weight:700; color:var(--header-color); font-size:1.1rem; }
#logOutput { width:100%; min-height:150px; overflow-y:auto; border:1px solid #d1d5db; background:var(--log-bg); padding:1rem; font-family: monospace; white-space:pre-wrap; margin-top:1rem; border-radius:.5rem; font-size: 0.85rem; }

.result-output { border: 1px solid #ccc; padding: 0.75rem; margin-top: 1rem; border-radius: 0.5rem; background: #fff; font-family: sans-serif; }
.result-output strong { color: var(--header-color); }
</style>
</head>
<body>
<div class="container">
    <h2>Karatsuba Deterministic Number Theory Suite</h2>

    <h3>Mersenne Input ($M_p = 2^p - 1$)</h3>
    <div class="input-group">
        <label for="exponentInput">Mersenne Exponent ($\mathbf{p}$)</label>
        <input type="text" id="exponentInput" value="127">
    </div>
    <div id="mpDigits" style="font-size: 0.9rem; margin-bottom: 1rem;">$M_p$ has 39 digits.</div>

    <hr>

    <h3>Lucas-Lehmer Primality Test</h3>
    <div class="button-group">
        <button id="runLltButton">Run LLT ($\mathbf{p}$ steps)</button>
    </div>
    <div id="lltResult" class="result-output" style="margin-top: 1.5rem;">Result: N/A</div>

    <hr>

    <h3>Extended Euclidean Algorithm ($\mathbf{ax + by = \text{GCD}(a, b)}$)</h3>
    <div class="input-group">
        <label for="numberAInput">Number A (or $\mathbf{M_p}$)</label>
        <input type="text" id="numberAInput" value="$M_p$">
    </div>
    <div class="input-group">
        <label for="numberBInput">Number B (or $\mathbf{M}$)</label>
        <input type="text" id="numberBInput" value="61">
    </div>
    <div class="button-group">
        <button id="calculateEeaButton">Calculate EEA</button>
    </div>
    <div id="eeaResult" class="result-output" style="margin-top: 1.5rem;">Result: N/A</div>

    <hr>

    <h3>Karatsuba Modular Exponentiation ($\mathbf{base^{\exp} \pmod{mod}}$)</h3>
    <div class="input-group">
        <label for="baseInput">Base</label>
        <input type="text" id="baseInput" value="2">
    </div>
    <div class="input-group">
        <label for="expInput">Exponent</label>
        <input type="text" id="expInput" value="127">
    </div>
    <div class="input-group">
        <label for="modulusInput">Modulus (or $\mathbf{M_p}$)</label>
        <input type="text" id="modulusInput" value="61">
    </div>
    <div class="button-group">
        <button id="runModPowButton">Calculate $\mathbf{Pow}$</button>
    </div>
    <div id="modPowResult" class="result-output" style="margin-top: 1.5rem;">Result: N/A</div>


    <div id="progressBarContainer"><div id="progressBar">0%</div></div>
    <div id="results">Status: Ready.</div>
    
    <h3>Process Log</h3>
    <pre id="logOutput">Log: Worker initialized. Ready for deterministic checks.</pre>
</div>

<script>
// --- GLOBAL STATE ---
let lltWorker = null;
let eeaWorker = null;
let modPowWorker = null;
let isCalculating = false;

const exponentInput = document.getElementById('exponentInput');
const numberAInput = document.getElementById('numberAInput');
const numberBInput = document.getElementById('numberBInput');
const runLltButton = document.getElementById('runLltButton');
const calculateEeaButton = document.getElementById('calculateEeaButton');
const runModPowButton = document.getElementById('runModPowButton');

// New Mod Pow Inputs
const baseInput = document.getElementById('baseInput');
const expInput = document.getElementById('expInput');
const modulusInput = document.getElementById('modulusInput');

const progressBar = document.getElementById('progressBar');
const resultsDiv = document.getElementById('results');
const logOutput = document.getElementById('logOutput');
const lltResultDiv = document.getElementById('lltResult');
const eeaResultDiv = document.getElementById('eeaResult');
const modPowResultDiv = document.getElementById('modPowResult');
const mpDigitsDiv = document.getElementById('mpDigits');

// --- UTILITY FUNCTIONS ---
function parseBigInt(str) {
    if (!str) return 0n;
    str = String(str).replace(/,/g, '').replace(/\s/g, '');
    try {
        // Handle $Mp$ placeholder: replace with calculated value
        if (str.toLowerCase() === '$m_p$') {
            const p = parseBigInt(exponentInput.value);
            return 2n ** p - 1n;
        }
        return BigInt(str);
    } catch (e) {
        return 0n;
    }
}
function log(msg) { logOutput.textContent += msg + '\n'; logOutput.scrollTop = logOutput.scrollHeight; }
function setStatus(t) { resultsDiv.textContent = 'Status: ' + t; }
function setProgress(p) {
    const percent = Math.min(100, Math.max(0, p)).toFixed(2);
    progressBar.style.width = percent + '%';
    progressBar.textContent = percent + '%';
}
function stopWorkers() {
    if (lltWorker) { lltWorker.terminate(); lltWorker = null; }
    if (eeaWorker) { eeaWorker.terminate(); eeaWorker = null; }
    if (modPowWorker) { modPowWorker.terminate(); modPowWorker = null; }
    isCalculating = false;
    runLltButton.disabled = false;
    calculateEeaButton.disabled = false;
    runModPowButton.disabled = false;
    setStatus('Stopped.');
    log('Worker terminated by user or finished.');
}
function updateMpDigits() {
    const p = parseBigInt(exponentInput.value);
    if (p < 2n) {
        mpDigitsDiv.textContent = "p must be prime > 1.";
    } else {
        const digits = (Number(p) * Math.log10(2)) + 1;
        mpDigitsDiv.textContent = `$M_p$ has ${Math.floor(digits)} digits.`;
    }
}

// --- LLT LOGIC ---
function startLlt() {
    stopWorkers();
    const pStr = exponentInput.value.trim();
    const p = parseBigInt(pStr);

    if (p <= 2n) { setStatus('Error: p must be > 2'); return; }
    if (p > 32000n) { setStatus('Error: p > 32000 is too large for current system limits.'); return; }

    lltResultDiv.textContent = 'Result: Testing...';
    logOutput.textContent = 'Log:\n';
    log(`--- Starting Lucas-Lehmer Test for M_${p} ---`);
    log(`Mersenne number M_p has ${Math.floor(Number(p) * Math.log10(2))} digits. Sequence length: ${p - 2n} steps.`);

    isCalculating = true;
    runLltButton.disabled = true;
    calculateEeaButton.disabled = true;
    runModPowButton.disabled = true;
    setStatus('Calculating...');
    setProgress(0);

    lltWorker = new Worker('ll_test_worker.js'); 

    lltWorker.onmessage = (e) => {
        const data = e.data;
        if (data.type === 'progress') {
            setStatus(`LLT progress: ${data.progress.toFixed(2)}%`);
            setProgress(data.progress);
        } else if (data.type === 'result') {
            if (data.isPrime) {
                log(`M${pStr} is PRIME! Final S = 0.`);
                lltResultDiv.innerHTML = `Result: $\mathbf{M_{${pStr}}}$ is **PRIME!** (Final S $\mathbf{=}$ 0)`;
            } else {
                log(`M${pStr} is COMPOSITE. (Final S $\\neq$ 0)`);
                lltResultDiv.innerHTML = `Result: $\mathbf{M_{${pStr}}}$ is **COMPOSITE** (Final S $\mathbf{\\neq}$ 0)`;
            }
            // Trigger MathJax re-render for the final result display
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, lltResultDiv]);
            
            setStatus('LLT check complete.');
            stopWorkers();
        } else if (data.type === 'error') {
            log(`Critical Error: ${data.message}`);
            setStatus('Critical Error: Check log for details.');
            stopWorkers();
        }
    };
    lltWorker.onerror = (e) => { log(`Worker Error: ${e.message}`); setStatus('Worker Error'); stopWorkers(); };

    lltWorker.postMessage({ p: pStr });
}

// --- EEA LOGIC ---
function startEea() {
    stopWorkers();
    const aStr = numberAInput.value.trim();
    const bStr = numberBInput.value.trim();

    const aBig = parseBigInt(aStr);
    const bBig = parseBigInt(bStr);

    if (aBig === 0n || bBig === 0n) { setStatus('Error: Numbers A and B must be non-zero.'); return; }

    const labelA = aStr;
    const labelB = bStr;

    eeaResultDiv.textContent = 'Result: Testing...';
    logOutput.textContent = 'Log:\n';
    log(`--- Starting Extended Euclidean Algorithm ---`);
    log(`Finding x, y for: ${labelA} (x) + ${labelB} (y) = GCD`);

    isCalculating = true;
    runLltButton.disabled = true;
    calculateEeaButton.disabled = true;
    runModPowButton.disabled = true;
    setStatus('Calculating EEA...');
    setProgress(0);

    eeaWorker = new Worker('eea_worker.js');

    eeaWorker.onmessage = (e) => {
        const data = e.data;
        if (data.type === 'log') {
            log(data.message);
        } else if (data.type === 'progress') {
             setProgress(data.progress);
        } else if (data.type === 'result') {
            const g = data.g;
            const x = data.x;
            const y = data.y;

            // Use MathJax for rendering
            eeaResultDiv.innerHTML = `
                $$\\mathbf{\\text{GCD}}(${labelA}, ${labelB}) = ${g}$$
                $$\\mathbf{${labelA}}x + \\mathbf{${labelB}}y = ${g}$$
                $$\\mathbf{x} = ${x}$$
                $$\\mathbf{y} = ${y}$$
            `;
            // Trigger MathJax re-render
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, eeaResultDiv]);

            log(`EEA complete. GCD=${g}. Steps: ${data.steps}.`);
            if (g === '1') {
                log(`Modular Inverse Found: x = ${x} is the inverse of ${labelA} mod ${labelB}`);
            }
            setStatus('EEA calculation complete.');
            stopWorkers();
        } else if (data.type === 'error') {
            log(`Critical Error: ${data.message}`);
            setStatus('Critical Error: Check log for details.');
            stopWorkers();
        }
    };
    eeaWorker.onerror = (e) => { log(`Worker Error: ${e.message}`); setStatus('Worker Error'); stopWorkers(); };

    eeaWorker.postMessage({ a: aBig.toString(), b: bBig.toString(), labelA: labelA, labelB: labelB });
}

// --- MOD POW LOGIC ---
function startModPow() {
    stopWorkers();
    const baseStr = baseInput.value.trim();
    const expStr = expInput.value.trim();
    const modStr = modulusInput.value.trim();

    const baseBig = parseBigInt(baseStr);
    const expBig = parseBigInt(expStr);
    const modBig = parseBigInt(modStr);

    if (modBig <= 1n) { setStatus('Error: Modulus must be > 1.'); return; }
    if (expBig < 0n) { setStatus('Error: Exponent must be non-negative.'); return; }

    modPowResultDiv.textContent = 'Result: Calculating...';
    logOutput.textContent = 'Log:\n';
    log(`--- Starting Modular Exponentiation (Karatsuba Pow) ---`);
    log(`Calculating ${baseStr}^${expStr} mod ${modStr}...`);

    isCalculating = true;
    runLltButton.disabled = true;
    calculateEeaButton.disabled = true;
    runModPowButton.disabled = true;
    setStatus('Calculating Modular Pow...');
    setProgress(0);

    modPowWorker = new Worker('mod_pow_worker.js');

    modPowWorker.onmessage = (e) => {
        const data = e.data;
        if (data.type === 'progress') {
            setStatus(`Modular Pow progress: ${data.progress.toFixed(2)}%`);
            setProgress(data.progress);
        } else if (data.type === 'result') {
            const result = data.result;
            modPowResultDiv.innerHTML = `
                $$\\mathbf{${baseStr}^{${expStr}} \\pmod{${modStr}}} = \\mathbf{${result}}$$
            `;
            // Trigger MathJax re-render
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, modPowResultDiv]);

            log(`Modular Pow complete. Result: ${result}`);
            setStatus('Modular Pow calculation complete.');
            stopWorkers();
        } else if (data.type === 'error') {
            log(`Critical Error: ${data.message}`);
            setStatus('Critical Error: Check log for details.');
            stopWorkers();
        }
    };
    modPowWorker.onerror = (e) => { log(`Worker Error: ${e.message}`); setStatus('Worker Error'); stopWorkers(); };

    modPowWorker.postMessage({ 
        base: baseBig.toString(), 
        exp: expBig.toString(), 
        mod: modBig.toString() 
    });
}

// --- INITIALIZATION ---
window.onload = function() {
    runLltButton.addEventListener('click', startLlt);
    calculateEeaButton.addEventListener('click', startEea);
    runModPowButton.addEventListener('click', startModPow);
    
    exponentInput.addEventListener('input', updateMpDigits);
    
    updateMpDigits();
    
    logOutput.textContent = 'Log: Worker initialized. Ready for deterministic checks.\n';
};
</script>
</body>
</html>
