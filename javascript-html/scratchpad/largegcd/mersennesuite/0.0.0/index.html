<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Karatsuba Deterministic Number Theory Suite</title>
<script src="https://unpkg.com/big-integer@1.6.48/BigInteger.min.js"></script>
<style>
:root { 
    --bg-color: #f3f4f6; --text-color: #1f2937; --card-bg: #fff; --gcd-bg: #1d4ed8; --gcd-hover: #1e40af;
    --llt-bg: #10b981; --llt-hover: #059669; --header-color: #0d9488; --log-bg: #e2e8f0; 
    --progress-bg: #22c34d; --error-color: #dc2626;
}
body { font-family: system-ui, sans-serif; background: var(--bg-color); color: var(--text-color); padding: 1rem; display: flex; justify-content: center; }
.container { max-width: 900px; width: 100%; background: var(--card-bg); border-radius: .5rem; box-shadow: 0 10px 15px rgba(0,0,0,.1); padding: 2rem; }
h2 { text-align:center; color: var(--header-color); margin-bottom: 2rem; font-size:1.8rem; font-weight:700; }
h3 { margin-top: 1.5rem; margin-bottom: 0.75rem; color: var(--card-text); border-bottom: 2px solid #e5e7eb; padding-bottom: 0.4rem; font-size: 1.2rem; }
.grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
.input-group { display:flex; flex-direction:column; }
label { margin-bottom: 0.4rem; font-weight: 600; font-size: 0.95rem; }
input[type="text"] { padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 0.3rem; background: #f9fafb; font-size: 1rem; }
button { padding: 0.75rem 1.25rem; border:none; border-radius: 0.3rem; color:#fff; font-weight:600; cursor:pointer; font-size: 0.95rem; transition: background-color 0.2s; margin-top: 1rem; }
button:disabled { background: #9ca3af; cursor: not-allowed; }
#logOutput { min-height: 200px; max-height: 400px; overflow-y: auto; border: 1px solid #d1d5db; background: var(--log-bg); padding: 1rem; font-family: monospace; white-space: pre-wrap; margin-top: 1rem; border-radius: 0.3rem; font-size: 0.85rem; }
#progressBarContainer { width:100%; background:#e0e0e0; border-radius:0.3rem; margin-top:1.5rem; overflow:hidden; }
#progressBar { height:25px; width:0%; background:var(--progress-bg); text-align:center; line-height:25px; color:white; font-weight:bold; transition: width 0.3s; }
.llt-button { background-color: var(--llt-bg); }
.llt-button:hover:not(:disabled) { background-color: var(--llt-hover); }
.gcd-button { background-color: var(--gcd-bg); }
.gcd-button:hover:not(:disabled) { background-color: var(--gcd-hover); }
.section-divider { margin: 2rem 0; border: none; border-top: 1px dashed #ccc; }
.result-box { margin-top: 1rem; padding: 1rem; border-radius: 0.3rem; background-color: #e0f2f1; color: #0f766e; font-weight: bold; }
.error-box { background-color: #fee2e2; color: var(--error-color); font-weight: bold; }
</style>
</head>
<body>
<div class="container">
    <h2>Karatsuba Deterministic Number Theory Suite</h2>
    <p style="text-align: center; color: #4b5563;">GCD uses $O(L^{1.58})$ multiplication. LLT uses the deterministic sequence check.</p>

    <!-- Global Input Section -->
    <h3>Number Components ($\mathbf{N = a^b + c}$ or $\mathbf{M_p = 2^p - 1}$)</h3>
    <div class="grid">
        <div class="input-group">
            <label for="baseInput">Base (a)</label>
            <input type="text" id="baseInput" value="10">
        </div>
        <div class="input-group">
            <label for="exponentInput">Exponent (b)</label>
            <input type="text" id="exponentInput" value="20000">
        </div>
        <div class="input-group">
            <label for="addendInput">Addend (c)</label>
            <input type="text" id="addendInput" value="1">
        </div>
    </div>
    <hr class="section-divider">

    <!-- GCD SECTION -->
    <h3>Fast Euclidean GCD ($\mathbf{GCD(N_1, N_2)}$)</h3>
    <p style="font-size: 0.85rem; color: #6b7280;">Uses Karatsuba Long Division for logarithmic speed.</p>
    <div class="grid">
        <div class="input-group">
            <label for="baseInput2">Base (aâ‚‚)</label>
            <input type="text" id="baseInput2" value="10">
        </div>
        <div class="input-group">
            <label for="exponentInput2">Exponent (bâ‚‚)</label>
            <input type="text" id="exponentInput2" value="20000">
        </div>
        <div class="input-group">
            <label for="addendInput2">Addend (câ‚‚)</label>
            <input type="text" id="addendInput2" value="3">
        </div>
        <button id="gcdButton" class="gcd-button">Calculate GCD</button>
    </div>
    <div id="gcdResult" class="result-box" style="display: none;"></div>
    <hr class="section-divider">

    <!-- LLT SECTION -->
    <h3>Lucas-Lehmer Primality Test ($\mathbf{M_p = 2^p - 1}$)</h3>
    <p style="font-size: 0.85rem; color: #6b7280;">Uses the deterministic sequence check. Enter $\mathbf{p}$ (a prime exponent) below.</p>
    <div class="grid">
        <div class="input-group">
            <label for="pInput">Mersenne Exponent (p)</label>
            <input type="text" id="pInput" value="127">
        </div>
        <button id="lltButton" class="llt-button">Run LLT ($\mathbf{p}$ steps)</button>
    </div>
    <div id="lltModulusDisplay" style="margin-top: 10px; font-size: 0.85rem; color: #4b5563;"></div>
    <div id="lltResult" class="result-box" style="display: none;"></div>
    <hr class="section-divider">
    
    <!-- Shared Controls and Output -->
    <h3>Process Output</h3>
    <div id="progressBarContainer">
        <div id="progressBar">0%</div>
    </div>
    <div id="statusDiv" class="result-box" style="display: block; background-color: #e5e7eb; color: #374151;">Status: Ready.</div>
    <button id="stopButton" disabled>Stop Worker</button>
    
    <h3>Log</h3>
    <pre id="logOutput">Log: Initializing Karatsuba Worker...</pre>
</div>

<script>
// --- GLOBAL STATE & CONFIGURATION ---
const chunk_size = 9; 
const EXPONENT_LIMIT = 32000; 

let worker = null;
let currentMode = null; // 'GCD' or 'LLT'

// --- UI Elements ---
const baseInput = document.getElementById('baseInput');
const exponentInput = document.getElementById('exponentInput');
const addendInput = document.getElementById('addendInput');
const baseInput2 = document.getElementById('baseInput2');
const exponentInput2 = document.getElementById('exponentInput2');
const addendInput2 = document.getElementById('addendInput2');
const pInput = document.getElementById('pInput');

const gcdButton = document.getElementById('gcdButton');
const lltButton = document.getElementById('lltButton');
const stopButton = document.getElementById('stopButton');

const gcdResult = document.getElementById('gcdResult');
const lltResult = document.getElementById('lltResult');
const lltModulusDisplay = document.getElementById('lltModulusDisplay');
const logOutput = document.getElementById('logOutput');
const progressBar = document.getElementById('progressBar');
const statusDiv = document.getElementById('statusDiv');

// Assuming worker is in the same directory
const llWorkerPath = 'll_test_worker.js'; 
const gcdWorkerPath = 'gcd_worker.js'; // Assuming you have the Karatsuba GCD worker

// --- Utility Functions ---
function log(msg) {
    logOutput.textContent += msg + '\n';
    logOutput.scrollTop = logOutput.scrollHeight;
}
function setStatus(t, isError = false) {
    statusDiv.textContent = 'Status: ' + t;
    if (isError) {
        statusDiv.classList.add('error-box');
        statusDiv.classList.remove('result-box');
    } else {
        statusDiv.classList.remove('error-box');
        statusDiv.classList.add('result-box');
        statusDiv.style.backgroundColor = '#e5e7eb';
        statusDiv.style.color = '#374151';
    }
}
function setProgress(p) {
    const percent = Math.min(100, Math.max(0, p)).toFixed(2);
    progressBar.style.width = percent + '%';
    progressBar.textContent = percent + '%';
}
function parseBigInt(str) {
    if (!str) return 0n;
    str = String(str).replace(/,/g, '').replace(/\s/g, '');
    if (str.includes('e') || str.includes('E')) {
        const parts = str.toLowerCase().split('e');
        return BigInt(parts[0]) * 10n ** BigInt(parts[1]);
    }
    return BigInt(str);
}
function resetUI() {
    gcdButton.disabled = false;
    lltButton.disabled = false;
    stopButton.disabled = true;
    currentMode = null;
    setProgress(0);
}
function disableControls(mode) {
    gcdButton.disabled = true;
    lltButton.disabled = true;
    stopButton.disabled = false;
    currentMode = mode;
    gcdResult.style.display = 'none';
    lltResult.style.display = 'none';
    lltModulusDisplay.innerHTML = '';
    logOutput.textContent = '';
    setStatus('Worker started.', false);
}

// --- Worker Handler ---
function handleWorkerMessage(e) {
    const data = e.data;

    if (data.type === 'progress') {
        const stepInfo = data.step ? ` (Step ${data.step}/${data.totalSteps})` : '';
        const modeLabel = currentMode === 'LLT' ? 'LLT Sequence' : 'GCD Calc';
        setStatus(`${modeLabel} running... ${data.value.toFixed(2)}%${stepInfo}`);
        setProgress(data.value);
    } else if (data.type === 'log') {
        log(data.message);
    } else if (data.type === 'error') {
        setStatus(`Critical Error: ${data.message}`, true);
        log(`[ERROR] ${data.message}`);
        stopWorker();
    } else if (data.type === 'result') {
        if (currentMode === 'GCD') {
            gcdResult.textContent = `GCD Result: ${data.gcd.toLocaleString()}`;
            gcdResult.style.display = 'block';
            setStatus('GCD calculation complete.');
        } else if (currentMode === 'LLT') {
            lltResult.textContent = data.isPrime ? 
                `M${data.p} is PRIME! ðŸŽ‰ (Final S = 0)` : 
                `M${data.p} is COMPOSITE. (Final S $\\neq$ 0)`;
            lltResult.style.display = 'block';
            lltResult.style.backgroundColor = data.isPrime ? '#d1fae5' : '#fee2e2';
            lltResult.style.color = data.isPrime ? '#065f46' : '#991b1b';
            setStatus('LLT check complete.');
        }
        stopWorker();
    } else if (data.type === 'modulus') {
        lltModulusDisplay.innerHTML = `M<sub>p</sub> has ${data.digits.toLocaleString()} digits. <br>M<sub>p</sub> (approx): ${data.Mp.slice(0, 50)}...`;
        log(`Mersenne number M_p has ${data.digits.toLocaleString()} digits. Sequence length: ${data.p - 2} steps.`);
    }
}

function startWorker(workerPath, mode, data) {
    stopWorker(); // Ensure previous worker is terminated
    disableControls(mode);

    // This is the simplest way to get the GCD worker path if you kept its name
    const path = mode === 'LLT' ? llWorkerPath : gcdWorkerPath; 
    
    worker = new Worker(path);
    worker.onmessage = handleWorkerMessage;
    worker.onerror = (e) => {
        setStatus(`Worker failed to load: ${e.message}`, true);
        log(`[CRITICAL ERROR] Worker failed to load: ${e.message}`);
        stopWorker();
    };
    
    worker.postMessage(data);
}

function stopWorker() {
    if (worker) {
        worker.terminate();
        worker = null;
        log('Worker terminated by user or finished.');
    }
    resetUI();
}

// --- Event Handlers ---
lltButton.addEventListener('click', () => {
    const p = pInput.value;
    if (!p || parseBigInt(p) < 3n || parseBigInt(p) > BigInt(EXPONENT_LIMIT)) {
        setStatus(`Error: p must be between 3 and ${EXPONENT_LIMIT}.`, true);
        return;
    }
    // We pass p as a string, let the worker handle conversion
    startWorker(llWorkerPath, 'LLT', { mode: 'LLT', p: p });
});

gcdButton.addEventListener('click', () => {
    const data = {
        mode: 'GCD',
        a1: baseInput.value, b1: exponentInput.value, c1: addendInput.value,
        a2: baseInput2.value, b2: exponentInput2.value, c2: addendInput2.value
    };
    // Note: Assuming your Karatsuba GCD worker is named 'gcd_worker.js'
    startWorker(gcdWorkerPath, 'GCD', data); 
});

stopButton.addEventListener('click', stopWorker);

// --- Initialization ---
window.onload = function() {
    log('Karatsuba Number Theory Suite ready.');
    // Check if the GCD worker file path is valid here if possible, but proceed anyway.
};
</script>
</body>
</html>

