<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Odd Composite Engine — Gnomon Factor Overlays</title>
<style>
  :root{
    --bg:#0b1220; --panel:#071025; --muted:#94a3b8; --accent:#f6c84c;
    --prime:#0b5f3b; --comp:#5a1212; --cell:#111827; --glass: rgba(255,255,255,0.03);
    --overlay-row: rgba(96,165,250,0.14);  /* bluish */
    --overlay-col: rgba(250,202,21,0.12);  /* yellowish */
    --overlay-cross: rgba(236,72,153,0.14); /* magenta cross if both */
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#020617);color:#e6eef6;font-family:Inter,ui-sans-serif,system-ui,monospace}
  .wrap{max-width:1200px;margin:18px auto;padding:16px;display:flex;flex-direction:column;gap:14px}
  header{display:flex;align-items:center;gap:12px}
  h1{margin:0;font-size:1.1rem;color:#9ad0ff}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type=number]{width:120px;padding:8px;border-radius:6px;border:1px solid #223046;background:var(--panel);color:#e6eef6}
  button{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:white;cursor:pointer}
  button.secondary{background:#334155}
  .layout{display:grid;grid-template-columns:2fr 1fr;gap:12px;height:68vh}
  .panel{background:var(--panel);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.6);overflow:auto}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(56px,1fr));gap:8px;padding:8px}
  .cell{background:var(--cell);padding:10px;border-radius:8px;text-align:center;cursor:pointer;user-select:none;border:1px solid transparent;transition:all .12s}
  .cell.small{padding:6px;font-size:0.85rem}
  .cell.prime{background:var(--prime);color:#d8fbe1;border-color:#059669}
  .cell.comp{background:var(--comp);color:#ffd7d7;border-color:#7f1d1d}
  .cell.selected{outline:3px solid rgba(246,200,76,0.15);transform:scale(1.03)}
  .info{display:flex;flex-direction:column;gap:8px}
  .info-row{display:flex;justify-content:space-between;gap:8px}
  .small-muted{color:var(--muted);font-size:0.86rem}
  .chains{display:flex;flex-direction:column;gap:6px;padding:6px}
  .chain-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{background:var(--glass);padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);font-size:0.88rem}
  footer{font-size:0.82rem;color:var(--muted);display:flex;justify-content:space-between;gap:12px;align-items:center}
  /* GNOMON GRID */
  .gnomon-grid { display:grid; gap:2px; justify-content:center; align-items:center; }
  .dot { width:14px; height:14px; background:#1e293b; border-radius:3px; transition:0.12s; box-sizing:border-box; }
  .dot.inner { background:#111827; opacity:0.32; }
  .dot.arm { background:#64748b; }
  .dot.corner { background:#facc15; box-shadow:0 0 6px #facc15aa; }
  .dot.selected { outline:2px solid rgba(255,255,255,0.06); transform:scale(1.2); }
  .dot:hover { transform:scale(1.25); outline:2px solid rgba(246,200,76,0.12); z-index:10; }
  /* overlays on dots */
  .dot.row-highlight { background: var(--overlay-row); }
  .dot.col-highlight { background: var(--overlay-col); }
  .dot.cross-highlight { background: var(--overlay-cross); }
  /* legend */
  .legend { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
  .legend .key { display:inline-flex; gap:6px; align-items:center; padding:6px 8px; border-radius:6px; background:rgba(255,255,255,0.02); font-size:0.85rem; }
  .legend .sw { width:14px; height:14px; border-radius:3px; display:inline-block; }
  .sw.row { background:var(--overlay-row) } .sw.col { background:var(--overlay-col) } .sw.cross { background:var(--overlay-cross) }
  @media (max-width:900px){.layout{grid-template-columns:1fr;height:62vh}.grid{grid-template-columns:repeat(auto-fill,minmax(44px,1fr))}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Odd Composite Engine — Gnomon Factor Overlays</h1>
    <div style="flex:1"></div>
    <div class="controls">
      <label class="small-muted">Max odd number</label>
      <input id="inpLimit" type="number" min="11" step="2" value="2001"/>
      <button id="btnRun">Generate</button>
      <button id="btnChains" class="secondary">Show chains</button>
      <button id="btnExport" class="secondary">Export CSV</button>
    </div>
  </header>

  <div class="layout">
    <!-- Left: Grid -->
    <div class="panel" id="leftPanel">
      <div class="small-muted" id="summary">Ready.</div>
      <div id="grid" class="grid" style="margin-top:8px"></div>
    </div>

    <!-- Right: Info -->
    <div class="panel info" id="rightPanel">
      <div>
        <div class="small-muted">Selected</div>
        <div id="selNum" style="font-size:1.4rem;font-weight:700;margin-top:6px">—</div>
        <div id="selType" class="small-muted" style="margin-top:4px">—</div>
      </div>

      <div>
        <div class="small-muted">Factorization</div>
        <div id="factors" style="margin-top:6px">Click a number to inspect factors.</div>
      </div>

      <div>
        <div class="small-muted">Nearest composite walls</div>
        <div id="walls" style="margin-top:6px">—</div>
      </div>

      <div>
        <div class="small-muted">Gnomon (odd number geometry)</div>
        <div id="gnomonInfo" style="margin-top:6px">—</div>

        <div id="gnomonCanvas"
             style="margin-top:10px;width:100%;min-height:160px;max-height:320px;overflow:auto;background:#0b1220;border:1px solid #1e293b;border-radius:8px;padding:10px;display:flex;justify-content:center;align-items:center;">
        </div>

        <div class="legend" id="gnomonLegend" style="display:none">
          <div class="key"><span class="sw row"></span> Row highlight (factor a)</div>
          <div class="key"><span class="sw col"></span> Column highlight (factor b)</div>
          <div class="key"><span class="sw cross"></span> Cross (a==b)</div>
        </div>
      </div>

      <div>
        <div class="small-muted">Chains preview (roots → projections)</div>
        <div class="chains" id="chainsBox"></div>
      </div>
    </div>
  </div>

  <footer>
    <div>Engine: iterate odd factors a=3..√N step 2, b=a..N/a step 2 — mark composites once.</div>
    <div id="perf" class="small-muted">—</div>
  </footer>
</div>

<script>
/* Odd Composite Engine with Gnomon overlays
   - Generates odd composites by iterating odd factor pairs (a*b).
   - smallestOddFactor[n] stores the smallest odd factor >=3 found.
   - On selection, we list all odd factor pairs and overlay their indices
     onto the k×k gnomon by mapping odd -> index = (odd+1)/2.
*/

const el = id => document.getElementById(id);
const gridEl = el('grid'), summaryEl = el('summary'), selNumEl = el('selNum'),
      selTypeEl = el('selType'), factorsEl = el('factors'), wallsEl = el('walls'),
      gnomonInfoEl = el('gnomonInfo'), gnomonCanvas = el('gnomonCanvas'),
      chainsBox = el('chainsBox'), perfEl = el('perf'), legendEl = el('gnomonLegend');

let limit = 2001;
let smallestOddFactor = null;  // Int32Array
let oddList = [];
let selected = null;
let chainsCache = [];

function makeArrays(maxN){
  smallestOddFactor = new Int32Array(maxN + 1);
}

function generate(limitVal){
  const t0 = performance.now();
  limit = Math.floor(limitVal);
  if (limit % 2 === 0) limit--;
  makeArrays(limit);
  oddList = [];
  for (let i = 1; i <= limit; i += 2) oddList.push(i);

  const maxA = Math.floor(Math.sqrt(limit));
  for (let a = 3; a <= maxA; a += 2) {
    for (let b = a; ; b += 2) {
      const prod = a * b;
      if (prod > limit) break;
      if (smallestOddFactor[prod] === 0) smallestOddFactor[prod] = a;
    }
  }

  // chains cache (3-line roots)
  chainsCache = [];
  for (let m = 3; m <= limit; m += 2) {
    const val = 3 * m;
    if (val > limit) break;
    let A = 3, B = m;
    const row = [];
    while (A * B <= limit) {
      row.push([A,B,A*B]);
      A += 2; B += 2;
    }
    if (row.length) chainsCache.push(row);
  }

  const t1 = performance.now();
  renderGrid();
  summaryEl.textContent = `Generated up to ${limit}. Odd entries: ${oddList.length}. Composites marked: ${countComposites()}. Took ${(t1-t0).toFixed(1)} ms.`;
  perfEl.textContent = `√limit ≈ ${Math.floor(Math.sqrt(limit))}. Chains: ${chainsCache.length}`;
}

function countComposites(){
  let c = 0;
  for (let i = 3; i <= limit; i += 2) if (smallestOddFactor[i] !== 0) c++;
  return c;
}

function renderGrid(){
  gridEl.innerHTML = '';
  const small = limit > 400;
  for (let i = 1; i <= limit; i += 2){
    const div = document.createElement('div');
    div.className = 'cell' + (small ? ' small' : '');
    div.innerText = i;
    div.dataset.val = i;
    if (i === 1) {
      div.classList.add('prime');
      div.title = '1 (unit)';
    } else if (smallestOddFactor[i] === 0) {
      div.classList.add('prime');
      div.title = 'Prime (no odd factor recorded)';
    } else {
      div.classList.add('comp');
      const a = smallestOddFactor[i];
      const b = i / a;
      div.title = `Composite: ${a} × ${b}`;
    }

    div.onclick = () => selectNumber(i, div);
    gridEl.appendChild(div);
  }
}

function listOddFactorPairs(n){
  // returns array of [a,b] with odd a<=b and a*b == n, excluding a==1
  const pairs = [];
  if (n === 1) return pairs;
  // iterate odd a from 3..sqrt(n)
  const s = Math.floor(Math.sqrt(n));
  for (let a = 3; a <= s; a += 2) {
    if (n % a === 0) {
      const b = n / a;
      if (b % 2 === 1) pairs.push([a, b]);
    }
  }
  // if n itself is odd and >1, we might want to include 1×n? Skip 1 by design.
  return pairs;
}

function selectNumber(n, domEl){
  const prev = document.querySelector('.cell.selected');
  if (prev) prev.classList.remove('selected');
  if (domEl) domEl.classList.add('selected');
  selected = n;
  selNumEl.innerText = n;
  const sf = smallestOddFactor[n];
  if (n === 1) {
    selTypeEl.innerText = 'Unit (1)';
    factorsEl.innerHTML = '1 has no nontrivial odd factors.';
  } else if (sf === 0) {
    selTypeEl.innerText = 'Prime';
    factorsEl.innerHTML = `<div class="small-muted">No odd factor recorded (prime)</div>`;
  } else {
    selTypeEl.innerText = 'Composite';
    const pairs = listOddFactorPairs(n);
    // If smallestOddFactor present but list is empty, still include that factor
    if (pairs.length === 0 && sf !== 0) {
      pairs.push([sf, n / sf]);
    }
    const html = pairs.map(p => `<div class="chip">${p[0]} × ${p[1]} = ${n}</div>`).join(' ');
    factorsEl.innerHTML = html;
  }

  // walls
  let lower = null, upper = null;
  for (let x = n - 2; x >= 3; x -= 2) {
    if (smallestOddFactor[x] !== 0) { lower = x; break; }
  }
  for (let x = n + 2; x <= limit; x += 2) {
    if (smallestOddFactor[x] !== 0) { upper = x; break; }
  }
  wallsEl.innerHTML = `<div class="small-muted">Lower:</div> ${lower ?? 'none'} ${lower ? `<span class="small-muted">(${smallestOddFactor[lower]}×${lower/smallestOddFactor[lower]})</span>` : ''}` +
                      `<br><div class="small-muted">Upper:</div> ${upper ?? 'none'} ${upper ? `<span class="small-muted">(${smallestOddFactor[upper]}×${upper/smallestOddFactor[upper]})</span>` : ''}` +
                      `<br><div class="small-muted">Gap size:</div> ${ (lower && upper) ? (upper-lower) : '—' }`;

  // Render gnomon + overlays
  renderGnomon(n);
}

function renderGnomon(n){
  // prepares the k×k grid and overlays lines for every odd factor pair (a,b)
  gnomonCanvas.innerHTML = '';
  legendEl.style.display = 'none';

  // Safety
  if (n > 3001) {
    gnomonInfoEl.innerHTML = `Side length ≈ ${(n+1)/2}. Too large to draw here (use ≤3001).`;
    gnomonCanvas.innerHTML = `<div class="small-muted" style="padding:20px;text-align:center;">Gnomon too large to visualize. Try a smaller number.</div>`;
    return;
  }

  const k = (n + 1) / 2;
  const inner = k - 1;
  gnomonInfoEl.innerHTML = `Side length = ${k}, wraps ${(k-1)}² square`;

  // Build factor pair list (odd factors)
  const pairs = listOddFactorPairs(n);

  // If none found (prime), still draw the gnomon but no overlays
  // Map odd -> idx = (odd + 1)/2
  const rowIdxs = new Set();
  const colIdxs = new Set();
  for (const [a,b] of pairs) {
    const ia = (a + 1) / 2;
    const ib = (b + 1) / 2;
    if (Number.isInteger(ia) && ia >= 1 && ia <= k) rowIdxs.add(ia-1);
    if (Number.isInteger(ib) && ib >= 1 && ib <= k) colIdxs.add(ib-1);
  }

  // If we have overlays show legend
  if (rowIdxs.size || colIdxs.size) legendEl.style.display = 'flex';

  // Create grid
  const grid = document.createElement('div');
  grid.className = 'gnomon-grid';
  grid.style.gridTemplateColumns = `repeat(${k}, 14px)`;
  grid.style.padding = '6px';

  for (let r = 0; r < k; r++) {
    for (let c = 0; c < k; c++) {
      const dot = document.createElement('div');
      dot.className = 'dot';
      const bottomRow = (r === k - 1);
      const rightCol = (c === k - 1);
      const corner = (r === k - 1 && c === k - 1);

      if (corner) dot.classList.add('corner');
      else if (bottomRow || rightCol) dot.classList.add('arm');
      else dot.classList.add('inner');

      // overlay highlights
      const isRow = rowIdxs.has(r);
      const isCol = colIdxs.has(c);
      if (isRow && isCol) dot.classList.add('cross-highlight');
      else if (isRow) dot.classList.add('row-highlight');
      else if (isCol) dot.classList.add('col-highlight');

      // tooltip: display coordinates and whether it's part of an overlay
      let title = `(${r+1}, ${c+1})`;
      if (isRow || isCol) title += ' — factor line';
      if (corner) title += ' — corner pivot';
      dot.title = title;

      // click highlight toggles
      dot.onclick = () => {
        const prev = grid.querySelector('.dot.selected');
        if (prev) prev.classList.remove('selected');
        dot.classList.add('selected');
      };

      grid.appendChild(dot);
    }
  }

  // Factor legend area (list pairs)
  const pairLegend = document.createElement('div');
  pairLegend.style.marginTop = '8px';
  pairLegend.style.display = 'flex';
  pairLegend.style.flexDirection = 'column';
  pairLegend.style.gap = '6px';
  pairLegend.style.alignItems = 'center';

  if (pairs.length === 0) {
    const p = document.createElement('div');
    p.className = 'small-muted';
    p.innerText = 'No odd factor pairs found (prime or unit).';
    pairLegend.appendChild(p);
  } else {
    // show each pair and a mini indicator
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.gap = '6px';
    row.style.flexWrap = 'wrap';
    for (const [a,b] of pairs) {
      const btn = document.createElement('div');
      btn.className = 'chip';
      const ia = (a+1)/2, ib = (b+1)/2;
      btn.innerText = `${a}×${b} = ${n}  (r=${ia}, c=${ib})`;
      // clicking the chip scrolls and highlights the corresponding dot in the grid (intersection)
      btn.onclick = () => {
        // compute target position r=ia-1, c=ib-1 and select that dot
        const rIdx = ia-1, cIdx = ib-1;
        const idx = rIdx * k + cIdx; // linear index in grid children
        const target = grid.children[idx];
        if (target) {
          target.scrollIntoView({behavior:'smooth', block:'center'});
          target.click();
        }
      };
      row.appendChild(btn);
    }
    pairLegend.appendChild(row);
  }

  // Attach grid + legend
  gnomonCanvas.appendChild(grid);
  gnomonCanvas.appendChild(pairLegend);
}

function showChains(){
  chainsBox.innerHTML = '';
  const maxShow = Math.min(chainsCache.length, 60);
  for (let i = 0; i < maxShow; i++){
    const row = chainsCache[i];
    const rowEl = document.createElement('div');
    rowEl.className = 'chain-row';
    for (let j = 0; j < row.length; j++){
      const [A,B,val] = row[j];
      const elChip = document.createElement('div');
      elChip.className = 'chip';
      elChip.innerText = `${A}×${B}=${val}`;
      elChip.onclick = () => {
        const cell = document.querySelector(`.cell[data-val='${val}']`);
        if (cell) {
          cell.scrollIntoView({behavior:'smooth',block:'center'});
          cell.click();
        }
      };
      rowEl.appendChild(elChip);
      if (j < row.length-1){
        const arrow = document.createElement('div');
        arrow.className = 'small-muted';
        arrow.style.alignSelf='center';
        arrow.style.padding='0 6px';
        arrow.innerText = '→';
        rowEl.appendChild(arrow);
      }
    }
    chainsBox.appendChild(rowEl);
  }
  if (chainsCache.length > 60){
    const more = document.createElement('div'); more.className='small-muted'; more.innerText = `... ${chainsCache.length - 60} more chains hidden`;
    chainsBox.appendChild(more);
  }
}

function exportCSV(){
  let csv = 'n,isComposite,smallestOddFactor\n';
  for (let i=1;i<=limit;i+=2){
    const f = smallestOddFactor[i] || '';
    csv += `${i},${f?1:0},${f}\n`;
  }
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = `odd-composites-to-${limit}.csv`; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

// Attach UI
el('btnRun').onclick = () => {
  const v = parseInt(el('inpLimit').value) || 2001;
  if (v < 11) { alert('Pick a higher odd limit (≥11)'); return; }
  generate(v);
};
el('btnChains').onclick = showChains;
el('btnExport').onclick = exportCSV;

// Start default
generate(parseInt(el('inpLimit').value));
</script>
</body>
</html>