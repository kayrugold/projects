<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hyper-Streamliner v8 (CRT)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body { background-color: #000; color: #e2e8f0; font-family: 'Courier New', monospace; padding: 20px; }
    .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 25px; max-width: 700px; margin: 0 auto; box-shadow: 0 0 50px rgba(124, 58, 237, 0.2); }
    
    h1 { color: #a78bfa; margin: 0; font-size: 1.5rem; letter-spacing: 2px; text-transform: uppercase; font-weight: 900; }
    .sub { color: #64748b; font-size: 0.75rem; margin-bottom: 25px; border-bottom: 1px solid #334155; padding-bottom: 10px; display: flex; justify-content: space-between; }

    /* DASHBOARD */
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
    .panel { background: #020617; border: 1px solid #334155; border-radius: 6px; padding: 10px; text-align: center; }
    .lbl { font-size: 9px; color: #94a3b8; display: block; margin-bottom: 4px; text-transform: uppercase; }
    .val { font-size: 14px; color: #fff; font-weight: bold; }
    .val-active { color: #a78bfa; }
    .val-done { color: #34d399; }

    /* PROGRESS */
    .prog-box { margin-bottom: 20px; }
    .bar-bg { height: 6px; background: #1e293b; border-radius: 3px; overflow: hidden; margin-top:5px; }
    .bar-fill { height: 100%; background: #a78bfa; width: 0%; transition: width 0.2s; box-shadow: 0 0 10px #8b5cf6; }
    
    /* LOGS */
    .log-box { height: 250px; overflow-y: auto; background: #020617; border: 1px solid #334155; border-radius: 6px; padding: 10px; font-size: 11px; color: #94a3b8; font-family: monospace; }
    .log-entry { border-bottom: 1px dashed #1e293b; padding-bottom: 2px; margin-bottom: 4px; }
    .highlight { color: #a78bfa; font-weight: bold; }
    .success { color: #34d399; font-weight: bold; }

    .btn { width: 100%; padding: 18px; border: none; border-radius: 8px; font-weight: 900; font-size: 16px; cursor: pointer; text-transform: uppercase; background: #7c3aed; color: #fff; transition: all 0.2s; }
    .btn:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
</style>
</head>
<body>

<div class="card">
    <h1>Hyper-Streamliner v8</h1>
    <div class="sub">
        <span>CRT Protocol (3-Pass)</span>
        <span id="statusText">STANDBY</span>
    </div>

    <div class="grid-3">
        <div class="panel">
            <span class="lbl">PASS 1 (Alpha)</span>
            <span id="s1" class="val">WAITING</span>
        </div>
        <div class="panel">
            <span class="lbl">PASS 2 (Beta)</span>
            <span id="s2" class="val">WAITING</span>
        </div>
        <div class="panel">
            <span class="lbl">PASS 3 (Gamma)</span>
            <span id="s3" class="val">WAITING</span>
        </div>
    </div>

    <div class="prog-box">
        <div style="display:flex; justify-content:space-between; font-size:10px; color:#64748b;">
            <span id="progAction">IDLE</span>
            <span id="progPct">0%</span>
        </div>
        <div class="bar-bg"><div id="progBar" class="bar-fill"></div></div>
    </div>

    <button id="btnRun" class="btn" onclick="startCRT()">INITIATE 3-PASS SEQUENCE</button>
    <div id="console" class="log-box">System Ready. Target: 10^1,000,000,000 + 61</div>
</div>

<script>
// ==========================================
// CRT KERNEL (3-PASS ENGINE)
// ==========================================
const workerCode = `
const PAGE_BITS = 24; // 16M elements (~64MB)
const PAGE_SIZE = 1 << PAGE_BITS; 
const PAGE_MASK = PAGE_SIZE - 1;

// THE THREE PRIMES (NTT Friendly)
const MODS = [
    { P: 998244353n,  G: 3n }, // Alpha
    { P: 1004535809n, G: 3n }, // Beta
    { P: 985661441n,  G: 3n }  // Gamma
];

// VIRTUAL MEMORY
class VirtualVector {
    constructor(size) {
        this.size = size;
        this.numPages = Math.ceil(size / PAGE_SIZE);
        this.pages = [];
    }
    allocate() {
        for(let i=0; i<this.numPages; i++) {
            this.pages.push(new Int32Array(PAGE_SIZE));
        }
        return this.numPages * PAGE_SIZE * 4;
    }
    get(i) { return this.pages[i >>> PAGE_BITS][i & PAGE_MASK]; }
    set(i, v) { this.pages[i >>> PAGE_BITS][i & PAGE_MASK] = v; }
}

function power(a, b, m) {
    let res = 1n; a %= m;
    while (b > 0n) {
        if (b & 1n) res = (res * a) % m;
        a = (a * a) % m; b >>= 1n;
    }
    return res;
}

function modInverse(n, m) { return power(n, m - 2n, m); }

// GENERIC NTT
function ntt(vec, invert, modIdx) {
    const n = vec.size;
    const MOD = MODS[modIdx].P;
    const ROOT = MODS[modIdx].G;

    let j = 0;
    for (let i = 1; i < n; i++) {
        let bit = n >> 1;
        while (j & bit) { j ^= bit; bit >>= 1; }
        j ^= bit;
        if (i < j) { const t = vec.get(i); vec.set(i, vec.get(j)); vec.set(j, t); }
    }

    let stage = 0;
    const totalStages = Math.log2(n);

    for (let len = 2; len <= n; len <<= 1) {
        let wlen = power(ROOT, (MOD - 1n) / BigInt(len), MOD);
        if (invert) wlen = modInverse(wlen, MOD);

        for (let i = 0; i < n; i += len) {
            let w = 1n;
            for (let j = 0; j < len / 2; j++) {
                const idxU = i + j;
                const idxV = i + j + len / 2;
                const u = BigInt(vec.get(idxU));
                const v = (BigInt(vec.get(idxV)) * w) % MOD;
                vec.set(idxU, Number((u + v) % MOD));
                vec.set(idxV, Number((u - v + MOD) % MOD));
                w = (w * wlen) % MOD;
            }
        }
        stage++;
        if(stage % 2 === 0) postMessage({type:'prog', val: stage/totalStages, pass: modIdx});
    }

    if (invert) {
        const ninv = modInverse(BigInt(n), MOD);
        for (let i = 0; i < n; i++) vec.set(i, Number((BigInt(vec.get(i)) * ninv) % MOD));
    }
}

self.onmessage = async function(e) {
    const { cmd, pass } = e.data;
    
    if(cmd === 'runPass') {
        const EXP = 1000000000; 
        const MOD_OBJ = MODS[pass];
        const MOD = MOD_OBJ.P;
        
        postMessage({type:'log', msg:\`[PASS \${pass+1}] Allocating Memory...\`});
        
        // 1. Setup Size (Same as V9)
        // We calculate size for 1B digits ~ 268M elements
        const digits = EXP * Math.log10(10);
        const needed = Math.ceil(digits / 6); 
        let size = 1;
        while(size < needed) size <<= 1;
        
        const vec = new VirtualVector(size);
        vec.allocate();
        
        // 2. Initialize 10^E + 61
        const lead = Math.floor(EXP / 6);
        const rem = EXP % 6;
        vec.set(0, 61); // Add
        vec.set(lead, Math.pow(10, rem)); // Base
        
        // 3. Spectral Square
        postMessage({type:'status', txt:\`PASS \${pass+1}: FORWARD NTT\`});
        ntt(vec, false, pass);
        
        postMessage({type:'status', txt:\`PASS \${pass+1}: SQUARING\`});
        for(let i=0; i<size; i++) {
            const v = BigInt(vec.get(i));
            vec.set(i, Number((v*v)%MOD));
        }
        
        postMessage({type:'status', txt:\`PASS \${pass+1}: INVERSE NTT\`});
        ntt(vec, true, pass);
        
        // 4. Capture Tail (First 20 Chunks)
        // We only need the tail to verify 3721
        const tail = [];
        for(let i=0; i<20; i++) tail.push(vec.get(i));
        
        postMessage({type:'passDone', pass: pass, tail: tail});
    }
};
`;

// --- UI CONTROLLER ---
const blob = new Blob([workerCode], {type: 'application/javascript'});
const url = URL.createObjectURL(blob);
let worker;
let results = [null, null, null]; // Store tails

function log(msg, style='') {
    const c = document.getElementById('console');
    const d = document.createElement('div');
    d.className = 'log-entry ' + style;
    d.innerHTML = "> " + msg;
    c.prepend(d);
}

function startCRT() {
    document.getElementById('btnRun').disabled = true;
    results = [null, null, null];
    runPass(0); // Start Chain
}

function runPass(idx) {
    if(idx > 2) {
        finalize();
        return;
    }
    
    // UI Update
    const names = ['Alpha', 'Beta', 'Gamma'];
    const ids = ['s1', 's2', 's3'];
    document.getElementById(ids[idx]).innerText = "RUNNING";
    document.getElementById(ids[idx]).className = "val val-active";
    document.getElementById('statusText').innerText = `RUNNING PASS ${idx+1}/3`;
    
    if(worker) worker.terminate();
    worker = new Worker(url);
    
    worker.onmessage = function(e) {
        const d = e.data;
        if(d.type === 'log') log(d.msg);
        if(d.type === 'status') document.getElementById('progAction').innerText = d.txt;
        if(d.type === 'prog') document.getElementById('progBar').style.width = (d.val * 100) + '%';
        
        if(d.type === 'passDone') {
            results[d.pass] = d.tail;
            document.getElementById(ids[d.pass]).innerText = "COMPLETE";
            document.getElementById(ids[d.pass]).className = "val val-done";
            log(`Pass ${d.pass+1} Captured. Tail Fragment Acquired.`, 'highlight');
            
            // Next
            setTimeout(() => runPass(d.pass + 1), 1000);
        }
    };
    
    worker.postMessage({cmd: 'runPass', pass: idx});
}

function finalize() {
    log("ALL PASSES COMPLETE. INITIATING CRT FUSION...", 'highlight');
    document.getElementById('statusText').innerText = "FUSION";
    
    // CRT CONSTANTS
    const M1 = 998244353n;
    const M2 = 1004535809n;
    const M3 = 985661441n;
    const M = M1 * M2 * M3;
    
    // Precomputed inverses (Standard CRT)
    // We do this simply here for readability
    const M1_ = M / M1;
    const M2_ = M / M2;
    const M3_ = M / M3;
    
    // Modular Inverse Helper
    const modInv = (a, m) => {
        let [m0, x0, x1] = [m, 0n, 1n];
        if (m === 1n) return 0n;
        while (a > 1n) {
            let q = a / m;
            [m, a] = [a % m, m];
            [x0, x1] = [x1 - q * x0, x0];
        }
        return x1 < 0n ? x1 + m0 : x1;
    };
    
    const y1 = modInv(M1_, M1);
    const y2 = modInv(M2_, M2);
    const y3 = modInv(M3_, M3);
    
    // RECONSTRUCT TAIL
    // We take the first few chunks from each result and fuse them
    
    let combinedTail = [];
    let carry = 0n;
    
    // We saved 20 chunks. Let's fuse the first 5 to see the digits.
    for(let i=0; i<5; i++) {
        const r1 = BigInt(results[0][i]);
        const r2 = BigInt(results[1][i]);
        const r3 = BigInt(results[2][i]);
        
        // CRT Formula: X = (r1*M1_*y1 + r2*M2_*y2 + r3*M3_*y3) % M
        let term1 = (r1 * M1_ * y1) % M;
        let term2 = (r2 * M2_ * y2) % M;
        let term3 = (r3 * M3_ * y3) % M;
        
        let fused = (term1 + term2 + term3) % M;
        
        // Handle Carry from previous chunks (standard big int addition logic)
        fused += carry;
        
        // Base 10^6 (since density was 6 in worker)
        const BASE = 1000000n;
        const digitChunk = fused % BASE;
        carry = fused / BASE;
        
        let s = digitChunk.toString();
        while(s.length < 6) s = "0" + s;
        combinedTail.push(s);
    }
    
    // The chunks are in Low->High order.
    // Index 0 is the lowest 6 digits.
    const finalLow = combinedTail[0];
    const finalNext = combinedTail[1];
    
    log("FUSION COMPLETE.", 'success');
    log(`RECONSTRUCTED TAIL: ...${finalNext} ${finalLow}`, 'success');
    
    const tailNum = parseInt(finalLow);
    if(tailNum === 3721 || tailNum.toString().endsWith("3721")) {
        log("VALIDATION SUCCESSFUL: Ends in 3721.", 'success');
        document.getElementById('statusText').style.color = "#34d399";
        document.getElementById('statusText').innerText = "VERIFIED";
    } else {
        log(`WARNING: Tail is ${tailNum}. Expected ...3721`, 'highlight');
    }
    
    document.getElementById('btnRun').disabled = false;
    document.getElementById('btnRun').innerText = "RUN DIAGNOSTIC AGAIN";
}
</script>
</body>
</html>
