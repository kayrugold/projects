<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prime Ordnance v2.1 (Async)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    :root {
        --bg-dark: #000000;
        --panel-bg: #0a0a0a;
        --border: #333;
        --primary: #8b5cf6; /* Violet */
        --accent: #10b981;  /* Emerald */
        --gold: #f59e0b;    /* Gold */
        --text-main: #e2e8f0;
        --text-dim: #64748b;
    }

    body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Courier New', monospace; padding: 10px; }
    
    .panel { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; }
    .panel-title { font-weight: 900; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
    
    /* COLORS */
    .border-telescope { border-left: 4px solid var(--primary); }
    .text-telescope { color: var(--primary); }
    .border-oracle { border-left: 4px solid var(--gold); }
    .text-oracle { color: var(--gold); }
    .border-microscope { border-left: 4px solid var(--accent); }
    .text-microscope { color: var(--accent); }

    /* INPUTS */
    label { display: block; font-size: 0.65rem; color: var(--text-dim); margin-bottom: 2px; text-transform: uppercase; }
    input, select { width: 100%; background: #111; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 4px; font-family: monospace; text-align: center; font-size: 0.9rem; }
    input:focus { outline: none; border-color: #555; }
    
    /* BUTTONS */
    .btn { width: 100%; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top:5px; border: 1px solid #333; transition: all 0.2s; }
    .btn-primary { background: #1e1b4b; color: var(--primary); border-color: #4c1d95; }
    .btn-primary:hover { background: #4c1d95; color: #fff; }
    .btn-gold { background: #451a03; color: var(--gold); border-color: #92400e; }
    .btn-gold:hover { background: #92400e; color: #fff; }
    .btn-accent { background: #064e3b; color: var(--accent); border-color: #065f46; }
    .btn-accent:hover { background: #059669; color: #fff; }
    .btn-stop { background: #450a0a; color: #f87171; border-color: #991b1b; display: none; }

    /* VISUALS */
    .log-box { height: 100px; overflow-y: auto; font-size: 0.7rem; color: var(--text-dim); background: #050505; padding: 8px; border: 1px solid #222; margin-top: 10px; font-family: monospace; }
    .progress-container { height: 4px; background: #222; width: 100%; margin-top: 8px; border-radius: 2px; overflow: hidden; }
    .progress-bar { height: 100%; width: 0%; transition: width 0.3s; }
    
    .grid-canvas { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 1px; background: #222; border: 1px solid #333; max-height: 300px; overflow-y: auto; margin-top: 10px; }
    .grid-cell { height: 45px; background: #0a0a0a; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #444; cursor: pointer; }
    .grid-cell.prime { background: #064e3b; color: #34d399; font-weight: bold; }
    .grid-cell.composite { background: #2a1010; color: #ef4444; }
    .grid-cell.is-factor { background: #ca8a04; color: #000; font-weight: 900; box-shadow: 0 0 10px #eab308; z-index:10; border: 1px solid yellow;}

    .row { display: flex; gap: 8px; }
    .col { flex: 1; }
    .core-row { display: flex; justify-content: space-between; font-size: 0.7rem; color: #666; margin-bottom: 2px; }
</style>
</head>
<body>

<div class="text-center mb-4">
    <h1 class="text-xl font-bold text-slate-200 tracking-widest">PRIME ORDNANCE v2.1</h1>
    <p class="text-[0.65rem] text-slate-600">ASYNC HOLOGRAPHIC CORE</p>
</div>

<div class="panel border-oracle">
    <div class="panel-header">
        <span class="panel-title text-oracle">HOLOGRAPHIC ORACLE</span>
        <div class="text-xs text-gray-500">WORKER-POWERED</div>
    </div>
    <div class="row">
        <div class="col"><label>Candidate</label><input id="oracleInput" value="2^2203-1"></div>
        <div class="col" style="flex:0 0 80px"><label>Witnesses</label><input id="oracleWitnesses" value="5"></div>
    </div>
    <div class="progress-container"><div id="oracleProgress" class="progress-bar bg-amber-500"></div></div>
    <div id="oracleStatus" class="text-right text-[0.6rem] text-amber-500 mt-1">IDLE</div>
    <div class="row">
        <button id="btnOracleRun" class="btn btn-gold col" onclick="runOracle()">RUN TEST</button>
        <button id="btnOracleStop" class="btn btn-stop col" onclick="stopOracle()">STOP</button>
    </div>
    <div id="oracleLog" class="log-box" style="border-color: #451a03;">Waiting for input...</div>
</div>

<div class="panel border-telescope">
    <div class="panel-header">
        <span class="panel-title text-telescope">PHANTOM FLEET</span>
        <div class="text-xs text-gray-500" id="sTime">00:00:00</div>
    </div>
    <div class="row mb-2">
        <div class="col"><label>Base</label><input id="inpExp" value="1000000000" onchange="syncTarget()"></div>
        <div class="col"><label>Add</label><input id="inpAdd" value="61" onchange="syncTarget()"></div>
        <div class="col" style="flex:0 0 60px"><label>Cores</label><select id="inpCores"><option>4</option><option selected>8</option></select></div>
    </div>
    <div class="row">
        <div class="col"><label>Start</label><input id="inpStart" value="100000000000" style="color:#a78bfa"></div>
        <div class="col"><label>End</label><input id="inpEnd" value="200000000000"></div>
    </div>
    <button id="btnStart" class="btn btn-primary" onclick="startScan()">DEPLOY SCANNER</button>
    <button id="btnStop" class="btn btn-stop" onclick="stopScan()">ABORT</button>
    <div id="coresContainer" class="mt-2 space-y-1"></div>
    <div id="logBox" class="log-box">System Ready.</div>
</div>

<div class="panel border-microscope">
    <div class="panel-header">
        <span class="panel-title text-microscope">PRIME GRID</span>
        <div class="text-xs text-gray-500">VISUALIZER</div>
    </div>
    <div class="row">
        <div class="col"><label>Start (e.g. 1e700)</label><input id="gridStart" value="1000"></div>
        <div class="col"><label>End</label><input id="gridEnd" value="1200"></div>
        <div class="col"><label>Cols</label><select id="gridCols"><option value="auto">Auto</option><option value="10">10</option></select></div>
    </div>
    <input id="gridTarget" class="mt-2" placeholder="Target Synced" disabled style="opacity:0.5; border-color:#065f46">
    <button class="btn btn-accent" onclick="drawGrid()">RENDER</button>
    <div id="gridCanvas" class="grid-canvas"></div>
</div>

<script>
// --- MAIN THREAD MATH ---
function parseExpression(str, safeLimit=false) {
    if(!str) return 1n;
    try {
        let s = str.toLowerCase().replace(/\s/g,'').replace(/,/g,'');
        if(safeLimit && (s.includes('^') || s.includes('e'))) {
            let exp = 0;
            if(s.includes('e')) exp = parseInt(s.split('e')[1]);
            if(s.includes('^')) exp = parseInt(s.split('^')[1]);
            if(exp > 30000) throw new Error("Number too big for UI thread.");
        }
        if(s.includes('^')) {
            const p = s.split('^'); const base = BigInt(p[0]);
            let rest = p[1], offset = 0n;
            if(rest.includes('-')) { const sp = rest.split('-'); rest = sp[0]; offset = -BigInt(sp[1]); }
            else if(rest.includes('+')) { const sp = rest.split('+'); rest = sp[0]; offset = BigInt(sp[1]); }
            return (base ** BigInt(rest)) + offset;
        }
        if(s.includes('e')) {
            const p = s.split('e'); const base = BigInt(Math.floor(parseFloat(p[0])));
            const exp = BigInt(p[1].split('+')[0].split('-')[0]);
            let val = base * (10n ** exp);
            if(s.includes('+')) val += BigInt(s.split('+')[1]);
            return val;
        }
        return BigInt(s);
    } catch(e) { throw e; }
}

function powMod(b, e, m) {
    let res = 1n; b = b % m;
    while (e > 0n) { if ((e & 1n) === 1n) res = (res * b) % m; b = (b * b) % m; e = e >> 1n; }
    return res;
}

// --- ORACLE WORKER (ASYNC PARSING) ---
const oracleWorkerBlob = new Blob([`
self.onmessage = function(e) {
    const { input, k } = e.data;
    
    // Internal Parser to unblock UI
    function parse(str) {
        try {
            let s = str.toLowerCase().replace(/\\s/g,'').replace(/,/g,'');
            if(s.includes('^')) {
                const p = s.split('^'); const base = BigInt(p[0]);
                let rest = p[1], offset = 0n;
                if(rest.includes('-')) { const sp = rest.split('-'); rest = sp[0]; offset = -BigInt(sp[1]); }
                else if(rest.includes('+')) { const sp = rest.split('+'); rest = sp[0]; offset = BigInt(sp[1]); }
                return (base ** BigInt(rest)) + offset;
            }
            if(s.includes('e')) {
                const p = s.split('e'); const base = BigInt(Math.floor(parseFloat(p[0])));
                const exp = BigInt(p[1].split('+')[0].split('-')[0]);
                let val = base * (10n ** exp);
                if(s.includes('+')) val += BigInt(s.split('+')[1]);
                return val;
            }
            return BigInt(s);
        } catch(e) { throw e; }
    }

    function powMod(b, e, m) {
        let res = 1n; b %= m;
        while (e > 0n) { if ((e & 1n) === 1n) res = (res * b) % m; b = (b * b) % m; e >>= 1n; }
        return res;
    }

    try {
        postMessage({type:'status', msg:'Constructing Number...'});
        const N = parse(input);
        
        if(N <= 2n) { postMessage({type:'error', msg:'Too small'}); return; }
        if(N % 2n === 0n) { postMessage({type:'result', isPrime:false, msg:'COMPOSITE (Even)'}); return; }
        
        postMessage({type:'log', msg:\`Candidate built: \${N.toString().length} digits.\`});
        postMessage({type:'status', msg:'Calculating Decomposition...'});
        
        let d = N - 1n;
        let s = 0;
        while(d % 2n === 0n) { d /= 2n; s++; }
        
        for(let i=0; i<k; i++) {
            postMessage({type:'status', msg:\`Checking Witness \${i+1}/\${k}...\`});
            const witness = BigInt([2,3,5,7,11,13,17,19,23,29,31,37][i] || (i*2+3));
            
            let x = powMod(witness, d, N);
            
            if(x === 1n || x === N-1n) {
                // Passed
            } else {
                let composite = true;
                for(let r=0; r<s-1; r++) {
                    x = (x*x) % N;
                    if(x === N-1n) { composite = false; break; }
                }
                if(composite) {
                    postMessage({type:'result', isPrime:false, msg:\`Witness \${witness} FAILED.\`});
                    return;
                }
            }
            postMessage({type:'progress', val:((i+1)/k)*100});
        }
        postMessage({type:'result', isPrime:true, msg:'PROBABLE PRIME'});
        
    } catch(e) { postMessage({type:'error', msg:e.message}); }
};
`], {type: 'application/javascript'});

let oracleWorker = null;

function runOracle() {
    stopOracle();
    const input = document.getElementById('oracleInput').value;
    const k = parseInt(document.getElementById('oracleWitnesses').value) || 5;
    
    document.getElementById('btnOracleRun').style.display='none';
    document.getElementById('btnOracleStop').style.display='inline-block';
    document.getElementById('oracleLog').innerHTML = '';
    
    oracleWorker = new Worker(URL.createObjectURL(oracleWorkerBlob));
    oracleWorker.onmessage = function(e) {
        const d = e.data;
        if(d.type==='status') document.getElementById('oracleStatus').innerText = d.msg;
        if(d.type==='log') document.getElementById('oracleLog').innerHTML += `<div>${d.msg}</div>`;
        if(d.type==='progress') document.getElementById('oracleProgress').style.width = d.val+"%";
        if(d.type==='result') {
            const color = d.isPrime ? '#10b981' : '#ef4444';
            document.getElementById('oracleLog').innerHTML += `<div style="color:${color}; font-weight:bold; margin-top:10px">${d.msg}</div>`;
            document.getElementById('oracleStatus').innerText = "COMPLETE";
            stopOracleUI();
        }
        if(d.type==='error') {
            document.getElementById('oracleLog').innerHTML += `<div style="color:red">Error: ${d.msg}</div>`;
            stopOracleUI();
        }
    };
    oracleWorker.postMessage({input, k});
}

function stopOracle() {
    if(oracleWorker) oracleWorker.terminate();
    oracleWorker = null;
    stopOracleUI();
}

function stopOracleUI() {
    document.getElementById('btnOracleRun').style.display='inline-block';
    document.getElementById('btnOracleStop').style.display='none';
}

// --- PHANTOM FLEET ---
const workerCode = `
self.onmessage = function(e) {
    const { expStr, addStr, startStr, endStr } = e.data;
    try {
        const exp = BigInt(expStr);
        const add = BigInt(addStr);
        const startLimit = parseInt(startStr);
        const endLimit = parseInt(endStr);
        const baseBI = 10n;

        function powMod(b, e, m) {
            let res = 1n; b %= m;
            while (e > 0n) { if ((e & 1n) === 1n) res = (res * b) % m; b = (b * b) % m; e >>= 1n; }
            return res;
        }

        const BLOCK = 300000;
        let low = startLimit;
        if(startLimit > 1000000) { const rem = low % 30; if(rem) low += (30-rem); }

        const sqrtLim = Math.floor(Math.sqrt(endLimit));
        const sieveLim = Math.max(sqrtLim, 200);
        const sieve = new Uint8Array(sieveLim+1);
        const primes = [];
        for(let i=2; i<=sieveLim; i++) {
            if(sieve[i]===0) {
                primes.push(i);
                for(let j=i*i; j<=sieveLim; j+=i) sieve[j]=1;
            }
        }

        const segment = new Uint8Array(BLOCK);
        const wheels = [1,7,11,13,17,19,23,29];
        let lastRep = Date.now();

        while(low < endLimit) {
            const high = Math.min(low+BLOCK, endLimit);
            segment.fill(0);
            
            for(let p of primes) {
                let s = Math.floor((low+p-1)/p)*p;
                if(s < p*p) s = p*p;
                for(let j=s-low; j<high-low; j+=p) segment[j]=1;
            }

            if(startLimit > 1000000) {
                for(let base=0; base<high-low; base+=30) {
                    for(let w of wheels) {
                        const idx = base+w;
                        if(idx >= high-low) break;
                        if(segment[idx]===0) {
                            const pVal = low+idx;
                            const P = BigInt(pVal);
                            
                            // PHANTOM TARGET LOGIC (v1.8 Fix: No Squaring)
                            const baseMod = powMod(baseBI, exp, P);
                            const T_mod = (baseMod + add) % P;
                            
                            // Index Check (T = 2I - 1)
                            // If T_mod == 0, then T is divisible by P.
                            // We can check I_mod if we want to be fancy, but % P is the gold standard.
                            // Let's stick to the Holographic Check for consistency with the theory.
                            const inv2 = (P+1n)/2n;
                            const I_mod = (T_mod + 1n) * inv2 % P;
                            
                            if(I_mod === inv2) postMessage({type:'hit', p:pVal});
                        }
                    }
                }
            } else {
                for(let i=0; i<high-low; i++) {
                    if(segment[i]===0) {
                        const pVal = low+i;
                        if(pVal < startLimit || pVal < 2) continue;
                        const P = BigInt(pVal);
                        const baseMod = powMod(baseBI, exp, P);
                        const T_mod = (baseMod + add) % P;
                        const inv2 = (P+1n)/2n;
                        const I_mod = (T_mod + 1n) * inv2 % P;
                        if(I_mod === inv2) postMessage({type:'hit', p:pVal});
                    }
                }
            }
            
            low += BLOCK;
            if(Date.now()-lastRep > 500) {
                postMessage({type:'progress', curr:low});
                lastRep = Date.now();
            }
        }
        postMessage({type:'done'});
    } catch(e) { postMessage({type:'error', msg:e.message}); }
};
`;

const workerBlob = new Blob([workerCode], {type:'application/javascript'});
const workerUrl = URL.createObjectURL(workerBlob);

let fleetWorkers = []; let fleetStartTime=0; let fleetTimer=null;

async function startScan() {
    stopScan();
    document.getElementById('coresContainer').innerHTML='';
    document.getElementById('btnStart').style.display='none';
    document.getElementById('btnStop').style.display='block';
    
    syncTarget();
    
    const exp = document.getElementById('inpExp').value;
    const add = document.getElementById('inpAdd').value;
    const start = parseInt(document.getElementById('inpStart').value);
    const end = parseInt(document.getElementById('inpEnd').value);
    const cores = parseInt(document.getElementById('inpCores').value);
    
    const chunk = Math.ceil((end-start)/cores);
    fleetStartTime = Date.now();
    fleetTimer = setInterval(()=>{
        const s = Math.floor((Date.now()-fleetStartTime)/1000);
        document.getElementById('sTime').innerText = new Date(s*1000).toISOString().substr(11,8);
    }, 1000);

    for(let i=0; i<cores; i++) {
        const s = start + i*chunk;
        const e = Math.min(s+chunk, end);
        const el = document.createElement('div');
        el.className = "core-row";
        el.innerHTML = `<span>Core ${i+1}</span><span id="p${i}">0%</span>`;
        document.getElementById('coresContainer').appendChild(el);
        
        const w = new Worker(workerUrl);
        w.onmessage = (msg) => {
            if(msg.data.type==='progress') {
                const pct = ((msg.data.curr - s)/(e-s)*100).toFixed(1);
                document.getElementById(`p${i}`).innerText = pct+'%';
            } else if(msg.data.type==='hit') {
                log(`HIT: ${msg.data.p}`, 'hit');
            } else if(msg.data.type==='done') {
                document.getElementById(`p${i}`).style.color = '#10b981';
                document.getElementById(`p${i}`).innerText = 'DONE';
            }
        };
        w.postMessage({expStr:exp, addStr:add, startStr:s.toString(), endStr:e.toString()});
        fleetWorkers.push(w);
    }
}

function stopScan() {
    fleetWorkers.forEach(w=>w.terminate()); fleetWorkers=[];
    clearInterval(fleetTimer);
    document.getElementById('btnStart').style.display='block';
    document.getElementById('btnStop').style.display='none';
}

function syncTarget() {
    const exp = document.getElementById('inpExp').value;
    const add = document.getElementById('inpAdd').value;
    document.getElementById('gridTarget').value = `10^${exp} + ${add}`;
}

const log = (m,t) => {
    const l = document.getElementById('logBox');
    l.innerHTML = `<div class="${t==='hit'?'hit-msg':''}">${m}</div>` + l.innerHTML;
}

// --- PRIME GRID ---
function drawGrid() {
    const c = document.getElementById('gridCanvas'); c.innerHTML='';
    let start, end;
    try {
        start = parseExpression(document.getElementById('gridStart').value, true);
        end = parseExpression(document.getElementById('gridEnd').value, true);
    } catch(e) { log(e.message,'hit'); return; }
    
    if(end-start > 500n) { log("Max 500 cells.",'hit'); return; }
    
    const cols = document.getElementById('gridCols').value === 'auto' ? 10 : 10;
    c.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    
    let tExp=0n, tAdd=0n;
    try {
        tExp = BigInt(document.getElementById('inpExp').value);
        tAdd = BigInt(document.getElementById('inpAdd').value);
    } catch(e){}

    for(let i=start; i<=end; i++) {
        const n = i;
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        let lbl = n.toString();
        if(lbl.length > 6) lbl = "..."+lbl.slice(-4);
        cell.innerText = lbl; cell.title = n.toString();
        
        let isP = false;
        if(n%2n!==0n && n > 1n) {
            const d = n-1n;
            if(powMod(2n, d, n) === 1n) isP = true;
        }
        if(n===2n) isP=true;
        
        if(isP) {
            cell.classList.add('prime');
            const p = n;
            const base = powMod(10n, tExp, p);
            if( (base+tAdd)%p === 0n ) {
                cell.classList.add('is-factor');
                log(`GRID FACTOR: ${n}`, 'hit');
            }
        } else {
            cell.classList.add('composite');
        }
        c.appendChild(cell);
    }
}

window.onload = function() { syncTarget(); drawGrid(); }
</script>
</body>
</html>
