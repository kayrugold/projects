<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HLU v6.2 MONITOR</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    :root {
        --neon-cyan: #06b6d4;
        --neon-green: #10b981;
        --neon-purple: #8b5cf6;
        --bg-dark: #020617;
        --panel-bg: #0f172a;
        --border: #1e293b;
    }
    body { background-color: var(--bg-dark); color: #e2e8f0; font-family: 'Courier New', monospace; padding: 10px; font-size: 14px; }
    
    /* CORE VISUALIZER */
    .core-container {
        position: relative; height: 40px; background: radial-gradient(circle, #1e293b 0%, #020617 90%);
        border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px;
        box-shadow: 0 0 15px rgba(6, 182, 212, 0.1); overflow: hidden;
    }
    .scanner-line {
        width: 4px; height: 100%; background: var(--neon-cyan); opacity: 0;
        position: absolute; left: 0; box-shadow: 0 0 20px var(--neon-cyan);
    }
    .core-active .scanner-line {
        animation: scan 1.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        opacity: 1;
    }
    @keyframes scan { 0% { left: -10%; opacity: 0; } 50% { opacity: 1; } 100% { left: 110%; opacity: 0; } }

    /* LAYOUT UTILS */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
    .panel { background: var(--panel-bg); border: 1px solid var(--border); padding: 8px; border-radius: 6px; }
    .label { font-size: 0.6rem; color: #64748b; letter-spacing: 1px; display: block; margin-bottom: 2px; text-transform: uppercase; }
    .input-val { width: 100%; background: transparent; color: #fff; font-weight: bold; text-align: center; border:none; outline:none; font-size: 1.1rem; }
    .select-val { width: 100%; background: #020617; color: var(--neon-cyan); border: 1px solid #1e293b; padding: 4px; border-radius: 4px; text-align: center; }

    /* MONITOR SECTION (Left of Display) */
    .display-wrapper { display: grid; grid-template-columns: 80px 1fr; gap: 8px; margin-bottom: 10px; height: 100px; }
    
    .monitor-panel {
        background: #000; border: 1px solid #334155; border-radius: 6px; padding: 4px;
        display: flex; flex-direction: row; gap: 2px; align-items: flex-end; justify-content: space-between;
        position: relative; overflow: hidden;
    }
    
    /* Vertical Bars */
    .bar-group { display: flex; flex-direction: column; align-items: center; height: 100%; flex: 1; }
    .v-track { width: 6px; background: #1e293b; height: 100%; border-radius: 2px; position: relative; overflow: hidden; }
    .v-fill { 
        position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; 
        background: var(--neon-green); transition: height 0.2s; 
        box-shadow: 0 0 5px var(--neon-green);
    }
    .v-fill.cpu { background: var(--neon-cyan); box-shadow: 0 0 5px var(--neon-cyan); }
    .v-fill.mem { background: var(--neon-purple); box-shadow: 0 0 5px var(--neon-purple); }
    
    .mon-label { font-size: 0.5rem; color: #64748b; margin-top: 2px; transform: scale(0.8); }
    .perc-text { 
        position: absolute; top: 2px; left: 0; width: 100%; text-align: center; 
        font-size: 0.55rem; color: #fff; text-shadow: 0 0 2px #000; z-index: 10;
        pointer-events: none;
    }

    /* ALGEBRAIC DISPLAY */
    .algebra-box { 
        background: #000; border: 1px solid #334155; padding: 8px; border-radius: 6px; 
        margin-bottom: 10px; font-size: 0.85rem; text-align: center; color: var(--neon-purple); 
        word-break: break-all; min-height: 40px; display: flex; align-items: center; justify-content: center;
    }
    
    /* CALCULATOR INPUT */
    .calc-input {
        width: 100%; height: 100%; background: #0f172a; border: 1px solid #334155; color: var(--neon-green);
        padding: 10px; font-size: 1.1rem; text-align: right; border-radius: 6px; 
        white-space: pre-wrap; word-break: break-all; overflow-y: auto; resize: none;
    }

    /* KEYPAD */
    .keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .btn {
        padding: 15px; border-radius: 6px; font-weight: bold; cursor: pointer; 
        background: #1e293b; border: 1px solid #334155; color: #cbd5e1; transition: 0.1s;
        display: flex; align-items: center; justify-content: center; user-select: none;
    }
    .btn:active { transform: scale(0.98); background: #334155; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-blue { background: #0e3c55; color: var(--neon-cyan); border-color: #155e75; }
    .btn-green { background: #064e3b; color: var(--neon-green); border-color: #065f46; }
    .btn-red { background: #450a0a; color: #f87171; border-color: #7f1d1d; }
    .btn-online { background: #064e3b; color: #fff; border-color: #065f46; pointer-events: none; }

    /* LOG */
    .log-box {
        height: 100px; background: #000; border: 1px solid var(--border); border-radius: 6px;
        margin-top: 10px; padding: 8px; overflow-y: auto; font-size: 0.7rem; color: #94a3b8;
    }
    .log-line { border-bottom: 1px solid #111; padding: 2px 0; }
</style>
</head>
<body>

<div class="max-w-lg mx-auto">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl font-bold tracking-widest text-cyan-400">HLU v6.2 <span class="text-xs text-purple-400">MONITOR</span></h1>
        <div id="statusLight" class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_red]"></div>
    </div>

    <div id="core" class="core-container"><div class="scanner-line"></div></div>

    <div class="grid-2">
        <div class="panel">
            <span class="label text-cyan-500">H EXPONENT (E)</span>
            <input id="inpExp" class="input-val" value="1000000000" type="number">
        </div>
        <div class="panel">
            <span class="label text-pink-500">C CONSTANT (C)</span>
            <input id="inpAdd" class="input-val" value="61" type="number">
        </div>
    </div>

    <div class="panel mb-2 flex justify-between items-center">
        <div>
            <span class="label text-gray-400">DEPLOYED CORES</span>
            <select id="coreSelect" class="select-val" onchange="updateCoreVisuals()">
                </select>
        </div>
        <div class="text-right">
            <span class="label text-gray-400">V-RAM (PAGED)</span>
            <span id="memText" class="text-purple-400 font-bold text-sm">0 MB</span>
        </div>
    </div>

    <div class="algebra-box">
        <span id="dispA" class="text-cyan-400">0</span>
        <span class="text-gray-500 mx-2">· H +</span>
        <span id="dispB" class="text-pink-400">0</span>
    </div>

    <div class="display-wrapper">
        <div class="monitor-panel" id="monitorPanel">
            </div>
        
        <textarea id="display" class="calc-input" placeholder="Enter N or Expression..." readonly></textarea>
    </div>

    <div class="keypad">
        <button class="btn btn-red" onclick="resetSys()">RST</button>
        <button class="btn" onclick="addChar('/')">÷</button>
        <button class="btn" onclick="addChar('*')">×</button>
        <button class="btn btn-red" id="btnInit" onclick="initSys()">INIT</button>

        <button class="btn" onclick="addChar('7')">7</button>
        <button class="btn" onclick="addChar('8')">8</button>
        <button class="btn" onclick="addChar('9')">9</button>
        <button class="btn btn-blue" id="btnSq" disabled onclick="runOp('HoloSquare')">HOLO²</button>

        <button class="btn" onclick="addChar('4')">4</button>
        <button class="btn" onclick="addChar('5')">5</button>
        <button class="btn" onclick="addChar('6')">6</button>
        <button class="btn btn-blue" id="btnMod" disabled onclick="runOp('HoloMod')">MOD N</button>

        <button class="btn" onclick="addChar('1')">1</button>
        <button class="btn" onclick="addChar('2')">2</button>
        <button class="btn" onclick="addChar('3')">3</button>
        <button class="btn btn-green" id="btnPrime" disabled onclick="runOp('IsPrime')">PRIME?</button>

        <button class="btn" onclick="addChar('0')">0</button>
        <button class="btn" onclick="addChar('.')">.</button>
        <button class="btn" onclick="addChar('+')">+</button>
        <button class="btn btn-blue" id="btnLoad" disabled onclick="runOp('Load')">LOAD</button>
    </div>

    <div id="terminal" class="log-box">
        <div class="log-line">System Standby.</div>
    </div>
</div>

<script>
// ==========================================
// WORKER KERNEL
// ==========================================
function workerCode() {
    let A = 0n, B = 0n, EXP = 0n, C = 0n;
    
    // Simulate Core Load
    function simulateLoad(cores) {
        let ticks = 0;
        const interval = setInterval(() => {
            ticks++;
            // Generate random load data for each core
            const loads = Array.from({length: cores}, () => Math.floor(Math.random() * 60) + 40); // 40-100%
            postMessage({type:'monitor', cpu: loads});
            if(ticks > 10) clearInterval(interval); // Safety
        }, 100);
        return interval;
    }

    function symbolicFold() {
        const E_val = Number(EXP);
        const bStr = B.toString();
        if (bStr.length > E_val) {
            const splitIdx = bStr.length - E_val;
            const q = BigInt(bStr.substring(0, splitIdx));
            const r = BigInt(bStr.substring(splitIdx));
            A += q; B = r;
            postMessage({type:'log', msg:`FOLD: 10^${bStr.length} -> A`});
        }
    }

    self.onmessage = function(e) {
        const d = e.data;
        try {
            if(d.cmd === 'init') {
                EXP = BigInt(d.exp); C = BigInt(d.add);
                A = 0n; B = 0n;
                postMessage({type:'log', msg:`Core Online. Threads: ${d.cores}`});
            }
            else if(d.cmd === 'Load') {
                // Raw Parse
                try {
                    // Handle simple expressions if Eval failed in main
                    if(/^\d+$/.test(d.val)) B = BigInt(d.val);
                    else B = BigInt(eval(d.val.replace(/\^/g,'**'))); // Basic fallback
                } catch(e){ B = 0n; }
                
                A = 0n; symbolicFold();
                postMessage({type:'update', A:A.toString(), B:B.toString()});
                postMessage({type:'log', msg:'Data Loaded.'});
            }
            else {
                // START SIMULATED LOAD
                const loadTimer = simulateLoad(d.cores);
                
                if(d.cmd === 'HoloSquare') {
                    const tA2 = A*A; const t2AB = 2n*A*B; const tB2 = B*B;
                    let nA = t2AB - (tA2 * C);
                    let nB = tB2;
                    A = nA; B = nB;
                    symbolicFold();
                    postMessage({type:'update', A:A.toString(), B:B.toString()});
                    postMessage({type:'log', msg:'Square Complete.'});
                }
                else if(d.cmd === 'HoloMod') {
                    let val = B - (A * C);
                    A = 0n; B = val;
                    postMessage({type:'update', A:A.toString(), B:B.toString()});
                    postMessage({type:'log', msg:'Fold Complete.'});
                }
                else if(d.cmd === 'IsPrime') {
                    // Quick Miller-Rabin on B (if small enough) or symbolic check
                    let N = B;
                    if(N < 2n) postMessage({type:'log', msg:'Too small.'});
                    else {
                        // Limit N size for demo performance
                        if(N.toString().length > 100) {
                            postMessage({type:'log', msg:'N too large for direct test. Using Holographic Heuristic...'});
                            // Heuristic stub
                        } else {
                            // Real test
                            let d = N-1n, s = 0;
                            while(d%2n===0n){d/=2n;s++}
                            const bases = [2n,3n,5n];
                            let p = true;
                            for(let a of bases){
                                if(a>=N)break;
                                let x=1n, ba=a, ex=d;
                                // modpow
                                while(ex>0n){if(ex%2n===1n)x=(x*ba)%N;ba=(ba*ba)%N;ex/=2n}
                                if(x===1n||x===N-1n)continue;
                                let c=true;
                                for(let r=1;r<s;r++){x=(x*x)%N;if(x===N-1n){c=false;break}}
                                if(c){p=false;break}
                            }
                            postMessage({type:'log', msg: p ? 'PROBABLE PRIME' : 'COMPOSITE', style: p?'text-green-400':'text-red-400'});
                        }
                    }
                }
                
                // Cleanup
                setTimeout(() => {
                    clearInterval(loadTimer);
                    postMessage({type:'monitor', cpu: []}); // Clear load
                }, 500);
            }
        } catch(e) {
            postMessage({type:'log', msg:'ERR: ' + e.message});
        }
    }
}

// ==========================================
// UI LOGIC
// ==========================================
let worker = null;
let inputBuff = "10^2 - 1";
let activeCores = 4;

function log(msg, style='') {
    const term = document.getElementById('terminal');
    const d = document.createElement('div');
    d.className = "log-line " + style;
    d.innerText = "> " + msg;
    term.prepend(d);
}

// AUTO-DETECT CORES
document.addEventListener("DOMContentLoaded", () => {
    const hwCores = navigator.hardwareConcurrency || 4;
    const sel = document.getElementById('coreSelect');
    sel.innerHTML = '';
    
    // Add options 1, 2, 4, 8, ... up to hwCores
    for(let i=1; i<=Math.max(hwCores, 8); i*=2) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.innerText = i + " Cores";
        if(i === hwCores) opt.selected = true;
        sel.appendChild(opt);
    }
    updateCoreVisuals();
});

function updateCoreVisuals() {
    activeCores = parseInt(document.getElementById('coreSelect').value);
    const panel = document.getElementById('monitorPanel');
    panel.innerHTML = '';
    
    // MEMORY BAR
    createBar(panel, 'MEM', 'mem');
    
    // CPU BARS
    // If > 8 cores, group them visually or limit bars to keep UI clean
    const displayBars = Math.min(activeCores, 16); 
    for(let i=0; i<displayBars; i++) {
        createBar(panel, `C${i}`, 'cpu');
    }
}

function createBar(parent, label, type) {
    const group = document.createElement('div');
    group.className = 'bar-group';
    group.style.width = (100 / (activeCores + 1)) + "%";
    
    const perc = document.createElement('div');
    perc.className = 'perc-text';
    perc.id = `txt-${label}`;
    perc.innerText = "0%";
    
    const track = document.createElement('div');
    track.className = 'v-track';
    
    const fill = document.createElement('div');
    fill.className = `v-fill ${type}`;
    fill.id = `bar-${label}`;
    
    const lbl = document.createElement('div');
    lbl.className = 'mon-label';
    lbl.innerText = label;
    
    track.appendChild(fill);
    group.appendChild(perc);
    group.appendChild(track);
    group.appendChild(lbl);
    parent.appendChild(group);
}

function initSys() {
    if(worker) worker.terminate();
    const blob = new Blob([`(${workerCode.toString()})()`], {type:'text/javascript'});
    worker = new Worker(URL.createObjectURL(blob));
    
    worker.onmessage = (e) => {
        const d = e.data;
        if(d.type === 'log') log(d.msg, d.style);
        if(d.type === 'update') {
            document.getElementById('dispA').innerText = formatNum(d.A);
            document.getElementById('dispB').innerText = formatNum(d.B);
            document.getElementById('core').classList.remove('core-active');
            
            // Clear CPU load visual
            updateLoadVisuals([]);
        }
        if(d.type === 'mem') {
            document.getElementById('memText').innerText = d.val + " MB";
            // Animate Mem Bar (fake static load for demo)
            const memPerc = Math.min(100, Math.floor((d.val / 4096) * 100)); 
            document.getElementById('bar-MEM').style.height = memPerc + "%";
            document.getElementById('txt-MEM').innerText = memPerc + "%";
        }
        if(d.type === 'monitor') {
            updateLoadVisuals(d.cpu);
        }
    };
    
    const exp = document.getElementById('inpExp').value;
    const add = document.getElementById('inpAdd').value;
    worker.postMessage({cmd:'init', exp, add, cores:activeCores});
    
    // UI Update
    document.getElementById('statusLight').className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_lime]";
    const btn = document.getElementById('btnInit');
    btn.innerText = "ONLINE";
    btn.classList.remove('btn-red');
    btn.classList.add('btn-online');
    
    ['btnSq', 'btnMod', 'btnPrime', 'btnLoad'].forEach(id => document.getElementById(id).disabled = false);
    
    // Auto-load if display has content
    runOp('Load');
}

function updateLoadVisuals(loads) {
    // loads is array of % integers
    const displayBars = Math.min(activeCores, 16);
    for(let i=0; i<displayBars; i++) {
        const bar = document.getElementById(`bar-C${i}`);
        const txt = document.getElementById(`txt-C${i}`);
        if(bar) {
            const load = loads[i] || 0;
            bar.style.height = load + "%";
            txt.innerText = load > 0 ? load + "%" : "";
            // Color shift on load
            bar.style.opacity = load > 80 ? '1' : '0.6';
        }
    }
}

function runOp(cmd) {
    if(!worker) return log("Initialize Core First.");
    document.getElementById('core').classList.add('core-active');
    
    // Resolve Input in Main Thread if possible (for small inputs)
    let val = document.getElementById('display').value;
    
    // If command is Load, we resolve standard math here.
    if(cmd === 'Load') {
        try {
            // Basic math support
            if(!/^\d+$/.test(val)) val = eval(val.replace(/\^/g,'**')).toString();
        } catch(e) {}
    }
    
    worker.postMessage({cmd, val, cores:activeCores});
}

function addChar(c) {
    if(inputBuff === '10^2 - 1') inputBuff = '';
    inputBuff += c;
    document.getElementById('display').value = inputBuff;
}

function resetSys() {
    inputBuff = "";
    document.getElementById('display').value = "";
    document.getElementById('dispA').innerText = "0";
    document.getElementById('dispB').innerText = "0";
    log("Reset.");
}

function formatNum(s) {
    if(s.length > 20) return s.substring(0, 10) + "..." + s.substring(s.length-10);
    return s;
}
</script>
</body>
</html>
