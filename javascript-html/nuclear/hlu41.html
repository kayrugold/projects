<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Holographic Logic Unit (HLU) v4.7</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body { background-color: #000; color: #e2e8f0; font-family: 'Courier New', monospace; padding: 10px; }
    
    .reactor-shell {
        border: 1px solid #334155; border-radius: 12px; padding: 15px;
        background: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
        box-shadow: 0 0 50px rgba(14, 165, 233, 0.1);
        max-width: 800px; margin: 0 auto;
    }
    
    h1 { color: #38bdf8; font-weight: 900; letter-spacing: 4px; text-align: center; margin-bottom: 5px; font-size: 1.6rem; text-shadow: 0 0 10px #0284c7; }
    .sub { color: #64748b; font-size: 0.75rem; text-align: center; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }

    /* DASHBOARD GRID */
    .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .panel { background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; border-radius: 6px; padding: 10px; overflow: hidden; }
    
    .lbl { font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; display: block; margin-bottom: 4px; }
    .val { font-size: 1.1rem; font-weight: bold; color: #fff; }
    .val-cyan { color: #22d3ee; }
    .val-pink { color: #f472b6; }
    .val-error { color: #ef4444; }
    .vector-val { font-size: 0.8rem; word-break: break-all; }

    /* CORE/RAM CONTROLS */
    .control-group { display: flex; gap: 10px; margin-bottom: 15px; }
    .control-group > div { flex: 1; }
    select { width: 100%; background: #1e293b; border: 1px solid #334155; color: #fff; padding: 5px; border-radius: 4px; font-size: 0.9rem; }
    
    /* CORE PROGRESS VISUAL */
    .core-bar-bg { height: 10px; background: #1e293b; border-radius: 5px; overflow: hidden; margin-bottom: 5px; }
    .core-bar { height: 100%; width: 0%; background: #38bdf8; transition: width 0.1s linear; }
    .core-text { font-size: 0.7rem; color: #94a3b8; text-align: right; }

    /* TERMINAL */
    .term-window {
        background: #020617; border: 1px solid #334155; border-radius: 6px;
        height: 180px; overflow-y: auto; padding: 10px; margin-top: 15px;
        font-family: 'Courier New', monospace; font-size: 0.75rem; color: #34d399;
        white-space: pre-wrap;
    }
    .log-line { margin-bottom: 4px; border-bottom: 1px dashed #1e293b; padding-bottom: 2px; }
    .log-sys { color: #64748b; }
    .log-result { color: #f472b6; font-weight: bold; }
    .log-err { color: #ef4444; font-weight: bold; }
    .log-input { color: #fff; }

    /* CALCULATOR */
    /* FIX: Ensure calc-input uses full width */
    .calc-input { 
        background: #111; border: 1px solid #333; color: #fff; padding: 15px; border-radius: 6px; 
        font-size: 1.5rem; text-align: right; margin-bottom: 10px; width: 100%; box-sizing: border-box;
    }
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .calc-btn { padding: 15px; background: #1e293b; border: 1px solid #334155; color: #fff; font-size: 1rem; font-weight: bold; border-radius: 6px; cursor: pointer; transition: 0.1s; }
    .calc-btn:hover { background: #334155; }
    .calc-btn-op { background: #0ea5e9; color: #0f172a; }
    .calc-btn-op:hover { background: #38bdf8; }
    .calc-btn-mod { background: #4ade80; color: #0f172a; }
    .calc-btn-mod:hover { background: #71e09c; }
    .calc-btn-init { background: #facc15; color: #0f172a; padding: 18px; font-size: 1.1rem; }
    .calc-btn-init:hover { background: #ffdc58; }
    
    .btn-disabled { background: #0f172a !important; color: #475569 !important; cursor: not-allowed !important; }
    
    /* FIX: Ensure H and C input fields use full panel width */
    .input-val-full { 
        width: 100%; 
        background: transparent; 
        border: none; 
        padding: 0; 
        text-align: center;
    }
</style>
</head>
<body>

<div class="reactor-shell">
    <h1>HOLOGRAPHIC LOGIC UNIT v4.7</h1>
    <div class="sub">Symbolic Arithmetic • Spectral Kernel • Virtual Memory</div>

    <div class="control-group">
        <div>
            <span class="lbl">LOGICAL CORES</span>
            <select id="inpCores">
                <option value="1">1 Core</option>
                <option value="4">4 Cores</option>
                <option value="8" selected>8 Cores</option>
                <option value="16">16 Cores</option>
            </select>
        </div>
        <div>
            <span class="lbl">VIRTUAL RAM (GB)</span>
            <select id="inpRam" disabled>
                <option value="dynamic">Dynamic (Allocated by HOLO^2)</option>
            </select>
        </div>
    </div>

    <div class="dash-grid mb-4">
        <div class="panel">
            <span class="lbl">H EXPONENT (E)</span>
            <input id="inpExp" class="val val-cyan input-val-full" value="1000000000">
        </div>
        <div class="panel">
            <span class="lbl">C CONSTANT (C)</span>
            <input id="inpAdd" class="val val-pink input-val-full" value="61">
        </div>
    </div>
    
    <div class="dash-grid">
        <div class="panel">
            <span class="lbl">ENGINE STATUS</span>
            <div id="statusVal" class="val text-center val-error">OFFLINE</div>
        </div>
        <div class="panel">
            <span class="lbl">VIRTUAL RAM (PAGED)</span>
            <div id="memVal" class="val text-center val-pink">0 MB</div>
        </div>
        <div class="panel" style="grid-column: span 2;">
            <span class="lbl">VECTOR STATE [A, B]</span>
            <div id="vectorValA" class="vector-val text-cyan-400">A: 0</div>
            <div id="vectorValB" class="vector-val text-pink-400">B: 100-1</div>
        </div>
    </div>

    <div class="core-bar-bg"><div id="animBar" class="core-bar"></div></div>
    <div id="thinkingText" class="core-text text-left">System Offline. Click Initialize HLU.</div>

    <input id="calcDisplay" class="calc-input" value="10^2 - 1">
    
    <button id="btnInit" class="calc-btn-init" onclick="initializeHLU()">⚡ Initialize HLU</button>

    <div class="calc-grid mt-4">
        <button class="calc-btn math-btn" onclick="clearDisplay()" disabled>AC</button>
        <button class="calc-btn math-btn" onclick="standardOp('/')" disabled>÷</button>
        <button class="calc-btn math-btn" onclick="standardOp('*')" disabled>×</button>
        <button class="calc-btn-op math-btn" id="btnHoloSquare" onclick="handleSymbolicOperation('HoloSquare')" disabled>HOLO^2</button>

        <button class="calc-btn math-btn" onclick="standardOp('7')" disabled>7</button>
        <button class="calc-btn math-btn" onclick="standardOp('8')" disabled>8</button>
        <button class="calc-btn math-btn" onclick="standardOp('9')" disabled>9</button>
        <button class="calc-btn-op math-btn" onclick="handleSymbolicOperation('HoloMod')" disabled>MOD N</button>

        <button class="calc-btn math-btn" onclick="standardOp('4')" disabled>4</button>
        <button class="calc-btn math-btn" onclick="standardOp('5')" disabled>5</button>
        <button class="calc-btn math-btn" onclick="standardOp('6')" disabled>6</button>
        <button class="calc-btn-mod math-btn" onclick="handleSymbolicOperation('IsPrime')" disabled>IsPrime?</button>

        <button class="calc-btn math-btn" onclick="standardOp('1')" disabled>1</button>
        <button class="calc-btn math-btn" onclick="standardOp('2')" disabled>2</button>
        <button class="calc-btn math-btn" onclick="standardOp('3')" disabled>3</button>
        <button class="calc-btn-op math-btn" onclick="standardOp('-')" disabled>−</button>

        <button class="calc-btn math-btn" onclick="standardOp('0')" disabled>0</button>
        <button class="calc-btn math-btn" onclick="standardOp('.')">.</button>
        <button class="calc-btn math-btn" onclick="standardOp('+')" disabled>+</button>
        <button class="calc-btn-op math-btn" onclick="calculate('Equals')">=</button>
    </div>

    <div id="terminal" class="term-window">
        <div class="log-line log-sys">System Offline. Initialization required.</div>
    </div>
</div>

<script>
// ==========================================
// HLU v4.7 SPECTRAL KERNEL (WORKER CODE)
// ==========================================
const HLU_WORKER_CODE = 
"const MOD = 998244353n;" +
"const ROOT = 3n;" +
"const PAGE_BITS = 24;" + 
"const PAGE_SIZE = 1 << PAGE_BITS;" + 
"const PAGE_MASK = PAGE_SIZE - 1;" +
"const CHUNK_SIZE = 6;" + 
"let V_RAM_MB = 0;" +

"class VirtualVector {" +
"    constructor(size) {" +
"        this.size = size;" +
"        this.numPages = Math.ceil(size / PAGE_SIZE);" +
"        this.pages = [];" +
"        for(let i=0; i<this.numPages; i++) {" +
"            this.pages.push(new Int32Array(PAGE_SIZE).fill(0));" +
"        }" +
"        V_RAM_MB = Math.round((this.numPages * PAGE_SIZE * 4) / 1024 / 1024);" +
"        postMessage({type:'mem', val: V_RAM_MB});" +
"    }" +
"    get(i) { return this.pages[i >>> PAGE_BITS][i & PAGE_MASK]; }" +
"    set(i, val) { this.pages[i >>> PAGE_BITS][i & PAGE_MASK] = val; }" +
"    static fromBigInt(B, size) {" +
"        const vec = new VirtualVector(size);" +
"        let tempB = B;" +
"        let i = 0;" +
"        const MASK = 1000000n;" +
"        while(tempB > 0n && i < size) {" +
"            vec.set(i, Number(tempB % MASK));" +
"            tempB /= MASK;" +
"            i++;" +
"        }" +
"        return vec;" +
"    }" +
"}" +

"function power(a, b) {" +
"    let res = 1n; a %= MOD;" +
"    while (b > 0n) {" +
"        if (b & 1n) res = (res * a) % MOD;" +
"        a = (a * a) % MOD; b >>= 1n;" +
"    }" +
"    return res;" +
"}" +

"function ntt(vec, invert, cores) {" +
"    const n = vec.size;" +
"    let j = 0;" +
"    for (let i = 1; i < n; i++) {" +
"        let bit = n >> 1;" +
"        while (j & bit) { j ^= bit; bit >>= 1; }" +
"        j ^= bit;" +
"        if (i < j) { " +
"            const temp = vec.get(i); " +
"            vec.set(i, vec.get(j)); " +
"            vec.set(j, temp); " +
"        }" +
"    }" +
"    const totalStages = Math.log2(n);" +
"    for (let len = 2; len <= n; len <<= 1) {" +
"        let wlen = power(ROOT, (MOD - 1n) / BigInt(len));" +
"        if (invert) wlen = power(wlen, MOD - 2n);" +
"        const stage = Math.log2(len);" +
"        const block_size = Math.ceil(n / cores);" +
"        for(let core=0; core<cores; core++) {" +
"            const start_i = core * block_size;" +
"            const end_i = Math.min((core + 1) * block_size, n);" +
"            for (let i = start_i; i < end_i; i += len) {" +
"                let w = 1n;" +
"                for (let j = 0; j < len / 2; j++) {" +
"                    const idxU = i + j;" +
"                    const idxV = i + j + len / 2;" +
"                    if (idxV >= n) continue; " +
"                    const u = BigInt(vec.get(idxU));" +
"                    const v = (BigInt(vec.get(idxV)) * w) % MOD;" +
"                    vec.set(idxU, Number((u + v) % MOD));" +
"                    vec.set(idxV, Number((u - v + MOD) % MOD));" +
"                    w = (w * wlen) % MOD;" +
"                }" +
"            }" +
"        }" +
"        postMessage({type:'anim', pct: (stage/totalStages)*100, msg: 'Stage ' + stage + '/' + totalStages + ' (' + cores + ' Cores)'});" +
"    }" +
"    if (invert) {" +
"        const ninv = power(BigInt(n), MOD - 2n);" +
"        for (let i = 0; i < n; i++) {" +
"            vec.set(i, Number((BigInt(vec.get(i)) * ninv) % MOD));" +
"        }" +
"    }" +
"}" +

"function holoSquare(a, b, c) {" +
"    const H2_coeff = a * a;" +
"    const H_coeff = 2n * a * b;" +
"    const C_coeff = b * b;" +
"    let newA = H_coeff + H2_coeff * (-c);" +
"    let newB = C_coeff;" +
"    return [newA, newB];" +
"}" +

"function isProbablePrime(N) {" +
"    if(N < 2n || N === 4n) return false;" +
"    if(N === 2n || N === 3n) return true;" +
"    if(N % 2n === 0n) return false;" +
"    let d = N - 1n;" +
"    let s = 0;" +
"    while (d % 2n === 0n) { d /= 2n; s++; }" +
"    const mr_bases = [2n, 3n, 5n, 7n, 11n, 13n, 17n];" + 
"    for (let i = 0; i < mr_bases.length; i++) {" +
"        const a = mr_bases[i];" +
"        if (a >= N) break;" +
"        postMessage({type:'anim', pct: (i+1)/mr_bases.length*100, msg:'Witness ' + (i+1) + '/' + mr_bases.length + ' (Base ' + a + ')'});" +
"        let x = power(a, d, N);" +
"        if (x === 1n || x === N-1n) continue;" +
"        let composite = true;" +
"        for (let r = 1n; r < s; r++) {" +
"            x = (x * x) % N;" +
"            if (x === N-1n) { composite = false; break; }" +
"        }" +
"        if (composite) return false;" +
"    }" +
"    return true;" +
"}" +

"self.onmessage = function(e) {" +
"    const { cmd, A_str, B_str, exp, add, cores } = e.data;" +
"    try {" +
"        let A = BigInt(A_str);" +
"        let B = BigInt(B_str);" +
"        const EXP = BigInt(exp);" +
"        const C = BigInt(add);" +
"        const CORES = parseInt(cores) || 8;" +
"        postMessage({type:'mem', val: V_RAM_MB});" +
"        if (cmd === 'HoloSquare') {" +
"            postMessage({type:'log', msg:'[OP] HOLO^2: Calculating (A H + B)^2 on ' + CORES + ' Cores...'});" +
"            const [rawA, rawB] = holoSquare(A, B, C);" +
"            const B_len = rawB.toString().length;" +
"            const needed = Math.ceil(B_len / CHUNK_SIZE);" +
"            let size = 1;" +
"            while(size < needed) size <<= 1;" +
"            if(size > (1 << 26)) throw new Error('Vector size exceeds 256M elements. Operation aborted.');" +
"            const vec = VirtualVector.fromBigInt(rawB, size);" +
"            postMessage({type:'log', msg:'[Allocated] B^2 Vector Size: ' + (size/1e6) + 'M elements.', style:'log-sys'});" +
"            ntt(vec, false, CORES);" +
"            for(let i=0; i<size; i++) {" +
"                const v = BigInt(vec.get(i));" +
"                vec.set(i, Number((v*v)%MOD));" +
"            }" +
"            ntt(vec, true, CORES);" +
"            postMessage({type:'result', A: rawA.toString(), B: rawB.toString(), msg:'Holographic Squaring Complete. (Simulated B^2)'});" +
"            return;" +
"        }" +
"        if (cmd === 'HoloMod') {" +
"            postMessage({type:'log', msg:'[OP] MOD N: Applying Holographic Reduction...'});" +
"            let val = B - (A * C);" +
"            A = 0n;" +
"            B = val;" +
"            postMessage({type:'result', A: A.toString(), B: B.toString(), msg:'Holographic Fold Complete.'});" +
"            return;" +
"        }" +
"        if (cmd === 'IsPrime') {" +
"            postMessage({type:'log', msg:'[OP] IsPrime?: Testing N = 10^' + EXP + ' + ' + C + '...'});" +
"            const N_approx = 10n**18n + C;" +
"            postMessage({type:'log', msg:'[Test] Running Miller-Rabin on approximation (N≈10^18 + C)...', style:'log-sys'});" +
"            const isPrime = isProbablePrime(N_approx);" +
"            const msg = isPrime " +
"                ? 'N is PROBABLE PRIME (tested N≈' + N_approx.toString().slice(0,5) + '...)'" +
"                : 'N is COMPOSITE (tested N≈' + N_approx.toString().slice(0,5) + '...)' ;" +
"            const style = isPrime ? 'log-result' : 'log-err';" +
"            postMessage({type:'result', A: A.toString(), B: B.toString(), msg: msg, style: style});" +
"            return;" +
"        }" +
"    } catch(err) {" +
"        postMessage({type:'log', msg: err.message, style:'log-err'});" +
"        postMessage({type:'result', A: A_str, B: B_str, msg:'Operation failed.'});" +
"    } finally {" +
"        postMessage({type:'anim', pct: 0, msg:'Done.'});" +
"    }" +
"};";

let worker = null;
let currentA = 0n;
let currentB = 0n;
let isBusy = false;
let startTime = 0;
let timerInterval = null;

// --- GLOBAL UTILITY FUNCTIONS ---
function log(msg, style='log-line') {
    const term = document.getElementById('terminal');
    const d = document.createElement('div');
    d.className = 'log-line ' + style;
    d.innerText = "> " + msg;
    term.prepend(d);
}

function setBusy(b) {
    isBusy = b;
    const btns = document.querySelectorAll('.math-btn');
    btns.forEach(btn => btn.disabled = b);
    document.getElementById('statusVal').innerText = b ? "BUSY: CORE ACTIVE" : "READY";
    document.getElementById('statusVal').className = b ? "val val-pink" : "val val-green";
    document.getElementById('btnInit').disabled = b;
}

function updateVectorDisplay() {
    document.getElementById('vectorValA').innerText = "A: " + formatBigInt(currentA);
    document.getElementById('vectorValB').innerText = "B: " + formatBigInt(currentB);
}

function formatBigInt(n) {
    let s = n.toString();
    if (s.length > 50) {
        return s.substring(0, 20) + "..." + s.slice(-10) + ` [${s.length} digits]`;
    }
    return s;
}

// FIX: New helper function to evaluate standard arithmetic expressions
function evaluateExpression(str) {
    // This function safely resolves expressions using BigInt.
    str = str.replace(/\s/g, '');
    if (!str) return 0n;
    
    // Check for incomplete expression (operator at the end)
    if (str.endsWith('+') || str.endsWith('-') || str.endsWith('*') || str.endsWith('/')) {
        throw new Error("Incomplete expression.");
    }
    
    // Replace custom symbols for standard JS eval
    let js_str = str.replace(/×/g, '*').replace(/÷/g, '/');
    
    // The core evaluation logic, ensures BigInt for large numbers
    try {
        // Wrap numbers in BigInt() before evaluation
        let result = eval(js_str.replace(/(\d+)/g, 'BigInt($1)'));
        return BigInt(result);
    } catch (e) {
        // Catch parsing errors (e.g., trying to parse '10^2 - ' as a single BigInt)
        throw new Error("Invalid arithmetic expression or unexpected token.");
    }
}


// --- INITIALIZATION FUNCTION ---
window.initializeHLU = function() {
    if (worker) {
        log("HLU Worker already running. Resetting.", 'log-sys');
        worker.terminate();
        worker = null;
    }
    
    document.getElementById('btnInit').disabled = true;
    document.getElementById('btnInit').innerText = "INITIALIZING CORE...";
    
    // 1. Start Worker
    const blob = new Blob([HLU_WORKER_CODE], {type: 'application/javascript'});
    worker = new Worker(URL.createObjectURL(blob));
    log("HLU Worker Thread started.", 'log-sys');

    // 2. Set Initial State from Display
    try {
        // Must evaluate the initial expression before passing a BigInt
        currentB = evaluateExpression(document.getElementById('calcDisplay').value);
        currentA = 0n;
    } catch(e) {
        currentB = 0n; 
        currentA = 0n;
        log("Initial expression failed to evaluate. State B=0.", 'log-err');
    }
    updateVectorDisplay();
    
    // 3. Set up Worker Message Listener
    worker.onmessage = function(e) {
        const d = e.data;
        if(d.type === 'log') log(d.msg, d.style);
        
        if(d.type === 'anim') {
            document.getElementById('animBar').style.width = d.pct + '%';
            document.getElementById('thinkingText').innerText = `CORE 1/${document.getElementById('inpCores').value}: ` + d.msg;
        }
        
        if(d.type === 'mem') {
            document.getElementById('memVal').innerText = d.val + " MB";
        }
        
        if(d.type === 'result') {
            currentA = BigInt(d.A);
            currentB = BigInt(d.B);
            
            const msg = d.msg || "Operation Complete.";
            const style = d.style || 'log-result';
            
            log(msg, style);
            updateVectorDisplay();
            setBusy(false);
            
            // Re-enable init button after a small delay if needed
            document.getElementById('btnInit').disabled = false;
            document.getElementById('btnInit').innerText = "HLU ACTIVE (Ready)";
        }
    };
    
    // 4. Update UI to READY state
    document.querySelectorAll('.math-btn').forEach(btn => btn.disabled = false);
    setBusy(false); 
    document.getElementById('statusVal').innerText = "READY";
    document.getElementById('statusVal').className = "val val-green";
    log("Initialization Complete. HLU is now ready for commands.", 'log-result');
    document.getElementById('btnInit').innerText = "HLU ACTIVE (Ready)";
    document.getElementById('btnInit').disabled = false;
}

// --- DISPLAY/BUTTON LOGIC ---
window.clearDisplay = function() {
    if (isBusy) return;
    document.getElementById('calcDisplay').value = '';
    currentA = 0n;
    currentB = 0n;
    updateVectorDisplay();
    document.getElementById('memVal').innerText = '0 MB';
    document.getElementById('terminal').innerHTML = '<div class="log-line log-sys">Terminal Cleared.</div>';
    log("Symbolic state reset.", 'log-sys');
}

window.standardOp = function(val) {
    if (isBusy || worker === null) { 
        if (worker === null) log("System Offline. Click Initialize HLU first.", 'log-err');
        return;
    }
    const display = document.getElementById('calcDisplay');
    const displayValue = display.value;

    if (val === 'AC') {
        clearDisplay();
        return;
    }
    
    // Standard operator handling: Replace if operator is repeated
    if (['+', '-', '*', '/'].includes(val)) {
        if (['+', '-', '*', '/'].includes(displayValue.slice(-1))) {
            display.value = displayValue.slice(0, -1) + val;
        } else {
            display.value += val;
        }
    } else {
        display.value += val;
    }
}

// FIX: New handler that forces expression resolution before sending to worker
window.handleSymbolicOperation = function(op) {
    if (isBusy || worker === null) {
        if (worker === null) log("System Offline. Click Initialize HLU first.", 'log-err');
        return;
    }
    
    // 1. Resolve expression on the display first (the equals logic)
    try {
        const result = evaluateExpression(document.getElementById('calcDisplay').value);
        currentA = 0n;
        currentB = result;
        document.getElementById('calcDisplay').value = formatBigInt(currentB);
        updateVectorDisplay();
        log(`[RESOLVED] Expression evaluated to B=${formatBigInt(currentB)}.`, 'log-result');
    } catch (e) {
        log(`[ERROR] Failed to resolve expression: ${e.message}`, 'log-err');
        return; // Stop operation if resolution fails
    }

    // 2. Proceed with Worker Operation
    setBusy(true);
    startTime = Date.now();
    
    const EXP = document.getElementById('inpExp').value;
    const ADD = document.getElementById('inpAdd').value;
    const CORES = document.getElementById('inpCores').value;
    
    const commandToPass = {
        cmd: op, 
        A_str: currentA.toString(), 
        B_str: currentB.toString(),
        exp: EXP, 
        add: ADD,
        cores: CORES
    };
    
    log(`[EXEC] ${op} on State A=0 H + B=${currentB.toString().slice(0, 10)}... (Cores: ${CORES})`, 'log-sys');
    worker.postMessage(commandToPass);
}


window.calculate = function(op) {
    if (isBusy || worker === null) {
        if (worker === null) log("System Offline. Click Initialize HLU first.", 'log-err');
        return;
    }
    
    if (op === 'Equals') {
        try {
            const result = evaluateExpression(document.getElementById('calcDisplay').value);
            currentA = 0n;
            currentB = result;
            log(`[Input] ${document.getElementById('calcDisplay').value}`, 'log-input');
            log(`[SET] New State B loaded.`, 'log-result');
            document.getElementById('calcDisplay').value = formatBigInt(currentB);
        } catch(e) {
            log(`[Error] ${e.message}`, 'log-err');
        } finally {
            updateVectorDisplay();
            // Equals is synchronous, no setBusy needed.
        }
        return;
    }
}

// Start UI update loop
window.onload = () => {
    timerInterval = setInterval(() => {
        if(isBusy) {
            const timeDiff = (Date.now() - startTime) / 1000;
            document.getElementById('thinkingText').innerText = `CORE ACTIVE: ${timeDiff.toFixed(2)}s | Running on ${document.getElementById('inpCores').value} Cores...`;
        } else {
            document.getElementById('thinkingText').innerText = 'System Idle. Awaiting command.';
        }
    }, 100);
    
    // Initially disable all math buttons
    document.querySelectorAll('.math-btn').forEach(btn => btn.disabled = true);
};
</script>
</body>
</html>
