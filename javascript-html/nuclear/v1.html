<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Holographic Naked Engine</title>
<style>
    body { background: #000; color: #f00; font-family: 'Courier New', monospace; padding: 20px; }
    .card { border: 1px solid #333; padding: 20px; }
    h1 { margin: 0; text-transform: uppercase; border-bottom: 1px solid #f00; display: inline-block;}
    .log { margin-top: 20px; white-space: pre-wrap; color: #888; font-size: 12px;}
    button { background: #f00; color: #000; border: none; padding: 15px; width: 100%; font-weight: bold; font-size: 1.2rem; cursor: pointer; margin-top: 20px;}
    button:disabled { background: #333; color: #555; }
    .bar { height: 5px; background: #333; margin-top: 10px; }
    .fill { height: 100%; background: #f00; width: 0%; }
</style>
</head>
<body>

<div class="card">
    <h1>Naked Kernel</h1>
    <p style="color:#666; font-size:10px;">WARNING: NO SAFETY RAILS. MAY CRASH BROWSER.</p>
    
    <div>BASE: <input id="base" value="10"></div>
    <div>EXP: <input id="exp" value="1000000000"></div>
    <div>ADD: <input id="add" value="61"></div>

    <div class="bar"><div id="fill" class="fill"></div></div>
    <div id="status">IDLE</div>

    <button id="btn" onclick="run()">EXECUTE RAW MATH</button>
    <div id="log" class="log"></div>
</div>

<script>
const workerCode = `
const MOD = 998244353n;
const ROOT = 3n;

function power(a, b) {
    let res = 1n;
    a %= MOD;
    while (b > 0n) {
        if (b & 1n) res = (res * a) % MOD;
        a = (a * a) % MOD;
        b >>= 1n;
    }
    return res;
}

// RAW NTT - NO YIELDING
function ntt(a, invert) {
    const n = a.length;
    
    // 1. Bit Reversal
    let j = 0;
    for (let i = 1; i < n; i++) {
        let bit = n >> 1;
        while (j & bit) { j ^= bit; bit >>= 1; }
        j ^= bit;
        if (i < j) { const temp = a[i]; a[i] = a[j]; a[j] = temp; }
    }

    // 2. Butterfly
    let stage = 0;
    const totalStages = Math.log2(n);
    
    for (let len = 2; len <= n; len <<= 1) {
        let wlen = power(ROOT, (MOD - 1n) / BigInt(len));
        if (invert) wlen = power(wlen, MOD - 2n);

        for (let i = 0; i < n; i += len) {
            let w = 1n;
            for (let j = 0; j < len / 2; j++) {
                const u = BigInt(a[i + j]);
                const v = (BigInt(a[i + j + len / 2]) * w) % MOD;
                
                // Writing directly to array
                a[i + j] = Number((u + v) % MOD);
                a[i + j + len / 2] = Number((u - v + MOD) % MOD);
                
                w = (w * wlen) % MOD;
            }
        }
        
        // Report ONLY at end of stage to minimize I/O overhead
        stage++;
        postMessage({type:'prog', pct: stage/totalStages});
    }

    if (invert) {
        const ninv = power(BigInt(n), MOD - 2n);
        for (let i = 0; i < n; i++) a[i] = Number((BigInt(a[i]) * ninv) % MOD);
    }
}

self.onmessage = function(e) {
    try {
        const { base, exp, add } = e.data;
        const BASE = BigInt(base);
        const EXP = BigInt(exp);
        
        // 1. CALC SIZE
        const digits = Number(EXP) * Math.log10(Number(BASE));
        const needed = Math.ceil(digits / 9);
        let size = 1;
        while(size < needed) size <<= 1;
        
        postMessage({type:'log', msg:\`Vector Size: \${size}\`});
        postMessage({type:'log', msg:'Allocating...' });
        
        // 2. ALLOCATE REAL RAM
        const vec = new Int32Array(size);
        vec[0] = 2; // Seed
        
        postMessage({type:'log', msg:'Starting Forward NTT...'});
        const t1 = Date.now();
        
        // 3. RUN RAW MATH
        ntt(vec, false);
        
        postMessage({type:'log', msg:\`Forward Done in \${(Date.now()-t1)/1000}s\`});
        
        // 4. SQUARE
        for(let i=0; i<size; i++) {
            const v = BigInt(vec[i]);
            vec[i] = Number((v*v)%MOD);
        }
        
        postMessage({type:'log', msg:'Squaring Done. Inverse NTT...'});
        
        // 5. INVERSE
        const t2 = Date.now();
        ntt(vec, true);
        
        postMessage({type:'log', msg:\`Inverse Done in \${(Date.now()-t2)/1000}s\`});
        postMessage({type:'done'});
        
    } catch(err) {
        postMessage({type:'error', msg:err.message});
    }
};
`;

const blob = new Blob([workerCode], {type:'text/javascript'});
const url = URL.createObjectURL(blob);
let w;

function run() {
    if(w) w.terminate();
    w = new Worker(url);
    
    document.getElementById('log').innerText = "Initializing...";
    document.getElementById('btn').disabled = true;
    
    w.onmessage = e => {
        if(e.data.type === 'log') document.getElementById('log').innerText += "\n" + e.data.msg;
        if(e.data.type === 'prog') {
            document.getElementById('fill').style.width = (e.data.pct * 100) + "%";
            document.getElementById('status').innerText = Math.round(e.data.pct * 100) + "%";
        }
        if(e.data.type === 'error') {
            document.getElementById('log').innerText += "\nERROR: " + e.data.msg;
            document.getElementById('btn').disabled = false;
        }
        if(e.data.type === 'done') {
            document.getElementById('log').innerText += "\nSUCCESS";
            document.getElementById('btn').disabled = false;
            document.getElementById('fill').style.backgroundColor = "#0f0";
        }
    };
    
    w.postMessage({
        base: document.getElementById('base').value,
        exp: document.getElementById('exp').value,
        add: document.getElementById('add').value
    });
}
</script>
</body>
</html>
