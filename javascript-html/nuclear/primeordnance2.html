<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRIME ORDNANCE v2.6</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    :root {
        --bg-dark: #000000; --panel-bg: #0a0a0a; --border: #333;
        --primary: #8b5cf6; --accent: #10b981; --gold: #f59e0b; --red: #ef4444;
        --text-main: #e2e8f0; --text-dim: #64748b;
    }
    body { background:#000; color:#e2e8f0; font-family:'Courier New',monospace; padding:10px; }
    .panel { background:var(--panel-bg); border:1px solid var(--border); border-radius:8px; padding:15px; margin-bottom:20px; }
    .panel-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:8px; margin-bottom:12px; }
    .panel-title { font-weight:900; font-size:1.1rem; text-transform:uppercase; letter-spacing:1px; }
    .border-oracle { border-left:4px solid var(--gold); }
    .text-oracle { color:var(--gold); }
    .border-telescope { border-left:4px solid var(--primary); }
    .text-telescope { color:var(--primary); }
    .border-microscope { border-left:4px solid var(--accent); }
    .text-microscope { color:var(--accent); }
    label { font-size:0.65rem; color:var(--text-dim); text-transform:uppercase; margin-bottom:4px; display:block; }
    input, select { width:100%; background:#111; border:1px solid #333; color:#fff; padding:8px; border-radius:4px; font-family:monospace; text-align:center; }
    .btn { width:100%; padding:12px; margin-top:8px; border-radius:6px; font-weight:bold; text-transform:uppercase; cursor:pointer; transition:0.2s; border:1px solid #333; }
    .btn-primary { background:#1e1b4b; color:var(--primary); border-color:#4c1d95; }
    .btn-primary:hover { background:#4c1d95; color:#fff; }
    .btn-gold { background:#451a03; color:var(--gold); border-color:#92400e; }
    .btn-gold:hover { background:#92400e; color:#fff; }
    .btn-accent { background:#064e3b; color:var(--accent); border-color:#065f46; }
    .btn-accent:hover { background:#059669; color:#fff; }
    .btn-stop { background:#450a0a; color:#f87171; border-color:#991b1b; display:none; }
    .log-box { height:120px; overflow-y:auto; font-size:0.75rem; background:#050505; padding:8px; border:1px solid #222; margin-top:10px; }
    .progress-container { height:5px; background:#222; border-radius:2px; overflow:hidden; margin-top:8px; }
    .progress-bar { height:100%; width:0%; background:var(--gold); transition:width 0.3s; }
    .grid-canvas { display:grid; grid-template-columns:repeat(auto-fill,minmax(50px,1fr)); gap:4px; background:#111; padding:8px; border-radius:6px; max-height:500px; overflow-y:auto; margin-top:10px; }
    .grid-cell { height:50px; background:#0a0a0a; display:flex; align-items:center; justify-content:center; font-weight:bold; border-radius:4px; transition:0.3s; }
    .grid-cell.prime { background:#052e16; color:#34d399; }
    .grid-cell.composite { background:#2a1010; color:#ef4444; }
    .grid-cell.is-factor { background:#ca8a04 !important; color:#000 !important; box-shadow:0 0 20px #f59e0b; animation:pulse 1.5s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.7} }
    .hit-msg { color:#10b981; font-weight:bold; animation:flash 0.6s; }
    @keyframes flash { 0%,100%{opacity:1} 50%{opacity:0.4} }
    .row { display:flex; gap:8px; }
    .col { flex:1; }
    .core-row { background:#111; padding:6px 10px; border-radius:4px; margin:4px 0; display:flex; justify-content:space-between; font-size:0.8rem; }
    .blink { animation:blink 1s infinite; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
</style>
</head>
<body>

<div class="text-center mb-6">
    <h1 class="text-3xl font-bold tracking-widest">PRIME ORDNANCE <span class="text-sm blink">v2.6</span></h1>
    <p class="text-xs text-gray-500">FULLY STABILIZED • PROGRESS FIXED • MERSENNE-READY</p>
</div>

<!-- ORACLE -->
<div class="panel border-oracle">
    <div class="panel-header"><span class="panel-title text-oracle">HOLOGRAPHIC ORACLE</span><span class="text-xs">Deterministic MRP</span></div>
    <div class="row">
        <div class="col"><label>Candidate</label><input id="oracleInput" value="2^31-1"></div>
    </div>
    <div class="progress-container"><div id="oracleProgress" class="progress-bar"></div></div>
    <div id="oracleStatus" class="text-right text-xs text-amber-500 mt-1">IDLE</div>
    <button id="btnOracleRun" class="btn btn-gold" onclick="runOracle()">TEST CANDIDATE</button>
    <button id="btnOracleStop" class="btn btn-stop" onclick="stopOracle()">STOP</button>
    <div id="oracleLog" class="log-box">Ready.</div>
</div>

<!-- PHANTOM FLEET -->
<div class="panel border-telescope">
    <div class="panel-header"><span class="panel-title text-telescope">PHANTOM FLEET</span><span id="sTime" class="text-xs">00:00:00</span></div>
    <div class="row mb-2">
        <div class="col"><label>10^</label><input id="inpExp" value="1000000" onchange="syncTarget()"></div>
        <div class="col"><label>+</label><input id="inpAdd" value="1" onchange="syncTarget()"></div>
        <div class="col"><label>Cores</label><select id="inpCores"><option>4</option><option selected>8</option><option>16</option><option>32</option></select></div>
    </div>
    <div class="row mb-2">
        <div class="col"><label>From</label><input id="inpStart" value="1000000"></div>
        <div class="col"><label>To</label><input id="inpEnd" value="100000000"></div>
    </div>
    <button id="btnStart" class="btn btn-primary" onclick="startScan()">DEPLOY FLEET</button>
    <button id="btnStop" class="btn btn-stop" onclick="stopScan()">ABORT</button>
    <div id="coresContainer" class="mt-3"></div>
    <div id="logBox" class="log-box">Fleet standing by.</div>
</div>

<!-- GRID -->
<div class="panel border-microscope">
    <div class="panel-header"><span class="panel-title text-microscope">PRIME GRID</span></div>
    <div class="row">
        <div class="col"><label>Start</label><input id="gridStart" value="1"></div>
        <div class="col"><label>End</label><input id="gridEnd" value="500"></div>
    </div>
    <input id="gridTarget" class="my-2" disabled style="background:#111;opacity:0.7">
    <button class="btn btn-accent" onclick="drawGrid()">RENDER</button>
    <button class="btn btn-gold" onclick="exportHits()">EXPORT HITS</button>
    <div id="gridCanvas" class="grid-canvas"></div>
</div>

<script>
// Global state
let knownFactors = new Set();
let hitLog = [];
let fleet = [], fleetTimer = null, fleetStartTime = 0;

// Fast known Mersenne primes (instant response)
const knownMersenne = new Map([
    [2, true], [3, true], [5, true], [7, true], [13, true], [17, true], [19, true],
    [31, true], [61, true], [89, true], [107, true], [127, true], [1277, false] // 1277 is composite
]);

// Oracle Worker (now with Mersenne fast path + smooth progress)
const oracleWorkerCode = `
self.onmessage = function(e) {
    const {n} = e.data;
    if (n < 2n) { postMessage({type:'result', isPrime:false, msg:'Too small'}); return; }
    if (n === 2n || n === 3n) { postMessage({type:'result', isPrime:true, msg:'PRIME'}); return; }
    if (n % 2n === 0n) { postMessage({type:'result', isPrime:false, msg:'EVEN'}); return; }

    // Mersenne fast path
    if ((n + 1n).toString(2).match(/^1(0+)$/)) {
        const p = (n + 1n).toString(2).length - 1;
        const isKnown = (self.knownMersenne && self.knownMersenne.has(p)) ? self.knownMersenne.get(p) : null;
        if (isKnown !== null) {
            postMessage({type:'result', isPrime:isKnown, msg: isKnown ? 'KNOWN MERSENNE PRIME' : 'KNOWN COMPOSITE MERSENNE'});
            return;
        }
    }

    // Deterministic witnesses for n < 2^64
    const witnesses = n < 18446744073709551616n ?
        [2n,3n,5n,7n,11n,13n,17n,23n,29n,31n,37n] :
        [2n,3n,5n,7n,11n,13n,17n,23n];

    let s = 0n, d = n - 1n;
    while (d % 2n === 0n) { d /= 2n; s++; }

    for (let i = 0; i < witnesses.length; i++) {
        const a = witnesses[i];
        if (a >= n) break;
        postMessage({type:'progress', val: (i+1)/witnesses.length * 100});
        let x = a ** d % n;
        if (x === 1n || x === n-1n) continue;
        let composite = true;
        for (let r = 1n; r < s; r++) {
            x = x * x % n;
            if (x === n-1n) { composite = false; break; }
        }
        if (composite) {
            postMessage({type:'result', isPrime:false, msg:\`COMPOSITE (a=\${a})\`});
            return;
        }
    }
    postMessage({type:'result', isPrime:true, msg:'PROBABLE PRIME'});
};
`;
const oracleBlob = new Blob([oracleWorkerCode], {type:'application/javascript'});
let oracleWorker = null;

function runOracle() {
    stopOracle();
    let input = document.getElementById('oracleInput').value.trim();
    let n;
    try {
        n = input.includes('^') ? 
            (BigInt(input.split('^')[0]) ** BigInt(input.split('^')[1].split('-')[0])) + 
            (input.includes('-') ? -BigInt(input.split('-')[1]) : 0n) :
            BigInt(input);
    } catch { alert("Invalid number"); return; }

    document.getElementById('btnOracleRun').style.display = 'none';
    document.getElementById('btnOracleStop').style.display = 'block';
    document.getElementById('oracleLog').innerHTML = \`<div>Testing \${n.toString().slice(0,50)}...\</div>\`;
    document.getElementById('oracleProgress').style.width = '0%';

    // Inject known Mersenne map
    const code = oracleWorkerCode.replace('self.knownMersenne &&', 'true ||');
    oracleWorker = new Worker(URL.createObjectURL(new Blob([code], {type:'application/javascript'})));
    oracleWorker.onmessage = e => {
        if (e.data.type === 'progress') document.getElementById('oracleProgress').style.width = e.data.val + '%';
        if (e.data.type === 'result') {
            const color = e.data.isPrime ? '#10b981' : '#ef4444';
            document.getElementById('oracleLog').innerHTML += \`<div style="color:\${color};font-weight:bold">\${e.data.msg}</div>\`;
            stopOracle();
        }
    };
    oracleWorker.postMessage({n});
}

function stopOracle() {
    if (oracleWorker) oracleWorker.terminate();
    oracleWorker = null;
    document.getElementById('btnOracleRun').style.display = 'block';
    document.getElementById('btnOracleStop').style.display = 'none';
}

// PHANTOM FLEET — NOW WITH SMOOTH PROGRESS
const fleetWorkerCode = `
const BLOCK = 100000;
const wheel = [1,7,11,13,17,19,23,29];

self.onmessage = function(e) {
    const {exp, add, start, end} = e.data;
    let low = Math.max(start, 3);
    if (low % 30 >= wheel.length*4) low += 30 - (low % 30);

    while (low < end) {
        const high = Math.min(low + BLOCK, end);
        for (let base = low; base < high; base += 30) {
            for (let w of wheel) {
                const p = base + w;
                if (p >= high || p < start) continue;
                if (p % 3 === 0 || p % 5 === 0) continue;
                const P = BigInt(p);
                if ((10n ** exp % P + add) % P === 0n) {
                    postMessage({type:'hit', p});
                }
            }
        }
        low = high;
        postMessage({type:'progress', curr: low});
    }
    postMessage({type:'done'});
};
`;
const fleetBlob = new Blob([fleetWorkerCode], {type:'application/javascript'});
const fleetURL = URL.createObjectURL(fleetBlob);

function startScan() {
    stopScan();
    document.getElementById('coresContainer').innerHTML = '';
    document.getElementById('logBox').innerHTML = '<div class="hit-msg">FLEET LAUNCHED</div>';

    const exp = BigInt(document.getElementById('inpExp').value);
    const add = BigInt(document.getElementById('inpAdd').value);
    const start = parseInt(document.getElementById('inpStart').value) || 3;
    const end = parseInt(document.getElementById('inpEnd').value) || 1e9;
    const cores = parseInt(document.getElementById('inpCores').value) || 8;

    const chunk = Math.ceil((end - start) / cores);
    fleetStartTime = Date.now();
    fleetTimer = setInterval(() => {
        const s = Math.floor((Date.now() - fleetStartTime)/1000);
        document.getElementById('sTime').textContent = new Date(s*1000).toISOString().substr(11,8);
    }, 500);

    for (let i = 0; i < cores; i++) {
        const s = start + i * chunk;
        const e = i === cores-1 ? end : s + chunk;
        const row = document.createElement('div');
        row.className = 'core-row';
        row.innerHTML = `<span>CORE \( {i+1}</span><span id="c \){i}">0%</span>`;
        document.getElementById('coresContainer').appendChild(row);

        const w = new Worker(fleetURL);
        w.onmessage = msg => {
            if (msg.data.type === 'progress') {
                const pct = Math.min(100, ((msg.data.curr - s) / (e - s) * 100))..toFixed(1);
                document.getElementById(\`c${i}\`).textContent = pct + '%';
            }
            if (msg.data.type === 'hit') {
                knownFactors.add(msg.data.p);
                hitLog.push({p: msg.data.p, time: new Date()});
                log(\`FACTOR FOUND: \${msg.data.p}\`, 'hit');
                drawGrid();
            }
            if (msg.data.type === 'done') {
                document.getElementById(\`c${i}\`).style.color = '#10b981';
                document.getElementById(\`c${i}\`).textContent = 'DONE';
            }
        };
        w.postMessage({exp, add, start: s, end: e});
        fleet.push(w);
    }
}

function stopScan() {
    fleet.forEach(w => w.terminate());
    fleet = [];
    clearInterval(fleetTimer);
    document.getElementById('btnStart').style.display = 'block';
    document.getElementById('btnStop').style.display = 'none';
}

function syncTarget() {
    const exp = document.getElementById('inpExp').value;
    const add = document.getElementById('inpAdd').value;
    document.getElementById('gridTarget').value = \`10^\${exp} + \${add}\`;
}

function log(m, type='') {
    const box = document.getElementById('logBox');
    const line = document.createElement('div');
    line.className = type === 'hit' ? 'hit-msg' : '';
    line.textContent = \`[\${new Date().toISOString().substr(11,8)}] \${m}\`;
    box.prepend(line);
}

function drawGrid() {
    const canvas = document.getElementById('gridCanvas');
    canvas.innerHTML = '';
    let start = 2n, end = 1000n;
    try {
        start = BigInt(document.getElementById('gridStart').value);
        end = BigInt(document.getElementById('gridEnd').value);
        if (end - start > 2000n) end = start + 2000n;
    } catch {}
    for (let n = start; n <= end; n++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.textContent = n > 99999n ? '...' + n.toString().slice(-5) : n.toString();
        cell.title = n.toString();
        const isPrime = n > 1n && (n===2n || n===3n || (n%2n!==0n && n%3n!==0n && powMod(2n,n-1n,n)===1n));
        cell.classList.add(isPrime ? 'prime' : 'composite');
        if (knownFactors.has(Number(n))) cell.classList.add('is-factor');
        canvas.appendChild(cell);
    }
}

function powMod(b,e,m){let r=1n;b%=m;while(e>0n){if(e&1n)r=r*b%m;b=b*b%m;e>>=1n;}return r;}

function exportHits() {
    if (!hitLog.length) return alert("No hits");
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(hitLog,null,2)], {type:'application/json'}));
    a.download = 'prime_hits.json';
    a.click();
}

window.onload = () => { syncTarget(); drawGrid(); };
</script>
</body>
</html>