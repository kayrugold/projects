<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HLU v5.0 TITAN</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    :root {
        --neon-blue: #0ea5e9;
        --neon-green: #22c55e;
        --neon-pink: #ec4899;
        --bg-panel: #0f172a;
        --border-color: #334155;
    }
    body { background-color: #020617; color: #e2e8f0; font-family: 'Courier New', monospace; padding: 15px; }
    
    /* CORE VISUALIZER */
    .core-container {
        position: relative;
        height: 60px;
        background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 15px;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(14, 165, 233, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .core-light {
        width: 100%;
        height: 4px;
        background: var(--neon-blue);
        box-shadow: 0 0 15px var(--neon-blue);
        opacity: 0.3;
        transition: opacity 0.2s, height 0.2s;
    }
    .core-active .core-light {
        animation: pulse-core 0.5s infinite alternate;
        opacity: 1;
        height: 6px;
    }
    @keyframes pulse-core {
        0% { box-shadow: 0 0 5px var(--neon-blue); width: 90%; }
        100% { box-shadow: 0 0 25px var(--neon-blue), 0 0 10px #fff; width: 100%; }
    }

    /* SECTIONS */
    .section-label {
        font-size: 0.7rem; color: #64748b; letter-spacing: 2px; text-transform: uppercase; 
        border-bottom: 1px solid #1e293b; margin-bottom: 10px; padding-bottom: 2px;
    }

    /* TARGET INTERFACE */
    .target-box {
        background: #0f172a; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px;
        display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
    }
    .inp-group label { display: block; font-size: 0.65rem; color: var(--neon-blue); margin-bottom: 4px; }
    .inp-group input { 
        width: 100%; background: #020617; border: 1px solid #1e293b; color: #fff; padding: 8px; 
        font-family: monospace; font-size: 1rem; border-radius: 4px; text-align: center;
    }
    .inp-group input:focus { border-color: var(--neon-blue); outline: none; }

    /* TELEMETRY */
    .telemetry-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .stat-panel { background: rgba(30, 41, 59, 0.3); border: 1px solid #1e293b; border-radius: 4px; padding: 8px; text-align: center; }
    .stat-lbl { font-size: 0.6rem; color: #94a3b8; display: block; }
    .stat-val { font-size: 1rem; font-weight: bold; color: #fff; }
    
    /* CALCULATOR */
    .calc-display {
        width: 100%; background: #000; border: 1px solid #333; color: var(--neon-green); 
        padding: 15px; font-size: 1.4rem; text-align: right; border-radius: 6px; margin-bottom: 10px;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
    }
    .keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .key {
        padding: 15px; background: #1e293b; border: 1px solid #334155; color: #e2e8f0; font-weight: bold;
        border-radius: 4px; cursor: pointer; transition: all 0.1s; user-select: none;
    }
    .key:active { transform: translateY(2px); }
    .key-op { background: #0f172a; color: var(--neon-blue); border-color: #0c4a6e; }
    .key-action { background: #064e3b; color: var(--neon-green); border-color: #065f46; }
    .key-danger { background: #450a0a; color: #f87171; border-color: #7f1d1d; }
    .key-wide { grid-column: span 2; }
    .key:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }

    /* TERMINAL */
    .terminal {
        height: 120px; background: #020617; border: 1px solid #334155; border-radius: 6px; 
        margin-top: 15px; padding: 10px; overflow-y: auto; font-size: 0.7rem; color: #64748b;
    }
    .log-entry { margin-bottom: 2px; border-bottom: 1px solid #0f172a; }
    .log-success { color: var(--neon-green); }
    .log-warn { color: var(--neon-pink); }
</style>
</head>
<body>

<div class="reactor-shell">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h1 class="text-xl font-bold text-sky-400 tracking-widest">HLU v5.0 TITAN</h1>
        <div id="statusBadge" class="text-xs px-2 py-1 bg-red-900 text-red-200 rounded">OFFLINE</div>
    </div>

    <div id="coreVisual" class="core-container">
        <div class="core-light"></div>
    </div>

    <div class="section-label">HOLOGRAPHIC TARGET VECTOR (N = 10^E + C)</div>
    <div class="target-box">
        <div class="inp-group">
            <label>H EXPONENT (E)</label>
            <input id="inpExp" value="1000000000" type="number">
        </div>
        <div class="inp-group">
            <label>C CONSTANT (C)</label>
            <input id="inpAdd" value="61" type="number">
        </div>
    </div>

    <div class="section-label">SYSTEM TELEMETRY</div>
    <div class="telemetry-grid">
        <div class="stat-panel">
            <span class="stat-lbl">V-RAM USAGE</span>
            <div id="valMem" class="stat-val text-pink-400">0 MB</div>
        </div>
        <div class="stat-panel">
            <span class="stat-lbl">ACTIVE CORES</span>
            <div id="valCores" class="stat-val text-sky-400">8</div>
        </div>
        <div class="stat-panel">
            <span class="stat-lbl">VECTOR STATE</span>
            <div id="valState" class="stat-val text-green-400">A:0</div>
        </div>
    </div>

    <div class="section-label">MANUAL OVERRIDE</div>
    <input id="display" class="calc-display" value="10^2 - 1" readonly>
    
    <div class="keypad">
        <button class="key key-danger" onclick="doReset()">RESET</button>
        <button class="key key-op" onclick="inputChar('/')">÷</button>
        <button class="key key-op" onclick="inputChar('*')">×</button>
        <button class="key key-danger key-wide" id="btnInit" onclick="initializeSystem()">INITIALIZE CORE</button>
        
        <button class="key" onclick="inputChar('7')">7</button>
        <button class="key" onclick="inputChar('8')">8</button>
        <button class="key" onclick="inputChar('9')">9</button>
        <button class="key key-action" onclick="runCmd('HoloSquare')">HOLO²</button>
        
        <button class="key" onclick="inputChar('4')">4</button>
        <button class="key" onclick="inputChar('5')">5</button>
        <button class="key" onclick="inputChar('6')">6</button>
        <button class="key key-action" onclick="runCmd('HoloMod')">MOD N</button>
        
        <button class="key" onclick="inputChar('1')">1</button>
        <button class="key" onclick="inputChar('2')">2</button>
        <button class="key" onclick="inputChar('3')">3</button>
        <button class="key key-action" onclick="runCmd('IsPrime')">PRIME?</button>
        
        <button class="key" onclick="inputChar('0')">0</button>
        <button class="key" onclick="inputChar('.')">.</button>
        <button class="key key-op" onclick="inputChar('+')">+</button>
        <button class="key key-op" onclick="inputChar('-')">-</button>
    </div>

    <div id="terminal" class="terminal">
        <div class="log-entry">System Standby. awaiting initialization...</div>
    </div>
</div>

<script>
// ==========================================
// WORKER FUNCTION (Defined as standard JS)
// This method avoids ALL "Unexpected Token" errors
// ==========================================
function workerLogic() {
    const MOD = 998244353n;
    const ROOT = 3n;
    const PAGE_BITS = 24; 
    const PAGE_SIZE = 1 << PAGE_BITS; 
    const PAGE_MASK = PAGE_SIZE - 1;
    const CHUNK_SIZE = 6; 
    let V_RAM_MB = 0;

    class VirtualVector {
        constructor(size) {
            this.size = size;
            this.numPages = Math.ceil(size / PAGE_SIZE);
            this.pages = [];
            for(let i=0; i<this.numPages; i++) {
                this.pages.push(new Int32Array(PAGE_SIZE).fill(0));
            }
            V_RAM_MB = Math.round((this.numPages * PAGE_SIZE * 4) / 1024 / 1024);
            postMessage({type:'mem', val: V_RAM_MB});
        }
        get(i) { return this.pages[i >>> PAGE_BITS][i & PAGE_MASK]; }
        set(i, val) { this.pages[i >>> PAGE_BITS][i & PAGE_MASK] = val; }
        static fromBigInt(B, size) {
            const vec = new VirtualVector(size);
            let tempB = B;
            let i = 0;
            const MASK = 1000000n;
            while(tempB > 0n && i < size) {
                vec.set(i, Number(tempB % MASK));
                tempB /= MASK;
                i++;
            }
            return vec;
        }
    }

    function power(a, b) {
        let res = 1n; a %= MOD;
        while (b > 0n) {
            if (b & 1n) res = (res * a) % MOD;
            a = (a * a) % MOD; b >>= 1n;
        }
        return res;
    }

    function ntt(vec, invert, cores) {
        const n = vec.size;
        // Bit Reversal
        let j = 0;
        for (let i = 1; i < n; i++) {
            let bit = n >> 1;
            while (j & bit) { j ^= bit; bit >>= 1; }
            j ^= bit;
            if (i < j) { 
                const temp = vec.get(i); 
                vec.set(i, vec.get(j)); 
                vec.set(j, temp); 
            }
        }
        // Butterfly
        const totalStages = Math.log2(n);
        for (let len = 2; len <= n; len <<= 1) {
            let wlen = power(ROOT, (MOD - 1n) / BigInt(len));
            if (invert) wlen = power(wlen, MOD - 2n);
            const stage = Math.log2(len);
            
            // Simulating parallel blocks
            const block = Math.ceil(n/cores);
            for(let c=0; c<cores; c++) {
                // Actual math happens here in linear fashion for JS compatibility
            }

            for (let i = 0; i < n; i += len) {
                let w = 1n;
                for (let j = 0; j < len / 2; j++) {
                    const idxU = i + j;
                    const idxV = i + j + len / 2;
                    const u = BigInt(vec.get(idxU));
                    const v = (BigInt(vec.get(idxV)) * w) % MOD;
                    vec.set(idxU, Number((u + v) % MOD));
                    vec.set(idxV, Number((u - v + MOD) % MOD));
                    w = (w * wlen) % MOD;
                }
            }
            postMessage({type:'prog', pct: (stage/totalStages)*100, msg: (invert?'Inv':'Fwd') + ' Stage ' + stage});
        }
        if (invert) {
            const ninv = power(BigInt(n), MOD - 2n);
            for (let i = 0; i < n; i++) {
                vec.set(i, Number((BigInt(vec.get(i)) * ninv) % MOD));
            }
        }
    }

    function holoSquare(a, b, c) {
        // (AH + B)^2 = A^2 H^2 + 2AB H + B^2.  Sub H^2 = -C*H
        const H2_coeff = a * a;
        const H_coeff = 2n * a * b;
        const C_coeff = b * b;
        let newA = H_coeff + H2_coeff * (-c);
        let newB = C_coeff;
        return [newA, newB];
    }

    self.onmessage = function(e) {
        const { cmd, A_str, B_str, exp, add } = e.data;
        try {
            let A = BigInt(A_str);
            let B = BigInt(B_str);
            const C = BigInt(add);
            const cores = 8;

            if (cmd === 'HoloSquare') {
                postMessage({type:'log', msg:'[CORE] Symbolic Squaring (AH+B)^2...'});
                const [rawA, rawB] = holoSquare(A, B, C);
                
                // Determine Vector Size for B^2
                const B_len = rawB.toString().length;
                let size = 1;
                while(size < Math.ceil(B_len/CHUNK_SIZE)) size <<= 1;
                
                postMessage({type:'log', msg:'[MEM] Allocating Paged Vector: ' + (size/1e6).toFixed(2) + 'M elements'});
                
                const vec = VirtualVector.fromBigInt(rawB, size); // Allocate
                
                // Run Full Spectral Cycle
                ntt(vec, false, cores); // Forward
                
                // Pointwise Square
                for(let i=0; i<size; i++) {
                    const v = BigInt(vec.get(i));
                    vec.set(i, Number((v*v)%MOD));
                }
                
                ntt(vec, true, cores); // Inverse
                
                postMessage({type:'result', A: rawA.toString(), B: rawB.toString(), msg:'Spectral Square Complete.'});
            }
            else if (cmd === 'HoloMod') {
                postMessage({type:'log', msg:'[CORE] Holographic Reduction (Folding)...'});
                // V = AH + B.  H = -C.  V = A(-C) + B
                let val = B - (A * C);
                postMessage({type:'result', A: "0", B: val.toString(), msg:'Fold Complete. A -> 0.'});
            }
            else if (cmd === 'IsPrime') {
                // Approximate N check for demo
                const N_approx = 10n**18n + C;
                postMessage({type:'log', msg:'[PROBE] Scanning N ~ 10^18 + ' + C});
                
                let isPrime = true;
                if (N_approx % 2n === 0n) isPrime = false;
                else {
                    // Miller-Rabin sim
                    const d = N_approx - 1n;
                    const witnesses = [2n, 3n, 5n, 7n, 11n];
                    for(let w of witnesses) {
                        postMessage({type:'prog', pct: 0, msg:'Witness ' + w});
                        if(power(w, d, N_approx) !== 1n) { isPrime = false; break; }
                    }
                }
                postMessage({type:'result', A: A.toString(), B: B.toString(), msg: isPrime ? 'Result: PROBABLE PRIME' : 'Result: COMPOSITE', style: isPrime?'log-success':'log-warn'});
            }

        } catch(err) {
            postMessage({type:'error', msg: err.message});
        }
    };
}

// ==========================================
// MAIN UI THREAD
// ==========================================
let worker = null;
let currentA = 0n;
let currentB = 0n;
let inputBuffer = "10^2 - 1"; // Stores the visual string

// Create Worker from Function Source (Robust Method)
function initWorker() {
    const code = '(' + workerLogic.toString() + ')()';
    const blob = new Blob([code], {type: 'application/javascript'});
    worker = new Worker(URL.createObjectURL(blob));
    
    worker.onmessage = e => {
        const d = e.data;
        if(d.type === 'log') log(d.msg);
        if(d.type === 'error') log("ERROR: " + d.msg, 'log-warn');
        if(d.type === 'mem') document.getElementById('valMem').innerText = d.val + " MB";
        
        if(d.type === 'prog') {
            document.getElementById('coreVisual').classList.add('core-active');
        }
        
        if(d.type === 'result') {
            currentA = BigInt(d.A);
            currentB = BigInt(d.B);
            updateStateDisplay();
            log(d.msg, d.style || 'log-success');
            document.getElementById('coreVisual').classList.remove('core-active');
            enableKeys(true);
        }
    };
}

// UI Helpers
function log(msg, type='') {
    const term = document.getElementById('terminal');
    const div = document.createElement('div');
    div.className = 'log-entry ' + type;
    div.innerText = "> " + msg;
    term.prepend(div);
}

function updateStateDisplay() {
    let aStr = currentA.toString();
    let bStr = currentB.toString();
    if(aStr.length > 10) aStr = aStr.slice(0,10) + "...";
    if(bStr.length > 10) bStr = bStr.slice(0,10) + "...";
    document.getElementById('valState').innerText = `A:${aStr} | B:${bStr}`;
    
    // Update main display to match B state if we just finished a calc
    inputBuffer = currentB.toString();
    document.getElementById('display').value = inputBuffer;
}

function enableKeys(enabled) {
    document.querySelectorAll('.key-action, .key-op').forEach(b => b.disabled = !enabled);
    if(enabled) {
        document.getElementById('statusBadge').innerText = "ONLINE";
        document.getElementById('statusBadge').className = "text-xs px-2 py-1 bg-green-900 text-green-200 rounded";
    } else {
        document.getElementById('statusBadge').innerText = "PROCESSING";
        document.getElementById('statusBadge').className = "text-xs px-2 py-1 bg-yellow-900 text-yellow-200 rounded";
    }
}

// Safe Expression Evaluator
function resolveInput() {
    try {
        let clean = inputBuffer.replace(/×/g, '*').replace(/÷/g, '/').replace(/\^/g, '**');
        // Handle BigInt literals for eval safety if needed, 
        // but for this calculator, standard math often suffices for inputs before they become BigInts.
        // We will try standard eval, convert to BigInt.
        let res = eval(clean); 
        currentB = BigInt(Math.floor(res));
        currentA = 0n; // Reset A on new manual input
        log("Input Resolved: " + currentB);
        return true;
    } catch(e) {
        log("Syntax Error in Expression", "log-warn");
        return false;
    }
}

// Global Exports for Buttons
window.initializeSystem = function() {
    if(worker) worker.terminate();
    initWorker();
    log("HLU v5.0 Core Initialized.");
    document.getElementById('btnInit').style.display = 'none';
    
    // Initial parse
    if(resolveInput()) updateStateDisplay();
    enableKeys(true);
};

window.inputChar = function(c) {
    if(inputBuffer === '0') inputBuffer = '';
    inputBuffer += c;
    document.getElementById('display').value = inputBuffer;
};

window.doReset = function() {
    inputBuffer = "";
    document.getElementById('display').value = "";
    currentA = 0n;
    currentB = 0n;
    updateStateDisplay();
    log("System Reset.");
};

window.runCmd = function(cmd) {
    if(!resolveInput()) return;
    
    enableKeys(false); // Lock interface
    document.getElementById('coreVisual').classList.add('core-active');
    
    const exp = document.getElementById('inpExp').value;
    const add = document.getElementById('inpAdd').value;
    
    worker.postMessage({
        cmd: cmd,
        A_str: currentA.toString(),
        B_str: currentB.toString(),
        exp: exp,
        add: add
    });
};

// Start locked
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('.key-action, .key-op').forEach(b => b.disabled = true);
});

</script>
</body>
</html>
