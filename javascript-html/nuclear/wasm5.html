<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mersenne Hunter: Director's Cut</title>
    <style>
        :root { --bg: #020617; --card: #1e293b; --accent: #0ea5e9; --green: #22c55e; --red: #ef4444; --text: #f1f5f9; }
        body { font-family: 'Segoe UI', system-ui, monospace; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .dashboard { background: var(--card); width: 100%; max-width: 700px; border-radius: 16px; border: 1px solid #334155; padding: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7); }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 1px solid #334155; padding-bottom: 16px; }
        h1 { margin: 0; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); }
        .badge { font-size: 0.75rem; background: #0f172a; padding: 4px 10px; border-radius: 99px; border: 1px solid #334155; color: #94a3b8; font-weight: bold; }
        
        /* Status Indicators */
        .spinner { width: 12px; height: 12px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); animation: pulse 1.5s infinite; display: none; }
        .spinner.active { display: block; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* Input */
        .input-group { margin-bottom: 20px; position: relative; }
        label { display: block; font-size: 0.8rem; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; font-weight: bold; }
        input { width: 100%; background: #0f172a; border: 1px solid #475569; padding: 14px; color: white; border-radius: 8px; font-family: monospace; font-size: 1.2rem; box-sizing: border-box; }
        input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2); }

        /* Telemetry Grid */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .stat-card { background: #0f172a; padding: 16px; border-radius: 10px; border: 1px solid #334155; text-align: center; }
        .stat-title { display: block; font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 1px; }
        .stat-val { font-size: 1.1rem; font-weight: bold; font-family: monospace; }
        .blue { color: var(--accent); } .green { color: var(--green); }

        /* Progress Bar */
        .bar-track { height: 8px; background: #334155; border-radius: 4px; overflow: hidden; margin-bottom: 24px; }
        .bar-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.2s; }

        /* Log */
        .console { background: #000; border: 1px solid #334155; border-radius: 8px; height: 180px; overflow-y: auto; padding: 16px; font-family: monospace; font-size: 0.85rem; color: #33da78; margin-bottom: 20px; white-space: pre-wrap; line-height: 1.4; }

        /* Controls */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button { padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.9rem; transition: filter 0.2s; color: #0f172a; }
        button:hover:not(:disabled) { filter: brightness(1.1); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--green); }
        .btn-danger { background: var(--red); color: white; }
        .btn-secondary { background: var(--accent); }
        .file-btn { position: relative; overflow: hidden; background: #8b5cf6; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 8px; cursor: pointer; text-transform: uppercase; font-size: 0.9rem; }
        .file-btn input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="header">
        <div style="display:flex; align-items:center; gap:12px;">
            <h1>Mersenne Hunter</h1>
            <span class="badge">V8 NATIVE ENGINE</span>
        </div>
        <div id="statusIcon" class="spinner"></div>
    </div>

    <div class="input-group">
        <label>Mersenne Exponent (p)</label>
        <input type="number" id="exponent" value="11213" placeholder="e.g., 11213">
    </div>

    <div class="grid">
        <div class="stat-card">
            <span class="stat-title">Progress</span>
            <div id="dispPct" class="stat-val blue">0.00%</div>
        </div>
        <div class="stat-card">
            <span class="stat-title">Speed</span>
            <div id="dispSpeed" class="stat-val green">0 it/s</div>
        </div>
        <div class="stat-card">
            <span class="stat-title">Current Step</span>
            <div id="dispStep" class="stat-val">0</div>
        </div>
        <div class="stat-card">
            <span class="stat-title">ETA</span>
            <div id="dispETA" class="stat-val">--:--</div>
        </div>
    </div>

    <div class="bar-track"><div id="progressBar" class="bar-fill"></div></div>
    <div id="consoleLog" class="console">System Initialized.
Architecture: Hybrid (JS Control + Native V8 Math).
Status: Ready.</div>

    <div class="controls">
        <button id="btnStart" class="btn-primary">Start Engine</button>
        <button id="btnStop" class="btn-danger" disabled>Abort</button>
        <button id="btnSave" class="btn-secondary" disabled>ðŸ’¾ Save State</button>
        <label class="file-btn">ðŸ“‚ Load State <input type="file" id="fileInput"></label>
    </div>
</div>

<script>
// ==============================================
//  HIGH-PERFORMANCE WORKER (Blob)
// ==============================================
const workerCode = `
self.onmessage = function(e) {
    const d = e.data;

    // SNAPSHOT COMMAND
    if (d.cmd === 'snapshot') {
        self.doSnapshot = true;
        return;
    }

    // START / RESUME COMMAND
    if (d.cmd === 'start' || d.cmd === 'resume') {
        const p = BigInt(d.p);
        const Mp = (1n << p) - 1n;
        let s = d.s ? BigInt(d.s) : 4n;
        let i = d.i ? Number(d.i) : 0;
        const total = Number(p) - 2;

        self.isRunning = true;
        self.doSnapshot = false;
        
        let startTime = performance.now();
        let lastTick = startTime;
        let lastStep = i;

        self.postMessage({ type: 'log', msg: d.cmd === 'start' ? ">> Starting M" + p : ">> Resuming from Step " + i });

        // OPTIMIZED MODULO (Bitwise Fold)
        const mersenneMod = (x) => {
            while (x > Mp) x = (x & Mp) + (x >> p);
            return x === Mp ? 0n : x;
        };

        // CHUNKED LOOP (Keeps UI Responsive)
        function runBatch() {
            if (!self.isRunning) return;

            // MOBILE TUNING: 200 steps per batch prevents freezing
            // DESKTOP TUNING: Increase this to 5000 for raw speed
            const batchSize = 200; 
            const end = Math.min(i + batchSize, total);

            // HOT PATH (V8 Native Optimization)
            for (; i < end; i++) {
                s = (s * s) - 2n;
                s = mersenneMod(s);
            }

            // TELEMETRY (Every 500ms)
            const now = performance.now();
            if (now - lastTick > 500) {
                const elapsed = (now - lastTick) / 1000;
                const ips = (i - lastStep) / elapsed;
                const remaining = total - i;
                const eta = ips > 0 ? remaining / ips : 0;

                self.postMessage({ 
                    type: 'stats', 
                    pct: (i/total)*100, 
                    ips: ips, 
                    step: i, 
                    eta: eta 
                });

                lastTick = now;
                lastStep = i;
            }

            // SNAPSHOT HANDLING
            if (self.doSnapshot) {
                self.postMessage({ type: 'save_ready', p: p.toString(), s: s.toString(), i: i });
                self.isRunning = false;
                self.doSnapshot = false;
                return;
            }

            // CONTINUE
            if (i < total) {
                setTimeout(runBatch, 0);
            } else {
                self.postMessage({ 
                    type: 'done', 
                    res: s === 0n, 
                    residue: s.toString(), 
                    time: ((now - startTime)/1000).toFixed(2)
                });
            }
        }

        runBatch();
    }
};
`;

// ==============================================
//  MAIN THREAD CONTROLLER
// ==============================================
let worker = null;
const ui = {
    start: document.getElementById('btnStart'), stop: document.getElementById('btnStop'), save: document.getElementById('btnSave'),
    exp: document.getElementById('exponent'), pct: document.getElementById('dispPct'), spd: document.getElementById('dispSpeed'),
    step: document.getElementById('dispStep'), eta: document.getElementById('dispETA'), bar: document.getElementById('progressBar'),
    log: document.getElementById('consoleLog'), spin: document.getElementById('statusIcon')
};

function log(msg) { ui.log.textContent += "\\n" + msg; ui.log.scrollTop = ui.log.scrollHeight; }
function fmtTime(s) { if(!isFinite(s)) return "--:--"; const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=Math.floor(s%60); return `${h}h ${m}m ${sec}s`; }

function initWorker(p, cmd, s=null, i=null) {
    if(worker) worker.terminate();
    const blob = new Blob([workerCode], {type: 'application/javascript'});
    worker = new Worker(URL.createObjectURL(blob));

    ui.start.disabled = true; ui.stop.disabled = false; ui.save.disabled = false;
    ui.spin.classList.add('active');

    worker.postMessage({ cmd, p, s, i });

    worker.onmessage = e => {
        const d = e.data;
        if (d.type === 'stats') {
            ui.pct.innerText = d.pct.toFixed(2) + "%";
            ui.spd.innerText = Math.floor(d.ips).toLocaleString() + " it/s";
            ui.step.innerText = d.step.toLocaleString();
            ui.eta.innerText = fmtTime(d.eta);
            ui.bar.style.width = d.pct + "%";
        } 
        else if (d.type === 'log') log(d.msg);
        else if (d.type === 'save_ready') {
            const blob = new Blob([JSON.stringify(d)], {type:'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `mersenne_M${d.p}_step${d.i}.json`;
            a.click();
            log(">> Checkpoint Saved successfully.");
            ui.spin.classList.remove('active');
        }
        else if (d.type === 'done') {
            log("---------------------------");
            log("COMPUTATION COMPLETE");
            log(`Total Time: ${d.time}s`);
            if (d.res) {
                log("RESULT: PRIME! ðŸŸ¢");
                ui.log.style.color = "#4ade80";
            } else {
                log("RESULT: COMPOSITE ðŸ”´");
                log(`Residue: ${d.residue.substring(0, 20)}...`);
                ui.log.style.color = "#f87171";
            }
            stop();
        }
    };
}

function stop() {
    if(worker) worker.terminate();
    ui.start.disabled = false; ui.stop.disabled = true; ui.save.disabled = true;
    ui.spin.classList.remove('active');
    log(">> Engine Stopped.");
}

ui.start.onclick = () => {
    const p = ui.exp.value;
    if(!p || p<3) return log("Error: Invalid Exponent");
    initWorker(p, 'start');
};

ui.stop.onclick = stop;

ui.save.onclick = () => { if(worker) worker.postMessage({cmd: 'snapshot'}); };

document.getElementById('fileInput').onchange = (e) => {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (ev) => {
        try {
            const d = JSON.parse(ev.target.result);
            ui.exp.value = d.p;
            log(`>> Checkpoint Validated.`);
            initWorker(d.p, 'resume', d.s, d.i);
        } catch(err) { log("Error: Corrupt Save File"); }
    };
    r.readAsText(f);
    e.target.value = '';
};
</script>
</body>
</html>
