<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GNOMON NAVIGATOR v7.1: MOBILE OPTIMIZED</title>
<style>
    :root { --bg: #020617; --a: #facc15; --cyan: #22d3ee; --pink: #f472b6; --text: #e2e8f0; --panel: rgba(15, 23, 42, 0.95); }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    body { background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; height: 100dvh; margin: 0; display: flex; flex-direction: column; overflow: hidden; touch-action: none; }
    
    /* TOP BAR - Shrunk for Mobile */
    .top { background: #0f172a; border-bottom: 2px solid var(--a); padding: 5px 8px; display: flex; gap: 5px; height: 50px; align-items: center; z-index: 20; flex-shrink: 0; }
    input { background: #000; border: 1px solid var(--a); color: #fff; padding: 4px; flex: 1; font-weight: bold; outline: none; border-radius: 4px; font-size: 16px; text-align: center; min-width: 0; }
    .btn { border: none; padding: 0 10px; font-weight: 900; cursor: pointer; border-radius: 4px; font-size: 11px; height: 34px; display: grid; place-items: center; background: #334155; color: #fff; white-space: nowrap; }
    .btn-go { background: var(--a); color: #000; }
    .btn-reset { background: #ef4444; color: #fff; }

    /* LAYOUT */
    .layout { flex: 1; position: relative; background: #000; overflow: hidden; cursor: crosshair; min-height: 0; }
    canvas { display: block; width: 100%; height: 100%; }

    /* STACKER VISUALIZER - Compact for Note 20 */
    .stacker-panel {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 110px;
        max-height: 180px;
        background: var(--panel);
        border: 1px solid var(--a);
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0,0,0,0.9);
        pointer-events: none;
        z-index: 15;
        overflow: hidden;
    }
    .stacker-header { 
        padding: 4px; font-size: 0.65rem; font-weight: bold; color: var(--a); 
        border-bottom: 1px solid #334155; text-align: center; 
        background: rgba(0,0,0,0.3);
    }
    .stacker-body {
        flex: 1;
        overflow-y: auto;
        padding: 5px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
    }
    .dot-matrix { display: grid; gap: 1px; }
    .dot { width: 8px; height: 8px; border-radius: 1px; }

    /* FOOTER - Shrunk for Mobile */
    .footer { background: #0b1120; border-top: 1px solid #1e293b; padding: 5px 10px; height: 70px; display: flex; flex-direction: column; justify-content: center; z-index: 20; flex-shrink: 0; }
    .eq-box { font-size: 0.95rem; font-weight: 900; text-align: center; color: var(--cyan); letter-spacing: 1px; margin-bottom: 2px; }
    .sub-box { text-align: center; font-size: 0.7rem; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
</style>
</head>
<body>

<div class="top">
    <input id="inpN" type="text" value="9" inputmode="numeric">
    <button class="btn btn-go" onclick="jumpToRoot()">JUMP</button>
    <button class="btn btn-reset" onclick="resetAll()">RESET</button>
</div>

<div class="layout" id="canvasWrap">
    <canvas id="gridCanvas"></canvas>
    <div class="stacker-panel">
        <div class="stacker-header" id="stackHeader">STACK: 0</div>
        <div class="stacker-body">
            <div id="dotMatrix" class="dot-matrix"></div>
        </div>
    </div>
</div>

<div class="footer">
    <div class="eq-box" id="eqOut">TAP TO STACK</div>
    <div class="sub-box" id="subOut">Sequence: --</div>
</div>

<script>
// Same Worker logic as original navigatorv71.html
var workerBlob = new Blob([
    "self.onmessage = function(e) {" +
    "  var items = e.data.items;" +
    "  var res = items.map(function(it) {" +
    "    var k = BigInt(it.r), b = BigInt(it.c);" +
    "    if (b > k || k < 0n || b < 0n) return null;" +
    "    var P2 = (k * 2n) + 1n, P1 = P2 - (b * 2n);" +
    "    var a = (P2 + P1) / 2n, N = P2 * P1;" +
    "    return { r: it.r, c: it.c, a: a.toString(), b: b.toString(), val: N.toString(), isSq: (b === 0n) };" +
    "  }).filter(function(x){ return x !== null; });" +
    "  self.postMessage(res);" +
    "};"
], {type: 'application/javascript'});

var canvas = document.getElementById('gridCanvas'), ctx = canvas.getContext('2d'), wrap = document.getElementById('canvasWrap');
var worker = new Worker(URL.createObjectURL(workerBlob));
var cellS = 80, viewPos = { r: 0n, c: 0n }, scroll = { x: 0, y: 0 };
var cellCache = {};
var path = [];

worker.onmessage = function(e) { e.data.forEach(function(p) { cellCache[p.r + "|" + p.c] = p; }); draw(); };

function resize() {
    canvas.width = wrap.clientWidth;
    canvas.height = wrap.clientHeight;
    draw();
}
window.onresize = resize;
resize();
request();

function resetAll() {
    path = [];
    viewPos = { r: 0n, c: 0n };
    scroll = { x: 0, y: 0 };
    cellCache = {};
    request();
    updateStacker();
    document.getElementById('eqOut').innerText = "CLEARED";
    document.getElementById('subOut').innerText = "Sequence: --";
    draw();
}

function jumpToRoot() {
    var raw = document.getElementById('inpN').value;
    try {
        var N = BigInt(raw);
        var a = BigInt(Math.floor(Math.sqrt(Number(N))));
        var k = (a - 1n) / 2n;
        viewPos = { r: k < 2n ? 0n : k - 2n, c: 0n }; 
        scroll = {x:0, y:0};
        cellCache = {};
        request();
    } catch(e){}
}

function handleTap(cell) {
    path.push(cell);
    var seq = path.map(p => p.val).join("+");
    document.getElementById('subOut').innerText = "Seq: " + seq;
    var total = path.reduce((sum, p) => sum + parseInt(p.val), 0);
    document.getElementById('eqOut').innerHTML = `SUM = <span style="color:var(--a)">${total}</span>`;
    updateStacker();
    draw();
}

function updateStacker() {
    var container = document.getElementById('dotMatrix');
    container.innerHTML = '';
    var total = path.reduce((s, p) => s + parseInt(p.val), 0);
    document.getElementById('stackHeader').innerText = "STACK: " + total;
    if (path.length === 0) return;

    var width = Math.ceil(Math.sqrt(total));
    container.style.gridTemplateColumns = `repeat(${width}, 1fr)`;
    var dotSize = width > 15 ? 4 : 8; // Shrink dots for large stacks
    
    path.forEach((p, idx) => {
        var count = parseInt(p.val);
        var colors = ['#facc15', '#22d3ee', '#f472b6', '#34d399', '#a78bfa'];
        for(var i=0; i<count; i++) {
            var dot = document.createElement('div');
            dot.className = 'dot';
            dot.style.width = dotSize + 'px';
            dot.style.height = dotSize + 'px';
            dot.style.backgroundColor = colors[idx % colors.length];
            container.appendChild(dot);
        }
    });
}

function request() { 
    var items = []; 
    var rows = Math.ceil(canvas.height / cellS) + 2, cols = Math.ceil(canvas.width / cellS) + 2;
    for(var r = -2; r < rows; r++) for(var c = -2; c < cols; c++) 
        items.push({r: (viewPos.r + BigInt(r)).toString(), c: (viewPos.c + BigInt(c)).toString()}); 
    worker.postMessage({items: items}); 
}

function draw() {
    ctx.fillStyle = '#020617'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    var rows = Math.ceil(canvas.height / cellS) + 4, cols = Math.ceil(canvas.width / cellS) + 4;
    for (var r = -2; r < rows; r++) {
        for (var c = -2; c < cols; c++) {
            var gr = viewPos.r + BigInt(r), gc = viewPos.c + BigInt(c);
            if (gc < 0n || gc > gr) continue;
            var x = c * cellS + scroll.x, y = r * cellS + scroll.y, cell = cellCache[gr + "|" + gc];
            ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 1; ctx.strokeRect(x, y, cellS, cellS);
            if (cell) {
                var pathIdx = path.findIndex(p => p.r === cell.r && p.c === cell.c);
                if (pathIdx !== -1) {
                    ctx.fillStyle = 'rgba(250, 204, 21, 0.15)'; ctx.fillRect(x, y, cellS, cellS);
                    ctx.strokeStyle = '#facc15'; ctx.lineWidth = 2; ctx.strokeRect(x, y, cellS, cellS);
                }
                if (cellS > 30) {
                    ctx.textAlign = 'center'; 
                    ctx.fillStyle = '#facc15'; ctx.font = "bold " + Math.floor(cellS/4) + "px monospace";
                    ctx.fillText(cell.a, x + cellS/2, y + cellS/3.5);
                    ctx.fillStyle = '#f472b6'; ctx.font = Math.floor(cellS/8) + "px monospace";
                    ctx.fillText(cell.a + "." + cell.b, x + cellS/2, y + cellS/1.9);
                    ctx.fillStyle = (pathIdx !== -1) ? '#fff' : '#22d3ee'; 
                    ctx.font = "bold " + Math.floor(cellS/5.5) + "px monospace";
                    ctx.fillText(cell.val, x + cellS/2, y + cellS/1.2);
                }
            }
        }
    }
}

// --- TOUCH ENGINE ---
var touchStart = null, lastPinch = 0, state = 'IDLE';
wrap.addEventListener('touchstart', function(e) {
    if (e.touches.length === 1) { state = 'PAN'; touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY, sx: scroll.x, sy: scroll.y }; }
    else if (e.touches.length === 2) { state = 'PINCH'; lastPinch = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); }
}, {passive: false});

wrap.addEventListener('touchmove', function(e) {
    e.preventDefault();
    if (state === 'PAN') {
        var dx = e.touches[0].clientX - touchStart.x, dy = e.touches[0].clientY - touchStart.y;
        scroll.x = touchStart.sx + dx; scroll.y = touchStart.sy + dy;
        request(); draw();
    } else if (state === 'PINCH') {
        var dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        if (lastPinch > 0) {
            var ratio = dist / lastPinch, newS = Math.min(Math.max(cellS * ratio, 25), 250);
            var cx = (e.touches[0].clientX + e.touches[1].clientX) / 2, cy = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            scroll.x = cx - (cx - scroll.x) * (newS / cellS); scroll.y = cy - (cy - scroll.y) * (newS / cellS);
            cellS = newS; draw();
        }
        lastPinch = dist;
    }
}, {passive: false});

wrap.addEventListener('touchend', function(e) {
    if (state === 'PAN' && e.changedTouches.length > 0 && Math.abs(e.changedTouches[0].clientX - touchStart.x) < 5 && Math.abs(e.changedTouches[0].clientY - touchStart.y) < 5) {
        var rect = canvas.getBoundingClientRect();
        var c = Math.floor((e.changedTouches[0].clientX - rect.left - scroll.x) / cellS);
        var r = Math.floor((e.changedTouches[0].clientY - rect.top - scroll.y) / cellS);
        var k = viewPos.r + BigInt(r), b = viewPos.c + BigInt(c);
        if(b >= 0n && b <= k) {
            var cell = cellCache[k + "|" + b];
            if(cell) handleTap(cell);
        }
    }
    if (e.touches.length === 0) state = 'IDLE';
});
</script>
</body>
</html>
