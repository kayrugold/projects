<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGS Tape v3 - Optimized Coordinate Sniper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #020617; color: #e2e8f0; font-family: 'Courier New', monospace; }
        .panel { background: #0f172a; border: 1px solid #1e293b; border-radius: 8px; padding: 1.5rem; }
        .input-glow { border: 1px solid #334155; background: #1e293b; color: #6ee7b7; text-align: center; }
        .input-glow:focus { border-color: #10b981; outline: none; box-shadow: 0 0 10px #059669; }
    </style>
</head>
<body class="p-4">
    <div class="max-w-3xl mx-auto panel">
        <h1 class="text-2xl font-bold text-emerald-500 text-center mb-4">SGS TAPE v3 (OPTIMIZED)</h1>
        
        <div class="grid grid-cols-1 gap-4 mb-6">
            <div>
                <label class="text-xs text-slate-500 uppercase font-bold">Target RSA Number (N)</label>
                <input id="targetN" type="text" class="w-full p-3 rounded input-glow text-lg" placeholder="Enter 60-digit number">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs text-slate-500 uppercase font-bold">Start ID (L)</label>
                    <input id="startL" type="text" class="w-full p-3 rounded input-glow" value="1">
                </div>
                <div>
                    <label class="text-xs text-slate-500 uppercase font-bold">Batch Size</label>
                    <input id="batchSize" type="number" class="w-full p-3 rounded input-glow" value="1000000">
                </div>
            </div>
        </div>

        <div class="flex gap-4">
            <button onclick="startResolve()" id="runBtn" class="flex-1 bg-emerald-600 hover:bg-emerald-500 p-4 rounded font-black tracking-widest uppercase">Resolve Geometry</button>
            <button onclick="stopResolve()" id="stopBtn" class="bg-red-600 hover:bg-red-500 px-6 rounded font-bold hidden">ABORT</button>
        </div>

        <div id="statusPanel" class="mt-6 pt-4 border-t border-slate-800 hidden">
            <div class="flex justify-between text-sm mb-2">
                <span>Current ID:</span>
                <span id="currentL" class="text-emerald-400 font-bold">-</span>
            </div>
            <div class="flex justify-between text-sm mb-4">
                <span>Speed:</span>
                <span id="speedDisplay" class="text-blue-400">- ticks/sec</span>
            </div>
            <div id="logBox" class="bg-black p-4 rounded h-40 overflow-y-auto text-xs text-emerald-300 font-mono border border-slate-800">
                System Initialized. Ready for 60-digit lookup.
            </div>
        </div>
    </div>

<script>
let worker = null;
const logBox = document.getElementById('logBox');

function log(msg) {
    const div = document.createElement('div');
    div.textContent = `> ${msg}`;
    logBox.prepend(div);
}

function startResolve() {
    const nStr = document.getElementById('targetN').value;
    const lStart = document.getElementById('startL').value;
    const batch = document.getElementById('batchSize').value;

    if (!nStr) { alert("N is required"); return; }

    document.getElementById('statusPanel').classList.remove('hidden');
    document.getElementById('runBtn').classList.add('hidden');
    document.getElementById('stopBtn').classList.remove('hidden');
    log(`Calibrating for RSA-60 Target...`);

    const blob = new Blob([workerCode], { type: 'application/javascript' });
    worker = new Worker(URL.createObjectURL(blob));

    worker.onmessage = (e) => {
        const d = e.data;
        if (d.type === 'progress') {
            document.getElementById('currentL').textContent = d.l;
            document.getElementById('speedDisplay').textContent = `${d.speed} ticks/sec`;
        } else if (d.type === 'hit') {
            log(`!!! FACTOR FOUND !!!`);
            log(`P: ${d.p}`);
            log(`Q: ${d.q}`);
            stopResolve();
        }
    };

    worker.postMessage({ n: nStr, l: lStart, batch: parseInt(batch) });
}

function stopResolve() {
    if (worker) worker.terminate();
    document.getElementById('runBtn').classList.remove('hidden');
    document.getElementById('stopBtn').classList.add('hidden');
    log("Scanner Terminated.");
}

const workerCode = `
self.onmessage = function(e) {
    let N = BigInt(e.data.n);
    let L = BigInt(e.data.l);
    const batch = e.data.batch;

    // --- INCREMENTAL ROW LOGIC (Sqrt Bypass) ---
    // Instead of re-calculating sqrt for k, we track the threshold
    let k = BigInt(Math.floor(Math.sqrt(Number(L * 2n))));
    let threshold = (k * (k + 1n)) / 2n;
    if (threshold < L) {
        k++;
        threshold = (k * (k + 1n)) / 2n;
    }

    const nDivBy3 = (N % 3n === 0n);
    let startTime = Date.now();
    let count = 0;

    while (true) {
        for (let i = 0; i < batch; i++) {
            // --- MODULAR FILTER (Division by 3s) ---
            // If N is not divisible by 3, skip IDs that are multiples of 3.
            if (!nDivBy3 && (L % 3n === 0n)) {
                L++;
                continue;
            }

            // Check if k threshold is crossed
            while (L > threshold) {
                k++;
                threshold = (k * (k + 1n)) / 2n;
            }

            // Geometry Unpacking
            let b_col = threshold - L;
            let anchor = k + 1n; // a = k + 1
            let hole = b_col;    // b = offset from spine

            // Resolution
            let p1 = anchor - hole;
            let p2 = anchor + hole;

            if (p1 * p2 === N) {
                self.postMessage({ type: 'hit', p: p1.toString(), q: p2.toString() });
                return;
            }

            L++;
            count++;
        }

        let now = Date.now();
        let speed = Math.floor(count / ((now - startTime) / 1000));
        self.postMessage({ type: 'progress', l: L.toString(), speed: speed });
    }
};
`;
</script>
</body>
</html>
