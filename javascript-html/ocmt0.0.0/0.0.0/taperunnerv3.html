<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TAPE RUNNER v2.3 (8-Core Telemetry)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    :root { --bg: #020617; --panel: #0f172a; --accent: #8b5cf6; --hit: #f43f5e; --text: #e2e8f0; --dim: #64748b; --bar: #1e293b; }
    body { background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; padding: 15px; }
    .card { background: var(--panel); border: 1px solid #1e293b; max-width: 900px; margin: 0 auto; padding: 20px; border-radius: 12px; box-shadow: 0 0 50px rgba(139, 92, 246, 0.1); }
    
    input { background: #1e293b; border: 1px solid #334155; color: #fff; padding: 12px; width: 100%; border-radius: 6px; font-family: monospace; font-size: 1.2rem; margin-bottom: 15px; text-align: center; }
    
    .btn { width: 100%; padding: 18px; font-weight: 900; border-radius: 6px; cursor: pointer; text-transform: uppercase; transition: all 0.2s; }
    .btn-run { background: var(--accent); color: #fff; }
    .btn-stop { background: var(--hit); color: #fff; display: none; }

    .worker-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
    @media (min-width: 600px) { .worker-grid { grid-template-columns: repeat(4, 1fr); } }

    .worker-card { background: #0f172a; border: 1px solid #334155; padding: 10px; border-radius: 8px; font-size: 0.7rem; position: relative; overflow: hidden; }
    .progress-bg { background: var(--bar); height: 6px; width: 100%; border-radius: 3px; margin-top: 8px; overflow: hidden; }
    .progress-fill { background: var(--accent); height: 100%; width: 0%; transition: width 0.3s; }
    .success-fill { background: #10b981 !important; }

    .log-box { margin-top: 20px; height: 150px; overflow-y: auto; background: #000; border: 1px solid #334155; padding: 10px; font-size: 0.8rem; color: var(--dim); border-radius: 6px; }
    .success { color: #10b981; font-weight: bold; }
    .sys { color: var(--accent); }
</style>
</head>
<body>

<div class="card">
    <h1 class="text-3xl font-black text-center text-purple-400 mb-1">TAPE RUNNER v2.3</h1>
    <p class="text-center text-xs text-slate-500 mb-6">8-CORE PARALLEL GAUNTLET + UNPACKER</p>

    <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">Target Cargo (N)</label>
    <input id="inpTarget" value="1007">

    <div class="flex gap-2">
        <button id="btnRun" class="btn btn-run" onclick="startFleet()">ENGAGE FLEET</button>
        <button id="btnStop" class="btn btn-stop" onclick="stopAll()">EMERGENCY BRAKE</button>
    </div>

    <div id="workerGrid" class="worker-grid"></div>
    <div id="logBox" class="log-box">> Ready for deployment in Anderson Yard.</div>
</div>

<script>
/* --- MULTI-MODE WORKER ENGINE --- */
const runnerCode = `
self.onmessage = function(e) {
    const { mode, start, end, targetN_str, skipMod3, chunkSize } = e.data;
    const targetN = BigInt(targetN_str);

    if (mode === 'gauntlet') {
        let current = BigInt(start);
        const finish = BigInt(end);
        const total = finish - current;
        
        for (let p = current; p <= finish; p += 2n) {
            if (targetN % p === 0n && targetN !== p) {
                self.postMessage({ type: 'hit', p: p.toString(), nOverP: (targetN / p).toString() });
                return;
            }
            if (p % 10001n === 0n || p === finish) {
                let pct = Number(((p - current) * 100n) / total);
                self.postMessage({ type: 'progress', pct, val: p.toString() });
            }
        }
        self.postMessage({ type: 'done' });
    } 

    if (mode === 'unpack') {
        let L = BigInt(start);
        const count = BigInt(chunkSize);
        
        function sqrtBigInt(n) {
            if (n < 2n) return n;
            let x = n; let y = (x + 1n) / 2n;
            while (y < x) { x = y; y = (x + n / x) / 2n; }
            return x;
        }

        for (let i = 0n; i < count; i++) {
            let val = L * 8n + 1n;
            let root = sqrtBigInt(val);
            let k = (root - 1n) / 2n;
            let triK = (k * (k + 1n)) / 2n;
            if (L > triK) { k++; triK = (k * (k + 1n)) / 2n; }
            
            let triPrev = (k * (k - 1n)) / 2n;
            let colIndex = L - triPrev; 
            let P2 = k * 2n + 1n;
            let b_geo = colIndex - 1n;
            let P1 = P2 - (b_geo * 2n);

            if (skipMod3 && (P2 % 3n === 0n || P1 % 3n === 0n)) { L++; continue; }

            if (P2 * P1 === targetN) {
                self.postMessage({ type: 'found', L: L.toString(), P2: P2.toString(), P1: P1.toString(), a: ((P2+P1)/2n).toString(), b: b_geo.toString() });
                return;
            }

            if (i % 50000n === 0n) {
                let pct = Number((i * 100n) / count);
                self.postMessage({ type: 'progress', pct, val: L.toString() });
            }
            L++;
        }
        self.postMessage({ type: 'done' });
    }
};
`;

let workers = [];
let targetN = 0n;
let activeCores = 0;
const TOTAL_CORES = 8;

function initGrid() {
    const grid = document.getElementById('workerGrid');
    grid.innerHTML = '';
    for(let i=0; i<TOTAL_CORES; i++) {
        grid.innerHTML += `
            <div class="worker-card" id="card-${i}">
                <div class="flex justify-between font-bold"><span>CORE ${i+1}</span><span id="pct-${i}">0%</span></div>
                <div class="text-[0.6rem] text-slate-500 mt-1 truncate" id="val-${i}">Standby</div>
                <div class="progress-bg"><div class="progress-fill" id="bar-${i}"></div></div>
            </div>`;
    }
}

async function startFleet() {
    const raw = document.getElementById('inpTarget').value.replace(/,/g,'').trim();
    try { targetN = BigInt(raw); } catch(e) { log("Invalid Number"); return; }
    
    initGrid();
    document.getElementById('btnRun').style.display = 'none';
    document.getElementById('btnStop').style.display = 'block';
    
    // PHASE 1: PARALLEL GAUNTLET
    log(`PHASE 1: Deploying Parallel Gauntlet (2M Limit)...`, "sys");
    await runPhase('gauntlet');
}

function runPhase(phaseName) {
    return new Promise((resolve) => {
        const blob = new Blob([runnerCode], {type:'application/javascript'});
        const url = URL.createObjectURL(blob);
        activeCores = TOTAL_CORES;
        let phaseDone = false;

        for(let i=0; i<TOTAL_CORES; i++) {
            const w = new Worker(url);
            workers.push(w);

            let start, end, chunkSize;
            if (phaseName === 'gauntlet') {
                const range = 2000000n / BigInt(TOTAL_CORES);
                start = (range * BigInt(i)) + 3n;
                if (start % 2n === 0n) start++;
                end = range * BigInt(i + 1);
            } else {
                // Calculate GPS for Phase 2
                const startID = calculateGPS(targetN);
                chunkSize = 2000000n; // 2M IDs per core check
                start = startID + (BigInt(i) * chunkSize);
            }

            w.postMessage({
                mode: phaseName,
                start: start.toString(),
                end: end ? end.toString() : null,
                chunkSize: chunkSize ? chunkSize.toString() : null,
                targetN_str: targetN.toString(),
                skipMod3: (targetN % 3n !== 0n)
            });

            w.onmessage = (e) => {
                const d = e.data;
                if(d.type === 'progress') {
                    document.getElementById(`bar-${idx=i}`).style.width = d.pct + '%';
                    document.getElementById(`pct-${idx}`).innerText = d.pct + '%';
                    document.getElementById(`val-${idx}`).innerText = d.val;
                }
                if(d.type === 'hit' || d.type === 'found') {
                    stopAll();
                    phaseDone = true;
                    log(`>>> MATCH FOUND BY CORE ${i+1} <<<`, "success");
                    if(d.type === 'hit') log(`FACTOR: ${d.p} x ${d.nOverP}`, "success");
                    else log(`TAPE ID: ${d.L} | ${d.P2} x ${d.P1}`, "success");
                    resolve();
                }
                if(d.type === 'done') {
                    activeCores--;
                    document.getElementById(`bar-${i}`).style.width = '100%';
                    document.getElementById(`bar-${i}`).classList.add('success-fill');
                    if(activeCores === 0 && !phaseDone) {
                        if(phaseName === 'gauntlet') {
                            log("GAUNTLET CLEAR. Switching to Unpacking...", "sys");
                            workers = [];
                            resolve(runPhase('unpack'));
                        } else {
                            log("Sector Clear. Target not found in this stretch.", "sys");
                            stopAll();
                        }
                    }
                }
            };
        }
    });
}

function calculateGPS(n) {
    const odds = (n - 1n) / 2n;
    const estPrimes = BigInt(Math.floor(Number(n) / (Math.log(Number(n)) - 1.1)));
    let startID = odds - estPrimes;
    startID -= (startID / 50n); // 2% Safety
    if(startID < 1n) startID = 1n;
    log(`GPS: Locked Start ID ${startID.toLocaleString()}`, "sys");
    return startID;
}

function stopAll() {
    workers.forEach(w => w.terminate());
    workers = [];
    document.getElementById('btnRun').style.display = 'block';
    document.getElementById('btnStop').style.display = 'none';
}

function log(msg, type='') {
    const box = document.getElementById('logBox');
    const line = document.createElement('div');
    line.className = type;
    line.innerHTML = `> ${msg}`;
    box.prepend(line);
}
</script>
</body>
</html>
