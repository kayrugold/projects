<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TAPE RUNNER v2.5 (Stable Build)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    :root { --bg: #020617; --panel: #0f172a; --accent: #8b5cf6; --hit: #f43f5e; --text: #e2e8f0; --dim: #64748b; }
    body { background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; padding: 10px; }
    .card { background: var(--panel); border: 1px solid #1e293b; max-width: 900px; margin: 0 auto; padding: 15px; border-radius: 12px; }
    .ticker-wrap { background: #000; padding: 10px; border-radius: 6px; border: 1px solid var(--accent); margin-bottom: 10px; text-align: center; }
    .ticker-val { font-size: 1.1rem; font-weight: 900; color: var(--accent); word-break: break-all; }
    input { background: #1e293b; border: 1px solid #334155; color: #fff; padding: 10px; width: 100%; border-radius: 6px; font-size: 0.85rem; margin-bottom: 10px; text-align: center; }
    .btn { width: 100%; padding: 15px; font-weight: 900; border-radius: 6px; cursor: pointer; text-transform: uppercase; }
    .btn-run { background: var(--accent); color: #fff; }
    .btn-stop { background: #ef4444; color: #fff; display: none; }
    .worker-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px; }
    .worker-card { background: #0f172a; border: 1px solid #334155; padding: 8px; border-radius: 6px; font-size: 0.65rem; }
    .progress-bg { background: #1e293b; height: 5px; width: 100%; border-radius: 3px; margin-top: 5px; overflow: hidden; }
    .progress-fill { background: var(--accent); height: 100%; width: 0%; transition: width 0.3s; }
    .log-box { margin-top: 15px; height: 150px; overflow-y: auto; background: #000; border: 1px solid #334155; padding: 8px; font-size: 0.7rem; color: #94a3b8; border-radius: 6px; }
    .success { color: #10b981; font-weight: bold; }
</style>
</head>
<body>
<div class="card">
    <div class="ticker-wrap">
        <div class="ticker-val" id="globalTicker">000,000,000,000</div>
        <div class="text-[0.5rem] text-slate-500 uppercase font-bold">Global Tape ID</div>
    </div>
    <input id="inpTarget" value="71641520761751435455133616475667090434063332228247871795429">
    <div class="flex gap-2">
        <button id="btnRun" class="btn btn-run" onclick="engageFleet()">ENGAGE FLEET</button>
        <button id="btnStop" class="btn btn-stop" onclick="stopAll()">STOP</button>
    </div>
    <div id="workerGrid" class="worker-grid"></div>
    <div id="logBox" class="log-box">> Ready for deployment.</div>
</div>

<script>
// Cleaned script to avoid mobile browser "Invalid Token" errors
const workerCode = "self.onmessage = function(e) {" +
    "const d = e.data; const targetN = BigInt(d.targetN_str);" +
    "function sqrtBigInt(n) { if (n < 2n) return n; let x = n; let y = (x + 1n) / 2n; while (y < x) { x = y; y = (x + n / x) / 2n; } return x; }" +
    "if (d.mode === 'gauntlet') {" +
        "let curr = BigInt(d.start); const finish = BigInt(d.end);" +
        "for (let p = curr; p <= finish; p += 2n) {" +
            "if (targetN % p === 0n && targetN !== p) { self.postMessage({type:'found', p:p.toString(), factors:p.toString() + ' x ' + (targetN/p).toString()}); return; }" +
            "if (p % 10001n === 0n) self.postMessage({type:'progress', pct: Number(((p-curr)*100n)/(finish-curr)), val: p.toString()});" +
        "}" +
        "self.postMessage({type:'done'});" +
    "} else if (d.mode === 'unpack') {" +
        "let L = BigInt(d.start); const count = BigInt(d.chunkSize);" +
        "for (let i = 0n; i < count; i++) {" +
            "let val = L * 8n + 1n; let root = sqrtBigInt(val); let k = (root - 1n) / 2n;" +
            "let triK = (k * (k + 1n)) / 2n; if (L > triK) { k++; triK = (k * (k + 1n)) / 2n; }" +
            "let triPrev = (k * (k - 1n)) / 2n; let P2 = k * 2n + 1n; let P1 = P2 - ((L - triPrev - 1n) * 2n);" +
            "if (P2 * P1 === targetN) { self.postMessage({type:'found', L:L.toString(), P2:P2.toString(), P1:P1.toString(), a:((P2+P1)/2n).toString(), b:(L-triPrev-1n).toString()}); return; }" +
            "if (i % 20000n === 0n) self.postMessage({type:'progress', pct: Number((i*100n)/count), val: L.toString()});" +
            "L++;" +
        "}" +
        "self.postMessage({type:'done'});" +
    "}" +
"};";

let workers = [];
let targetN = 0n;
let activeCores = 0;

function engageFleet() {
    const val = document.getElementById('inpTarget').value.trim();
    if (!val) return;
    targetN = BigInt(val);
    document.getElementById('workerGrid').innerHTML = '';
    for(let i=0; i<8; i++) {
        const div = document.createElement('div');
        div.className = 'worker-card';
        div.innerHTML = '<b>CORE ' + (i+1) + '</b> <span id="pct-' + i + '">0%</span>' +
                        '<div class="progress-bg"><div class="progress-fill" id="bar-' + i + '"></div></div>';
        document.getElementById('workerGrid').appendChild(div);
    }
    document.getElementById('btnRun').style.display = 'none';
    document.getElementById('btnStop').style.display = 'block';
    runPhase('gauntlet');
}

function runPhase(phase) {
    const blob = new Blob([workerCode], {type:'application/javascript'});
    const url = URL.createObjectURL(blob);
    activeCores = 8;
    const gRange = 2000000n / 8n;
    const uRange = 5000000n / 8n;
    let startID = (phase === 'gauntlet') ? 3n : calculateGPS(targetN);
    log("Phase: " + phase.toUpperCase() + " deployed.", "sys");

    for(let i=0; i<8; i++) {
        const w = new Worker(url);
        workers.push(w);
        const chunk = (phase === 'gauntlet') ? gRange : uRange;
        const wStart = startID + (BigInt(i) * chunk);
        w.postMessage({mode:phase, start:wStart.toString(), end:(wStart+chunk).toString(), chunkSize:chunk.toString(), targetN_str:targetN.toString()});
        w.onmessage = function(e) {
            const m = e.data;
            if(m.type === 'progress') {
                document.getElementById('bar-' + i).style.width = m.pct + '%';
                document.getElementById('pct-' + i).innerText = Math.floor(m.pct) + '%';
                if(i === 0) document.getElementById('globalTicker').innerText = BigInt(m.val).toLocaleString();
            }
            if(m.type === 'found') {
                stopAll();
                log(">>> TARGET ACQUIRED <<<", "success");
                if(phase === 'gauntlet') log("FACTORS: " + m.factors, "success");
                else log("FACTORS: " + m.P2 + " x " + m.P1 + " @ ID: " + m.L, "success");
            }
            if(m.type === 'done') {
                activeCores--;
                if(activeCores === 0 && phase === 'gauntlet') runPhase('unpack');
            }
        };
    }
}

function calculateGPS(n) {
    const odds = (n - 1n) / 2n;
    const est = BigInt(Math.floor(Number(n) / (Math.log(Number(n)) - 1.1)));
    return odds - est - (odds / 50n);
}

function stopAll() {
    workers.forEach(function(w){ w.terminate(); });
    workers = [];
    document.getElementById('btnRun').style.display = 'block';
    document.getElementById('btnStop').style.display = 'none';
}

function log(msg, type) {
    const box = document.getElementById('logBox');
    const div = document.createElement('div');
    if(type) div.className = type;
    div.innerText = "> " + msg;
    box.prepend(div);
}
</script>
</body>
</html>
