<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FERMAT'S CLOCK v1.0</title>
<style>
    :root {
        --bg: #020617; --panel: #0f172a; --border: #1e293b;
        --cyan: #22d3ee; --pink: #f472b6; --green: #34d399; --text: #e2e8f0; --dim: #64748b;
        --anchor: #facc15; /* Yellow for Anchor */
    }
    body { background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    /* CONTROLS */
    .controls { background: var(--panel); border-bottom: 2px solid var(--anchor); padding: 15px; display: flex; flex-direction: column; gap: 12px; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .status-bar { font-size: 11px; color: var(--anchor); display: flex; justify-content: space-between; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
    
    .input-group { display: flex; gap: 10px; }
    input { background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #fff; padding: 12px; font-family: inherit; font-size: 16px; font-weight: bold; flex: 1; outline: none; text-align: center; border-radius: 4px; }
    input:focus { border-color: var(--anchor); background: #000; }
    
    /* BUTTONS */
    .action-btns { display: flex; gap: 5px; }
    button { border: none; padding: 12px; font-weight: 900; cursor: pointer; text-transform: uppercase; border-radius: 4px; flex: 1; font-size: 13px; transition: all 0.1s; }
    button:active { transform: translateY(2px); }
    
    .btn-id { background: var(--dim); color: #fff; }
    .btn-resolve { background: var(--green); color: #000; }
    
    .highway-btns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
    .btn-hwy { background: transparent; border: 1px solid var(--dim); color: var(--dim); font-size: 11px; padding: 8px; }
    .btn-hwy:hover { border-color: var(--anchor); color: var(--anchor); }

    /* TAPE LIST */
    .tape-container { flex: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; }
    table { width: 100%; border-collapse: collapse; font-size: 15px; }
    thead { position: sticky; top: 0; background: var(--bg); z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.8); }
    th { text-align: left; padding: 12px; color: var(--dim); font-size: 10px; text-transform: uppercase; border-bottom: 1px solid var(--border); letter-spacing: 1px; }
    td { padding: 10px 12px; border-bottom: 1px solid #0f172a; font-variant-numeric: tabular-nums; }
    tr:hover { background: rgba(250, 204, 21, 0.05); }

    .col-id { color: var(--dim); width: 80px; font-size: 12px; border-right: 1px solid #1e293b; text-align: center; }
    .col-record { color: #fff; font-family: 'Consolas', 'Monaco', monospace; }
    
    /* NOTATION STYLES */
    .val-a { color: var(--anchor); font-weight: bold; }
    .val-N { color: #fff; font-weight: bold; }
    .val-geo { color: var(--pink); opacity: 0.8; font-size: 0.9em; }
    .symbol { color: var(--dim); margin: 0 5px; }
    
    .target-row { border-left: 4px solid var(--green); background: rgba(52, 211, 153, 0.1) !important; }
</style>
</head>
<body>

    <div class="controls">
        <div class="status-bar">
            <span>Fermat's Clock v1.0</span>
            <span id="sysStatus">TICK 1</span>
        </div>
        
        <div class="input-group">
            <input type="text" id="inpSearch" placeholder="Enter N or Tick...">
        </div>
        
        <div class="action-btns">
            <button class="btn-id" onclick="forceID()">SET TICK (L)</button>
            <button class="btn-resolve" onclick="forceScan()">RESOLVE GEOMETRY</button>
        </div>

        <div class="highway-btns">
            <button class="btn-hwy" onclick="jumpToID(1)">Start (Tick 1)</button>
            <button class="btn-hwy" onclick="jumpToID(340)">Near 1005 (Tick 340)</button>
            <button class="btn-hwy" onclick="jumpToID(368)">1007 (Tick 368)</button>
        </div>
    </div>

    <div class="tape-container" id="tapeContainer">
        <table id="tapeTable">
            <thead>
                <tr>
                    <th style="text-align:center">Tick (L)</th>
                    <th>Canonical Record [ a : N @ a-b ]</th>
                </tr>
            </thead>
            <tbody id="tapeBody"></tbody>
        </table>
    </div>

<script>
    // --- WORKER 1: THE GENERATOR (Unpacker) ---
    // Maps Linear Tick (L) -> Anchor (a) & Gap (b) -> Cargo (N)
    const unpackerWorkerCode = `
    self.onmessage = function(e) {
        const { startID_str, count } = e.data;
        let L = BigInt(startID_str);
        let results = [];
        
        for (let i = 0; i < count; i++) {
            // 1. UNPACK L -> TRIANGULAR COORDINATES (k, b_col)
            // This is the "Addition" part - mapping linear time to grid space
            let val = L * 8n + 1n;
            let root = sqrtBigInt(val);
            let k = (root - 1n) / 2n;       // Row Index
            
            let triK = (k * (k + 1n)) / 2n; // Triangular Number
            while (triK > L) { k--; triK = (k * (k + 1n)) / 2n; }
            
            let b_col = L - triK;           // Column in triangle
            
            // 2. CONVERT TO GEOMETRY (a, b)
            // P2 (Larger Factor) is defined by Row k
            let P2 = k * 2n + 1n;
            
            // P1 (Smaller Factor) is defined by column offset
            let P1 = P2 - (b_col * 2n);
            
            // ANCHOR (a) is the average
            let a = (P2 + P1) / 2n;
            
            // GAP (b) is the distance
            let b = (P2 - P1) / 2n;
            
            // CARGO (N) is the result
            let N = P2 * P1;
            
            results.push({
                L: L.toString(),
                a: a.toString(),
                b: b.toString(),
                N: N.toString()
            });
            L++; 
        }
        self.postMessage(results);
    };

    function sqrtBigInt(n) {
        if (n < 2n) return n;
        let x = n; let y = (x + 1n) / 2n;
        while (y < x) { x = y; y = (x + n / x) / 2n; }
        return x;
    }
    `;
    const unpackerWorker = new Worker(URL.createObjectURL(new Blob([unpackerWorkerCode], {type: "application/javascript"})));

    // --- WORKER 2: THE RESOLVER (Scanner) ---
    // Finds the Tick (L) that corresponds to Cargo (N)
    const scannerWorkerCode = `
    self.onmessage = function(e) {
        const N = BigInt(e.data);
        
        // Start Rolling Anchors from sqrt(N)
        let a = sqrtBigInt(N);
        if (a*a < N) a++;
        
        let found = false;
        let limit = 2000000; // Safety brake
        
        for(let i=0; i<limit; i++) {
            let val = a*a - N; // Calculate Gap^2
            let b = sqrtBigInt(val);
            
            if (b*b === val) {
                // GEOMETRY RESOLVED!
                // Map back to Tick (L)
                let P2 = a + b;
                let k = (P2 - 1n) / 2n;
                let triK = (k * (k + 1n)) / 2n;
                
                // L = TriangularBase + ColumnOffset
                // ColumnOffset = b (since P1 = P2 - 2*b_col, and b_geo = b_col)
                let L = triK + b;
                
                let P1 = a - b;
                if(P1 > 1n) {
                    self.postMessage({ found: true, L: L.toString() });
                    found = true;
                    break;
                }
            }
            a++; // Tick Tock
        }
        if(!found) self.postMessage({ found: false });
    };
    function sqrtBigInt(n) {
        if (n < 2n) return n;
        let x = n; let y = (x + 1n) / 2n;
        while (y < x) { x = y; y = (x + n / x) / 2n; }
        return x;
    }
    `;
    const scannerWorker = new Worker(URL.createObjectURL(new Blob([scannerWorkerCode], {type: "application/javascript"})));

    // --- APP LOGIC ---
    let currentL = 1n; 
    let isLoading = false;
    let targetL = -1n;

    function forceID() {
        const val = document.getElementById('inpSearch').value.trim();
        if(!val) return;
        jumpToID(BigInt(val));
    }

    function forceScan() {
        const val = document.getElementById('inpSearch').value.trim();
        if(!val) return;
        document.getElementById('sysStatus').innerText = "RESOLVING...";
        scannerWorker.postMessage(val);
    }

    scannerWorker.onmessage = function(e) {
        if (e.data.found) {
            const L = BigInt(e.data.L);
            document.getElementById('sysStatus').innerText = `RESOLVED AT TICK ${L}`;
            jumpToID(L);
        } else {
            alert("Geometry not found in local sector.");
            document.getElementById('sysStatus').innerText = "IDLE";
        }
    };

    function jumpToID(idVal) {
        targetL = BigInt(idVal);
        let start = targetL - 5n;
        if (start < 1n) start = 1n;
        currentL = start;
        document.getElementById('sysStatus').innerText = `TICK ${targetL}`;
        document.getElementById('tapeBody').innerHTML = "";
        fetchBatch();
    }

    function fetchBatch() {
        if(isLoading) return;
        isLoading = true;
        unpackerWorker.postMessage({ startID_str: currentL.toString(), count: 50 });
    }

    unpackerWorker.onmessage = function(e) {
        const data = e.data;
        const tbody = document.getElementById('tapeBody');
        let html = "";
        data.forEach(item => {
            let thisL = BigInt(item.L);
            let rowClass = "";
            if (thisL === targetL) rowClass = "target-row";
            
            // THE NEW NOTATION: a : N @ a-b
            let notation = `
                <span class="val-a">${item.a}</span>
                <span class="symbol">:</span>
                <span class="val-N">${item.N}</span>
                <span class="symbol">@</span>
                <span class="val-geo">${item.a}-${item.b}</span>
            `;

            html += `
                <tr class="${rowClass}">
                    <td class="col-id">${item.L}</td>
                    <td class="col-record">${notation}</td>
                </tr>
            `;
        });
        tbody.insertAdjacentHTML('beforeend', html);
        currentL += 50n;
        isLoading = false;
    };

    document.getElementById('tapeContainer').addEventListener('scroll', (e) => {
        const el = e.target;
        if (el.scrollTop + el.clientHeight >= el.scrollHeight - 100) fetchBatch();
    });

    jumpToID(1);

</script>
</body>
</html>
