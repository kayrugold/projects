<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GNOMON NAVIGATOR v7.5: ANCHOR-FIRST</title>
<style>
    :root {
        --bg: #020617; --panel: #0f172a; --border: #1e293b;
        --cyan: #22d3ee; --text: #e2e8f0; --pink: #f472b6; --green: #34d399;
        --anchor-gold: #facc15;
    }
    * { box-sizing: border-box; }
    body { 
        background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; 
        height: 100dvh; margin: 0; display: flex; flex-direction: column; overflow: hidden; 
    }
    .top-section {
        background: var(--panel); border-bottom: 2px solid var(--anchor-gold);
        padding: 12px; flex-shrink: 0; display: flex; flex-direction: column; gap: 8px;
    }
    .tape-row { display: flex; gap: 8px; align-items: center; background: #1e293b; padding: 6px; border-radius: 6px; border: 1px solid var(--anchor-gold); }
    .tape-lbl { font-weight: 900; color: #000; background: var(--anchor-gold); padding: 6px 10px; border-radius: 4px; font-size: 0.9rem; }
    #inpTapeID { flex: 1; background: transparent; border: none; color: #fff; font-family: inherit; font-weight: bold; font-size: 1.1rem; outline: none; }
    
    .layout { flex: 1; position: relative; background: #000; touch-action: none; }
    canvas { display: block; width: 100%; height: 100%; }

    .decoder { background: #0f172a; border-top: 3px solid var(--anchor-gold); display: flex; flex-direction: column; flex-shrink: 0; }
    .big-readout { padding: 12px; display: flex; justify-content: space-between; background: #0b1120; border-bottom: 1px solid #1e293b; }
    .readout-val { font-size: 1.3rem; font-weight: 900; color: var(--anchor-gold); }
</style>
</head>
<body>

<div class="top-section">
    <div class="tape-row">
        <div class="tape-lbl">TARGET N</div>
        <input id="inpTapeID" type="text" placeholder="Enter Number (N) to Resolve...">
        <button style="background:var(--green); border:none; padding:8px; font-weight:bold; cursor:pointer;" onclick="resolveN()">RESOLVE</button>
    </div>
</div>

<div class="layout" id="canvasWrap">
    <canvas id="gridCanvas"></canvas>
</div>

<div class="decoder">
    <div class="big-readout">
        <div>
            <div style="font-size:0.6rem; color:#94a3b8;">ANCHOR (a)</div>
            <div class="readout-val" id="dispAddr">--</div>
        </div>
        <div style="text-align:right">
            <div style="font-size:0.6rem; color:#94a3b8;">CARGO (N)</div>
            <div class="readout-val" id="dispVal" style="color:#fff;">--</div>
        </div>
    </div>
</div>

<script>
const workerCode = `
self.onmessage = (ev) => {
    const msg = ev.data;
    const process = (r_in, c_in) => {
        const k = BigInt(r_in);
        const b = BigInt(c_in);
        if (b > k) return null;
        const P2 = (k * 2n) + 1n;
        const P1 = P2 - (b * 2n);
        const a = (P2 + P1) / 2n;
        const N = P2 * P1;
        return { 
            r: r_in, c: c_in, 
            a: a.toString(), 
            b: b.toString(), 
            val: N.toString(),
            isSq: (b === 0n) 
        };
    };
    if (msg.cmd === 'batch') {
        const res = msg.items.map(it => process(it.r, it.c)).filter(x => x);
        self.postMessage({ type: 'batch', payload: res });
    }
};
`;

const canvas = document.getElementById('gridCanvas');
const ctx = canvas.getContext('2d');
const wrap = document.getElementById('canvasWrap');
let cellS = 70;
let viewAnchor = { r: 0n, c: 0n };
let cellCache = new Map();
let highlight = { r: 0n, c: 0n };

const blob = new Blob([workerCode], {type:'application/javascript'});
const worker = new Worker(URL.createObjectURL(blob));

worker.onmessage = (ev) => {
    if (ev.data.type === 'batch') {
        ev.data.payload.forEach(p => cellCache.set(\`\${p.r}|\${p.c}\`, p));
        draw();
    }
};

function draw() {
    const w = canvas.width; const h = canvas.height;
    ctx.fillStyle = '#020617'; ctx.fillRect(0, 0, w, h);
    
    const rows = Math.ceil(h / cellS) + 1;
    const cols = Math.ceil(w / cellS) + 1;

    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            const gr = viewAnchor.r + BigInt(r);
            const gc = viewAnchor.c + BigInt(c);
            if (gc > gr) continue;

            const x = c * cellS; const y = r * cellS;
            const cell = cellCache.get(\`\${gr}|\${gc}\`);

            ctx.strokeStyle = '#1e293b'; ctx.strokeRect(x, y, cellS, cellS);

            if (cell) {
                // Focus: Display the Anchor (a)
                ctx.textAlign = 'center';
                ctx.fillStyle = cell.isSq ? '#fff' : '#facc15';
                ctx.font = 'bold 14px monospace';
                ctx.fillText(\`a:\${cell.a}\`, x + cellS/2, y + cellS/2 - 5);
                
                // Secondary: Display the Cargo (N)
                ctx.fillStyle = '#64748b';
                ctx.font = '10px monospace';
                let v = cell.val; if(v.length > 8) v = v.slice(0,3) + '..' + v.slice(-3);
                ctx.fillText(v, x + cellS/2, y + cellS/2 + 15);
            }
        }
    }
}

function requestBatch() {
    const items = [];
    for(let r=0; r<15; r++) {
        for(let c=0; c<15; c++) {
            items.push({r: (viewAnchor.r + BigInt(r)).toString(), c: (viewAnchor.c + BigInt(c)).toString()});
        }
    }
    worker.postMessage({cmd:'batch', items});
}

function resolveN() {
    const N = BigInt(document.getElementById('inpTapeID').value);
    // Simple Fermat resolution to find a
    let a = BigInt(Math.floor(Math.sqrt(Number(N))));
    if (a*a < N) a++;
    while(true) {
        let b2 = a*a - N;
        let b = BigInt(Math.floor(Math.sqrt(Number(b2))));
        if (b*b === b2) {
            const k = (a + b - 1n) / 2n;
            viewAnchor = { r: k, c: b };
            cellCache.clear();
            requestBatch();
            document.getElementById('dispAddr').innerText = a.toString();
            document.getElementById('dispVal').innerText = N.toString();
            break;
        }
        a++;
    }
}

window.onresize = () => { canvas.width = wrap.clientWidth; canvas.height = wrap.clientHeight; draw(); };
window.onresize();
requestBatch();
</script>
</body>
</html>
