<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGS CLUSTER TAPE (8-Core Logic)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #020617; color: #e2e8f0; font-family: 'Courier New', monospace; }
        .panel { background: #0f172a; border: 1px solid #1e293b; border-radius: 8px; padding: 1.5rem; }
        .input-glow { border: 1px solid #334155; background: #1e293b; color: #6ee7b7; text-align: center; font-size: 1.1rem; }
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .worker-card { background: #1e293b; padding: 10px; border-radius: 4px; font-size: 0.8rem; border: 1px solid #334155; }
        .worker-active { border-color: #10b981; color: #6ee7b7; }
        .worker-idle { border-color: #64748b; color: #64748b; }
    </style>
</head>
<body class="p-4">
    <div class="max-w-4xl mx-auto panel">
        <h1 class="text-2xl font-bold text-emerald-500 text-center mb-2">SGS CLUSTER TAPE</h1>
        <p class="text-center text-slate-500 text-xs mb-6">MULTI-CORE LEHMAN SCANNER</p>
        
        <div class="mb-4">
            <label class="text-xs text-slate-500 uppercase font-bold">Target (Composite 59-digit)</label>
            <input id="targetN" type="text" class="w-full p-2 rounded input-glow" 
                   value="71641520761751435455133616475667090434063332228247871795429">
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <label class="text-xs text-slate-500 uppercase font-bold">Total Multipliers to Scan</label>
                <input id="totalK" type="number" class="w-full p-2 rounded input-glow" value="10000000">
                <p class="text-[10px] text-slate-400 mt-1">Recommended: 10M for overnight</p>
            </div>
            <div>
                <label class="text-xs text-slate-500 uppercase font-bold">Threads (Cores)</label>
                <select id="threadCount" class="w-full p-2 rounded input-glow bg-[#1e293b]">
                    <option value="4">4 Cores (Safe)</option>
                    <option value="6">6 Cores (Fast)</option>
                    <option value="8" selected>8 Cores (Max Power)</option>
                </select>
            </div>
        </div>

        <button onclick="igniteCluster()" id="startBtn" class="w-full bg-emerald-600 hover:bg-emerald-500 p-4 rounded font-black tracking-widest uppercase shadow-lg mb-4">
            IGNITE CLUSTER
        </button>

        <div id="mainStatus" class="text-center text-emerald-400 font-bold hidden mb-4">
            Scanning <span id="speedometer">0</span> multipliers/sec
        </div>

        <div id="workerGrid" class="status-grid">
            </div>

        <div id="logBox" class="mt-4 bg-black p-4 rounded h-40 overflow-y-auto text-xs text-emerald-300 font-mono border border-slate-800">
            System Initialized. Ready to distribute workload.
        </div>
    </div>

<script>
let workers = [];
let startTime = 0;
let totalChecked = 0;

function log(msg, type='info') {
    const box = document.getElementById('logBox');
    const div = document.createElement('div');
    div.innerText = `> ${msg}`;
    if(type === 'hit') { div.style.color = '#fff'; div.style.background = '#059669'; div.style.padding = '5px'; }
    box.prepend(div);
}

function igniteCluster() {
    const nStr = document.getElementById('targetN').value.trim();
    const totalK = parseInt(document.getElementById('totalK').value);
    const cores = parseInt(document.getElementById('threadCount').value);
    
    if(!nStr) return alert("Need Target N");

    // UI Updates
    document.getElementById('startBtn').classList.add('hidden');
    document.getElementById('mainStatus').classList.remove('hidden');
    document.getElementById('workerGrid').innerHTML = '';
    
    // Calculate Ranges
    const rangeSize = Math.ceil(totalK / cores);
    startTime = Date.now();

    log(`Spawning ${cores} workers for target N...`);
    log(`Range per Core: ${rangeSize.toLocaleString()} multipliers`);

    const blob = new Blob([workerCode], {type: 'application/javascript'});
    const workerURL = URL.createObjectURL(blob);

    for(let i=0; i<cores; i++) {
        // Create UI Card
        const card = document.createElement('div');
        card.className = 'worker-card worker-active';
        card.id = `card-${i}`;
        card.innerHTML = `<div>CORE ${i+1}</div><div class="text-xs text-slate-400">Initializing...</div>`;
        document.getElementById('workerGrid').appendChild(card);

        // Spawn Worker
        const w = new Worker(workerURL);
        const startK = (i * rangeSize) + 1;
        const endK = (i + 1) * rangeSize;

        w.postMessage({ 
            id: i, 
            n: nStr, 
            start: startK, 
            end: endK,
            depth: 100 // Shallow check per multiplier for max speed
        });

        w.onmessage = handleMessage;
        workers.push(w);
    }
}

function handleMessage(e) {
    const d = e.data;
    const card = document.getElementById(`card-${d.id}`);
    
    if (d.type === 'progress') {
        // Update specific worker card
        const kDisp = d.currentK.toLocaleString();
        card.innerHTML = `<div>CORE ${d.id+1}</div><div class="text-xs text-emerald-400">k: ${kDisp}</div>`;
        
        // Update Global Speed
        totalChecked += d.batchSize;
        const elapsed = (Date.now() - startTime) / 1000;
        const speed = Math.floor(totalChecked / elapsed);
        document.getElementById('speedometer').innerText = speed.toLocaleString();

    } else if (d.type === 'hit') {
        // STOP EVERYTHING
        workers.forEach(w => w.terminate());
        log(`!!! CLUSTER HIT FOUND !!!`, 'hit');
        log(`Multiplier: x${d.k}`, 'hit');
        log(`P: ${d.p}`, 'hit');
        log(`Q: ${d.q}`, 'hit');
        alert(`FACTOR FOUND!\nMultiplier: ${d.k}\nP: ${d.p}`);
    } else if (d.type === 'done') {
        card.className = 'worker-card worker-idle';
        card.innerHTML = `<div>CORE ${d.id+1}</div><div class="text-xs">Done.</div>`;
    }
}

const workerCode = `
self.onmessage = function(e) {
    const { id, n, start, end, depth } = e.data;
    const N = BigInt(n);
    const DEPTH = BigInt(depth);
    
    let currentK = start;
    let batchCounter = 0;

    // Report back every 1000 checks
    const REPORT_INTERVAL = 1000;

    while (currentK <= end) {
        let K = BigInt(currentK);
        let target = N * K;
        
        // Sqrt(kN)
        let root = sqrtBigInt(target);
        if (root * root < target) root++;

        // Check small window around the root
        for(let i=0n; i<DEPTH; i++) {
            let a = root + i;
            let diff = (a*a) - target;
            
            if (isSquare(diff)) {
                let b = sqrtBigInt(diff);
                let factorA = a - b;
                let p = gcd(factorA, N);
                if (p > 1n && p < N) {
                    let q = N / p;
                    self.postMessage({ type: 'hit', k: currentK, p: p.toString(), q: q.toString() });
                    return;
                }
            }
        }

        currentK++;
        batchCounter++;

        if (batchCounter >= REPORT_INTERVAL) {
            self.postMessage({ type: 'progress', id: id, currentK: currentK, batchSize: batchCounter });
            batchCounter = 0;
        }
    }
    self.postMessage({ type: 'done', id: id });
};

// --- Worker Math Lib ---
function sqrtBigInt(n) {
    if (n < 2n) return n;
    let x = n, y = (x + n / x) / 2n;
    while (y < x) { x = y; y = (x + n / x) / 2n; }
    return x;
}

function isSquare(n) {
    if (n < 0n) return false;
    const h = n & 0xFn;
    if (h > 9n) return false; 
    if (h !== 0n && h !== 1n && h !== 4n && h !== 9n) return false;
    let s = sqrtBigInt(n);
    return s * s === n;
}

function gcd(a, b) {
    while (b > 0n) { let t = b; b = a % b; a = t; }
    return a;
}
`;
</script>
</body>
</html>
