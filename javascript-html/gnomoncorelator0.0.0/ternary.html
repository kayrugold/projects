<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RSA HUNTER: Multicore Engine</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body { background: #020617; color: #e2e8f0; font-family: 'Courier New', monospace; padding: 20px; display: flex; justify-content: center; }
    .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 24px; max-width: 900px; width: 100%; box-shadow: 0 0 50px rgba(0, 0, 0, 0.5); }
    
    h1 { color: #f43f5e; margin-bottom: 5px; text-shadow: 0 0 15px rgba(244, 63, 94, 0.3); }
    label { display: block; font-size: 0.7rem; color: #64748b; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
    input { width: 100%; background: #1e293b; border: 1px solid #334155; color: #fff; padding: 10px; border-radius: 4px; font-weight: bold; font-family: monospace; font-size: 1rem; text-align: center; }
    input:focus { outline: none; border-color: #f43f5e; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }

    .btn { width: 100%; padding: 15px; border-radius: 6px; font-weight: 900; cursor: pointer; text-transform: uppercase; transition: all 0.2s; letter-spacing: 1px; font-size: 1rem; }
    .btn-run { background: #f43f5e; color: #fff; border: 1px solid #be123c; }
    .btn-run:hover { background: #be123c; box-shadow: 0 0 20px rgba(244, 63, 94, 0.4); }
    .btn-stop { background: #334155; color: #fff; display: none; border: 1px solid #1e293b; }

    /* CORE VISUALIZER */
    .cores-container { margin-top: 20px; border-top: 1px dashed #334155; padding-top: 20px; max-height: 400px; overflow-y: auto; }
    .core-row { background: #020617; padding: 10px; margin-bottom: 8px; border-radius: 4px; border: 1px solid #1e293b; display: flex; flex-direction: column; }
    .core-header { display: flex; justify-content: space-between; font-size: 0.75rem; color: #94a3b8; margin-bottom: 5px; }
    .progress-track { height: 6px; background: #1e293b; border-radius: 3px; overflow: hidden; }
    .progress-bar { height: 100%; background: #f43f5e; width: 0%; transition: width 0.5s; box-shadow: 0 0 10px #f43f5e; }
    .core-status { font-size: 0.7rem; color: #64748b; margin-top: 4px; text-align: right; }

    .log-box { height: 150px; overflow-y: auto; font-size: 0.75rem; color: #94a3b8; margin-top: 20px; background: #020617; padding: 10px; border-radius: 4px; border: 1px solid #1e293b; font-family: monospace; white-space: pre-wrap; }
    .hit { color: #22c55e; font-weight: bold; }
    .sys { color: #3b82f6; }
</style>
</head>
<body>

<div class="card">
    <h1 class="text-3xl font-black text-center">RSA HUNTER v1</h1>
    <p class="text-center text-xs text-slate-500 mb-6 tracking-widest">MULTICORE TERNARY ENGINE</p>

    <label>TARGET NUMBER (N)</label>
    <input id="inpTarget" value="71641520761751435455133616475667090434063332228247871795429">
    
    <div style="margin-top: 15px;"></div>

    <div class="grid-3">
        <div>
            <label>CPU CORES</label>
            <input id="inpCores" value="Auto-Detecting..." disabled style="color:#22c55e; border-color:#14532d;">
        </div>
        <div>
            <label>START 'a' (Middle)</label>
            <input id="inpStart" placeholder="Leave blank for Auto">
        </div>
        <div>
            <label>SEARCH DEPTH (Range)</label>
            <input id="inpRange" value="100000000"> </div>
    </div>

    <button id="btnStart" class="btn btn-run" onclick="startSystem()">DEPLOY WORKERS</button>
    <button id="btnStop" class="btn btn-stop" onclick="stopSystem()">ABORT</button>
    
    <div id="coresList" class="cores-container">
        <div class="text-center text-xs text-slate-600 p-4">SYSTEM IDLE - WAITING FOR TARGET</div>
    </div>

    <div id="logBox" class="log-box">System Initialized.</div>
</div>

<script>
// ==========================================
// 1. THE WORKER (Ternary Logic + Bounded Search)
// ==========================================
const workerScript = `
self.onmessage = function(e) {
    const { N_str, start_str, end_str, id } = e.data;
    const N = BigInt(N_str);
    let a = BigInt(start_str);
    const endA = BigInt(end_str);

    // --- TERNARY FILTER ---
    const mod3 = N % 3n;
    let step = 1n;
    if (mod3 === 2n) step = 3n; // Optimized jump
    else if (mod3 === 0n) {
        self.postMessage({ type: 'found', f1: "3", f2: (N/3n).toString() });
        return;
    }

    // --- ALIGNMENT ---
    // Ensure 'a' starts on a valid wall
    if (step === 3n) {
        const rem = a % 3n;
        if (rem !== 0n) a += (3n - rem);
    }
    // Ensure a^2 > N
    if (a*a <= N) a++;

    // --- THE LOOP ---
    const totalRange = Number(endA - a); // Approximate for progress bar
    let checks = 0;
    const reportInterval = 20000; 
    let initialA = a;

    while (a < endA) {
        const gap = a*a - N;
        const b = sqrtBigInt(gap);
        
        if (b*b === gap) {
            const f1 = a - b;
            const f2 = a + b;
            self.postMessage({ type: 'found', f1: f1.toString(), f2: f2.toString() });
            return;
        }

        a += step;
        checks++;

        if (checks % reportInterval === 0) {
            // Calculate Percentage
            const currentDist = Number(a - initialA);
            const pct = (currentDist / totalRange) * 100;
            self.postMessage({ type: 'progress', pct: pct, currentA: a.toString() });
        }
    }
    
    self.postMessage({ type: 'done' });
};

function sqrtBigInt(value) {
    if (value < 0n) throw 'negative';
    if (value < 2n) return value;
    let x0 = value;
    let x1 = (x0 + value / x0) >> 1n;
    while (x1 < x0) { x0 = x1; x1 = (x0 + value / x0) >> 1n; }
    return x0;
}
`;

// ==========================================
// 2. MAIN CONTROLLER
// ==========================================
let workers = [];
let detectedCores = navigator.hardwareConcurrency || 4;
document.getElementById('inpCores').value = detectedCores + " CORES DETECTED";

function log(msg, css='') {
    const box = document.getElementById('logBox');
    const div = document.createElement('div');
    div.textContent = `> ${msg}`;
    if(css) div.className = css;
    box.prepend(div);
}

// BIGINT SQRT HELPER (For Main Thread Auto-Calc)
function sqrtBigIntMain(value) {
    if (value < 0n) throw 'negative';
    if (value < 2n) return value;
    let x0 = value;
    let x1 = (x0 + value / x0) >> 1n;
    while (x1 < x0) { x0 = x1; x1 = (x0 + value / x0) >> 1n; }
    return x0;
}

function startSystem() {
    const nVal = document.getElementById('inpTarget').value.trim();
    let startVal = document.getElementById('inpStart').value.trim();
    const rangeVal = document.getElementById('inpRange').value.trim();

    if(!nVal) return;

    // UI Reset
    document.getElementById('coresList').innerHTML = '';
    document.getElementById('btnStart').style.display = 'none';
    document.getElementById('btnStop').style.display = 'block';
    log("Initializing Fleet...", 'sys');

    // 1. AUTO-CALCULATE START IF EMPTY
    let bigN = BigInt(nVal);
    let bigStart;
    if (!startVal) {
        log("Auto-Calculating Sqrt(N) for Start Point...", 'sys');
        bigStart = sqrtBigIntMain(bigN);
        document.getElementById('inpStart').value = bigStart.toString();
    } else {
        bigStart = BigInt(startVal);
    }

    // 2. CALCULATE RANGES
    const bigRange = BigInt(rangeVal);
    const cores = detectedCores;
    const chunk = bigRange / BigInt(cores);

    log(`Distributing ${rangeVal} checks across ${cores} cores.`, 'sys');

    // 3. LAUNCH WORKERS
    const blob = new Blob([workerScript], {type: 'application/javascript'});
    const url = URL.createObjectURL(blob);

    for (let i = 0; i < cores; i++) {
        // Define Chunk
        let chunkStart = bigStart + (BigInt(i) * chunk);
        let chunkEnd = chunkStart + chunk;
        
        // UI Row
        const row = document.createElement('div');
        row.className = 'core-row';
        row.innerHTML = `
            <div class="core-header">
                <span>CORE ${i+1}</span>
                <span id="pct-${i}">0%</span>
            </div>
            <div class="progress-track"><div id="bar-${i}" class="progress-bar"></div></div>
            <div class="core-status" id="stat-${i}">Scanning ${chunkStart.toString().slice(0,6)}...</div>
        `;
        document.getElementById('coresList').appendChild(row);

        // Spawn
        const w = new Worker(url);
        w.postMessage({ 
            N_str: nVal, 
            start_str: chunkStart.toString(), 
            end_str: chunkEnd.toString(),
            id: i 
        });

        w.onmessage = (e) => handleMessage(e.data, i);
        workers.push(w);
    }
}

function handleMessage(data, id) {
    if (data.type === 'progress') {
        const pct = data.pct.toFixed(1) + "%";
        document.getElementById(`bar-${id}`).style.width = pct;
        document.getElementById(`pct-${id}`).textContent = pct;
        document.getElementById(`stat-${id}`).textContent = "Current: ..." + data.currentA.slice(-10);
    }
    else if (data.type === 'found') {
        log("!!! TARGET DESTROYED !!!", 'hit');
        log(`Factor 1: ${data.f1}`, 'hit');
        log(`Factor 2: ${data.f2}`, 'hit');
        // Stop all
        stopSystem();
        // Highlight finder
        document.getElementById(`bar-${id}`).style.backgroundColor = "#22c55e";
        document.getElementById(`stat-${id}`).innerHTML = "<span class='text-green-500 font-bold'>FACTOR FOUND HERE</span>";
    }
    else if (data.type === 'done') {
        document.getElementById(`bar-${id}`).style.width = "100%";
        document.getElementById(`bar-${id}`).style.backgroundColor = "#334155";
        document.getElementById(`pct-${id}`).textContent = "DONE";
        document.getElementById(`stat-${id}`).textContent = "Sector Clear (No Match)";
    }
}

function stopSystem() {
    workers.forEach(w => w.terminate());
    workers = [];
    document.getElementById('btnStart').style.display = 'block';
    document.getElementById('btnStop').style.display = 'none';
    log("Fleet Halted.", 'sys');
}
</script>
</body>
</html>
