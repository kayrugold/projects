<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Radio v12: Live Interceptor</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap');

    body { 
        background: #020617; 
        color: #e2e8f0; 
        font-family: 'Share Tech Mono', monospace; 
        height: 100dvh;
        width: 100vw;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: none;
        user-select: none;
    }

    .radio-box {
        background: linear-gradient(180deg, #0f172a, #020617);
        border: 2px solid #1e293b;
        border-radius: 16px;
        box-shadow: 0 0 80px rgba(0,0,0,0.8);
        padding: 15px;
        width: 100%;
        max-width: 550px;
        height: 98dvh;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    /* SCREEN */
    .screen {
        background: #000;
        border: 2px solid #1e293b;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 10px;
        box-shadow: inset 0 0 40px rgba(16, 185, 129, 0.05);
        flex-shrink: 0;
        display: flex; flex-direction: column; gap: 8px;
    }

    .input-grp { 
        display: flex; align-items: center; gap: 5px; 
        border-bottom: 1px solid #1e293b; padding-bottom: 10px;
    }
    input.sym-input {
        background: transparent; border: 1px solid #334155; border-radius: 4px;
        color: #10b981; font-family: 'Share Tech Mono', monospace; font-size: 0.9rem;
        width: 100%; text-align: center; padding: 8px;
    }
    input.sym-input:focus { outline: none; border-color: #10b981; background: #0f172a; }

    .readout {
        display: flex; justify-content: space-between; align-items: flex-end;
        background: #050505; border: 1px solid #334155; border-radius: 6px;
        padding: 10px;
    }
    .freq-label { font-size: 0.6rem; color: #64748b; letter-spacing: 1px; margin-bottom: 2px; }
    .freq-val {
        font-family: 'Orbitron', sans-serif; font-size: 1.8rem; 
        color: #10b981; line-height: 1; text-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
    }

    /* LOCK INDICATOR */
    .lock-light {
        width: 12px; height: 12px; border-radius: 50%; background: #333;
        border: 1px solid #555; margin-bottom: 4px; transition: all 0.1s;
    }
    .lock-active { background: #ef4444; box-shadow: 0 0 15px #ef4444; border-color: #f87171; transform: scale(1.2); }
    .lock-text { font-size: 0.7rem; color: #333; font-weight: bold; letter-spacing: 2px; }
    .text-active { color: #ef4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.6); }

    .meter-container {
        background: #0f172a; height: 6px; border-radius: 4px;
        position: relative; overflow: hidden; border: 1px solid #334155;
    }
    .needle {
        position: absolute; top: 0; bottom: 0; width: 4px; background: #ef4444;
        box-shadow: 0 0 10px #ef4444; transition: left 0.1s ease-out; z-index: 10;
    }

    /* KNOBS */
    .knob-section {
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;
        align-items: center; justify-items: center; flex-grow: 1; padding: 10px 0;
    }
    .knob-wrapper { display: flex; flex-direction: column; align-items: center; width: 100%; }

    .knob-base {
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #334155, #0f172a);
        border: 3px solid #1e293b;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        position: relative; touch-action: none;
        transition: transform 0.05s linear;
    }
    .knob-base::after {
        content: ''; position: absolute; top: 5px; left: 50%; transform: translateX(-50%); border-radius: 50%;
    }

    .k-macro { width: 90px; height: 90px; border-color: #475569; }
    .k-macro::after { width: 6px; height: 6px; background: #94a3b8; box-shadow: 0 0 5px #94a3b8; }

    .k-fine { width: 90px; height: 90px; border-color: #475569; }
    .k-fine::after { width: 6px; height: 6px; background: #38bdf8; box-shadow: 0 0 5px #38bdf8; }

    .k-micro { width: 90px; height: 90px; border-color: #f59e0b; }
    .k-micro::after { width: 6px; height: 6px; background: #fbbf24; box-shadow: 0 0 8px #fbbf24; }

    .k-label { font-size: 0.6rem; margin-top: 8px; letter-spacing: 1px; font-weight: bold; }

    /* CONTROLS */
    .controls { display: grid; grid-template-columns: 1fr 0.8fr 1fr; gap: 10px; margin-top: auto; }
    .btn {
        background: #1e293b; color: #94a3b8; border: 1px solid #334155;
        padding: 15px; border-radius: 8px; font-weight: bold; width: 100%;
        cursor: pointer; font-size: 0.75rem; letter-spacing: 1px;
    }
    .btn-active { background: #10b981; color: #000; border-color: #10b981; }
    .btn-seek { background: #3b82f6; color: #fff; border-color: #2563eb; }
    .btn-reset { background: #ef4444; color: #fff; border-color: #dc2626; }

    .log-area {
        margin-top: 10px; height: 80px; overflow-y: auto;
        background: #000; border: 1px solid #1e293b; padding: 8px;
        border-radius: 4px; font-size: 0.65rem; color: #64748b; font-family: monospace;
    }
    .hit { color: #facc15; border-bottom: 1px solid #333; margin-bottom: 2px;}

</style>
</head>
<body>

<div class="radio-box">
    <div class="screen">
        <div class="input-grp">
            <input id="base" class="sym-input" value="10" placeholder="Base">
            <span style="color:#64748b">^</span>
            <input id="exp" class="sym-input" value="3" placeholder="Exp">
            <span style="color:#64748b">+</span>
            <input id="add" class="sym-input" value="7" placeholder="Add">
        </div>
        
        <div class="readout">
            <div>
                <div class="freq-label">SEARCH FREQUENCY</div>
                <div class="freq-val" id="dispStart">2</div>
            </div>
            <div style="display:flex; flex-direction:column; align-items:center;">
                <div class="lock-light" id="lockLight"></div>
                <div class="lock-text" id="lockText">LOCKED</div>
            </div>
        </div>

        <div class="meter-container">
            <div class="needle" id="meterNeedle" style="left: 0%"></div>
        </div>
    </div>

    <div class="knob-section">
        <div class="knob-wrapper">
            <div class="knob-base k-macro" id="knobMacro"></div>
            <div class="k-label" style="color:#94a3b8">MACRO</div>
        </div>
        <div class="knob-wrapper">
            <div class="knob-base k-fine" id="knobFine"></div>
            <div class="k-label" style="color:#38bdf8">FINE</div>
        </div>
        <div class="knob-wrapper">
            <div class="knob-base k-micro" id="knobMicro"></div>
            <div class="k-label" style="color:#fbbf24">MICRO</div>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-seek" id="seekBtn" onclick="toggleSeek()">SCAN</button>
        <button class="btn btn-reset" id="resetBtn" onclick="resetSystem()">RESET</button>
        <button class="btn" id="audioBtn" onclick="toggleAudio()">AUDIO</button>
    </div>
    
    <div id="logArea" class="log-area">
        > Live Receiver Active.<br>
        > Manual Tuning enabled.
    </div>
</div>

<script>
    // --- WORKER: SYMBOLIC ENGINE ---
    const workerCode = `
    self.onmessage = function(e) {
        const { cmd, baseStr, expStr, addStr, startVal, range } = e.data;
        
        if (cmd === 'scan') {
            const base = BigInt(baseStr);
            const exp = BigInt(expStr); 
            const add = BigInt(addStr);
            const start = parseInt(startVal);
            const limit = start + range;
            
            function powMod(b, e, m) {
                let r = 1n; b %= m;
                while (e > 0n) {
                    if ((e & 1n) === 1n) r = (r * b) % m;
                    b = (b * b) % m; e >>= 1n;
                }
                return r;
            }

            // Local Sieve
            const sieve = new Uint8Array(range).fill(1);
            const sqrtLim = Math.floor(Math.sqrt(limit));
            
            // Only sieve odd numbers
            for(let i=3; i<=sqrtLim; i+=2) {
                let s = Math.floor((start + i - 1) / i) * i;
                if(s < i*i) s = i*i;
                if(s % 2 === 0) s += i; 
                for(let j=s; j<limit; j+=(2*i)) if(j >= start) sieve[j-start] = 0;
            }

            const hits = [];
            
            for(let i=0; i<range; i++) {
                const num = start + i;
                if(num < 2) continue;
                if(num > 2 && num % 2 === 0) continue;
                
                // If it's a prime (according to window sieve), check it
                if(sieve[i]) {
                    const P = BigInt(num);
                    const rem = (powMod(base, exp, P) + add) % P;
                    if(rem === 0n) hits.push(num);
                }
            }
            
            self.postMessage({ type: 'result', hits: hits });
        }
    };`;

    const blob = new Blob([workerCode], {type: 'application/javascript'});
    const worker = new Worker(URL.createObjectURL(blob));

    // --- STATE ---
    let scanStart = 2;
    let isSeeking = false;
    let audioCtx = null;
    let osc = null;
    let gainNode = null;
    let isAudioOn = false;
    let knobControllers = [];
    let liveCheckTimeout = null;

    const dispStart = document.getElementById('dispStart');
    const needle = document.getElementById('meterNeedle');
    const logArea = document.getElementById('logArea');
    const lockLight = document.getElementById('lockLight');
    const lockText = document.getElementById('lockText');

    // --- LIVE CHECK FUNCTION ---
    function triggerCheck() {
        // Send a request for a tiny range (10) around current frequency
        // This ensures visual "snap" if you are close
        worker.postMessage({
            cmd: 'scan',
            baseStr: document.getElementById('base').value,
            expStr: document.getElementById('exp').value,
            addStr: document.getElementById('add').value,
            startVal: scanStart,
            range: 1 // Only check the EXACT number on the dial
        });
    }

    // --- ACCUMULATOR KNOB LOGIC ---
    function makeRotatable(element, sensitivity) {
        let currentAngle = 0;
        let startAngle = 0;
        let isDragging = false;
        let residual = 0.0;
        
        function getAngle(x, y) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            return Math.atan2(y - centerY, x - centerX) * (180 / Math.PI);
        }

        function start(x, y) {
            isDragging = true;
            startAngle = getAngle(x, y) - currentAngle;
            element.style.cursor = 'grabbing';
            element.style.transition = 'none'; 
        }

        function move(x, y) {
            if (!isDragging) return;
            const newAngle = getAngle(x, y) - startAngle;
            let delta = newAngle - currentAngle;
            
            if (delta > 180) delta -= 360;
            if (delta < -180) delta += 360;
            
            currentAngle = newAngle;
            element.style.transform = `rotate(${currentAngle}deg)`;
            
            let rawChange = delta * sensitivity;
            residual += rawChange;
            let integerChange = Math.trunc(residual);
            
            if (integerChange !== 0) {
                residual -= integerChange;
                updateValue(integerChange);
            }
        }

        function end() {
            isDragging = false;
            element.style.cursor = 'grab';
            element.style.transition = 'transform 0.1s ease-out';
        }

        function reset() {
            currentAngle = 0;
            residual = 0;
            element.style.transition = 'transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
            element.style.transform = `rotate(0deg)`;
        }

        element.addEventListener('mousedown', e => start(e.clientX, e.clientY));
        window.addEventListener('mousemove', e => move(e.clientX, e.clientY));
        window.addEventListener('mouseup', end);
        element.addEventListener('touchstart', e => { e.preventDefault(); start(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
        window.addEventListener('touchmove', e => { if(isDragging) e.preventDefault(); move(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
        window.addEventListener('touchend', end);

        return { reset };
    }

    knobControllers.push(makeRotatable(document.getElementById('knobMacro'), 5000)); 
    knobControllers.push(makeRotatable(document.getElementById('knobFine'), 50));
    knobControllers.push(makeRotatable(document.getElementById('knobMicro'), 0.2)); 

    function updateValue(delta) {
        scanStart += delta;
        if(scanStart < 2) scanStart = 2;
        dispStart.innerText = Math.floor(scanStart).toLocaleString();
        
        // Reset Lock Visuals on movement
        lockLight.classList.remove('lock-active');
        lockText.classList.remove('text-active');
        needle.style.left = "0%";

        if(audioCtx && isAudioOn && osc) {
            const rev = 60 + (Math.abs(delta) / 100);
            osc.frequency.setTargetAtTime(rev, audioCtx.currentTime, 0.1);
        }
        
        // TRIGGER LIVE CHECK
        clearTimeout(liveCheckTimeout);
        // Debounce slightly to prevent worker flooding, but fast enough to feel live
        liveCheckTimeout = setTimeout(triggerCheck, 10);
    }

    // --- SYSTEM RESET ---
    function resetSystem() {
        if(isSeeking) toggleSeek();
        stopAudio();
        scanStart = 2;
        dispStart.innerText = "2";
        lockLight.classList.remove('lock-active');
        lockText.classList.remove('text-active');
        needle.style.left = "0%";
        logArea.innerHTML = "> System Reset.<br>> Frequency: 2";
        knobControllers.forEach(ctrl => ctrl.reset());
    }

    // --- SEEK LOGIC ---
    function toggleSeek() {
        if(isSeeking) {
            isSeeking = false;
            document.getElementById('seekBtn').innerText = "SCAN";
            document.getElementById('seekBtn').classList.remove('btn-active');
        } else {
            isSeeking = true;
            document.getElementById('seekBtn').innerText = "STOP";
            document.getElementById('seekBtn').classList.add('btn-active');
            if(isAudioOn && osc) osc.frequency.setTargetAtTime(150, audioCtx.currentTime, 2);
            scanLoop();
        }
    }

    function scanLoop() {
        if(!isSeeking) return;
        
        // CHECK CURRENT CHUNK FIRST (Don't skip!)
        const range = 200000;
        
        worker.postMessage({
            cmd: 'scan',
            baseStr: document.getElementById('base').value,
            expStr: document.getElementById('exp').value,
            addStr: document.getElementById('add').value,
            startVal: scanStart,
            range: range
        });
        
        // Increment AFTER request
        scanStart += range;
        dispStart.innerText = Math.floor(scanStart).toLocaleString();
        
        // Auto-rotate visuals
        const rot = (scanStart / 10000) % 360;
        document.getElementById('knobMacro').style.transform = `rotate(${rot}deg)`;
        
        needle.style.left = (Math.random() * 5) + "%";
    }

    // --- WORKER RESULT ---
    worker.onmessage = function(e) {
        const { hits } = e.data;
        if(hits.length > 0) {
            hits.forEach(p => {
                const div = document.createElement('div');
                div.className = 'hit';
                div.innerText = `>> INTERCEPT: ${p}`;
                logArea.prepend(div);
                
                // LOCK ON
                needle.style.left = "100%";
                lockLight.classList.add('lock-active');
                lockText.classList.add('text-active');
                
                // BEEP
                if(audioCtx && isAudioOn) {
                    const beep = audioCtx.createOscillator();
                    const bg = audioCtx.createGain();
                    beep.connect(bg); bg.connect(audioCtx.destination);
                    beep.frequency.value = 880;
                    bg.gain.value = 0.2;
                    beep.start(); beep.stop(audioCtx.currentTime + 0.15);
                }
            });
        }
        
        if(isSeeking) {
            requestAnimationFrame(scanLoop);
        }
    };

    // --- AUDIO ---
    function stopAudio() {
        if(audioCtx) {
            if(osc) { try{osc.stop();}catch(e){} osc=null; }
            if(gainNode) { try{gainNode.disconnect();}catch(e){} gainNode=null; }
            audioCtx.close(); audioCtx = null;
        }
        isAudioOn = false;
        document.getElementById('audioBtn').innerText = "AUDIO";
        document.getElementById('audioBtn').classList.remove('btn-active');
    }

    function startAudio() {
        if(audioCtx) stopAudio();
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        osc = audioCtx.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = 60;
        const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 400;
        gainNode = audioCtx.createGain(); gainNode.gain.value = 0.05; 
        osc.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
        osc.start();
        isAudioOn = true;
        document.getElementById('audioBtn').innerText = "ACTIVE";
        document.getElementById('audioBtn').classList.add('btn-active');
    }

    function toggleAudio() { if(isAudioOn) stopAudio(); else startAudio(); }
    document.addEventListener("visibilitychange", () => { if (document.hidden) stopAudio(); });

</script>
</body>
</html>
