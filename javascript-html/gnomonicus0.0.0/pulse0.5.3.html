<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Geometric Pulse Engine (v0.1.5)</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/big-integer@1.6.48/BigInteger.min.js"></script>
    <style>
        :root {
            --bg: #050505;
            --main: #ffcc00; /* Gold */
            --sub: #00ffff;  /* Cyan */
            --pink: #ff00ff; /* Hot Pink */
            --dim: #333;
            --panel: #111;
            --text-bright: #ccc;
        }
        body {
            background: var(--bg); color: var(--main);
            font-family: 'Share Tech Mono', monospace;
            margin: 0; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow-y: auto; overflow-x: hidden;
            box-sizing: border-box; -webkit-font-smoothing: antialiased;
        }
        
        h1 { margin: 0 0 10px 0; font-size:1.2rem; text-align:center; border-bottom: 2px solid var(--dim); padding-bottom: 10px; width: 100%; }

        /* CONTROLS */
        .controls { width: 100%; display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        input { 
            padding: 12px; background: #1a1a1a; border: 1px solid var(--dim); 
            color: #fff; font-family: inherit; font-size: 1.1rem; text-align: center;
            border-radius: 4px; outline: none; width: 100%; box-sizing: border-box;
        }
        input:focus { border-color: var(--main); }
        button {
            padding: 12px; background: var(--main); color: #000; border: none;
            font-weight: bold; cursor: pointer; font-size: 1rem; border-radius: 4px; width: 100%;
        }

        /* VISUALIZER */
        #vis-container {
            width: 100%; aspect-ratio: 1 / 1; max-width: 380px;
            background: #000; border: 1px solid var(--sub);
            margin-bottom: 15px; position: relative;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.05);
        }
        canvas { width: 100%; height: 100%; display: block; }
        .overlay-tag {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0,0,0,0.8); color: var(--sub);
            padding: 4px 8px; font-size: 0.7rem; border: 1px solid var(--sub);
            pointer-events: none;
        }

        /* SLIDER */
        .slider-box {
            width: 100%; padding: 10px; box-sizing: border-box;
            border: 1px solid var(--dim); background: var(--panel);
            margin-bottom: 15px; text-align: center; border-radius: 4px;
        }
        input[type=range] { width: 100%; margin: 15px 0; cursor: pointer; accent-color: var(--sub); }
        .frame-info { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; }

        /* DUAL CORE DISPLAY */
        .dual-core {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: 15px;
        }
        .core-box {
            background: #0a0a0a; border: 1px solid var(--dim); padding: 10px;
            display: flex; flex-direction: column; justify-content: flex-start;
            min-height: 120px;
        }
        .core-box.active { border-color: var(--sub); }
        .core-title { font-size: 0.7rem; color: #888; margin-bottom: 8px; text-transform: uppercase; text-align: center; width: 100%; border-bottom: 1px solid #222; padding-bottom: 5px; }
        
        /* Chain Styles */
        .step-row { display: flex; justify-content: space-between; width: 100%; margin-bottom: 4px; font-size: 0.8rem; color: #aaa; }
        .step-eq { font-family: 'Courier New', monospace; }
        .step-lbl { color: #555; font-size: 0.6rem; text-align: right; }
        .hl-num { color: #fff; font-weight: bold; }
        .hl-res { color: var(--sub); font-weight: bold; }

        /* Wave Styles */
        .wave-box { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; font-size: 0.9rem; line-height: 1.5; color: #fff;}

        /* ETERNAL CHAIN STYLES */
        .eternal-box {
            width: 100%; background: #000; border: 1px solid var(--dim);
            padding: 15px; box-sizing: border-box; margin-bottom: 15px;
            font-family: 'Courier New', monospace; font-size: 0.9rem;
            white-space: nowrap; overflow-x: auto; color: var(--text-bright);
        }
        .et-seg { display: inline-block; margin-right: 5px; }
        .et-seg.active { color: var(--pink); font-weight: bold; text-shadow: 0 0 5px rgba(255,0,255,0.3); }

        /* SHELL SUMMATION */
        .math-box {
            width: 100%; padding: 15px; box-sizing: border-box;
            background: #080808; margin-bottom: 15px;
            font-family: 'Courier New', monospace; font-size: 0.9rem;
            color: #aaa; border-left: 3px solid #333;
        }

        /* STATS GRID */
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
        .card {
            background: var(--panel); border: 1px solid var(--dim);
            padding: 10px; text-align: center; border-radius: 4px;
        }
        .card.highlight { border-color: var(--sub); background: rgba(0, 255, 255, 0.05); }
        .lbl { font-size: 0.6rem; color: #888; margin-bottom: 3px; text-transform: uppercase; }
        .val { font-size: 1.4rem; font-weight: bold; color: #fff; }
        .sub { font-size: 0.7rem; color: var(--main); }
        .note { font-size: 0.6rem; color: #666; margin-top: 2px; }

    </style>
</head>
<body>

<h1>Geometric Pulse Engine</h1>

<div class="controls">
    <input type="number" id="inpNum" value="21" placeholder="Target N">
    <button onclick="loadEngine()">LOAD TARGET</button>
</div>

<div id="vis-container">
    <canvas id="canvas"></canvas>
    <div class="overlay-tag">GNOMON SCOPE</div>
</div>

<div class="slider-box">
    <div class="frame-info">
        <span>TIMELINE</span>
        <span id="pulseLabel" style="color:var(--main)">SEED</span>
    </div>
    <input type="range" id="timeSlider" min="1" max="1" value="1" oninput="updateState()">
    <div class="frame-info">
        <span>FRAME <span id="frameVal" style="color:#fff;">1</span></span>
        <span>INDEX <span id="idxVal" style="color:#fff;">1</span></span>
    </div>
</div>

<div class="dual-core">
    <div class="core-box active">
        <div class="core-title" style="color:var(--main)">CONSTRUCTION CHAIN</div>
        <div id="chainContent" style="width:100%"></div>
    </div>
    <div class="core-box" style="border-color:var(--pink)">
        <div class="core-title" style="color:var(--pink)">WAVE BALANCE</div>
        <div id="waveContent" class="wave-box"></div>
    </div>
</div>

<div style="width:100%; text-align:left; font-size:0.7rem; color:#888; margin-bottom:2px;">THE ETERNAL CHAIN</div>
<div class="eternal-box" id="eternalChain"></div>

<div style="width:100%; text-align:left; font-size:0.7rem; color:#888; margin-bottom:2px;">ETERNAL GENETICS</div>
<div class="eternal-box" id="eternalGenetics"></div>

<div style="width:100%; text-align:left; font-size:0.7rem; color:#888; margin-bottom:2px;">SHELL SUMMATION</div>
<div class="math-box" id="shellSum"></div>

<div class="dash-grid">
    <div class="card">
        <div class="lbl">Total Square</div>
        <div class="val" id="sqVal">--</div>
        <div class="sub">√<span id="rootVal">--</span></div>
    </div>
    <div class="card highlight">
        <div class="lbl">Active Shell</div>
        <div class="val" id="shellVal" style="color:var(--sub)">--</div>
        <div class="sub"><span id="shellMult">--</span> × 8</div>
        <div class="note">This is the Gnomon</div>
    </div>
    <div class="card">
        <div class="lbl">Triangle Base</div>
        <div class="val" id="triBase">--</div>
        <div class="note">Count of Shells</div>
    </div>
    <div class="card">
        <div class="lbl">Triangle Sum</div>
        <div class="val" id="triSum" style="color:var(--main)">--</div>
        <div class="note">Total 8s Used</div>
    </div>
</div>

<script>
    let canvas, ctx;
    let maxIndex = 1;
    let targetN = 21;

    function init() {
        canvas = document.getElementById('canvas');
        ctx = canvas.getContext('2d');
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        loadEngine();
    }

    function resizeCanvas() {
        const rect = document.getElementById('vis-container').getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        updateState();
    }

    function loadEngine() {
        const val = parseInt(document.getElementById('inpNum').value);
        if(val && val % 2 !== 0) {
            targetN = val;
            maxIndex = Math.max(25, (targetN + 1)/2 + 5); 
            const slider = document.getElementById('timeSlider');
            slider.max = maxIndex;
            slider.value = Math.min((targetN + 1) / 2, maxIndex);
            updateState();
        } else {
            alert("Please enter an odd number.");
        }
    }

    function updateState() {
        const frame = parseInt(document.getElementById('timeSlider').value);
        
        // Math
        const root = (2 * frame) - 1;
        const square = root * root;
        const prevRoot = Math.max(1, root - 2);
        const prevSquare = (frame === 1) ? 0 : prevRoot * prevRoot;
        const shellVol = square - prevSquare;
        const triBase = frame - 1;
        const triSum = (triBase * (triBase + 1)) / 2;

        // UI Updates
        document.getElementById('frameVal').innerText = frame;
        document.getElementById('idxVal').innerText = frame; 
        document.getElementById('pulseLabel').innerText = (frame === 1) ? "SEED" : "EXPAND (+2)";
        document.getElementById('sqVal').innerText = square;
        document.getElementById('rootVal').innerText = root;
        document.getElementById('shellVal').innerText = (frame === 1) ? "1" : shellVol;
        document.getElementById('shellMult').innerText = triBase; 
        document.getElementById('triBase').innerText = triBase;
        document.getElementById('triSum').innerText = triSum;

        // --- CHAIN DISPLAY (LEFT) ---
        const chainBox = document.getElementById('chainContent');
        if (frame === 1) {
            chainBox.innerHTML = `<div class="step-row"><span class="step-eq">1 = 1</span> <span class="step-lbl">SEED</span></div>`;
        } else {
            const stepSize = root * 2;
            const steps = frame - 1;
            let html = `
                <div class="step-row">
                    <span class="step-eq">${prevRoot} + 2 = <span class="hl-num">${root}</span></span>
                    <span class="step-lbl">PULSE</span>
                </div>
            `;
            let accum = root;
            for(let i=1; i<=steps; i++) {
                let nextVal = accum + stepSize;
                let lbl = (i === steps) ? "SQUARE" : `STEP ${i}`;
                let hl = (i === steps) ? "hl-res" : "";
                html += `
                    <div class="step-row">
                        <span class="step-eq">${accum} + ${stepSize} = <span class="${hl}">${nextVal}</span></span>
                        <span class="step-lbl">${lbl}</span>
                    </div>
                `;
                accum = nextVal;
            }
            chainBox.innerHTML = html;
        }

        // --- WAVE DISPLAY (RIGHT) ---
        const waveWing = (root * (root - 1)) / 2;
        document.getElementById('waveContent').innerHTML = `
            <div>${waveWing}</div>
            <div style="font-size:1.2rem; color:var(--pink); font-weight:bold;">+ ${root}</div>
            <div>${waveWing}</div>
            <div style="border-top:1px dashed #666; width:80%; margin:5px 0;"></div>
            <div style="color:#fff; font-weight:bold;">= ${square}</div>
        `;

        // --- ETERNAL CHAIN (BOTTOM SCROLL) ---
        generateEternalChain(frame);
        
        // --- ETERNAL GENETICS (BOTTOM SCROLL) ---
        generateEternalGenetics(frame);

        // --- SHELL SUMMATION ---
        updateShellSum(frame, square);
        
        drawVisualizer(frame, root);
    }

    function generateEternalChain(currFrame) {
        const box = document.getElementById('eternalChain');
        let html = "";
        for(let f=1; f<=currFrame; f++) {
            let r = (2*f) - 1;
            let isActive = (f === currFrame);
            let classStr = isActive ? "et-seg active" : "et-seg";
            if (f === 1) {
                html += `<span class="${classStr}">1</span>`;
            } else {
                html += `<span class="${classStr}">+2=${r}</span>`;
                let stepSize = r * 2;
                let steps = f - 1;
                let accum = r;
                for(let s=1; s<=steps; s++) {
                    accum += stepSize;
                    html += `<span class="${classStr}">+${stepSize}=${accum}</span>`;
                }
                if (f < currFrame) {
                    for(let s=1; s<=steps; s++) {
                        accum -= stepSize;
                        html += `<span class="${classStr}">-${stepSize}=${accum}</span>`;
                    }
                }
            }
        }
        box.innerHTML = html;
        if(currFrame > 3) box.scrollLeft = box.scrollWidth;
    }

    function generateEternalGenetics(currFrame) {
        const box = document.getElementById('eternalGenetics');
        let html = "";
        for(let f=1; f<=currFrame; f++) {
            let r = (2*f) - 1;
            let pr = Math.max(1, r - 2);
            let isActive = (f === currFrame);
            let classStr = isActive ? "et-seg active" : "et-seg";
            
            if (f === 1) {
                html += `<span class="${classStr}">1×1</span>`;
            } else {
                // Pulse: +2x1
                html += `<span class="${classStr}">+2×1=${r}×1</span>`;
                // Growth: +Rx2
                html += `<span class="${classStr}">+${r}×2=${r}×3</span>`;
                // Decay if not current: -Rx2
                if (f < currFrame) {
                   html += `<span class="${classStr}">-${r}×2=${r}×1</span>`;
                }
            }
        }
        box.innerHTML = html;
        if(currFrame > 3) box.scrollLeft = box.scrollWidth;
    }

    function updateShellSum(frame, totalSquare) {
        const box = document.getElementById('shellSum');
        let html = "<span style='color:#fff'>1</span>";
        if (frame > 1) {
            for (let i = 1; i < frame; i++) {
                let term = i * 8;
                let style = (i === frame - 1) ? "color:var(--sub); font-weight:bold;" : "";
                html += ` + <span style='${style}'>${term}</span>`;
            }
        }
        html += ` = <span style='color:#fff; font-weight:bold;'>${totalSquare}</span>`;
        box.innerHTML = html;
    }

    function drawVisualizer(k, root) {
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        const padding = 20;
        const availableSize = Math.min(canvas.width, canvas.height) - padding;
        const cellSize = availableSize / root;

        for(let i = 1; i <= k; i++) {
            let loopRoot = (2 * i) - 1;
            let loopSize = loopRoot * cellSize;
            let isCurrent = (i === k);
            if (i === 1) {
                ctx.fillStyle = "#ffcc00"; 
                ctx.fillRect(cx - cellSize/2, cy - cellSize/2, cellSize-1, cellSize-1);
            } else {
                ctx.strokeStyle = isCurrent ? "#00ffff" : "#333"; 
                ctx.lineWidth = isCurrent ? cellSize : (cellSize - 1); 
                let strokeSize = loopSize - cellSize; 
                ctx.strokeRect(cx - strokeSize/2, cy - strokeSize/2, strokeSize, strokeSize);
            }
        }
    }

    setTimeout(init, 100);

</script>
</body>
</html>
