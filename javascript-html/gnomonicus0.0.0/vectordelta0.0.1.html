<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Codex Gnomonicus v0.0.9 (Data Fix)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/big-integer@1.6.48/BigInteger.min.js"></script>
    <style>
        :root {
            --bg: #020617; 
            --panel: #0f172a; 
            --border: #1e293b;
            --cyan: #22d3ee; 
            --pink: #f472b6; 
            --green: #34d399;
            --gold: #fbbf24;
            --text: #e2e8f0;
            --font-mono: 'Roboto Mono', monospace;
        }

        body {
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: var(--font-mono);
            overflow: hidden;
            touch-action: none;
        }

        /* HUD CONTROLS */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 10px; box-sizing: border-box;
            display: flex; justify-content: space-between;
            pointer-events: none; z-index: 10;
        }
        .stat-box { 
            background: rgba(15, 23, 42, 0.9); 
            padding: 6px 12px; 
            border-radius: 4px; 
            border: 1px solid var(--cyan); 
            font-size: 0.9rem; 
            color: var(--cyan);
            font-weight: bold;
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.1);
        }

        /* DATA CARD */
        #card {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 420px;
            background: rgba(15, 23, 42, 0.95); 
            border: 1px solid #334155;
            padding: 0; border-radius: 8px;
            box-shadow: 0 0 40px rgba(0,0,0,0.9);
            display: none; flex-direction: column;
            font-size: 0.85rem;
            z-index: 40; overflow: hidden;
            backdrop-filter: blur(8px);
        }
        
        .card-header { 
            font-size: 1.0rem; color: #fff; font-weight: bold;
            text-align: center; padding: 8px; background: #1e293b;
            border-bottom: 1px solid #334155; letter-spacing: 1px;
            display:flex; justify-content: space-between; align-items: center;
        }

        .card-body { padding: 10px; display: flex; flex-direction: column; gap: 6px; }

        .v-row {
            display: grid; grid-template-columns: 0.5fr 1.2fr 1fr 1fr; 
            gap: 4px; align-items: center; text-align: right;
            padding: 6px 4px; border-radius: 4px; margin-bottom: 2px;
            border: 1px solid transparent;
        }
        .v-head { color:#94a3b8; font-size:0.6rem; font-weight:bold; text-align:center; padding-bottom:4px;}
        
        .v-lbl { font-weight:900; font-size:0.8rem; text-align: center; padding: 2px 4px; border-radius:3px; color:#000;}
        .v-target { font-family:monospace; font-weight:bold; font-size:0.95rem; color:#fff; text-align: center;}
        .v-delta { font-family:monospace; font-size:0.8rem; color:#ccc; }

        .v-x3 { background: rgba(251, 191, 36, 0.1); border-color: rgba(251, 191, 36, 0.3); }
        .v-x3 .v-lbl { background: var(--gold); }
        
        .v-x5 { background: rgba(34, 211, 238, 0.1); border-color: rgba(34, 211, 238, 0.3); }
        .v-x5 .v-lbl { background: var(--cyan); }
        
        .v-x7 { background: rgba(244, 114, 182, 0.1); border-color: rgba(244, 114, 182, 0.3); }
        .v-x7 .v-lbl { background: var(--pink); }

        canvas { display: block; width: 100%; height: 100%; }
    </style>
</head>
<body>

    <div id="hud">
        <div class="stat-box">ROW <span id="disp-row" style="color:#fff">--</span></div>
        <div class="stat-box">ZOOM <span id="disp-scale" style="color:#fff">1.0x</span></div>
    </div>

    <div id="card">
        <div class="card-header">
            <span style="color:#94a3b8">SOURCE ID:</span>
            <span id="c-tape" style="color:#fff; font-size:1.1rem; font-family:monospace;">--</span>
            <span id="c-coord" style="font-size:0.7rem; color:#64748b">--</span>
        </div>
        <div class="card-body">
            
            <div style="display:grid; grid-template-columns: 0.5fr 1.2fr 1fr 1fr; padding:0 4px;">
                <div class="v-head">MUL</div>
                <div class="v-head">TARGET ID</div>
                <div class="v-head">Δ ROW</div>
                <div class="v-head">Δ COL</div>
            </div>

            <div class="v-row v-x3">
                <div class="v-lbl">x3</div>
                <div class="v-target" id="t-3">--</div>
                <div class="v-delta" id="d-r3">--</div>
                <div class="v-delta" id="d-c3">--</div>
            </div>

            <div class="v-row v-x5">
                <div class="v-lbl">x5</div>
                <div class="v-target" id="t-5">--</div>
                <div class="v-delta" id="d-r5">--</div>
                <div class="v-delta" id="d-c5">--</div>
            </div>

            <div class="v-row v-x7">
                <div class="v-lbl">x7</div>
                <div class="v-target" id="t-7">--</div>
                <div class="v-delta" id="d-r7">--</div>
                <div class="v-delta" id="d-c7">--</div>
            </div>

        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { alpha: false });

        let scale = 60;
        let offsetX = window.innerWidth / 2;
        let offsetY = 100;
        let activeVectors = []; 

        let evCache = [];
        let prevDiff = -1;
        let clickStartPos = {x:0, y:0};

        function init() {
            window.addEventListener('resize', resize);
            resize();
            canvas.addEventListener('pointerdown', onPointerDown);
            canvas.addEventListener('pointermove', onPointerMove);
            canvas.addEventListener('pointerup', onPointerUp);
            canvas.addEventListener('pointercancel', onPointerUp);
            canvas.addEventListener('pointerout', onPointerUp);
            canvas.addEventListener('pointerleave', onPointerUp);
            canvas.addEventListener('wheel', onWheel, {passive: false});
            canvas.addEventListener('click', onClick);
            requestAnimationFrame(draw);
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            draw();
        }

        function getGridInfo(r, c) {
            let R = BigInt(r) + 1n; 
            let halfW = R - 1n;
            let endID = R * R;
            let offsetFromEnd = halfW - BigInt(c);
            let tapeID = endID - offsetFromEnd;
            return { r: r, c: c, tapeID: tapeID, R: R };
        }

        function getCoordsFromTape(T_val) {
            try {
                let T = BigInt(T_val);
                let R = bigSqrt(T); 
                if (R*R < T) R++;
                let endID = R * R;
                let offsetFromEnd = endID - T;
                let halfW = R - 1n;
                let c = halfW - offsetFromEnd;
                return { r: Number(R) - 1, c: Number(c), valid: true };
            } catch(e) { return { valid: false }; }
        }

        function bigSqrt(value) {
            if (value < 0n) return -1n;
            if (value < 2n) return value;
            let x = value;
            let y = (x + 1n) / 2n;
            while (y < x) { x = y; y = (value / x + x) / 2n; }
            return x;
        }

        function draw() {
            ctx.fillStyle = "#020617";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            let startRow = Math.floor(-offsetY / scale);
            let endRow = startRow + Math.ceil(canvas.height / scale) + 1;
            if (startRow < 0) startRow = 0;
            let midX = offsetX;

            document.getElementById('disp-row').innerText = startRow + 1;
            document.getElementById('disp-scale').innerText = (scale/60).toFixed(1) + "x";

            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            let fontSize = Math.max(10, scale * 0.35);
            ctx.font = `bold ${fontSize}px monospace`;

            for (let r = startRow; r < endRow; r++) {
                let y = offsetY + r * scale;
                let R = r + 1;
                let halfW = R - 1;
                
                let screenLeftC = Math.floor((-offsetX) / scale) - 1;
                let screenRightC = Math.floor((canvas.width - offsetX) / scale) + 1;
                let startC = Math.max(-halfW, screenLeftC);
                let endC = Math.min(halfW, screenRightC);

                for (let c = startC; c <= endC; c++) {
                    let x = midX + c * scale;
                    let info = getGridInfo(r, c);
                    
                    let isCorner = (c === halfW); 
                    let isCenter = (c === 0);
                    
                    let isStart = activeVectors.some(v => v.start.id === info.tapeID);
                    let isEnd3 = activeVectors.some(v => v.type === 'x3' && v.end.id === info.tapeID);
                    let isEnd5 = activeVectors.some(v => v.type === 'x5' && v.end.id === info.tapeID);
                    let isEnd7 = activeVectors.some(v => v.type === 'x7' && v.end.id === info.tapeID);

                    ctx.fillStyle = "#0f172a"; 
                    if (isCenter) ctx.fillStyle = "rgba(34, 211, 238, 0.05)"; 
                    if (isCorner) ctx.fillStyle = "rgba(251, 191, 36, 0.05)"; 
                    
                    if (isStart) ctx.fillStyle = "rgba(255, 255, 255, 0.15)"; 
                    if (isEnd3) ctx.fillStyle = "rgba(251, 191, 36, 0.3)";
                    if (isEnd5) ctx.fillStyle = "rgba(34, 211, 238, 0.3)";
                    if (isEnd7) ctx.fillStyle = "rgba(244, 114, 182, 0.3)";

                    ctx.fillRect(x - scale/2 + 1, y - scale/2 + 1, scale - 2, scale - 2);

                    ctx.lineWidth = 1;
                    ctx.strokeStyle = "#1e293b";
                    
                    if (isCorner) { ctx.strokeStyle = "#fbbf24"; ctx.lineWidth = 2; }
                    else if (isCenter) ctx.strokeStyle = "#22d3ee";
                    
                    if (isStart) { ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; }
                    if (isEnd3) { ctx.strokeStyle = "#fbbf24"; ctx.lineWidth = 3; }
                    if (isEnd5) { ctx.strokeStyle = "#22d3ee"; ctx.lineWidth = 3; }
                    if (isEnd7) { ctx.strokeStyle = "#f472b6"; ctx.lineWidth = 3; }

                    ctx.strokeRect(x - scale/2 + 1, y - scale/2 + 1, scale - 2, scale - 2);

                    ctx.fillStyle = "#64748b";
                    if (isCenter) ctx.fillStyle = "#22d3ee";
                    if (isCorner) ctx.fillStyle = "#fbbf24";
                    if (isStart || isEnd3 || isEnd5 || isEnd7) ctx.fillStyle = "#fff";

                    if (scale > 20) {
                        let txt = info.tapeID.toString();
                        if (txt.length > 6) txt = txt.substring(0, 2) + ".." + txt.slice(-2);
                        ctx.fillText(txt, x, y);
                    }
                }
            }
            activeVectors.forEach(v => drawVectorLine(v));
        }

        function drawVectorLine(v) {
            let startX = offsetX + v.start.c * scale;
            let startY = offsetY + v.start.r * scale;
            let endX = offsetX + v.end.c * scale;
            let endY = offsetY + v.end.r * scale;

            let color = "#fbbf24"; 
            if (v.type === 'x5') color = "#22d3ee"; 
            if (v.type === 'x7') color = "#f472b6"; 

            ctx.shadowBlur = 15;
            ctx.shadowColor = color;
            ctx.strokeStyle = color;
            ctx.lineWidth = Math.max(2, scale * 0.08);
            ctx.lineCap = "round";

            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.stroke();

            ctx.shadowBlur = 0;
            ctx.lineWidth = 1;
        }

        function onClick(e) {
            const dist = Math.hypot(e.clientX - clickStartPos.x, e.clientY - clickStartPos.y);
            if (dist > 10) return; 
            
            let r = Math.floor((e.clientY - (offsetY - scale/2)) / scale);
            let c = Math.floor((e.clientX - (offsetX - scale/2)) / scale);
            let R = r + 1;
            let halfW = R - 1;
            if (Math.abs(c) > halfW) return; 

            let info = getGridInfo(r, c);
            let startNode = { r: r, c: c, id: info.tapeID };
            
            activeVectors = []; 
            
            addVector(startNode, 3n, 'x3');
            addVector(startNode, 5n, 'x5');
            addVector(startNode, 7n, 'x7');

            updateCard(startNode);
            draw();
        }

        function addVector(startNode, mult, type) {
            let targetID = startNode.id * mult;
            let coords = getCoordsFromTape(targetID);
            if (coords.valid) {
                activeVectors.push({
                    start: startNode,
                    end: { r: coords.r, c: coords.c, id: targetID },
                    type: type
                });
            }
        }

        function updateCard(s) {
            document.getElementById('card').style.display = 'flex';
            document.getElementById('c-tape').innerText = s.id.toString();
            document.getElementById('c-coord').innerText = `(R:${s.r+1}, C:${s.c})`;

            const fillRow = (type, suffix) => {
                let v = activeVectors.find(vec => vec.type === type);
                if (v) {
                    let dRow = v.end.r - v.start.r;
                    let dCol = v.end.c - v.start.c;
                    document.getElementById('t-'+suffix).innerText = v.end.id.toString();
                    document.getElementById('d-r'+suffix).innerText = "+" + dRow;
                    document.getElementById('d-c'+suffix).innerText = (dCol >= 0 ? "+" : "") + dCol;
                } else {
                    document.getElementById('t-'+suffix).innerText = "N/A";
                    document.getElementById('d-r'+suffix).innerText = "--";
                    document.getElementById('d-c'+suffix).innerText = "--";
                }
            };

            // FIX: Pass the correct suffix matching the HTML ID
            fillRow('x3', '3');
            fillRow('x5', '5');
            fillRow('x7', '7');
        }

        function onPointerDown(ev) { evCache.push(ev); clickStartPos={x:ev.clientX, y:ev.clientY}; }
        function onPointerMove(ev) {
            const index = evCache.findIndex(e => e.pointerId === ev.pointerId);
            if (index > -1) evCache[index] = ev;
            if (evCache.length === 1) {
                offsetX += ev.movementX; offsetY += ev.movementY; requestAnimationFrame(draw);
            } else if (evCache.length === 2) {
                const curDiff = Math.hypot(evCache[0].clientX - evCache[1].clientX, evCache[0].clientY - evCache[1].clientY);
                const midX = (evCache[0].clientX + evCache[1].clientX) / 2;
                const midY = (evCache[0].clientY + evCache[1].clientY) / 2;
                if (prevDiff > 0) {
                    let zoomFactor = 1.0 + (curDiff - prevDiff) * 0.005;
                    if (curDiff < prevDiff) zoomFactor = 1.0 - (prevDiff - curDiff) * 0.005;
                    const newScale = scale * zoomFactor;
                    if (newScale > 0.5 && newScale < 500) {
                        offsetX = midX - (midX - offsetX) * zoomFactor;
                        offsetY = midY - (midY - offsetY) * zoomFactor;
                        scale = newScale;
                    }
                }
                prevDiff = curDiff; requestAnimationFrame(draw);
            }
        }
        function onPointerUp(ev) {
            const index = evCache.findIndex(e => e.pointerId === ev.pointerId);
            if (index > -1) evCache.splice(index, 1);
            if (evCache.length < 2) prevDiff = -1;
        }
        function onWheel(ev) {
            ev.preventDefault();
            const zoomFactor = ev.deltaY > 0 ? 0.9 : 1.1;
            const newScale = scale * zoomFactor;
            if (newScale > 0.5 && newScale < 500) {
                offsetX = ev.clientX - (ev.clientX - offsetX) * zoomFactor;
                offsetY = ev.clientY - (ev.clientY - offsetY) * zoomFactor;
                scale = newScale; draw();
            }
        }

        init();
    </script>
</body>
</html>
