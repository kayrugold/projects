<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SGS Filter Analyzer (Fixed)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background-color: #0f172a; color: #e2e8f0; font-family: monospace; padding: 2rem; }
  .card { max-width: 800px; margin: 0 auto; background: #1e293b; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  .input { background: #334155; border: 1px solid #475569; padding: 0.5rem; color: white; width: 100%; border-radius: 0.25rem; }
  .btn { background: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; width: 100%; transition: 0.2s; cursor: pointer; }
  .btn:hover { background: #2563eb; }
  
  /* Funnel Rows */
  .row { display: flex; align-items: center; margin-bottom: 6px; font-size: 0.9rem; }
  .lbl { width: 150px; color: #94a3b8; flex-shrink: 0; }
  .bar-container { flex-grow: 1; background: #0f172a; height: 24px; border-radius: 4px; overflow: hidden; margin: 0 10px; position: relative; }
  .bar { height: 100%; transition: width 0.5s; }
  .val { width: 100px; text-align: right; font-weight: bold; color: #fff; flex-shrink: 0; }
  .delta { width: 80px; text-align: right; color: #f87171; flex-shrink: 0; font-size: 0.8rem; }

  .bg-total { background: #64748b; }
  .bg-bin { background: #8b5cf6; } /* Purple */
  .bg-prime { background: #10b981; } /* Green */
  .bg-final { background: #f59e0b; } /* Orange */
</style>
</head>
<body>

<div class="card">
    <h1 class="text-2xl font-bold text-center text-blue-400 mb-2">SGS Filter Analyzer</h1>
    <p class="text-center text-xs text-gray-400 mb-6">
        Test how many "S-list Candidates" survive your filters.<br>
        (This does NOT find factors; it measures efficiency.)
    </p>

    <div class="grid grid-cols-3 gap-4 mb-4">
        <div><label class="text-xs text-gray-400">Base</label><input id="base" type="text" class="input" value="10"></div>
        <div><label class="text-xs text-gray-400">Exponent</label><input id="exp" type="text" class="input" value="30"></div>
        <div><label class="text-xs text-gray-400">Addend</label><input id="add" type="text" class="input" value="1"></div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-6">
        <div>
            <label class="text-xs text-gray-400">Sample Size (Test Shots)</label>
            <input id="sample" type="number" class="input" value="100000">
        </div>
        <div>
            <label class="text-xs text-gray-400">Filter Depth (Primes)</label>
            <input id="primeCount" type="number" class="input" value="15">
        </div>
    </div>

    <button onclick="runAnalysis()" class="btn" id="runBtn">Run Analysis</button>
    <div id="status" class="text-center text-yellow-400 mt-2 text-sm h-6"></div>

    <div id="results" class="mt-8 hidden">
        <div class="flex justify-between border-b border-slate-700 pb-2 mb-2 text-xs text-slate-400 uppercase font-bold">
            <span style="width:150px">Filter Step</span>
            <span class="flex-grow text-center">Visual Reduction</span>
            <span style="width:100px; text-align:right">Remaining</span>
            <span style="width:80px; text-align:right">Drop</span>
        </div>
        <div id="bars"></div>
        
        <div class="mt-6 p-4 bg-slate-800 rounded border border-slate-700 text-sm text-center">
            <p class="text-slate-300">
                <strong class="text-yellow-400" id="res-pct"></strong> of numbers survived to the final check.
            </p>
        </div>
    </div>
</div>

<script>
// --- MATH UTILS ---
function powMod(base, exp, mod) {
    let r = 1n; base %= mod;
    while (exp > 0n) { if ((exp & 1n) === 1n) r = (r * base) % mod; exp >>= 1n; base = (base * base) % mod; }
    return r;
}

function legendreSymbol(a, p) {
    if (a === 0n) return 0; 
    if (p === 2n) return 1;
    a = (a % p + p) % p;
    const ls = powMod(a, (p - 1n) / 2n, p);
    return (ls === p - 1n) ? -1 : 1;
}

function customIntegerSqrt(n) {
    if (n < 0n) return null; if (n < 2n) return n;
    let x = n; let y = (x + 1n) / 2n;
    while (y < x) { x = y; y = (x + n / x) / 2n; }
    return x;
}

// --- PRE-COMPUTE ---
const SQ_MOD_4096 = new Uint8Array(4096);
for (let i = 0; i < 4096; i++) SQ_MOD_4096[(i * i) % 4096] = 1;

function getPrimes(count) {
    const p = [];
    let n = 3;
    while(p.length < count) {
        let isP = true;
        for(let i=2; i*i<=n; i++) if(n%i===0) isP=false;
        if(isP) p.push(BigInt(n));
        n+=2;
    }
    return p;
}

async function runAnalysis() {
    const statusEl = document.getElementById('status');
    const btn = document.getElementById('runBtn');
    
    try {
        // 1. Setup
        btn.disabled = true;
        statusEl.innerText = "Calculating N...";
        
        // Small delay to let UI update
        await new Promise(r => setTimeout(r, 10));

        // FIX: IDs match HTML now
        const aStr = document.getElementById('base').value;
        const bStr = document.getElementById('exp').value;
        const cStr = document.getElementById('add').value; // Was 'addend', now 'add'
        const sampleSize = parseInt(document.getElementById('sample').value);
        const maxPrimes = parseInt(document.getElementById('primeCount').value);
        
        let N;
        try {
            N = BigInt(aStr)**BigInt(bStr) + BigInt(cStr);
        } catch(e) { 
            throw new Error("Invalid Number Input"); 
        }
        
        const fourN = N * 4n;
        
        statusEl.innerText = "Calculating Square Root...";
        const sqrtN = customIntegerSqrt(N);
        let S_start = sqrtN * 2n;
        if (S_start*S_start < fourN) S_start += 1n;
        if(N % 2n !== 0n && S_start % 2n !== 0n) S_start++; 

        const primes = getPrimes(maxPrimes);
        let counts = new Array(primes.length + 2).fill(0);
        
        statusEl.innerText = `Testing ${sampleSize.toLocaleString()} Candidates...`;
        await new Promise(r => setTimeout(r, 10));

        // 2. Run Simulation
        for(let i=0; i<sampleSize; i++) {
            let S = S_start + BigInt(i*2); // Step by 2
            let D = S*S - fourN; 
            
            counts[0]++; // Total
            
            // Binary Filter
            if (SQ_MOD_4096[Number(D & 4095n)] !== 1) continue; 
            counts[1]++; 
            
            // Prime Filters
            let pIdx = 0;
            for(; pIdx<primes.length; pIdx++) {
                let p = primes[pIdx];
                if (legendreSymbol(D, p) === -1) break; // DIED
                counts[pIdx + 2]++; 
            }
        }
        
        renderResults(counts, primes, sampleSize);
        statusEl.innerText = "Analysis Complete.";
        
    } catch (err) {
        alert("Error: " + err.message);
        statusEl.innerText = "Error.";
        console.error(err);
    }
    btn.disabled = false;
}

function renderResults(counts, primes, total) {
    const container = document.getElementById('bars');
    container.innerHTML = '';
    document.getElementById('results').classList.remove('hidden');
    
    const createRow = (label, count, prevCount, color) => {
        const pctTotal = ((count / total) * 100); 
        const width = Math.max(pctTotal, 0.5); 
        
        let dropText = "";
        if(prevCount > 0) {
            const drop = 100 - ((count / prevCount) * 100);
            if(drop > 0) dropText = `-${drop.toFixed(1)}%`;
        }

        return `
        <div class="row">
            <div class="lbl">${label}</div>
            <div class="bar-container">
                <div class="bar ${color}" style="width: ${width}%"></div>
            </div>
            <div class="val">${count.toLocaleString()}</div>
            <div class="delta">${dropText}</div>
        </div>`;
    };
    
    let html = createRow("1. Initial Set", counts[0], counts[0], "bg-total");
    html += createRow("2. Mod 4096", counts[1], counts[0], "bg-bin");
    
    primes.forEach((p, i) => {
        let color = "bg-prime";
        if (i === primes.length - 1) color = "bg-final";
        html += createRow(`Mod ${p}`, counts[i+2], counts[i+1], color);
    });
    
    container.innerHTML = html;
    
    const final = counts[counts.length-1];
    const pct = ((final / total) * 100).toFixed(4);
    document.getElementById('res-pct').innerText = `${pct}%`;
}
</script>
</body>
</html>
