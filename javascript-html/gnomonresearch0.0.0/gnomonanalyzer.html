<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gnomon Structural Analyzer</title>
    <style>
        :root {
            --bg-dark: #101014;
            --panel-bg: #1c1c22;
            --border: #2d2d35;
            --primary: #6366f1;
            --text-main: #eef2ff;
            --text-muted: #818cf8;
            --stable: #10b981;
            --unstable: #ef4444;
            --brick-color: #f472b6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* HEADER */
        header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(16, 16, 20, 0.95);
        }
        h1 { margin: 0; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }

        /* MAIN LAYOUT */
        .layout {
            display: flex;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }
        
        @media (min-width: 768px) {
            .layout { flex-direction: row; }
        }

        /* CANVAS AREA */
        .stage {
            flex: 1;
            position: relative;
            background-image: radial-gradient(#2d2d35 1px, transparent 1px);
            background-size: 24px 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        canvas {
            max-width: 90%;
            max-height: 90%;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.5));
        }

        /* CONTROLS SIDEBAR */
        .controls {
            width: 100%;
            background: var(--panel-bg);
            border-top: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 10;
        }

        @media (min-width: 768px) {
            .controls { width: 340px; border-top: none; border-left: 1px solid var(--border); }
        }

        /* SLIDER CARD */
        .control-group {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; }
        .val { font-size: 1.25rem; font-weight: 800; }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }

        /* FORMULA DECODER */
        .formula-box {
            font-family: monospace;
            background: #000;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #a5b4fc;
        }
        .highlight { color: white; font-weight: bold; border-bottom: 1px dashed white; }
        
        .status-pill {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .stable { background: rgba(16, 185, 129, 0.2); color: var(--stable); border: 1px solid rgba(16, 185, 129, 0.4); }
        .unstable { background: rgba(239, 68, 68, 0.2); color: var(--unstable); border: 1px solid rgba(239, 68, 68, 0.4); }

        /* BRICK TOGGLES */
        .brick-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        .brick-btn {
            background: #2d2d35;
            border: 1px solid #3f3f46;
            color: #94a3b8;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            text-align: center;
        }
        .brick-btn:hover { background: #3f3f46; }
        .brick-btn.active { background: var(--brick-color); color: black; border-color: white; font-weight: bold; }
        .brick-btn.disabled { opacity: 0.3; cursor: not-allowed; }

        .corner-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-top: 10px;
        }
        .check-box {
            width: 18px; height: 18px; border: 2px solid var(--text-muted); border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }
        .check-box.checked { background: var(--primary); border-color: var(--primary); }
        .check-box.checked::after { content: "✓"; font-size: 12px; color: white; }

    </style>
</head>
<body>

    <header>
        <h1>Structure Lab</h1>
        <div id="status-display" class="status-pill stable">Stable</div>
    </header>

    <div class="layout">
        <!-- CANVAS -->
        <div class="stage">
            <canvas id="canvas"></canvas>
        </div>

        <!-- CONTROLS -->
        <div class="controls">
            
            <!-- 1. Navigation -->
            <div class="control-group">
                <div class="row">
                    <span class="label">Index (N)</span>
                    <span class="val" id="val-n">8</span>
                </div>
                <input type="range" id="n-slider" min="2" max="35" value="8">
                <div class="row" style="margin-top:10px;">
                    <span class="label">Gnomon Value</span>
                    <span class="val" style="color:var(--primary)" id="val-gnomon">15</span>
                </div>
            </div>

            <!-- 2. The Corner Logic -->
            <div class="control-group">
                <span class="label">Core Geometry</span>
                <div class="corner-toggle" onclick="toggleCorner()">
                    <div class="check-box checked" id="corner-check"></div>
                    <div style="font-size: 0.9rem;">Include Cornerstone (+1)</div>
                </div>
                <div style="margin-top:8px; font-size:0.8rem; color:#9ca3af; line-height:1.4;">
                    <span id="corner-desc">With corner: <strong>Odd (2n-1)</strong>. Only odd numbers can be prime (except 2).</span>
                </div>
            </div>

            <!-- 3. Brick Fitter (The Proof) -->
            <div class="control-group">
                <span class="label">Stability Test (Fit Bricks)</span>
                <div style="font-size:0.8rem; color:#9ca3af; margin: 5px 0 10px 0;">
                    Try to build this Gnomon using only smaller odd bricks.
                </div>
                <div class="brick-grid" id="brick-list">
                    <!-- JS Injects Buttons -->
                </div>
            </div>

            <!-- 4. Formula Decoder -->
            <div class="formula-box" id="formula-display">
                <!-- JS Injects Explanation -->
                Analyzing structure...
            </div>

        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const slider = document.getElementById('n-slider');
        const cornerCheck = document.getElementById('corner-check');
        const brickList = document.getElementById('brick-list');
        const formulaDisplay = document.getElementById('formula-display');
        const statusDisplay = document.getElementById('status-display');
        const cornerDesc = document.getElementById('corner-desc');

        let state = {
            n: 8,
            showCorner: true,
            activeBrick: null // If user selects a brick to test
        };

        // --- MATH ENGINE ---
        function getFactors(num) {
            const factors = [];
            for (let i = 3; i <= Math.sqrt(num); i += 2) {
                if (num % i === 0) {
                    factors.push(i);
                    if (i !== num/i) factors.push(num/i);
                }
            }
            return factors.sort((a,b) => a-b);
        }

        // --- CORE LOGIC ---
        function update() {
            const n = state.n;
            const gnomon = state.showCorner ? (2 * n - 1) : (2 * n - 2);
            
            // Update UI Text
            document.getElementById('val-n').innerText = n;
            document.getElementById('val-gnomon').innerText = gnomon;
            
            cornerCheck.className = state.showCorner ? 'check-box checked' : 'check-box';
            
            if (state.showCorner) {
                cornerDesc.innerHTML = `With corner: <strong style="color:white">Odd (${gnomon})</strong>. Potential for stability.`;
            } else {
                cornerDesc.innerHTML = `No corner: <strong style="color:#ef4444">Even (${gnomon})</strong>. Always unstable (divisible by 2).`;
            }

            // Determine Status & Bricks
            const factors = getFactors(gnomon);
            const isStable = factors.length === 0 && gnomon > 1;
            
            if (!state.showCorner) {
                statusDisplay.innerText = "Even (Unstable)";
                statusDisplay.className = "status-pill unstable";
            } else if (isStable) {
                statusDisplay.innerText = "Prime (Stable)";
                statusDisplay.className = "status-pill stable";
            } else {
                statusDisplay.innerText = "Composite (Unstable)";
                statusDisplay.className = "status-pill unstable";
            }

            renderBricksUI(gnomon, factors);
            renderFormula(gnomon, factors);
            renderCanvas(gnomon, factors);
        }

        function renderBricksUI(gnomon, factors) {
            let html = '';
            // Show buttons for potential odd factors up to gnomon/3
            // Just show first few valid small odd numbers to let user "guess"
            const candidates = [3, 5, 7, 9, 11, 13];
            
            candidates.forEach(b => {
                if (b >= gnomon) return;
                const works = (gnomon % b === 0);
                const isActive = state.activeBrick === b;
                
                // If it's active, we force it style
                // If user clicks, we set activeBrick
                html += `<div 
                    class="brick-btn ${isActive ? 'active' : ''}" 
                    onclick="selectBrick(${b})">
                    Size ${b}
                </div>`;
            });
            
            if (candidates[0] >= gnomon) {
                html = `<div style="grid-column:span 4; font-size:0.8rem; color:#666; text-align:center;">No smaller bricks fit</div>`;
            }

            brickList.innerHTML = html;
        }

        function selectBrick(b) {
            if (state.activeBrick === b) state.activeBrick = null;
            else state.activeBrick = b;
            update();
        }

        function renderFormula(gnomon, factors) {
            if (!state.showCorner) {
                formulaDisplay.innerHTML = `
                    Missing Cornerstone.<br>
                    Structure = Left Arm + Right Arm<br>
                    ${state.n-1} + ${state.n-1} = ${gnomon} (Even)
                `;
                return;
            }

            if (state.activeBrick) {
                const b = state.activeBrick;
                const count = gnomon / b;
                const isInteger = (count % 1 === 0);
                
                if (isInteger) {
                     formulaDisplay.innerHTML = `
                        <span style="color:#10b981">PERFECT FIT!</span><br>
                        Brick Size: <span class="highlight">${b}</span><br>
                        Quantity: <span class="highlight">${count}</span> bricks<br>
                        ${b} × ${count} = ${gnomon}<br>
                        <span style="color:#666">This proves structure is unstable.</span>
                     `;
                } else {
                    formulaDisplay.innerHTML = `
                        <span style="color:#ef4444">MISMATCH!</span><br>
                        Brick Size: ${b}<br>
                        Needs: ${count.toFixed(2)} bricks<br>
                        <span style="color:#666">Cannot build structure with this brick.</span>
                    `;
                }
                return;
            }

            if (factors.length > 0) {
                const f1 = factors[0];
                const f2 = gnomon / f1;
                // Convert to i, j
                const i = (f1 - 1) / 2;
                const j = (f2 - 1) / 2;
                
                formulaDisplay.innerHTML = `
                    <strong>Unstable Analysis:</strong><br>
                    Can be built with Size <strong>${f1}</strong> bricks.<br>
                    Algebra: k = i + j + 2ij<br>
                    Map: ${state.n-1} = ${i} + ${j} + 2(${i})(${j})
                `;
            } else {
                formulaDisplay.innerHTML = `
                    <strong>Stable Analysis:</strong><br>
                    No smaller odd bricks can build this.<br>
                    The geometry is atomic.<br>
                    k = ${state.n-1} (No integer solution)
                `;
            }
        }

        // --- CANVAS RENDER ---
        function renderCanvas(gnomon, factors) {
            const size = Math.min(window.innerWidth, 500);
            const dpr = window.devicePixelRatio || 2;
            canvas.width = size * dpr;
            canvas.height = size * dpr;
            canvas.style.width = `${size}px`;
            canvas.style.height = `${size}px`;
            ctx.scale(dpr, dpr);
            
            const n = state.n;
            // Add padding
            const padding = 40;
            const drawSize = size - (padding * 2);
            const cellSize = drawSize / n;

            ctx.clearRect(0,0,size,size);
            
            // 1. Draw Previous Square (Ghost)
            ctx.fillStyle = '#1c1c22';
            ctx.fillRect(padding, padding, (n-1)*cellSize, (n-1)*cellSize);
            
            // 2. Linearize Gnomon
            const cells = [];
            // Vert Arm
            for(let r=0; r<n-1; r++) cells.push({c: n-1, r: r});
            
            // Corner (Only if toggled)
            if (state.showCorner) {
                cells.push({c: n-1, r: n-1});
            }
            
            // Horiz Arm
            for(let c=n-2; c>=0; c--) cells.push({c: c, r: n-1});

            // 3. Coloring Logic
            const gap = 2;
            
            cells.forEach((pos, idx) => {
                let color = '#6366f1'; // Default Blue

                // If testing a brick
                if (state.activeBrick) {
                    const b = state.activeBrick;
                    const brickIdx = Math.floor(idx / b);
                    const isEven = brickIdx % 2 === 0;
                    
                    // If it fits perfectly
                    if (gnomon % b === 0) {
                        color = isEven ? '#f472b6' : '#db2777'; // Pink Pattern
                    } else {
                        // Mismatch visual
                        // If we run out of bricks or overflow
                        const totalNeeded = Math.ceil(gnomon/b) * b;
                        if (idx >= gnomon - (gnomon%b)) {
                            color = '#ef4444'; // Red error at end
                        } else {
                            color = isEven ? '#9ca3af' : '#6b7280'; // Grey fit
                        }
                    }
                } 
                // If Corner is disabled
                else if (!state.showCorner) {
                     color = '#4b5563'; // Grey even
                }
                // Prime vs Composite default
                else if (factors.length === 0 && gnomon > 1) {
                    color = '#10b981'; // Green Prime
                }

                ctx.fillStyle = color;
                ctx.fillRect(
                    padding + pos.c*cellSize + gap,
                    padding + pos.r*cellSize + gap,
                    cellSize - gap*2,
                    cellSize - gap*2
                );
            });
            
            // Draw Ghost Corner outline if disabled
            if (!state.showCorner) {
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(
                    padding + (n-1)*cellSize + gap, 
                    padding + (n-1)*cellSize + gap, 
                    cellSize - gap*2, 
                    cellSize - gap*2
                );
                ctx.setLineDash([]);
            }
        }

        function toggleCorner() {
            state.showCorner = !state.showCorner;
            state.activeBrick = null; // Reset test
            update();
        }

        slider.addEventListener('input', (e) => {
            state.n = parseInt(e.target.value);
            state.activeBrick = null;
            update();
        });

        window.addEventListener('resize', () => update());

        // Init
        update();

    </script>
</body>
</html>

