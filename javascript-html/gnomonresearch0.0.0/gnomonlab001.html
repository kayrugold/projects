<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gnomon Mod 8 Explorer</title>
    <style>
        body { margin: 0; background: #050505; color: #eee; font-family: 'Courier New', monospace; overflow: hidden; touch-action: none; }
        canvas { display: block; touch-action: none; }
        
        /* Floating HUD */
        #hud {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid #444; border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            transition: all 0.2s ease;
        }

        .hud-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; cursor: pointer; border-bottom: 1px solid #333; padding-bottom: 8px;}
        .hud-title { font-weight: bold; color: #fff; font-size: 1.1em; }
        .hud-toggle { font-size: 0.8em; color: #3498db; text-decoration: none; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9em; margin-top: 10px; }
        .stat-item { background: rgba(255,255,255,0.05); padding: 5px 8px; border-radius: 4px; }
        .stat-label { color: #888; font-size: 0.75em; display: block; text-transform: uppercase; letter-spacing: 1px;}
        .stat-val { color: #fff; font-weight: bold; font-size: 1.1em; }
        
        .highlight-blue { color: #3498db; }
        .highlight-green { color: #2ecc71; }
        .highlight-orange { color: #f39c12; }

        /* Controls */
        #controls { display: none; margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; }
        .control-row { margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; font-size: 0.9em;}
        input[type="range"] { flex-grow: 1; margin-left: 10px; accent-color: #3498db; }
        input[type="checkbox"] { transform: scale(1.2); accent-color: #2ecc71; }
        
        .reticle-info { text-align: center; color: #666; font-size: 0.8em; margin-top: 5px; font-style: italic;}
    </style>
</head>
<body>

<canvas id="mainCanvas"></canvas>

<div id="hud">
    <div class="hud-header" onclick="toggleControls()">
        <span class="hud-title">Index: <span id="sel-index" class="highlight-blue">--</span></span>
        <span class="hud-toggle" id="toggle-text">⚙ Settings</span>
    </div>

    <div class="stat-grid">
        <div class="stat-item">
            <span class="stat-label">Gnomon (2n-1)</span>
            <span class="stat-val" id="sel-val">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Square (n²)</span>
            <span class="stat-val" id="sel-sum">-</span>
        </div>
        
        <div class="stat-item" style="grid-column: span 2;" id="row-jump">
            <span class="stat-label">Jump from prev Odd Square</span>
            <span class="stat-val" id="sel-jump">-</span>
        </div>
        
        <div class="stat-item" style="grid-column: span 2;">
            <span class="stat-label">Properties</span>
            <span class="stat-val" id="sel-props">-</span>
        </div>
    </div>
    
    <div class="reticle-info">Tap cell to inspect</div>

    <div id="controls">
        <div class="control-row">
            <label>Max Index: <span id="max-idx-display">50</span></label>
            <input type="range" id="slider-max" min="5" max="200" value="50">
        </div>
        <div class="control-row">
            <label for="chk-primes">Highlight Prime Gnomons</label>
            <input type="checkbox" id="chk-primes">
        </div>
        <div class="control-row">
            <label for="chk-mod8" style="color:#2ecc71; font-weight:bold;">Highlight Odd Jumps (Mod 8)</label>
            <input type="checkbox" id="chk-mod8" checked>
        </div>
        <div class="control-row" style="justify-content: flex-end;">
            <button onclick="resetView()" style="background:#444; color:#fff; border:none; padding:8px 12px; border-radius:4px;">Reset View</button>
        </div>
    </div>
</div>

<script id="worker-code" type="javascript/worker">
    self.onmessage = function(e) {
        if (e.data.type === 'GENERATE') {
            const max = e.data.maxIndex;
            const buffer = [];
            for (let i = 1; i <= max; i++) {
                const val = 2 * i - 1;
                const isPrime = checkPrime(val);
                // Calculate jump if odd index
                let jump = 0;
                let k_factor = 0;
                if (i % 2 !== 0 && i > 1) {
                    const prevOddSq = (i-2)*(i-2);
                    const currSq = i*i;
                    jump = currSq - prevOddSq;
                    k_factor = jump / 8;
                }
                
                buffer.push({ i, val, sum: i*i, isPrime, jump, k_factor });
            }
            self.postMessage({ type: 'DATA', data: buffer });
        }
    };

    function checkPrime(n) {
        if (n <= 1) return false;
        if (n <= 3) return true;
        if (n % 2 === 0 || n % 3 === 0) return false;
        for (let i = 5; i * i <= n; i += 6) {
            if (n % i === 0 || n % (i + 2) === 0) return false;
        }
        return true;
    }
</script>

<script>
    /* --- 1. SETUP --- */
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    
    const blob = new Blob([document.getElementById('worker-code').textContent], {type: 'application/javascript'});
    const worker = new Worker(URL.createObjectURL(blob));

    let data = [];
    let config = {
        maxIndex: 50,
        showPrimes: false,
        showMod8: true
    };
    
    let view = { x: 40, y: 40, scale: 25, minScale: 2, maxScale: 150 };
    let selection = null;

    /* --- 2. INPUTS --- */
    let isDragging = false;
    let lastPos = { x: 0, y: 0 };
    let touches = {};

    canvas.addEventListener('pointerdown', e => {
        isDragging = true;
        lastPos = { x: e.clientX, y: e.clientY };
        canvas.setPointerCapture(e.pointerId);
        handleTap(e.clientX, e.clientY);
    });

    canvas.addEventListener('pointermove', e => {
        if (!isDragging) return;
        view.x += e.clientX - lastPos.x;
        view.y += e.clientY - lastPos.y;
        lastPos = { x: e.clientX, y: e.clientY };
        requestAnimationFrame(draw);
    });

    canvas.addEventListener('pointerup', e => {
        isDragging = false;
        canvas.releasePointerCapture(e.pointerId);
    });

    canvas.addEventListener('wheel', e => {
        e.preventDefault();
        const newScale = view.scale * (1 - e.deltaY * 0.001);
        if (newScale >= view.minScale && newScale <= view.maxScale) {
            const mouseX = e.clientX - view.x;
            const mouseY = e.clientY - view.y;
            const ratio = newScale / view.scale;
            view.x -= mouseX * (ratio - 1);
            view.y -= mouseY * (ratio - 1);
            view.scale = newScale;
            requestAnimationFrame(draw);
        }
    }, { passive: false });

    /* --- 3. LOGIC --- */
    function handleTap(screenX, screenY) {
        const gridX = Math.floor((screenX - view.x) / view.scale);
        const gridY = Math.floor((screenY - view.y) / view.scale);
        if (gridX >= 0 && gridY >= 0) {
            const layer = Math.max(gridX, gridY) + 1;
            if (layer <= config.maxIndex) {
                selection = layer;
                updateHUD();
                requestAnimationFrame(draw);
            }
        }
    }

    function draw() {
        ctx.fillStyle = '#0a0a0a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.save();
        ctx.translate(view.x, view.y);
        
        const cs = view.scale;
        const gap = (cs > 5) ? 1 : 0;
        const drawSize = cs - gap;

        for (const item of data) {
            const i = item.i; 
            const coord = i - 1;
            
            // --- COLOR LOGIC ---
            let color;
            let isOdd = (i % 2 !== 0);
            
            if (config.showMod8) {
                // Mod 8 Mode: Emphasize Odd Indices (1, 3, 5...)
                if (isOdd) {
                     // Odd Indices are bright
                     color = '#2ecc71'; // Greenish
                     if (config.showPrimes && item.isPrime) color = '#f39c12'; // Orange override
                } else {
                    // Even indices (Dark Gray / Background)
                    color = '#1a1a1a'; // Very dark
                }
            } else {
                // Standard Mode: Alternating
                color = (i % 2 === 0) ? '#222' : '#333';
                if (config.showPrimes && item.isPrime) color = '#d35400';
            }

            // Selection Override
            if (selection === i) {
                color = '#fff'; // Selected is white
            } else if (selection && !isOdd && config.showMod8 && selection === i+1) {
                 // Subtle highlight for the 'gap' if next is selected? optional
            }

            ctx.fillStyle = color;

            // Draw L-Shape (Horizontal + Vertical + Corner)
            // Vertical (Left side of L)
            if (coord > 0) ctx.fillRect(coord * cs, 0, drawSize, coord * cs);
            // Horizontal (Top side of L)
            if (coord > 0) ctx.fillRect(0, coord * cs, coord * cs, drawSize);
            // Corner
            ctx.fillRect(coord * cs, coord * cs, drawSize, drawSize);

            // Draw Dot/Marker
            if ((config.showPrimes && item.isPrime) || (config.showMod8 && isOdd)) {
                if (cs > 10) {
                    ctx.fillStyle = (selection === i) ? '#000' : 'rgba(0,0,0,0.3)';
                    const cx = coord * cs + cs/2;
                    const cy = coord * cs + cs/2;
                    ctx.beginPath();
                    ctx.arc(cx, cy, cs/5, 0, Math.PI*2);
                    ctx.fill();
                }
            }
        }
        ctx.restore();
    }

    function updateHUD() {
        if (!selection) return;
        const d = data[selection - 1];
        
        document.getElementById('sel-index').innerText = d.i;
        document.getElementById('sel-val').innerText = d.val;
        document.getElementById('sel-sum').innerText = d.sum;
        
        // Jump Stats (Mod 8)
        const jumpRow = document.getElementById('row-jump');
        const jumpVal = document.getElementById('sel-jump');
        
        if (d.i % 2 !== 0 && d.i > 1) {
            jumpRow.style.display = 'block';
            jumpRow.style.gridColumn = 'span 2';
            jumpVal.innerHTML = `<span class="highlight-green">${d.jump}</span> (8 × ${d.k_factor})`;
        } else if (d.i === 1) {
             jumpRow.style.display = 'block';
             jumpVal.innerText = "Start (1)";
        } else {
             // Even Index
             jumpRow.style.display = 'none';
        }

        // Properties
        let props = [];
        if (d.isPrime) props.push("<span class='highlight-orange'>PRIME GNOMON</span>");
        if (d.i % 2 !== 0) props.push("Odd Index");
        else props.push("Even Index");
        
        document.getElementById('sel-props').innerHTML = props.join(" • ");
    }

    /* --- 4. CONTROLS --- */
    worker.onmessage = (e) => {
        if (e.data.type === 'DATA') {
            data = e.data.data;
            requestAnimationFrame(draw);
        }
    };
    function refresh() { worker.postMessage({ type: 'GENERATE', maxIndex: config.maxIndex }); }

    document.getElementById('slider-max').addEventListener('input', (e) => {
        config.maxIndex = parseInt(e.target.value);
        document.getElementById('max-idx-display').innerText = config.maxIndex;
        refresh();
    });

    document.getElementById('chk-primes').addEventListener('change', (e) => {
        config.showPrimes = e.target.checked;
        requestAnimationFrame(draw);
    });

    document.getElementById('chk-mod8').addEventListener('change', (e) => {
        config.showMod8 = e.target.checked;
        requestAnimationFrame(draw);
    });

    function toggleControls() {
        const c = document.getElementById('controls');
        c.style.display = (c.style.display === 'block') ? 'none' : 'block';
    }

    function resetView() {
        view = { x: 40, y: 40, scale: 25, minScale: 2, maxScale: 150 };
        requestAnimationFrame(draw);
    }

    refresh();
    resize();
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; requestAnimationFrame(draw); }
    window.addEventListener('resize', resize);
</script>
</body>
</html>
