<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3-ENGINE: DEPTH SOUNDER</title>
<style>
    :root {
        --bg: #000000;
        --grid: #1e293b;
        --cyan: #00f3ff;
        --gold: #ffd700;
        --alert: #ff0055;
        --matrix: #0aff0a;
    }
    body {
        margin: 0; background: var(--bg); color: #fff;
        font-family: 'Consolas', 'Monaco', monospace;
        display: flex; flex-direction: column; height: 100vh;
        overflow: hidden;
    }
    
    /* --- HUD HEADER --- */
    .hud {
        background: rgba(10,10,10,0.9);
        border-bottom: 2px solid var(--cyan);
        padding: 15px; z-index: 100;
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
    }
    .hud-title { font-size: 1.5rem; letter-spacing: 4px; color: var(--cyan); text-shadow: 0 0 10px var(--cyan); margin-bottom: 10px; }
    
    .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
    input {
        background: #0a0a0a; border: 1px solid #333; color: var(--gold);
        font-family: inherit; font-size: 1.1rem; padding: 10px; flex: 1;
        letter-spacing: 1px;
    }
    button {
        background: var(--cyan); color: #000; border: none;
        padding: 0 25px; font-weight: 900; font-size: 1.1rem;
        cursor: pointer; text-transform: uppercase;
        clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%);
        transition: all 0.2s;
    }
    button:hover { background: #fff; box-shadow: 0 0 15px #fff; }
    button.stop { background: var(--alert); color: #fff; }

    /* --- STATS BAR --- */
    .stats-bar {
        display: flex; gap: 20px; font-size: 0.8rem; color: #888;
        border-top: 1px solid #333; padding-top: 10px;
    }
    .stat-val { color: var(--matrix); font-weight: bold; margin-left: 5px; }

    /* --- MAIN DISPLAY --- */
    #viewport {
        flex: 1; position: relative;
        background: linear-gradient(0deg, rgba(0,20,0,0.2) 0%, rgba(0,0,0,1) 100%);
        overflow: hidden;
    }
    
    /* RAIN LANES */
    .lane-container {
        display: flex; height: 100%; width: 100%;
        position: absolute; top: 0; left: 0;
    }
    .lane {
        flex: 1; border-right: 1px dashed rgba(0, 243, 255, 0.1);
        position: relative; overflow: hidden;
    }
    .lane-header {
        text-align: center; color: #444; font-size: 0.7rem; padding-top: 5px;
        border-bottom: 1px solid #333;
    }
    .lane.active .lane-header { color: var(--cyan); font-weight: bold; background: rgba(0, 243, 255, 0.1); }
    
    /* DROPS */
    .drop {
        position: absolute; width: 100%; height: 20px;
        background: linear-gradient(180deg, transparent, var(--cyan));
        opacity: 0.5; animation: fall linear infinite;
    }
    @keyframes fall { from { top: -20%; } to { top: 120%; } }

    /* --- RESULTS PANEL --- */
    #result-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.95); display: none;
        flex-direction: column; align-items: center; justify-content: center;
        z-index: 200;
    }
    .success-box {
        border: 2px solid var(--matrix); padding: 30px;
        background: rgba(0, 20, 0, 0.8); box-shadow: 0 0 50px rgba(10, 255, 10, 0.2);
        max-width: 800px; width: 90%; text-align: left;
    }
    .trace-step {
        font-family: monospace; color: #888; margin: 5px 0; border-left: 2px solid #333; padding-left: 10px;
    }
    .trace-root { color: var(--gold); border-left: 2px solid var(--gold); font-weight: bold; font-size: 1.1rem; margin-top: 15px; }
    .trace-target { color: var(--cyan); border-left: 2px solid var(--cyan); font-weight: bold; font-size: 1.2rem; margin-bottom: 15px; }

</style>
</head>
<body>

<div class="hud">
    <div class="hud-title">3-ENGINE // DEPTH SOUNDER</div>
    <div class="input-group">
        <input type="text" id="inpN" value="71641520761751435455133616475667090434063332228247871795429" placeholder="TARGET N">
        <button id="btnScan" onclick="toggleScan()">INITIATE SCAN</button>
    </div>
    <div class="stats-bar">
        <div>MOD 9 SIG: <span id="modSig" class="stat-val">-</span></div>
        <div>ACTIVE LANES: <span id="activeLanes" class="stat-val">-</span></div>
        <div>DEPTH (k): <span id="depthVal" class="stat-val">0</span></div>
        <div>SPEED: <span id="speedVal" class="stat-val">0</span> k/s</div>
    </div>
</div>

<div id="viewport">
    <div class="lane-container" id="lanes">
        </div>
    <div style="position:absolute; bottom:10px; left:10px; color:#444; font-size:3rem; font-weight:900; opacity:0.3; pointer-events:none;">
        FAR-FIELD SCANNING
    </div>
</div>

<div id="result-overlay">
    <div class="success-box" id="resultContent"></div>
    <button style="margin-top:20px; border-color:var(--matrix); color:var(--matrix); background:transparent;" onclick="document.getElementById('result-overlay').style.display='none'">ACKNOWLEDGE</button>
</div>

<script id="worker-code" type="javascript/worker">
    self.onmessage = function(e) {
        const { cmd, N_str, startK } = e.data;
        if(cmd === 'scan') {
            const N = BigInt(N_str);
            const nMod = Number(N % 9n);
            const batchSize = 1000000;
            let k = BigInt(startK);
            
            // --- MOD 9 PRE-CALCULATION ---
            // We want to skip invalid k.
            // A = 2k + 3.
            // If N is not div by 3, A cannot be div by 3.
            // A = 0,3,6 mod 9 are invalid.
            // 2k+3 != 0,3,6 mod 9.
            // 2k != 6,0,3 mod 9.
            // k != 3,0,6 mod 9.
            // We construct a stride map.
            // Or simpler: just check `if (k%3n === 0n) continue` inside loop.
            // That handles the "Increment by 6" logic (skipping 1/3 of checks).
            
            const t0 = performance.now();
            
            while(true) {
                for(let i=0; i<batchSize; i++) {
                    // Filter: if k is multiple of 3, then 2k is mult of 3, 2k+3 is mult of 3.
                    // If N is not div by 3, this is impossible.
                    if (k % 3n === 0n) {
                        k++; 
                        continue;
                    }

                    // The Core Check
                    let A = (k * 2n) + 3n;
                    
                    if (N % A === 0n) {
                        // HIT!
                        let B = N / A;
                        self.postMessage({ type: 'found', k: k.toString(), A: A.toString(), B: B.toString() });
                        return;
                    }
                    k++;
                }
                
                // Report progress
                const t1 = performance.now();
                self.postMessage({ type: 'progress', currentK: k.toString(), time: t1-t0 });
                if (t1-t0 > 500) { // Throttle messages
                     // self.postMessage... 
                }
            }
        }
    };
</script>

<script>
    let worker;
    let isScanning = false;
    let scanSpeed = 0;
    let lastK = 0n;
    let lastTime = 0;

    // --- UI SETUP ---
    function initLanes() {
        const container = document.getElementById('lanes');
        container.innerHTML = '';
        for(let i=0; i<9; i++) {
            let d = document.createElement('div');
            d.className = 'lane';
            d.id = `lane-${i}`;
            d.innerHTML = `<div class="lane-header">${i}</div>`;
            container.appendChild(d);
        }
    }
    initLanes();

    // --- LOGIC ---
    function toggleScan() {
        if(isScanning) {
            stopScan();
        } else {
            startScan();
        }
    }

    function startScan() {
        const nStr = document.getElementById('inpN').value.trim();
        if(!nStr) return;
        
        // UI Updates
        document.getElementById('btnScan').innerText = "ABORT SCAN";
        document.getElementById('btnScan').classList.add('stop');
        isScanning = true;
        
        const N = BigInt(nStr);
        const mod9 = Number(N % 9n);
        document.getElementById('modSig').innerText = mod9;
        
        // Highlight Active Lanes (Where k is NOT 0,3,6 mod 9)
        // Actually, the worker checks k % 3 !== 0.
        // This corresponds to k mod 9 in {1,2, 4,5, 7,8}.
        // Lanes 0,3,6 are DEAD.
        let activeCount = 0;
        for(let i=0; i<9; i++) {
            const el = document.getElementById(`lane-${i}`);
            if(i % 3 !== 0) {
                el.classList.add('active');
                // Add rain effect
                let drop = document.createElement('div');
                drop.className = 'drop';
                drop.style.animationDuration = (Math.random()*2 + 1) + 's';
                el.appendChild(drop);
                activeCount++;
            } else {
                el.classList.remove('active');
                el.innerHTML = `<div class="lane-header">${i}</div>`; // Clear drops
                el.style.background = "rgba(255,0,0,0.05)"; // Dead zone
            }
        }
        document.getElementById('activeLanes').innerText = `${activeCount} / 9`;

        // Start Worker
        const blob = new Blob([document.getElementById('worker-code').textContent], { type: "text/javascript" });
        worker = new Worker(window.URL.createObjectURL(blob));
        
        worker.onmessage = function(e) {
            if(e.data.type === 'found') {
                handleSuccess(e.data, N);
            } else if (e.data.type === 'progress') {
                const k = BigInt(e.data.currentK);
                document.getElementById('depthVal').innerText = k.toLocaleString();
                
                // Calc speed
                const now = performance.now();
                if(now - lastTime > 1000) {
                    const diff = k - lastK;
                    document.getElementById('speedVal').innerText = (diff).toLocaleString();
                    lastK = k;
                    lastTime = now;
                }
            }
        };
        
        worker.postMessage({ cmd: 'scan', N_str: nStr, startK: "0" });
        lastTime = performance.now();
    }

    function stopScan() {
        if(worker) worker.terminate();
        isScanning = false;
        document.getElementById('btnScan').innerText = "INITIATE SCAN";
        document.getElementById('btnScan').classList.remove('stop');
        initLanes(); // Reset visuals
    }

    function handleSuccess(data, N) {
        stopScan();
        const k = BigInt(data.k);
        const A = BigInt(data.A);
        const B = BigInt(data.B);
        
        // Back-Trace Logic
        // We simulate the descent from the 3-Line Root.
        // N = (Root + 2k)(3 + 2k).
        // A = 3 + 2k.
        // B = Root + 2k.
        // Root = B - 2k = B - (A-3) = B - A + 3.
        
        const Root = B - A + 3n;
        
        let html = `
            <div style="color:var(--matrix); font-size:2rem; font-weight:900; margin-bottom:20px;">TARGET ACQUIRED</div>
            <div class="trace-target">TARGET: ${N}</div>
            
            <div style="margin-bottom:10px; color:#fff;">SCAN DEPTH (k): <span style="color:var(--cyan);">${k}</span></div>
            <div style="margin-bottom:20px; color:#fff;">FACTOR A (3 + 2k): <span style="color:var(--gold); font-size:1.5rem;">${A}</span></div>
            <div style="margin-bottom:20px; color:#fff;">FACTOR B: <span style="color:var(--gold); font-size:1.5rem;">${B}</span></div>
            
            <div style="margin-top:30px; border-top:1px solid #333; padding-top:10px;">
                <div style="color:#888; font-size:0.8rem;">BACK-TRACE LOG:</div>
                <div class="trace-step">Gen -0: ${A} × ${B} = ${N}</div>
                <div class="trace-step">Gen -1: ${A-2n} × ${B-2n}</div>
                <div class="trace-step">... (${k-1n} steps) ...</div>
                <div class="trace-step">Gen -${k}: 3 × ${Root}</div>
                <div class="trace-root">ORIGIN ROOT: ${Root}</div>
                <div style="color:#666; font-size:0.8rem; margin-top:5px;">This 60-digit number is the ${k}th descendant of the 3-Line Root ${Root}.</div>
            </div>
        `;
        
        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('result-overlay').style.display = 'flex';
    }

</script>
</body>
</html>
