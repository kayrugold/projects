<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
<title>Gnomon Overlay v5 – Parchment + Collapsible Panel</title>
<style>
:root{
  --ink:#3f2e2a;
  --ink2:#6b4e3d;
  --paper:#f3e5ab;
  --paper2:#f7efc8;
  --accent:#b91c1c;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; overflow:hidden;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  background:
    radial-gradient(1200px 600px at 20% 10%, rgba(255,255,255,.35), transparent 60%),
    radial-gradient(900px 700px at 85% 40%, rgba(0,0,0,.08), transparent 55%),
    linear-gradient(180deg, var(--paper2), var(--paper));
}

/* Top bar */
#top{
  position:fixed; left:0; right:0; top:0; z-index:50;
  display:flex; gap:10px; align-items:center;
  padding:10px 10px;
  background:rgba(20,26,35,.92);
  border-bottom:3px solid #31c7d9;
  box-shadow:0 8px 30px rgba(0,0,0,.25);
}
.btn{
  padding:10px 14px;
  border-radius:12px;
  border:2px solid rgba(255,255,255,.08);
  background:rgba(17,24,39,.85);
  color:#e5e7eb;
  font-weight:900;
  letter-spacing:.4px;
  cursor:pointer;
  user-select:none;
}
.btn.primary{
  background:#31c7d9;
  color:#06141a;
  border-color:transparent;
}
.btn.on{ box-shadow:0 0 0 2px rgba(49,199,217,.30) inset; }
#jump{
  flex:1; min-width:0;
  padding:10px 12px;
  border-radius:12px;
  border:2px solid rgba(255,255,255,.10);
  background:rgba(2,6,23,.35);
  color:#fff;
  font-weight:900;
  font-size:16px;
  text-align:center;
  outline:none;
}

/* Canvas fills almost entire screen */
#wrap{
  position:absolute; left:0; right:0;
  top:66px; bottom:0;
}
canvas{width:100%; height:100%; display:block}

/* Collapsible bottom sheet */
#sheet{
  position:fixed; left:0; right:0; bottom:0;
  z-index:60;
  padding:10px 10px 12px 10px;
  pointer-events:none; /* allow canvas touches except on panel itself */
}
#panel{
  pointer-events:auto;
  margin:0 auto;
  width:min(980px, calc(100vw - 20px));
  background:
    radial-gradient(900px 260px at 30% 0%, rgba(255,255,255,.35), transparent 65%),
    linear-gradient(180deg, #fff7df, var(--paper));
  border:3px solid var(--ink2);
  border-radius:18px;
  box-shadow:0 20px 60px rgba(0,0,0,.25);
  position:relative;
  overflow:hidden;
  transition:height .22s ease, transform .22s ease, opacity .22s ease;
  height: 86px; /* collapsed default */
  opacity:.96;
}
#panel.expanded{
  height:min(62vh, 560px);
}
#panel:before{
  content:"";
  position:absolute; inset:10px;
  border:2px solid rgba(107,78,61,.35);
  border-radius:12px;
  pointer-events:none;
}

/* drag handle */
#handle{
  height:26px;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.03);
  border-bottom:2px solid rgba(107,78,61,.25);
}
#pill{
  width:78px; height:8px; border-radius:999px;
  background:rgba(63,46,42,.28);
}

/* inner panel content */
#inner{
  padding:12px 12px 14px 12px;
}
.hdr{
  display:flex; justify-content:space-between; gap:10px; align-items:flex-end;
  padding:2px 4px 10px 4px;
  border-bottom:2px solid rgba(107,78,61,.35);
  margin-bottom:10px;
}
.title{
  color:var(--accent);
  font-weight:900;
  font-size:18px;
  letter-spacing:1px;
}
.small{
  color:rgba(63,46,42,.70);
  font-weight:900;
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:1px;
}
.grid{
  display:grid;
  grid-template-columns: 1.3fr 1fr 1fr;
  gap:10px;
}
.card{
  background:rgba(255,255,255,.55);
  border:2px solid rgba(107,78,61,.35);
  border-radius:14px;
  padding:10px;
}
.lbl{
  font-size:11px;
  color:rgba(63,46,42,.70);
  font-weight:900;
  letter-spacing:1px;
  text-transform:uppercase;
}
.val{
  margin-top:6px;
  font-size:18px;
  font-weight:900;
  color:var(--ink);
  word-break:break-all;
}
.sub{
  margin-top:4px;
  font-size:12px;
  color:rgba(63,46,42,.85);
  font-weight:800;
}

#bigBtns{
  display:flex; gap:14px; justify-content:center;
  margin-top:12px;
}
.bigBtn{
  min-width:160px;
  padding:14px 18px;
  border-radius:16px;
  background:linear-gradient(180deg, #fffdf4, #f3ead0);
  border:3px solid var(--ink2);
  box-shadow:0 10px 24px rgba(0,0,0,.18);
  font-weight:900;
  font-size:18px;
  color:var(--ink);
  cursor:pointer;
}
.bigBtn:active{transform:translateY(1px)}

@media (max-width:820px){
  .grid{grid-template-columns:1fr}
  #bigBtns .bigBtn{flex:1}
}
</style>
</head>
<body>

<div id="top">
  <button class="btn on" id="btnMirror">GNOMON</button>
  <button class="btn on" id="btnEqui">TRIVIALS</button>
  <button class="btn" id="btnDense">SPLIT</button>
  <button class="btn" id="btnPanel">PANEL</button>
  <button class="btn" id="btnResetTop">RESET</button>
  <button class="btn primary" id="btnJumpTop">FIND ID</button>
  <input id="jump" placeholder="TapeID (e.g. 368) or k,b (e.g. 26,34)"/>
</div>

<div id="wrap"><canvas id="cv"></canvas></div>

<div id="sheet">
  <div id="panel">
    <div id="handle" title="Tap to expand/collapse"><div id="pill"></div></div>
    <div id="inner">
      <div class="hdr">
        <div class="title" id="panelTitle">GNOMON OVERLAY</div>
        <div class="small" id="panelMeta">ROW (k) —  •  SCALE 1.00x</div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="lbl">Selected Cell (k,b)</div>
          <div class="val" id="outKB">—</div>
          <div class="sub" id="outIDs">TapeID — • PhaseID —</div>
        </div>
        <div class="card">
          <div class="lbl">Cargo Value (N)</div>
          <div class="val" id="outN">—</div>
          <div class="sub" id="outMore">a.q.r —</div>
        </div>
        <div class="card">
          <div class="lbl">Notes</div>
          <div class="sub" style="line-height:1.35">
            Tap cells on the right triangle to read Cargo / a.q.r / TapeID.<br/>
            Everything is built additively (8-shells + triangle sums).
          </div>
        </div>
      </div>

      <div id="bigBtns">
        <button class="bigBtn" id="btnOrigin">Origin</button>
        <button class="bigBtn" id="btnJump">Jump</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= ENUMERATION (NO ×, ÷, mod, √) ========= */
function buildRow(k){
  let K=0n, T=0n, a=1n, S=1n, g=8n;
  while(K<k){
    K++;
    T += K;
    a += 2n;
    S += g;
    g += 8n;
  }
  return {k:K, T:T, a:a, S:S, step:(a+a)};
}
function cargo(row,b){
  let N=row.S, i=0n;
  while(i<b){ N -= row.step; i++; }
  return N;
}
function phaseAQR(row,b){
  let G=0n, i=0n;
  while(i<b){ G += row.step; i++; }
  let q=0n;
  while(G>=8n){ G -= 8n; q++; }
  return {a:row.a, q:q, r:G};
}
function fromTape(id){
  let k=0n, T=0n;
  while(true){
    let nk=k+1n, nT=T+nk;
    if(nT>id) break;
    k=nk; T=nT;
  }
  let b = id - T;
  if(b>k) b=k;
  return {k:k, b:b};
}

/* ========= CANVAS DRAW ========= */
const wrap=document.getElementById("wrap");
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");
let DPR=window.devicePixelRatio||1;

let showMirror=true, showEqui=true, dense=false;
let ox=0, oy=0, scale=1;
let last=null;
let sel={k:0n,b:0n};

const CELL=92;

function resize(){
  DPR=window.devicePixelRatio||1;
  cv.width = wrap.clientWidth*DPR;
  cv.height = wrap.clientHeight*DPR;
  draw();
}
window.addEventListener("resize", resize);

function draw(){
  const W=cv.width/DPR, H=cv.height/DPR;

  ctx.setTransform(DPR,0,0,DPR,0,0);
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,"#fff7df");
  g.addColorStop(1,"#f3e5ab");
  ctx.fillStyle=g;
  ctx.fillRect(0,0,cv.width,cv.height);

  // graph paper
  ctx.globalAlpha=0.18;
  ctx.strokeStyle="#9ca3af";
  ctx.lineWidth=1;
  const step=28;
  for(let x=0;x<W;x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  for(let y=0;y<H;y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
  ctx.globalAlpha=1;

  ctx.setTransform(DPR,0,0,DPR,ox,oy);

  const mid = dense ? 0 : W*0.46;

  if(showMirror && !dense) drawMirror(18,18,mid-36,H-36);
  if(showEqui) drawEqui(mid+18,18,W-mid-36,H-36);
}

function inkRect(x,y,w,h,thick=3){
  ctx.save();
  ctx.lineWidth=thick;
  ctx.strokeStyle="rgba(63,46,42,.55)";
  ctx.strokeRect(x,y,w,h);
  ctx.lineWidth=1.6;
  ctx.strokeStyle="rgba(63,46,42,.25)";
  ctx.strokeRect(x+6,y+6,w-12,h-12);
  ctx.restore();
}

function drawMirror(x0,y0,w,h){
  const rows=Math.floor(h/(CELL*scale));
  inkRect(x0-8,y0-8,w+16,h+16,3);
  for(let r=0;r<rows;r++){
    const k=BigInt(r);
    const row=buildRow(k);
    const cols=Math.min(r+1, Math.floor(w/(CELL*scale)));
    for(let c=0;c<cols;c++){
      const b=BigInt(c);
      const x=x0+c*CELL*scale;
      const y=y0+r*CELL*scale;
      ctx.save();
      ctx.fillStyle="rgba(255,255,255,.50)";
      ctx.fillRect(x,y,CELL*scale-8,CELL*scale-8);
      ctx.strokeStyle="rgba(63,46,42,.25)";
      ctx.lineWidth=2;
      ctx.strokeRect(x,y,CELL*scale-8,CELL*scale-8);
      const N=cargo(row,b).toString();
      ctx.fillStyle="rgba(63,46,42,.55)";
      ctx.font="12px ui-monospace, monospace";
      ctx.fillText(N, x+10, y+20);
      ctx.restore();
    }
  }
}

function drawEqui(x0,y0,w,h){
  const dy=CELL*0.80*scale;
  const dx=CELL*0.94*scale;
  const rows=Math.floor(h/dy);
  inkRect(x0-8,y0-8,w+16,h+16,3);

  for(let r=0;r<rows;r++){
    const k=BigInt(r);
    const row=buildRow(k);
    const cols=Math.min(r+1, Math.floor(w/dx));
    for(let c=0;c<cols;c++){
      const b=BigInt(c);
      const x=x0 + c*dx + r*dx*0.5;
      const y=y0 + r*dy;

      ctx.save();
      ctx.fillStyle="rgba(255,255,255,.62)";
      ctx.fillRect(x,y,CELL*scale-10,CELL*scale-10);
      ctx.strokeStyle="rgba(63,46,42,.32)";
      ctx.lineWidth=2;
      ctx.strokeRect(x,y,CELL*scale-10,CELL*scale-10);

      const N=cargo(row,b);
      const tid=row.T+b;
      const aqr=phaseAQR(row,b);

      ctx.fillStyle="#3f2e2a";
      ctx.font="bold 18px ui-monospace, monospace";
      ctx.fillText(N.toString(), x+10, y+28);

      ctx.fillStyle="#0b4a4a";
      ctx.font="bold 12px ui-monospace, monospace";
      ctx.fillText(`${aqr.a}.${aqr.q}.${aqr.r}`, x+10, y+46);

      ctx.fillStyle="rgba(63,46,42,.65)";
      ctx.font="bold 11px ui-monospace, monospace";
      const tag="ID "+tid.toString();
      const tw=ctx.measureText(tag).width;
      ctx.fillText(tag, x+(CELL*scale-14)-tw, y+18);

      if(k===sel.k && b===sel.b){
        ctx.strokeStyle="rgba(185,28,28,.75)";
        ctx.lineWidth=4;
        ctx.strokeRect(x-2,y-2,CELL*scale-6,CELL*scale-6);
      }
      ctx.restore();
    }
  }
}

function pickEquiWorld(wx,wy){
  const W=cv.width/DPR;
  const mid = dense ? 0 : W*0.46;

  const dy=CELL*0.80*scale;
  const dx=CELL*0.94*scale;

  const r = Math.floor((wy - 18)/dy);
  if(r<0) return null;

  const baseX = (wx - (mid+18) - r*dx*0.5);
  const c = Math.floor(baseX/dx);
  if(c<0 || c>r) return null;

  const cellX = (mid+18) + c*dx + r*dx*0.5;
  const cellY = 18 + r*dy;

  if(wx < cellX || wx > cellX + (CELL*scale-10)) return null;
  if(wy < cellY || wy > cellY + (CELL*scale-10)) return null;

  return {k:BigInt(r), b:BigInt(c)};
}

/* ========= PANEL / UI ========= */
const panel=document.getElementById("panel");
const handle=document.getElementById("handle");

function togglePanel(force){
  const willExpand = (typeof force==="boolean") ? force : !panel.classList.contains("expanded");
  panel.classList.toggle("expanded", willExpand);
}
handle.addEventListener("click", ()=>togglePanel());
document.getElementById("btnPanel").addEventListener("click", ()=>togglePanel());

const btnMirror=document.getElementById("btnMirror");
const btnEqui=document.getElementById("btnEqui");
const btnDense=document.getElementById("btnDense");
const btnResetTop=document.getElementById("btnResetTop");
const btnJumpTop=document.getElementById("btnJumpTop");
const inp=document.getElementById("jump");
const btnOrigin=document.getElementById("btnOrigin");
const btnJump=document.getElementById("btnJump");

function updatePanel(){
  const row=buildRow(sel.k);
  const N=cargo(row,sel.b);
  const tid=row.T+sel.b;
  const aqr=phaseAQR(row,sel.b);

  document.getElementById("panelMeta").textContent = `ROW (k) ${sel.k}  •  SCALE ${scale.toFixed(2)}x`;
  document.getElementById("outKB").textContent = `${sel.k}, ${sel.b}`;
  document.getElementById("outIDs").textContent = `TapeID: ${tid}  •  PhaseID: ${aqr.a}.${aqr.q}.${aqr.r}`;
  document.getElementById("outN").textContent = N.toString();
  document.getElementById("outMore").textContent = `a.q.r = ${aqr.a}.${aqr.q}.${aqr.r}   |   Spine S = ${row.S}`;
}

function doOrigin(){
  ox=0; oy=0; scale=1;
  sel={k:0n,b:0n};
  updatePanel();
  draw();
}
function doJump(){
  const v=inp.value.trim();
  if(!v) return;
  if(v.includes(",")){
    const [k,b]=v.split(",").map(s=>s.trim());
    sel={k:BigInt(k), b:BigInt(b)};
  }else{
    const id=BigInt(v);
    const r=fromTape(id);
    sel={k:r.k, b:r.b};
  }
  updatePanel();
  draw();
  togglePanel(true); // expand when user jumps
}

btnMirror.onclick=()=>{showMirror=!showMirror;btnMirror.classList.toggle("on",showMirror);draw();};
btnEqui.onclick=()=>{showEqui=!showEqui;btnEqui.classList.toggle("on",showEqui);draw();};
btnDense.onclick=()=>{dense=!dense; btnDense.classList.toggle("on",dense); draw();};
btnResetTop.onclick=doOrigin;
btnJumpTop.onclick=doJump;
btnOrigin.onclick=doOrigin;
btnJump.onclick=doJump;

/* pan + tap select */
wrap.addEventListener("pointerdown", e=>{
  wrap.setPointerCapture(e.pointerId);
  last={x:e.clientX,y:e.clientY, moved:false};
});
wrap.addEventListener("pointermove", e=>{
  if(!last) return;
  const dx=e.clientX-last.x, dy=e.clientY-last.y;
  if(Math.abs(dx)+Math.abs(dy)>2) last.moved=true;
  ox+=dx; oy+=dy;
  last.x=e.clientX; last.y=e.clientY;
  draw();
});
wrap.addEventListener("pointerup", e=>{
  if(!last) return;
  if(!last.moved){
    const rect=cv.getBoundingClientRect();
    const sx=(e.clientX-rect.left);
    const sy=(e.clientY-rect.top);

    const wx = sx - ox;
    const wy = sy - oy;

    const picked = pickEquiWorld(wx,wy);
    if(picked){
      sel=picked;
      updatePanel();
      draw();
      // quick peek panel without blocking: leave collapsed unless user wants
    }
  }
  last=null;
});

/* init */
doOrigin();
resize();
</script>
</body>
</html>
