<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GNOMON: FRACTAL DRILL</title>
<style>
    :root {
        --bg: #050505;
        --neon: #00ff41;
        --warn: #ff003c;
        --cyan: #00f3ff;
        --gold: #ffd700;
        --panel: #111;
    }
    body {
        background: var(--bg); color: #fff;
        font-family: 'Courier New', monospace;
        margin: 0; height: 100vh; display: flex; flex-direction: column;
        overflow: hidden;
    }

    /* --- HUD --- */
    .hud {
        background: #111; border-bottom: 2px solid var(--neon);
        padding: 15px; z-index: 100;
        box-shadow: 0 5px 20px #000;
        display: flex; gap: 20px; align-items: center;
    }
    .hud-title {
        font-weight: 900; letter-spacing: 2px; color: var(--neon);
        display: flex; flex-direction: column; font-size: 0.8rem;
    }
    .hud-title span { font-size: 1.2rem; }

    input {
        background: #000; border: 1px solid #444; color: var(--gold);
        font-family: inherit; font-size: 1.1rem; padding: 10px; flex: 1;
        font-weight: bold; min-width: 200px;
    }

    .btn-group { display: flex; gap: 5px; }
    button {
        border: none; padding: 10px 20px; font-weight: 900; cursor: pointer;
        text-transform: uppercase; letter-spacing: 1px; transition: all 0.1s;
    }
    .btn-squeeze {
        background: var(--warn); color: #fff;
        clip-path: polygon(10% 0, 100% 0, 100% 100%, 0 100%);
    }
    .btn-lock {
        background: var(--cyan); color: #000;
        clip-path: polygon(0 0, 90% 0, 100% 100%, 0 100%);
    }
    .btn-narrow {
        background: var(--neon); color: #000;
        clip-path: polygon(0 0, 100% 0, 90% 100%, 0 100%);
    }
    .btn-reset { background: #333; color: #888; }
    
    button:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
    button:active { transform: scale(0.95); filter: brightness(1.2); }

    /* --- CHAMBER --- */
    .chamber {
        flex: 1; position: relative;
        display: flex; justify-content: center; align-items: center;
        perspective: 1000px; overflow: hidden;
        background: radial-gradient(circle at center, #1a1a1a 0%, #000 70%);
    }
    
    /* WALLS */
    .wall {
        position: absolute; height: 200%; width: 1000px;
        background: linear-gradient(90deg, #000 0%, rgba(255,0,60,0.2) 100%);
        border-right: 4px solid var(--warn);
        transform-origin: center right;
        transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        display: flex; align-items: center; justify-content: flex-end;
        left: -1050px; transform: translateX(-50px) rotateY(20deg);
    }
    .wall.right { 
        right: -1050px; left: auto;
        background: linear-gradient(-90deg, #000 0%, rgba(255,0,60,0.2) 100%);
        border-right: none; border-left: 4px solid var(--warn);
        justify-content: flex-start;
        transform: translateX(50px) rotateY(-20deg);
    }

    .wall-label {
        color: var(--warn); font-size: 1.2rem; font-weight: bold;
        writing-mode: vertical-rl; padding: 20px; text-shadow: 0 0 10px var(--warn);
        opacity: 0.7; font-family: monospace;
    }

    /* CORE (Target) */
    .core-display {
        position: relative; z-index: 10;
        display: flex; flex-direction: column; align-items: center;
        transition: transform 0.5s;
    }
    .target-val {
        font-size: 2rem; color: #fff; font-weight: bold;
        background: rgba(0,0,0,0.8); padding: 15px 30px; border: 2px solid #fff;
        text-align: center; margin-bottom: 10px;
        box-shadow: 0 0 20px rgba(255,255,255,0.2);
    }
    .target-meta { color: var(--cyan); font-size: 0.9rem; letter-spacing: 2px; }

    /* LOCK RING */
    .lock-ring {
        position: absolute; width: 350px; height: 350px;
        border: 4px dashed var(--cyan); border-radius: 50%;
        animation: spin 10s linear infinite;
        opacity: 0; transition: opacity 0.5s; pointer-events: none;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* LOG PANEL */
    .drill-log {
        position: absolute; bottom: 20px; left: 20px;
        font-family: monospace; font-size: 0.8rem; color: #666;
        max-height: 200px; overflow-y: auto; pointer-events: none;
    }
    .log-entry { margin-bottom: 5px; border-left: 2px solid #333; padding-left: 10px; }
    .log-hl { color: var(--neon); }

    /* STATES */
    .state-squeezed .wall.left { transform: translateX(350px) rotateY(0deg); }
    .state-squeezed .wall.right { transform: translateX(-350px) rotateY(0deg); }
    
    .state-locked .lock-ring { opacity: 1; border-style: solid; border-color: var(--gold); animation-duration: 2s; transform: scale(0.9); }
    .state-locked .target-val { border-color: var(--gold); color: var(--gold); }

    .state-narrow .core-display { transform: scale(0.5); opacity: 0; } /* Zoom out effect */

</style>
</head>
<body>

<div class="hud">
    <div class="hud-title">GNOMON <span>FRACTAL DRILL</span></div>
    <input type="text" id="inpN" value="71641520761751435455133616475667090434063332228247871795429">
    <div class="btn-group">
        <button class="btn-squeeze" id="btnSqueeze" onclick="doSqueeze()">1. SQUEEZE</button>
        <button class="btn-lock" id="btnLock" onclick="doLock()" disabled>2. LOCK RAY</button>
        <button class="btn-narrow" id="btnNarrow" onclick="doNarrow()" disabled>3. DRILL DOWN</button>
        <button class="btn-reset" onclick="reset()">RESET</button>
    </div>
</div>

<div class="chamber" id="chamber">
    <div class="lock-ring"></div>
    
    <div class="wall left" id="wallL"><div class="wall-label" id="lblL">LOWER</div></div>
    
    <div class="core-display" id="coreDisp">
        <div class="target-meta" id="lblGen">GENERATION 0</div>
        <div class="target-val" id="dispN">TARGET</div>
    </div>
    
    <div class="wall right" id="wallR"><div class="wall-label" id="lblR">UPPER</div></div>

    <div class="drill-log" id="logBox"></div>
</div>

<script>
    // ENGINE STATE
    let gen = 0;
    let currentTarget = 0n;
    let nextTarget = 0n; // This will be the Quotient
    let currentRay = 0n; // The Remainder
    let lastDivisor = 9n; // Starts at 9, then becomes previous Remainder

    const chamber = document.getElementById('chamber');
    const dispN = document.getElementById('dispN');
    const lblGen = document.getElementById('lblGen');
    const btnS = document.getElementById('btnSqueeze');
    const btnL = document.getElementById('btnLock');
    const btnN = document.getElementById('btnNarrow');

    function log(txt) {
        const d = document.createElement('div');
        d.className = 'log-entry';
        d.innerHTML = txt;
        document.getElementById('logBox').prepend(d);
    }

    function reset() {
        gen = 0;
        currentTarget = 0n;
        lastDivisor = 9n;
        chamber.className = 'chamber';
        dispN.innerText = "TARGET";
        lblGen.innerText = "GENERATION 0";
        document.getElementById('logBox').innerHTML = '';
        btnS.disabled = false;
        btnL.disabled = true;
        btnN.disabled = true;
    }

    function doSqueeze() {
        const nStr = (gen === 0) ? document.getElementById('inpN').value.trim() : currentTarget.toString();
        if(gen === 0) currentTarget = BigInt(nStr);
        
        // 1. FIND WALLS (Mod 3)
        // Walls are simply nearest multiples of 3.
        let mod3 = currentTarget % 3n;
        let lower = currentTarget - mod3;
        if(lower % 2n === 0n) lower -= 3n;
        let upper = currentTarget + (3n - mod3);
        if(upper % 2n === 0n) upper += 3n;

        // Visuals
        dispN.innerText = fmt(currentTarget);
        document.getElementById('lblL').innerText = fmt(lower);
        document.getElementById('lblR').innerText = fmt(upper);
        
        chamber.classList.add('state-squeezed');
        log(`<span style="color:#fff">GEN ${gen} SQUEEZE:</span> Walls set at Â±${(upper-currentTarget)}`);
        
        btnS.disabled = true;
        btnL.disabled = false;
    }

    function doLock() {
        // 2. LOCK RAY (Mod 9 or Mod Previous Remainder)
        // User logic: "Dividing quotient mod remainder"
        // Cycle 0: Divisor is 9.
        // Cycle 1+: Divisor is Previous Remainder.
        
        // Safety: If lastDivisor is 0 or 1, we might get stuck or error.
        if (lastDivisor <= 1n) lastDivisor = 9n; // Reset to 9 if we hit atomic

        currentRay = currentTarget % lastDivisor;
        nextTarget = currentTarget / lastDivisor; // This is the Quotient
        
        // Visuals
        chamber.classList.add('state-locked');
        log(`<span style="color:var(--cyan)">GEN ${gen} LOCK:</span> Ray ${currentRay} (Mod ${lastDivisor})`);
        log(`&nbsp;>> Quotient Identified: ${fmt(nextTarget)}`);
        
        btnL.disabled = true;
        btnN.disabled = false;
    }

    function doNarrow() {
        // 3. DRILL DOWN
        // We replace Current with Next (Quotient)
        // We update Divisor for next cycle (Remainder becomes new Divisor)
        
        chamber.classList.add('state-narrow'); // Zoom out animation
        
        setTimeout(() => {
            // LOGIC UPDATE
            gen++;
            currentTarget = nextTarget;
            
            // "Deduce the number down to stride 3"
            // We need to decide what the NEW Modulo is.
            // User: "Quotient mod Remainder".
            // So next divisor = currentRay.
            if(currentRay > 1n) {
                lastDivisor = currentRay;
            } else {
                // If Remainder was 0 or 1, we can't mod by it effectively. 
                // Default back to 3 or 9 to keep drilling?
                // Let's hold 3 as the floor.
                lastDivisor = 3n; 
                log(`<span style="color:var(--warn)">ATOMIC FLOOR REACHED. RESETTING MODULO TO 3.</span>`);
            }

            // VISUAL RESET
            chamber.className = 'chamber'; // Reset all animations
            lblGen.innerText = `GENERATION ${gen} (MOD ${lastDivisor})`;
            dispN.innerText = fmt(currentTarget);
            
            // Reset Buttons
            btnN.disabled = true;
            btnS.disabled = false; // Ready to squeeze new target
            
            log(`<span style="color:var(--neon)">>>> DESCENDING TO GEN ${gen}</span>`);
            
            // Auto-trigger Squeeze for flow? No, let user click.
        }, 500);
    }

    function fmt(n) {
        let s = n.toString();
        if(s.length > 12) return s.slice(0,6) + "..." + s.slice(-6);
        return s;
    }

</script>
</body>
</html>
