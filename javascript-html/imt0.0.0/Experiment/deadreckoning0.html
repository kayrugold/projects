<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GNOMON 3-ENGINE: DEAD RECKONING</title>
<style>
    :root {
        --bg: #020617; /* Deep Night */
        --glass: rgba(15, 23, 42, 0.6);
        --neon-cyan: #22d3ee;
        --neon-gold: #facc15;
        --neon-pink: #f472b6;
        --road-line: #334155;
        --text-main: #e2e8f0;
        --terminal-green: #4ade80;
    }

    * { box-sizing: border-box; }
    body {
        margin: 0; padding: 0;
        background: var(--bg); color: var(--text-main);
        font-family: 'Courier New', monospace;
        height: 100vh; display: flex; flex-direction: column;
        overflow: hidden;
    }

    /* --- DASHBOARD UI --- */
    .dashboard {
        padding: 15px;
        background: linear-gradient(180deg, #0f172a 0%, #020617 100%);
        border-bottom: 2px solid var(--neon-cyan);
        display: flex; flex-direction: column; gap: 10px;
        z-index: 10; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }
    
    .hud-row { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
    
    .title-mod {
        font-weight: 900; letter-spacing: 2px;
        color: var(--neon-cyan); text-shadow: 0 0 10px rgba(34, 211, 238, 0.4);
    }

    /* INPUTS */
    input[type="text"] {
        background: #000; border: 1px solid var(--neon-cyan);
        color: var(--neon-gold); font-size: 1.2rem; padding: 8px;
        font-family: 'Courier New', monospace; font-weight: bold;
        width: 100%; border-radius: 4px;
    }
    
    button {
        background: var(--neon-cyan); color: #000;
        border: none; padding: 10px 20px;
        font-weight: 900; cursor: pointer;
        text-transform: uppercase; letter-spacing: 1px;
        clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        transition: all 0.2s;
    }
    button:active { transform: scale(0.95); background: var(--neon-gold); }
    button.stop { background: var(--neon-pink); color: #fff; }

    /* STATS GRID */
    .stats-panel {
        display: grid; grid-template-columns: repeat(2, 1fr);
        gap: 8px; font-size: 0.8rem; color: #94a3b8;
    }
    .stat-box {
        background: rgba(255,255,255,0.05); padding: 5px 10px;
        border-left: 2px solid var(--neon-gold);
    }
    .stat-val { color: var(--neon-gold); font-weight: bold; margin-left: 5px; }

    /* --- WINDSHIELD (CANVAS) --- */
    #windshield-container {
        flex: 1; position: relative; overflow: hidden;
        background: radial-gradient(circle at 50% 100%, #1e293b 0%, #000000 70%);
    }
    canvas { width: 100%; height: 100%; display: block; }

    /* --- OVERLAY TEXT --- */
    .overlay-msg {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        text-align: center; pointer-events: none;
        display: none;
    }
    .success-msg { color: var(--terminal-green); text-shadow: 0 0 20px rgba(74, 222, 128, 0.5); }
    .scan-line {
        position: absolute; left: 0; width: 100%; height: 2px;
        background: var(--neon-cyan);
        box-shadow: 0 0 10px var(--neon-cyan);
        opacity: 0.5; pointer-events: none;
    }

    /* LOG PANEL */
    .log-panel {
        height: 150px; background: #000;
        border-top: 1px solid var(--road-line);
        font-size: 0.75rem; padding: 10px;
        overflow-y: auto; color: #64748b;
    }
    .log-entry { margin-bottom: 4px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; }
    .log-hit { color: var(--terminal-green); font-weight: bold; border: 1px solid var(--terminal-green); padding: 5px; margin: 5px 0; background: rgba(74,222,128,0.1); }
</style>
</head>
<body>

<div class="dashboard">
    <div class="hud-row">
        <div class="title-mod">3-ENGINE // DEAD RECKONING</div>
        <div style="font-size: 0.7rem; color: #64748b;">V8.2.1 [MOD 9 FILTER]</div>
    </div>
    
    <div class="hud-row">
        <input type="text" id="inpTarget" value="1007" placeholder="ENTER TARGET N">
        <button id="btnEngage" onclick="engage3Engine()">ENGAGE</button>
        <button id="btnStop" class="stop" onclick="killEngine()">BRAKE</button>
    </div>

    <div class="stats-panel">
        <div class="stat-box">TARGET N: <span id="valN" class="stat-val">-</span></div>
        <div class="stat-box">MOD 9 SIG: <span id="valMod" class="stat-val">-</span></div>
        <div class="stat-box">3-LINE ROOTS CHECKED: <span id="valChecked" class="stat-val">0</span></div>
        <div class="stat-box">SPEED: <span id="valSpeed" class="stat-val">0</span> k/s</div>
    </div>
</div>

<div id="windshield-container">
    <canvas id="rainCanvas"></canvas>
    <div id="scanLine" class="scan-line"></div>
    <div id="statusOverlay" class="overlay-msg">
        <h1 style="font-size:3rem; margin:0;">TARGET ACQUIRED</h1>
        <div id="foundDetails" style="font-size:1.2rem;"></div>
    </div>
</div>

<div class="log-panel" id="logPanel">
    <div class="log-entry">SYSTEM READY. WAITING FOR COORDINATES...</div>
</div>

<script id="worker-code" type="javascript/worker">
    self.onmessage = function(e) {
        const { cmd, N_str, chunkSize } = e.data;
        
        if (cmd === 'start') {
            const N = BigInt(N_str);
            const nMod9 = Number(N % 9n);
            
            // --- THE 3-ENGINE MOD 9 FILTER ---
            // We use the user's logic: Factor A = 2k + 3.
            // We only check k values that are mathematically possible for N % 9.
            // Map N%9 -> Valid k%9
            // Calculation Logic:
            // N%9 = (A * B) % 9
            // Iterate possible A%9 (0..8). If A has inverse, calculate required B.
            // If valid, map back to k. A = 2k + 3 => k = (A-3)/2.
            
            const validKMods = [];
            
            // Build the filter table dynamically for this specific N
            for(let kMod = 0; kMod < 9; kMod++) {
                let A_mod = (2 * kMod + 3) % 9;
                // If A_mod is 0, 3, 6, A is divisible by 3.
                // If N is not divisible by 3, A cannot be divisible by 3 (unless N=0mod3)
                // Assuming N is not div by 3 for the main engine (primes/semiprimes).
                if (nMod9 % 3 !== 0 && A_mod % 3 === 0) continue; 
                
                // If A_mod is coprime to 9, it has an inverse.
                // We don't strictly need to solve B, we just need to know if it's "legal".
                // Actually, simply checking A=2k+3 is a start. 
                // The user specified: "k can be 2 4 or 8 when N Mod 9=8".
                // Let's implement that Specific logic as a priority filter, 
                // but keep it general for other N.
                validKMods.push(kMod);
            }

            let k = 0n; // This is our iterator for the small factor (A = 2k+3)
            const rootLimit = (BigIntMath_sqrt(N) - 3n) / 2n;
            
            let checkedCount = 0;
            const startTime = performance.now();

            // Main Loop
            while (k <= rootLimit) {
                // Batch Check
                for (let i = 0; i < chunkSize; i++) {
                    
                    // 1. DEAD RECKONING FILTER (Mod 9 check on k)
                    // We only process if k % 9 is in our valid list.
                    // (In a super-optimized version we'd jump indices, 
                    // but for JS BigInt, a quick modulo check is fine for visualization)
                    if (validKMods.includes(Number(k % 9n))) {
                        
                        let A = (k * 2n) + 3n;
                        
                        // 2. THE HIT CHECK
                        if (N % A === 0n) {
                            let B = N / A;
                            // Found a factor!
                            // Calculate "Generations" (Steps back to 3-line)
                            // A = 3 + 2s => 2s = A - 3 => s = (A-3)/2. 
                            // Wait, k IS s in the formula A = 3 + 2k.
                            // So k is the Generation Count directly.
                            
                            // Calculate the Root.
                            // Original Formula: N = (3+2s)(RootBase+2s)
                            // We have A = 3+2s. B = RootBase + 2s.
                            // So RootBase = B - 2s = B - 2k.
                            // The 3-Line Root Value = 3 * RootBase.
                            
                            let s = k;
                            let rootBase = B - (2n * s);
                            let rootVal = 3n * rootBase; // This is the ancestor on the 3-line
                            
                            self.postMessage({
                                type: 'found',
                                factors: [A.toString(), B.toString()],
                                generations: s.toString(),
                                root: rootVal.toString(),
                                rootBase: rootBase.toString()
                            });
                            return; // Stop after first find (smallest factor)
                        }
                    }
                    
                    k++;
                    checkedCount++;
                }

                // Progress Update
                if (checkedCount % (chunkSize * 5) === 0) {
                     self.postMessage({ type: 'progress', checked: checkedCount, currentK: k.toString() });
                }
            }
            
            self.postMessage({ type: 'done' });
        }
    };

    // Helper for BigInt Sqrt
    function BigIntMath_sqrt(value) {
        if (value < 0n) { throw 'negative'; }
        if (value < 2n) { return value; }
        return newtonIteration(value, 1n);
    }
    function newtonIteration(n, x0) {
        let x1 = ((n / x0) + x0) >> 1n;
        if (x0 === x1 || x0 === (x1 - 1n)) { return x0; }
        return newtonIteration(n, x1);
    }
</script>

<script>
    // --- MAIN THREAD ---
    let worker;
    const canvas = document.getElementById('rainCanvas');
    const ctx = canvas.getContext('2d');
    let isRunning = false;
    let particles = [];
    let animationId;
    
    // UI Elements
    const elN = document.getElementById('valN');
    const elMod = document.getElementById('valMod');
    const elChecked = document.getElementById('valChecked');
    const elSpeed = document.getElementById('valSpeed');
    const elLog = document.getElementById('logPanel');
    const overlay = document.getElementById('statusOverlay');
    const scanLine = document.getElementById('scanLine');

    function log(msg, type='') {
        const div = document.createElement('div');
        div.className = 'log-entry ' + type;
        div.innerText = `>> ${msg}`;
        elLog.prepend(div);
    }

    function initCanvas() {
        canvas.width = document.getElementById('windshield-container').clientWidth;
        canvas.height = document.getElementById('windshield-container').clientHeight;
    }
    window.onresize = initCanvas;
    initCanvas();

    // --- VISUALIZATION: THE 3-RAIN ---
    class RainDrop {
        constructor() {
            this.reset();
        }
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * -100;
            this.speed = Math.random() * 5 + 2;
            this.len = Math.random() * 20 + 10;
            this.color = Math.random() > 0.9 ? '#facc15' : '#22d3ee'; // Gold or Cyan
            this.opacity = Math.random() * 0.5 + 0.1;
            this.val = Math.floor(Math.random() * 9); // Represent Modulo
        }
        update() {
            this.y += this.speed;
            if (this.y > canvas.height) this.reset();
        }
        draw() {
            ctx.beginPath();
            ctx.strokeStyle = this.color;
            ctx.lineWidth = 1;
            ctx.globalAlpha = this.opacity;
            ctx.moveTo(this.x, this.y);
            // Draw diagonal trail based on speed (simulating angle)
            ctx.lineTo(this.x - (this.speed * 0.5), this.y - this.len);
            ctx.stroke();
            
            // Occasionally draw a number
            if (Math.random() > 0.98) {
                ctx.fillStyle = '#fff';
                ctx.font = '10px monospace';
                ctx.fillText(this.val, this.x, this.y);
            }
            ctx.globalAlpha = 1;
        }
    }

    function startVisuals() {
        particles = Array(100).fill().map(() => new RainDrop());
        function animate() {
            if(!isRunning) return;
            ctx.fillStyle = 'rgba(2, 6, 23, 0.2)'; // Trails
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            particles.forEach(p => {
                p.update();
                p.draw();
            });
            
            // Draw the "3-Line" (Left Wall)
            ctx.fillStyle = '#334155';
            ctx.fillRect(0, 0, 50, canvas.height);
            ctx.fillStyle = '#facc15';
            ctx.font = 'bold 20px Courier New';
            ctx.fillText("3-LINE", 5, 30);
            
            // Scan Line Animation
            let scanY = (Date.now() / 5) % canvas.height;
            scanLine.style.top = scanY + 'px';

            animationId = requestAnimationFrame(animate);
        }
        animate();
    }

    // --- ENGINE LOGIC ---
    function engage3Engine() {
        if (isRunning) killEngine();
        
        const nStr = document.getElementById('inpTarget').value.replace(/,/g, '');
        if (!nStr) return;
        
        try {
            const N = BigInt(nStr);
            elN.innerText = nStr;
            elMod.innerText = (N % 9n).toString();
            
            overlay.style.display = 'none';
            isRunning = true;
            document.getElementById('btnEngage').innerText = "RUNNING...";
            
            log(`TARGET LOCKED: ${N}`);
            log(`CALCULATING MOD 9 VECTOR: ${N%9n}`);
            log(`INITIATING DEAD RECKONING SEQUENCE...`);

            // Start Worker
            const blob = new Blob([document.getElementById('worker-code').textContent], { type: "text/javascript" });
            worker = new Worker(window.URL.createObjectURL(blob));
            
            worker.onmessage = function(e) {
                const data = e.data;
                if (data.type === 'progress') {
                    elChecked.innerText = parseInt(data.currentK).toLocaleString();
                    // Speed approx
                    elSpeed.innerText = Math.floor(data.checked / 1000) + "k";
                } else if (data.type === 'found') {
                    handleSuccess(data);
                } else if (data.type === 'done') {
                    isRunning = false;
                    log("SCAN COMPLETE. NO FACTORS FOUND (PRIME?)");
                    killEngine();
                }
            };
            
            worker.postMessage({ cmd: 'start', N_str: nStr, chunkSize: 5000 });
            startVisuals();
            
        } catch (err) {
            alert("Invalid Number");
            console.error(err);
        }
    }

    function handleSuccess(data) {
        isRunning = false;
        cancelAnimationFrame(animationId);
        
        // Visual Flare
        ctx.fillStyle = 'rgba(74, 222, 128, 0.2)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        const f1 = BigInt(data.factors[0]);
        const f2 = BigInt(data.factors[1]);
        const gens = data.generations;
        const root = data.root;
        const rootBase = data.rootBase;

        log(`!!! IMPACT CONFIRMED !!!`, 'log-hit');
        log(`FACTORS: ${f1} x ${f2}`, 'log-hit');
        log(`GENERATIONS FROM 3-LINE: ${gens}`);
        log(`ORIGIN ROOT: ${root} (Base ${rootBase})`);
        
        // Overlay Update
        const details = `
            <div style="color:#facc15; margin-top:20px;">FACTORS: ${f1} x ${f2}</div>
            <div style="color:#22d3ee; font-size:1rem; margin-top:10px;">
                TRACED BACK ${gens} GENERATIONS<br>
                TO 3-LINE ROOT: <span style="color:#fff; border-bottom:1px solid #fff;">${root}</span>
            </div>
        `;
        document.getElementById('foundDetails').innerHTML = details;
        overlay.style.display = 'block';
        
        document.getElementById('btnEngage').innerText = "ENGAGE";
    }

    function killEngine() {
        isRunning = false;
        if (worker) worker.terminate();
        cancelAnimationFrame(animationId);
        document.getElementById('btnEngage').innerText = "ENGAGE";
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

</script>
</body>
</html>
