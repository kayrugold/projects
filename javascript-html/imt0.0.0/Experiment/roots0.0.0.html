<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GNOMON EXPLORER v9.0 (Manual Drive)</title>
<style>
    :root {
        --bg: #020617; --panel: #0f172a; --border: #1e293b;
        --cyan: #22d3ee; --text: #e2e8f0; --pink: #f472b6; --green: #34d399;
        --orange: #fbbf24; --btn-bg: #1e293b;
    }
    * { box-sizing: border-box; }
    body { 
        background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; 
        height: 100dvh; margin: 0; display: flex; flex-direction: column; overflow: hidden; 
    }

    /* --- TOP SECTION --- */
    .top-section {
        background: var(--panel); border-bottom: 2px solid var(--pink);
        padding: 15px; flex-shrink: 0; z-index: 200;
        box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }
    
    .input-row { display: flex; gap: 10px; margin-bottom: 0px; }
    #inpVal { 
        background: #020617; border: 1px solid var(--pink); color: #fff; 
        padding: 12px; font-family: 'Courier New', monospace; 
        font-weight: 900; font-size: 1.4rem; outline: none; flex: 1; border-radius: 4px;
        text-align: center;
    }
    #btnReset {
        background: var(--pink); color: #000; border: none; border-radius: 4px;
        font-weight: 900; cursor: pointer; padding: 0 20px; font-size: 1rem;
        transition: transform 0.1s;
    }
    #btnReset:active { transform: translateY(2px); }

    /* --- MAIN WORKSPACE --- */
    .workspace { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; align-items: center; }

    /* --- CURRENT STATE CARD --- */
    .state-card { 
        background: #0f172a; border: 1px solid var(--border); border-radius: 12px; 
        padding: 20px; width: 100%; max-width: 600px; text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .rem-label { color: #64748b; font-size: 0.8rem; letter-spacing: 2px; font-weight: bold; margin-bottom: 5px; }
    .rem-val { font-size: 3rem; font-weight: 900; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.1); }
    .path-history { 
        display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; 
        padding-top: 15px; border-top: 1px solid #1e293b;
    }
    .hist-tag { 
        background: var(--cyan); color: #000; padding: 4px 8px; border-radius: 4px; 
        font-weight: bold; font-size: 0.9rem; 
    }
    .hist-tag.even { background: #334155; color: #94a3b8; }

    /* --- OPTIONS GRID --- */
    .options-grid { 
        display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
        gap: 10px; width: 100%; max-width: 600px; 
    }
    .opt-btn {
        background: var(--btn-bg); border: 1px solid #334155; padding: 15px;
        border-radius: 8px; cursor: pointer; text-align: left; transition: all 0.1s;
        position: relative; overflow: hidden;
    }
    .opt-btn:hover { border-color: var(--cyan); background: #1e293b; }
    .opt-btn:active { transform: scale(0.98); }
    
    .opt-root { font-size: 1.2rem; font-weight: bold; color: #fff; }
    .opt-sq { font-size: 0.8rem; color: #64748b; margin-top: 2px; }
    .opt-rem { 
        position: absolute; top: 10px; right: 10px; 
        font-size: 0.9rem; font-weight: bold; color: var(--green); 
    }
    .opt-btn.even { opacity: 0.7; }
    .opt-btn.even .opt-root { color: #94a3b8; }

    .undo-btn {
        background: transparent; border: 1px solid #64748b; color: #64748b;
        padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold;
        margin-top: 10px;
    }
    .undo-btn:hover { color: #fff; border-color: #fff; }

    .complete-msg { color: var(--green); font-size: 1.5rem; font-weight: bold; margin-top: 20px; }

</style>
</head>
<body>

<div class="top-section">
    <div class="input-row">
        <input id="inpVal" type="text" value="1007" placeholder="Enter Number">
        <button id="btnReset">START</button>
    </div>
</div>

<div class="workspace">
    
    <div class="state-card">
        <div class="rem-label">CURRENT REMAINDER</div>
        <div class="rem-val" id="dispRem">--</div>
        
        <div class="path-history" id="pathHist">
            </div>
        
        <button class="undo-btn" id="btnUndo" style="display:none;">↩ UNDO LAST STEP</button>
    </div>

    <div id="decisionDeck" class="options-grid">
        </div>

    <div id="completeMsg" class="complete-msg" style="display:none;">DECOMPOSITION COMPLETE</div>

</div>

<script>
// --- CORE LOGIC ---
let startN = 0n;
let currentRem = 0n;
let history = []; // Array of { root, sq }

function sqrtBigInt(n) { 
    if(n < 2n) return n; 
    let x = n; 
    let y = (x + 1n) / 2n; 
    while(y < x) { x = y; y = (x + n / x) / 2n; } 
    return x; 
}

function init(valStr) {
    try {
        startN = BigInt(valStr);
        if(startN < 0n) startN = -startN;
        currentRem = startN;
        history = [];
        render();
    } catch(e) { alert("Invalid Number"); }
}

function takeStep(root) {
    let sq = root * root;
    if (sq > currentRem) return; // Safety
    
    currentRem = currentRem - sq;
    history.push({ root: root, sq: sq });
    render();
}

function undo() {
    if (history.length === 0) return;
    let last = history.pop();
    currentRem = currentRem + last.sq;
    render();
}

function render() {
    // 1. Update Display
    document.getElementById('dispRem').innerText = currentRem.toString();
    
    // 2. Update History
    const histContainer = document.getElementById('pathHist');
    histContainer.innerHTML = history.map(h => {
        let isEven = (h.root % 2n === 0n);
        return `<div class="hist-tag ${isEven?'even':''}">${h.root}²</div>`;
    }).join("");
    
    // 3. Undo Button Visibility
    document.getElementById('btnUndo').style.display = (history.length > 0) ? 'inline-block' : 'none';

    // 4. Render Options (The "Fork" Logic)
    const deck = document.getElementById('decisionDeck');
    const msg = document.getElementById('completeMsg');
    deck.innerHTML = "";
    
    if (currentRem === 0n) {
        msg.style.display = 'block';
        return;
    } else {
        msg.style.display = 'none';
    }

    // Generate Top 6 Choices
    let maxRoot = sqrtBigInt(currentRem);
    let optionsCount = 0;
    
    // Safety check for tiny remainders
    if (maxRoot === 0n && currentRem > 0n) maxRoot = 1n; // Should not happen with integer math but safe guard

    for (let r = maxRoot; r >= 1n; r--) {
        if (optionsCount >= 6) break; // Only show top 6 options to keep UI clean
        
        let sq = r * r;
        let nextRem = currentRem - sq;
        let isEven = (r % 2n === 0n);
        
        let btn = document.createElement('div');
        btn.className = `opt-btn ${isEven?'even':''}`;
        btn.innerHTML = `
            <div class="opt-rem">Rem: ${nextRem}</div>
            <div class="opt-root">-${r}²</div>
            <div class="opt-sq">(${sq})</div>
        `;
        
        // Click Handler
        btn.onclick = () => takeStep(r);
        
        deck.appendChild(btn);
        optionsCount++;
    }
}

// --- BINDS ---
document.getElementById('btnReset').onclick = () => init(document.getElementById('inpVal').value);
document.getElementById('btnUndo').onclick = undo;
document.getElementById('inpVal').onkeydown = (e) => { if(e.key==='Enter') init(e.target.value); };

// Start with user's example
window.onload = () => init("1007");

</script>
</body>
</html>
