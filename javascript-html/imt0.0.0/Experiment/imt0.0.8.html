<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GNOMON NAVIGATOR v8.0 (Clean Interface)</title>
<style>
    :root {
        --bg: #020617; 
        --panel: #0f172a; 
        --border: #1e293b;
        --cyan: #22d3ee; 
        --pink: #f472b6; 
        --green: #34d399;
        --yellow: #facc15;
        --red: #ef4444;
        --text: #e2e8f0;
        --text-dim: #94a3b8;
        --input-bg: rgba(15, 23, 42, 0.8);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
        background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; 
        height: 100dvh; margin: 0; display: flex; flex-direction: column; overflow: hidden; 
    }

    /* --- TOP HEADER (View Controls) --- */
    .header {
        background: var(--panel); border-bottom: 1px solid var(--border);
        padding: 8px; flex-shrink: 0; z-index: 200;
        display: flex; flex-direction: column; gap: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    
    .toolbar { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .tool-group { display: flex; gap: 4px; align-items: center; }

    /* Buttons */
    .btn { 
        background: #1e293b; color: var(--text-dim); border: 1px solid var(--border);
        height: 36px; padding: 0 12px; border-radius: 4px; 
        font-family: inherit; font-weight: bold; font-size: 0.75rem; 
        cursor: pointer; display: flex; align-items: center; justify-content: center;
        transition: all 0.2s; text-transform: uppercase;
    }
    .btn.active { background: rgba(34, 211, 238, 0.15); color: var(--cyan); border-color: var(--cyan); }
    .btn.active-pink { background: rgba(244, 114, 182, 0.15); color: var(--pink); border-color: var(--pink); }
    .btn-action { background: var(--cyan); color: #000; border: none; }
    .btn-action:active { transform: translateY(1px); }
    .btn-danger { background: var(--red); color: #000; border: none; }
    .btn-danger:disabled { opacity: 0.5; background: #333; color: #666; }

    /* Inputs */
    .input-box {
        background: var(--input-bg); border: 1px solid var(--border); color: #fff;
        padding: 0 12px; height: 36px; border-radius: 4px;
        font-family: inherit; font-weight: bold; font-size: 1rem;
        outline: none; flex: 1; text-align: center; min-width: 0;
    }
    .input-box:focus { border-color: var(--cyan); }

    /* Range Slider */
    input[type=range] { width: 60px; accent-color: var(--cyan); }

    /* --- MODULES --- */
    .module-row { display: flex; gap: 6px; width: 100%; }
    
    /* Dead Reckoning Panel */
    .dr-panel {
        background: #0b1120; border: 1px solid var(--pink); border-radius: 6px;
        padding: 8px; display: none; animation: slideIn 0.2s ease-out;
    }
    @keyframes slideIn { from{opacity:0; transform:translateY(-5px);} to{opacity:1; transform:translateY(0);} }
    .dr-panel.open { display: flex; flex-direction: column; gap: 8px; }

    .hud-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; }
    .hud-metric { 
        background: rgba(255,255,255,0.03); border: 1px solid var(--border); 
        padding: 4px; text-align: center; border-radius: 4px;
    }
    .metric-lbl { font-size: 0.6rem; color: var(--text-dim); font-weight: bold; }
    .metric-val { font-size: 0.8rem; color: #fff; font-weight: bold; }

    /* The Result Box (Terminal Style) */
    .hud-result { 
        grid-column: span 3; 
        background: #000; border: 1px dashed var(--border); 
        padding: 10px; text-align: center; border-radius: 4px;
        font-size: 0.75rem; line-height: 1.4; color: var(--text-dim);
        cursor: pointer; word-break: break-all; /* CRITICAL FIX FOR LONG NUMBERS */
    }
    .hud-result.locked { border-style: solid; }

    /* --- CANVAS AREA --- */
    .viewport { flex: 1; position: relative; overflow: hidden; background: #000; touch-action: none; }
    canvas { display: block; width: 100%; height: 100%; }

    /* --- BOTTOM DECODER --- */
    .decoder { 
        background: var(--panel); border-top: 2px solid var(--pink); 
        padding-bottom: env(safe-area-inset-bottom);
        box-shadow: 0 -4px 20px rgba(0,0,0,0.5); z-index: 150;
    }
    .data-row { 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 8px 12px; border-bottom: 1px solid var(--border); 
    }
    .data-group { display: flex; flex-direction: column; min-width: 0; }
    .label { font-size: 0.6rem; color: var(--text-dim); font-weight: 800; letter-spacing: 1px; margin-bottom: 2px; }
    .value { 
        font-size: 1.1rem; font-weight: 900; color: #fff; 
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        cursor: pointer;
    }
    .sub-value { font-size: 0.8rem; color: var(--pink); cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Coordinate Inputs */
    .coord-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; padding: 6px; }
    .coord-box { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 4px; border-radius: 4px; text-align: center; }
    .coord-input { 
        width: 100%; background: transparent; border: none; color: #fff; 
        font-family: inherit; font-weight: bold; font-size: 0.9rem; text-align: center; outline: none; 
    }
    .c-green { color: var(--green); } .c-pink { color: var(--pink); } .c-blue { color: #3b82f6; } .c-gold { color: #fbbf24; }

    /* --- OVERLAYS --- */
    .toast {
        position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
        background: rgba(15, 23, 42, 0.95); border: 1px solid var(--cyan);
        color: var(--cyan); padding: 8px 16px; border-radius: 20px;
        font-size: 0.85rem; font-weight: bold; z-index: 1000;
        opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .toast.show { opacity: 1; }

    .modal {
        position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1100;
        display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px);
    }
    .modal-content {
        background: var(--panel); border: 1px solid var(--cyan); width: 100%; max-width: 600px; max-height: 80vh;
        border-radius: 8px; display: flex; flex-direction: column; overflow: hidden;
    }
    .modal-head { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
    .modal-body { padding: 20px; overflow-y: auto; word-break: break-all; line-height: 1.5; font-size: 0.9rem; }
    .full-data { background: #000; padding: 10px; border-radius: 4px; border: 1px solid var(--border); margin-bottom: 10px; color: #fff; }

</style>
</head>
<body>

<div id="toast" class="toast">STATUS</div>

<div class="header">
    <div class="toolbar">
        <div class="tool-group">
            <button class="btn" id="btnHelp">?</button>
            <input id="inpZoom" type="range" min="20" max="150" value="64">
        </div>
        <div class="tool-group">
            <button class="btn active" id="btnTrivials">TRIV</button>
            <button class="btn" id="btnGnomon">GNO</button>
            <button class="btn active" id="btnMirror">MIR</button>
            <button class="btn" id="btnLayout">SPINE</button>
        </div>
    </div>

    <div class="module-row">
        <button class="btn active-pink" id="btnToggleDR">DR MOD</button>
        <input id="inpFind" class="input-box" type="text" placeholder="Find Tape ID">
        <button class="btn btn-action" id="btnFind">GO</button>
    </div>

    <div class="dr-panel" id="drPanel">
        <div class="module-row">
            <input id="inpTarget" class="input-box" style="border-color:var(--pink); background:rgba(244,114,182,0.1);" type="text" placeholder="Target Cargo N">
            <input id="inpMaxG" class="input-box" style="width:80px; flex:none;" type="text" placeholder="Max G">
        </div>
        <div class="module-row" style="margin-top:4px;">
            <button class="btn btn-action" style="flex:1; background:var(--pink);" id="btnTriangulate">TRIANGULATE</button>
            <button class="btn btn-danger" id="btnStopScan" disabled>STOP</button>
        </div>
        
        <div class="hud-grid" id="drHud" style="display:none; margin-top:8px;">
            <div class="hud-metric" style="border-color:var(--cyan)">
                <div class="metric-lbl">MOD 9</div>
                <div class="metric-val" id="valMod9">-</div>
            </div>
            <div class="hud-metric" style="border-color:var(--pink)">
                <div class="metric-lbl">MOD 5</div>
                <div class="metric-val" id="valMod5">-</div>
            </div>
            <div class="hud-metric" style="border-color:var(--green)">
                <div class="metric-lbl">MOD 7</div>
                <div class="metric-val" id="valMod7">-</div>
            </div>
            <div class="hud-result" id="drResult" onclick="executeJump()">
                SYSTEM READY
            </div>
        </div>
    </div>
</div>

<div class="viewport" id="canvasWrap">
    <canvas id="gridCanvas"></canvas>
</div>

<div class="decoder">
    <div class="data-row">
        <div class="data-group">
            <div class="label">SMART ID (a.b)</div>
            <div class="value" id="dispComp" style="color:var(--cyan)">--</div>
            <div class="sub-value" id="dispSq" style="color:#94a3b8">--</div>
        </div>
        <div class="data-group" style="text-align:right">
            <div class="label">CARGO (N)</div>
            <div class="value" id="dispVal">--</div>
            <div class="sub-value" id="dispFactors">--</div>
        </div>
    </div>

    <div class="coord-grid">
        <div class="coord-box">
            <div class="label">GNOMON</div>
            <input id="inpGnomon" class="coord-input c-gold" readonly>
        </div>
        <div class="coord-box">
            <div class="label">GAP (b)</div>
            <input id="inpCol" class="coord-input c-pink" onchange="updateFromInput('col')">
        </div>
        <div class="coord-box">
            <div class="label">ANCHOR (a)</div>
            <input id="inpA" class="coord-input c-blue" onchange="updateFromInput('a')">
        </div>
        <div class="coord-box">
            <div class="label">ROW (k)</div>
            <input id="inpK" class="coord-input c-green" onchange="updateFromInput('k')">
        </div>
    </div>
</div>

<div id="fullValModal" class="modal">
    <div class="modal-content">
        <div class="modal-head">
            <span style="color:var(--cyan); font-weight:bold;">MANIFEST DATA</span>
            <span id="closeFull" style="cursor:pointer; color:#fff; font-size:1.5rem;">×</span>
        </div>
        <div class="modal-body">
            <div class="label">CARGO (N)</div><div class="full-data" id="fullN"></div>
            <div class="label">FACTORS</div><div class="full-data" id="fullFactors" style="color:var(--cyan)"></div>
            <div class="label">SMART ID</div><div class="full-data" id="fullSmart" style="color:var(--pink)"></div>
            <div class="label">TAPE ID</div><div class="full-data" id="fullTape" style="color:#94a3b8"></div>
        </div>
    </div>
</div>

<script>
// --- CORE CONFIG ---
const canvas = document.getElementById('gridCanvas');
const ctx = canvas.getContext('2d', {alpha: false});
const wrap = document.getElementById('canvasWrap');
let DPR = window.devicePixelRatio || 1;
let cellS = 64; const HDR_S = 30; 
let viewAnchor = { r: 0n, c: 0n };
let scrollX = 0, scrollY = 0;
let highlight = { r: 0n, c: 0n };
let hideMirror = true; 
let layoutMode = 'spine'; 
let cellCache = new Map();
let currentFullData = null;
let activeModuli = []; let isInvertMod = false;
let showTrivials = true; let showGnomon = false;
let pendingJump = null;

// --- WORKER (INLINED) ---
const workerCode = `
self.addEventListener('message', (ev) => {
    const msg = ev.data;
    const getTapeID = (row, gap) => (row * (row + 1n)) / 2n + gap;
    const process = (r_in, c_in, mode) => {
        const r = BigInt(r_in), c = BigInt(c_in);
        let P2, P1, k, a, b, isSq;
        if (mode === 'spine') {
            k = r; b = c; P2 = (k * 2n) + 1n; P1 = P2 - (b * 2n); a = P2 - b; isSq = (c === 0n);
        } else {
            let k_raw = r, j_raw = c;
            if (k_raw >= j_raw) { P2 = (k_raw * 2n) + 1n; P1 = (j_raw * 2n) + 1n; k = k_raw; } 
            else { P2 = (j_raw * 2n) + 1n; P1 = (k_raw * 2n) + 1n; k = j_raw; }
            b = (P2 - P1) / 2n; a = (P2 + P1) / 2n; isSq = (r === c);
        }
        if (P1 <= 0n) return null;
        const val = P2 * P1;
        let displayVal = val.toString();
        if (displayVal.length > 8) displayVal = ".." + displayVal.slice(-6);
        return {
            r: r_in, c: c_in, k: k.toString(), a: a.toString(), b: b.toString(),
            tapeID: getTapeID(k, b).toString(), g: (k + 1n).toString(),
            val: displayVal, fullVal: val.toString(), isSq: isSq, P2: P2.toString(), P1: P1.toString()
        };
    };
    if (msg.cmd === 'batch') {
        const res = msg.items.map(it => process(it.r, it.c, msg.mode)).filter(x => x);
        self.postMessage({ type: 'batch', payload: res });
    } else if (msg.cmd === 'cell') {
        self.postMessage({ type: 'cell', payload: process(msg.r, msg.c, msg.mode) });
    }
});
`;
const worker = new Worker(URL.createObjectURL(new Blob([workerCode], {type:'application/javascript'})));
worker.onmessage = (ev) => {
    if (ev.data.type === 'batch') { ev.data.payload.forEach(p => cellCache.set(`${p.r}|${p.c}`, p)); draw(); }
    else if (ev.data.type === 'cell') {
        const p = ev.data.payload; cellCache.set(`${p.r}|${p.c}`, p);
        if(highlight.r.toString() === p.r && highlight.c.toString() === p.c) updateDecoder(p);
        draw();
    }
};

// --- RENDER ENGINE ---
function draw() {
    const w = canvas.width/DPR; const h = canvas.height/DPR;
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0); ctx.fillStyle = '#020617'; ctx.fillRect(0, 0, w, h);
    
    // Normalize scroll
    while (scrollX > 0) { scrollX -= cellS; viewAnchor.c -= 1n; }
    while (scrollX <= -cellS) { scrollX += cellS; viewAnchor.c += 1n; }
    while (scrollY > 0) { scrollY -= cellS; viewAnchor.r -= 1n; }
    while (scrollY <= -cellS) { scrollY += cellS; viewAnchor.r += 1n; }
    
    const cols = Math.ceil(w/cellS)+1; const rows = Math.ceil(h/cellS)+1;
    const fsMain = Math.floor(cellS*0.22); const fsSub = Math.max(8, Math.floor(cellS*0.15));
    
    ctx.save(); ctx.translate(HDR_S + scrollX, HDR_S + scrollY); 
    
    // Batch Request
    const items = [];
    for (let r = -1; r < rows; r++) { 
        for (let c = -1; c < cols; c++) {
            const gr = viewAnchor.r + BigInt(r); const gc = viewAnchor.c + BigInt(c);
            if(gr<0n || gc<0n) continue;
            if(layoutMode==='diag' && hideMirror && gc>gr) continue;
            if(layoutMode==='spine' && gc>gr) continue;
            
            const x = c * cellS; const y = r * cellS;
            const cell = cellCache.get(`${gr}|${gc}`);
            
            if(!cell) { items.push({r:gr.toString(), c:gc.toString()}); continue; }
            if(cell.P1==="1" && !showTrivials) continue;

            const isSel = (gr===highlight.r && gc===highlight.c);
            let bg = '#111827'; let fg = '#64748b';
            if(cell.isSq) { bg = 'rgba(34, 211, 238, 0.05)'; fg='#fff'; }
            if(showGnomon) bg = `hsla(${Number(gr%50n)*7}, 60%, 20%, 0.4)`;
            
            ctx.fillStyle = bg; ctx.fillRect(x, y, cellS-1, cellS-1);
            if(isSel) { ctx.strokeStyle = '#f472b6'; ctx.lineWidth = 2; ctx.strokeRect(x+1,y+1,cellS-3,cellS-3); fg='#fff'; }
            else if(cell.isSq) { ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 1; ctx.strokeRect(x+2,y+2,cellS-5,cellS-5); }

            ctx.textAlign = 'center'; 
            ctx.fillStyle = cell.isSq ? '#22d3ee' : fg;
            ctx.font = `bold ${fsMain}px monospace`;
            ctx.fillText(cell.val, x+cellS/2, y+cellS/2);
            
            ctx.fillStyle = '#475569';
            ctx.font = `${fsSub}px monospace`;
            let tid = cell.tapeID; if(tid.length>6) tid=".."+tid.slice(-4);
            ctx.fillText(tid, x+cellS/2, y+cellS-4);
        }
    }
    ctx.restore();
    if(items.length) worker.postMessage({cmd:'batch', items, mode: layoutMode});

    // Headers
    ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,w,HDR_S); ctx.fillRect(0,0,HDR_S,h);
    ctx.fillStyle = '#22d3ee'; ctx.font = 'bold 10px monospace';
    ctx.textAlign='left'; ctx.fillText(`R:${viewAnchor.r}`, 5, 18);
    ctx.textAlign='center'; ctx.fillText(`C:${viewAnchor.c}`, HDR_S/2, 10);
}

function showToast(msg) {
    const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2000);
}

// --- LOGIC ---
function jumpTo(r, c) {
    viewAnchor = { r: BigInt(r), c: BigInt(c) }; scrollX = 0; scrollY = 0;
    highlight = { r: BigInt(r), c: BigInt(c) };
    worker.postMessage({cmd:'cell', r: highlight.r.toString(), c: highlight.c.toString(), mode: layoutMode});
    draw();
}

function updateDecoder(p) {
    currentFullData = p;
    const trunc = (s, l=12) => s.length > l ? s.slice(0,6) + ".." + s.slice(-4) : s;
    document.getElementById('dispComp').innerText = `${trunc(p.a)}.${trunc(p.b)}`;
    document.getElementById('dispSq').innerText = "ID: " + trunc(p.tapeID, 15);
    document.getElementById('dispVal').innerText = trunc(p.fullVal, 15);
    document.getElementById('dispFactors').innerText = `${trunc(p.P2)} × ${trunc(p.P1)}`;
    document.getElementById('inpK').value=p.k; document.getElementById('inpCol').value=p.c; 
    document.getElementById('inpA').value=p.a; document.getElementById('inpGnomon').value=p.g;
}

// --- DR ENGINE (SCANNER) ---
async function runTriangulate() {
    const input = document.getElementById('inpTarget').value.trim();
    if(!input) return;
    let N; try { N = BigInt(input); } catch(e) { showToast("Invalid N"); return; }

    const resBox = document.getElementById('drResult');
    document.getElementById('drHud').style.display = 'grid';
    resBox.className = "hud-result"; resBox.innerHTML = "SCANNING...";
    
    // Signals
    document.getElementById('valMod9').innerText = `R:${N%9n}`;
    document.getElementById('valMod5').innerText = `R:${N%5n}`;
    document.getElementById('valMod7').innerText = `R:${N%7n}`;

    window.__drStop = false;
    document.getElementById('btnStopScan').disabled = false;

    // Scan
    const channels = [9n, 7n, 5n, 3n];
    let found = false;
    
    for(let mod of channels) {
        if(window.__drStop) break;
        // Batch scan logic to keep UI responsive
        for(let g=mod; g<100000n; g+=mod) {
            if(window.__drStop) break;
            if(g % 5000n === 0n) await new Promise(r=>setTimeout(r,0)); // Yield
            
            let P = 2n*g - 1n;
            if(N % P === 0n) {
                // Lock
                let P2 = P > (N/P) ? P : (N/P);
                let P1 = N/P2;
                let r = (P2-1n)/2n; let c = (P2-P1)/2n;
                
                resBox.className = "hud-result locked";
                resBox.style.borderColor = (mod===9n)?"var(--cyan)":(mod===7n?"var(--green)":"var(--pink)");
                resBox.innerHTML = `LOCK (MOD ${mod}): ROW ${r}<br>GAP ${c}<br><span style="color:#fff">BEAM P2=${P2}</span><br>TAP TO JUMP`;
                pendingJump = {r, c};
                found = true;
                break;
            }
        }
        if(found) break;
    }
    
    if(!found) {
        resBox.innerHTML = window.__drStop ? "STOPPED" : "NO LOCK IN RANGE";
        resBox.style.borderColor = "var(--red)";
    }
    document.getElementById('btnStopScan').disabled = true;
}

function executeJump() {
    if(pendingJump) {
        if(layoutMode!=='spine') document.getElementById('btnLayout').click();
        jumpTo(pendingJump.r, pendingJump.c);
        showToast("JUMPING...");
    }
}

// --- INPUTS ---
const bind = (id, fn) => document.getElementById(id).onclick = fn;
bind('btnTrivials', (e)=>{ showTrivials=!showTrivials; e.target.classList.toggle('active'); draw(); });
bind('btnGnomon', (e)=>{ showGnomon=!showGnomon; e.target.classList.toggle('active'); draw(); });
bind('btnMirror', (e)=>{ hideMirror=!hideMirror; e.target.classList.toggle('active'); cellCache.clear(); draw(); });
bind('btnLayout', (e)=>{ layoutMode=(layoutMode==='spine')?'diag':'spine'; e.target.innerText=layoutMode.toUpperCase(); cellCache.clear(); draw(); });
bind('btnFind', ()=>{ 
    let v = document.getElementById('inpFind').value; 
    if(v) { 
        // Approx jump logic
        try { let id=BigInt(v); let k=(sqrtBigInt(8n*id+1n)-1n)/2n; let base=(k*(k+1n))/2n; jumpTo(k, id-base); } catch(e){} 
    } 
});
bind('btnToggleDR', (e)=>{ 
    const p = document.getElementById('drPanel'); 
    p.classList.toggle('open'); 
    e.target.classList.toggle('active-pink'); 
});
bind('btnTriangulate', runTriangulate);
bind('btnStopScan', ()=>{ window.__drStop=true; });

// Modals
const showFull = () => { if(currentFullData) {
    ['N','Factors','Smart','Tape'].forEach(k => document.getElementById('full'+k).innerText = 
        k==='Smart' ? `${currentFullData.a}.${currentFullData.b}` : 
        k==='Factors' ? `${currentFullData.P2} × ${currentFullData.P1}` : 
        k==='N' ? currentFullData.fullVal : currentFullData.tapeID
    );
    document.getElementById('fullValModal').style.display = 'flex';
}};
['dispVal','dispComp','dispSq'].forEach(id => bind(id, showFull));
bind('closeFull', ()=>document.getElementById('fullValModal').style.display='none');

// Helper
function sqrtBigInt(n) { if(n<2n) return n; let x=n, y=(x+1n)/2n; while(y<x){x=y;y=(x+n/x)/2n;} return x; }
function updateFromInput(t) { try { jumpTo(BigInt(document.getElementById('inpK').value), BigInt(document.getElementById('inpCol').value)); } catch(e){} }

// Init
window.onresize = ()=>{ DPR=window.devicePixelRatio||1; canvas.width=wrap.clientWidth*DPR; canvas.height=wrap.clientHeight*DPR; draw(); };
window.onload = ()=>{ window.onresize(); jumpTo(0n, 0n); };

// Touch Logic (Simplified)
let lastX=0, lastY=0, dragging=false;
wrap.addEventListener('touchmove', e=>{ if(e.touches.length===1){ e.preventDefault(); pan(e.touches[0].clientX-lastX, e.touches[0].clientY-lastY); lastX=e.touches[0].clientX; lastY=e.touches[0].clientY; }});
wrap.addEventListener('touchstart', e=>{ if(e.touches.length===1){ dragging=true; lastX=e.touches[0].clientX; lastY=e.touches[0].clientY; }});
wrap.addEventListener('touchend', e=>{ 
    if(!dragging && e.changedTouches.length){ 
        const t=e.changedTouches[0]; 
        const r=canvas.getBoundingClientRect(); 
        const c=Math.floor((t.clientX-r.left-HDR_S-scrollX)/cellS);
        const row=Math.floor((t.clientY-r.top-HDR_S-scrollY)/cellS);
        jumpTo(viewAnchor.r+BigInt(row), viewAnchor.c+BigInt(c));
    }
    dragging=false; 
});

</script>
</body>
</html>
