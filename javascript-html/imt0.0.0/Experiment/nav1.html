<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>IMT NAVIGATOR v0.0.7 (Safe-Mode)</title>
<style>
    :root {
        --bg: #020617; --panel: #0f172a; --border: #1e293b;
        --cyan: #22d3ee; --text: #e2e8f0; --pink: #f472b6; --green: #34d399;
        --input-bg: rgba(0,0,0,0.3);
        --mod-highlight: #3b82f6; 
        --beacon: #facc15;
    }
    * { box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; height: 100dvh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }

    .top-section { background: var(--panel); border-bottom: 2px solid var(--cyan); padding: 4px 8px; flex-shrink: 0; z-index: 200; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    .controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 4px; margin-bottom: 6px; }
    
    .toggle-btn { background: #334155; color: #94a3b8; padding: 0 6px; height: 32px; border-radius: 4px; border:none; cursor: pointer; font-weight:bold; font-size:0.6rem; text-transform: uppercase; }
    .toggle-btn.active { background: var(--cyan); color: #000; box-shadow: 0 0 5px var(--cyan); }
    #btnBeacon.active { background: var(--beacon); color: #000; box-shadow: 0 0 15px var(--beacon); }
    #btnPulse.active { background: var(--pink); color: #000; }

    .cargo-input-row { display: flex; align-items: center; gap: 4px; padding-bottom: 4px; }
    #inpFind, #inpIntercept { background: #1e293b; border: 1px solid #334155; color: #fff; padding: 6px; flex: 1; font-weight: 800; font-size: 1rem; text-align: center; border-radius: 4px; outline: none; }
    .btn-action { background: var(--cyan); color: #000; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; padding: 0 8px; height: 36px; font-size: 0.75rem; }
    #btnIntercept { background: var(--pink); }

    .layout { flex: 1; position: relative; overflow: hidden; background: #000; touch-action: none; }
    canvas { display: block; width: 100%; height: 100%; }

    .decoder { background: #0f172a; border-top: 3px solid var(--pink); display: flex; flex-direction: column; z-index: 150; box-shadow: 0 -10px 40px rgba(0,0,0,0.8); }
    .panel-sec { padding: 4px 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .bm-val { font-size: 1.1rem; font-weight: 900; color: #fff; cursor: pointer; border-bottom: 1px dotted #334155; }
    #sqLock { color: var(--beacon); font-weight: 900; font-size: 0.65rem; display: none; animation: blink 1s infinite; margin-left: 5px; }
    @keyframes blink { 50% { opacity: 0.2; } }

    .info-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; padding: 6px; }
    .info-item { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 2px; border-radius: 4px; text-align: center; }
    .info-input { width: 100%; background: var(--input-bg); border: 1px solid #334155; color: #fff; font-weight: bold; font-size: 0.75rem; text-align: center; border-radius: 4px; outline: none; }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(2, 6, 23, 0.95); z-index: 1100; display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
    .modal-card { background: #0f172a; border: 1px solid var(--cyan); width: 100%; max-width: 600px; border-radius: 12px; display: flex; flex-direction: column; color: #cbd5e1; }
    .full-val-box { background:#0b1120; padding:10px; border-radius:6px; margin-bottom:10px; border:1px solid #334155; font-family:monospace; font-size:0.8rem; word-break: break-all; color:#fff;}
</style>
</head>
<body>

<div class="top-section">
    <div class="controls">
        <div class="control-toggles-left">
            <button class="toggle-btn" id="btnBeacon">BEACON</button>
            <button class="toggle-btn" id="btnPulse">PULSE</button>
        </div>
        <div class="control-toggles-right">
            <button class="toggle-btn active" id="btnTrivials">TRIV</button>
            <button class="toggle-btn" id="btnLayout">SPINE</button>
        </div>
    </div>
    <div class="cargo-input-row">
        <button id="btnFind" class="btn-action">FIND ID</button>
        <input id="inpFind" type="text" placeholder="Tape ID">
        <input id="inpZoom" type="range" min="20" max="150" value="64" style="width: 40px;">
    </div>
    <div class="cargo-input-row">
        <button id="btnIntercept" class="btn-action">INTERCEPT N</button>
        <input id="inpIntercept" type="text" placeholder="Direct Intercept N">
    </div>
</div>

<div class="layout" id="canvasWrap"><canvas id="gridCanvas"></canvas></div>

<div class="decoder">
    <div class="panel-sec" style="background:#0b1120;">
        <div>
            <div style="font-size:0.6rem; color:#64748b">SMART ID (a.b) <span id="sqLock">â˜… LOCK</span></div>
            <div id="dispComp" class="bm-val">--</div>
            <div id="dispSq" style="font-size:0.7rem; color:var(--pink); font-weight:bold;">--</div>
        </div>
        <div style="text-align:right">
            <div style="font-size:0.6rem; color:#64748b">CARGO (N)</div>
            <div id="dispVal" class="bm-val">--</div>
            <div id="dispFactors" style="font-size:0.7rem; color:var(--cyan); font-weight:bold;">--</div>
        </div>
    </div>
    <div class="info-grid">
        <div class="info-item"><div style="font-size:0.5rem">GNOMON</div><input id="inpGnomon" class="info-input" readonly></div>
        <div class="info-item"><div style="font-size:0.5rem">GAP (b)</div><input id="inpCol" class="info-input"></div>
        <div class="info-item"><div style="font-size:0.5rem">ANCHOR (a)</div><input id="inpA" class="info-input"></div>
        <div class="info-item"><div style="font-size:0.5rem">ROW (k)</div><input id="inpK" class="info-input"></div>
    </div>
</div>

<div id="fullValModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-body" style="padding:20px;">
            <div class="full-val-box" id="fullN"></div>
            <div class="full-val-box" id="fullFactors" style="color:var(--cyan)"></div>
            <div class="full-val-box" id="fullSmart" style="color:var(--pink)"></div>
            <button onclick="document.getElementById('fullValModal').style.display='none'" style="width:100%; background:var(--cyan); border:none; padding:10px; font-weight:bold; border-radius:4px; color:#000;">CLOSE</button>
        </div>
    </div>
</div>

<script>
var canvas = document.getElementById('gridCanvas'), ctx = canvas.getContext('2d', {alpha: false});
var wrap = document.getElementById('canvasWrap');
var DPR = window.devicePixelRatio || 1, cellS = 64, HDR_S = 30;
var viewAnchor = { r: 0n, c: 0n }, scrollX = 0, scrollY = 0, highlight = { r: 0n, c: 0n };
var layoutMode = 'spine', cellCache = new Map(), currentFullData = null;
var showTrivials = true, showBeacon = false, showPulse = false;

// WORKER (Sanitized: NO BACKTICKS OR ES6 TOKENS)
var workerCode = 'self.onmessage = function(e) {' +
    'var m = e.data;' +
    'var f = function(r_in, c_in, mode) {' +
        'var r = BigInt(r_in), c = BigInt(c_in);' +
        'var P2, P1, k, a, b;' +
        'if (mode === "spine") { k = r; b = c; P2 = (k * 2n) + 1n; P1 = P2 - (b * 2n); a = P2 - b; }' +
        'else { k = r; var j = c; P2 = (k * 2n) + 1n; P1 = (j * 2n) + 1n; b = (P2 - P1) / 2n; a = (P2 + P1) / 2n; }' +
        'if (P1 <= 0n) return null;' +
        'var v = P2 * P1;' +
        'var sq = (b > 0n && BigInt(Math.floor(Math.sqrt(Number(b)))) * BigInt(Math.floor(Math.sqrt(Number(b)))) === b);' +
        'var dVal = v.toString(); if(dVal.length>8) dVal=".."+dVal.slice(-6);' +
        'return { r: r_in, c: c_in, k: k.toString(), a: a.toString(), b: b.toString(), tapeID: ((k*(k+1n)/2n)+b).toString(), val: dVal, fullVal: v.toString(), isSq: b===0n, isGapSq: sq, P2: P2.toString(), P1: P1.toString() };' +
    '};' +
    'if (m.cmd === "batch") { self.postMessage({ type: "batch", payload: m.items.map(function(it){return f(it.r, it.c, m.mode);}).filter(function(x){return x;}) }); }' +
    'else if (m.cmd === "cell") { self.postMessage({ type: "cell", payload: f(m.r, m.c, m.mode) }); }' +
'};';

var worker = new Worker(URL.createObjectURL(new Blob([workerCode], {type:'application/javascript'})));
worker.onmessage = function(e) {
    if (e.data.type === 'batch') { e.data.payload.forEach(function(p){ cellCache.set(p.r + "|" + p.c, p); }); draw(); }
    else if (e.data.type === 'cell') { var p = e.data.payload; if(p){ cellCache.set(p.r + "|" + p.c, p); if(highlight.r.toString()===p.r && highlight.c.toString()===p.c) updateDecoder(p); draw(); } }
};

function requestBatch() {
    var w = canvas.width/DPR, h = canvas.height/DPR;
    var items = [];
    for(var r=-1; r<Math.ceil(h/cellS)+2; r++) {
        for(var c=-1; c<Math.ceil(w/cellS)+2; c++) {
            var gr = viewAnchor.r + BigInt(r), gc = viewAnchor.c + BigInt(c);
            if(gr>=0n && gc>=0n && gc<=gr && !cellCache.has(gr.toString()+"|"+gc.toString())) items.push({r:gr.toString(), c:gc.toString()});
        }
    }
    if(items.length) worker.postMessage({cmd:"batch", items: items, mode: layoutMode});
}

function draw() {
    var w = wrap.clientWidth, h = wrap.clientHeight;
    canvas.width = w * DPR; canvas.height = h * DPR; ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    ctx.fillStyle = '#020617'; ctx.fillRect(0, 0, w, h);
    
    while(scrollX > 0){ scrollX -= cellS; viewAnchor.c -= 1n; }
    while(scrollX <= -cellS){ scrollX += cellS; viewAnchor.c += 1n; }
    while(scrollY > 0){ scrollY -= cellS; viewAnchor.r -= 1n; }
    while(scrollY <= -cellS){ scrollY += cellS; viewAnchor.r += 1n; }

    var hCell = cellCache.get(highlight.r.toString()+"|"+highlight.c.toString());
    var pulseD = (hCell && showPulse) ? hCell.fullVal.slice(-1) : null;

    ctx.save(); ctx.translate(HDR_S + scrollX, HDR_S + scrollY);
    for(var r=-1; r<Math.ceil(h/cellS)+1; r++) {
        for(var c=-1; c<Math.ceil(w/cellS)+1; c++) {
            var gr = viewAnchor.r + BigInt(r), gc = viewAnchor.c + BigInt(c);
            var x = c * cellS, y = r * cellS, cell = cellCache.get(gr.toString()+"|"+gc.toString());
            if(cell && !(!showTrivials && cell.P1 === "1")) {
                var bg = '#111827';
                if(cell.isSq) bg = 'rgba(34,211,238,0.05)';
                if(pulseD && cell.fullVal.slice(-1) === pulseD) bg = 'rgba(244,114,182,0.15)';
                ctx.fillStyle = bg; ctx.fillRect(x, y, cellS-1, cellS-1);
                
                if(gr === highlight.r && gc === highlight.c) {
                    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.strokeRect(x+1, y+1, cellS-3, cellS-3);
                    if(showBeacon) {
                        ctx.save(); ctx.beginPath(); ctx.setLineDash([4, 4]); ctx.strokeStyle = 'rgba(250, 204, 21, 0.6)';
                        ctx.lineWidth = 1.5; ctx.shadowBlur = 10; ctx.shadowColor = '#facc15';
                        ctx.moveTo(x + cellS/2, y + cellS/2); ctx.lineTo(-scrollX - 15, y + cellS/2); ctx.stroke(); ctx.restore();
                    }
                }
                ctx.fillStyle = cell.isSq ? '#22d3ee' : '#444'; ctx.font = '9px monospace'; ctx.textAlign = 'center';
                ctx.fillText(cell.a + "." + cell.b, x + cellS/2, y + cellS/2);
            }
        }
    }
    ctx.restore(); requestBatch();
}

function updateDecoder(p) {
    currentFullData = p;
    document.getElementById('dispComp').innerText = p.a + "." + p.b;
    document.getElementById('dispVal').innerText = p.fullVal.length > 12 ? p.fullVal.slice(0,6) + "..." + p.fullVal.slice(-4) : p.fullVal;
    document.getElementById('dispSq').innerText = "ID: " + p.tapeID;
    document.getElementById('dispFactors').innerText = p.P2 + " x " + p.P1;
    document.getElementById('sqLock').style.display = p.isGapSq ? 'inline' : 'none';
    document.getElementById('inpA').value = p.a; document.getElementById('inpCol').value = p.b;
    document.getElementById('inpK').value = p.k; document.getElementById('inpGnomon').value = BigInt(p.k)+1n;
}

// INTERACTION
function pan(dx, dy) { scrollX += dx; scrollY += dy; draw(); }
function zoomAt(newS, cx, cy) {
    var rect = wrap.getBoundingClientRect();
    var rx = cx - rect.left - HDR_S - scrollX, ry = cy - rect.top - HDR_S - scrollY;
    var oldS = cellS; cellS = Math.max(20, Math.min(150, newS));
    document.getElementById('inpZoom').value = cellS;
    var ratio = cellS / oldS; scrollX = (scrollX + rx) - (rx * ratio); scrollY = (scrollY + ry) - (ry * ratio);
    draw();
}

var drag=false, lx, ly, sx, sy, pDist=0, pS=64, pCX=0, pCY=0;
wrap.addEventListener('touchstart', function(e){
    if(e.touches.length===2){ drag=false; pDist=Math.hypot(e.touches[0].pageX-e.touches[1].pageX, e.touches[0].pageY-e.touches[1].pageY); pS=cellS; pCX=(e.touches[0].pageX+e.touches[1].pageX)/2; pCY=(e.touches[0].pageY+e.touches[1].pageY)/2; }
    else if(e.touches.length===1){ drag=true; lx=e.touches[0].pageX; ly=e.touches[0].pageY; sx=lx; sy=ly; }
}, {passive:false});
wrap.addEventListener('touchmove', function(e){
    if(e.touches.length===2){ e.preventDefault(); var d=Math.hypot(e.touches[0].pageX-e.touches[1].pageX, e.touches[0].pageY-e.touches[1].pageY); zoomAt(pS*(d/pDist), pCX, pCY); }
    else if(drag){ e.preventDefault(); pan(e.touches[0].pageX-lx, e.touches[0].pageY-ly); lx=e.touches[0].pageX; ly=e.touches[0].pageY; }
}, {passive:false});
wrap.addEventListener('touchend', function(e){ drag=false; if(e.touches.length===0 && Math.hypot(e.changedTouches[0].pageX-sx, e.changedTouches[0].pageY-sy)<10){
    var rect = wrap.getBoundingClientRect();
    var c = Math.floor((e.changedTouches[0].pageX-rect.left-HDR_S-scrollX)/cellS), r = Math.floor((e.changedTouches[0].pageY-rect.top-HDR_S-scrollY)/cellS);
    highlight={r:viewAnchor.r+BigInt(r), c:viewAnchor.c+BigInt(c)};
    worker.postMessage({cmd:"cell", r:highlight.r.toString(), c:highlight.c.toString(), mode:layoutMode});
}});

document.getElementById('btnBeacon').onclick = function(e){ showBeacon=!showBeacon; e.target.classList.toggle('active'); draw(); };
document.getElementById('btnPulse').onclick = function(e){ showPulse=!showPulse; e.target.classList.toggle('active'); draw(); };
document.getElementById('btnLayout').onclick = function(e){ layoutMode=(layoutMode==="spine")?"diag":"spine"; e.target.innerText=layoutMode.toUpperCase(); cellCache.clear(); draw(); };
document.getElementById('btnFind').onclick = function(){
    var val = BigInt(document.getElementById('inpFind').value);
    var k = (BigInt(Math.floor(Math.sqrt(Number(8n * val + 1n)))) - 1n) / 2n;
    viewAnchor = { r: k, c: val - (k * (k + 1n) / 2n) }; scrollX = 0; scrollY = 0; highlight = {r: k, c: val - (k * (k + 1n) / 2n)};
    cellCache.clear(); draw();
};
document.getElementById('btnIntercept').onclick = function(){
    var val = BigInt(document.getElementById('inpIntercept').value);
    var a = BigInt(Math.floor(Math.sqrt(Number(val))));
    var k = (a - 1n) / 2n;
    var b = ((k * 2n + 1n) * (k * 2n + 1n) - val) / 2n;
    viewAnchor = { r: k, c: b }; scrollX = 0; scrollY = 0; highlight = {r: k, c: b};
    cellCache.clear(); draw();
};
document.getElementById('dispVal').onclick = function(){ if(currentFullData){ document.getElementById("fullN").innerText=currentFullData.fullVal; document.getElementById("fullFactors").innerText=currentFullData.P2+" x "+currentFullData.P1; document.getElementById("fullSmart").innerText=currentFullData.a+"."+currentFullData.b; document.getElementById("fullValModal").style.display="flex"; }};

window.onresize=function(){ draw(); }; window.onload=function(){ draw(); };
</script>
</body>
</html>
