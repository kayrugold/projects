<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Codex Gnomonicus v0.0.7 (Stable)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/big-integer@1.6.48/BigInteger.min.js"></script>
    <style>
        :root {
            --bg: #020617; --panel: #0f172a; --border: #1e293b;
            --cyan: #22d3ee; --pink: #f472b6; --green: #34d399;
            --gold: #fbbf24; --text: #e2e8f0; --font-mono: 'Roboto Mono', monospace;
        }
        body { margin: 0; background-color: var(--bg); color: var(--text); font-family: var(--font-mono); overflow: hidden; touch-action: none; }
        
        #hud { position: absolute; top: 0; left: 0; width: 100%; padding: 10px; box-sizing: border-box; display: flex; justify-content: space-between; pointer-events: none; z-index: 10; }
        .stat-box { background: rgba(15, 23, 42, 0.9); padding: 6px 12px; border-radius: 4px; border: 1px solid var(--cyan); font-size: 0.9rem; color: var(--cyan); font-weight: bold; }

        .action-tray { position: absolute; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 50; pointer-events: auto; }
        .btn-action { width: 64px; height: 64px; border-radius: 50%; border: none; font-family: var(--font-mono); font-size: 0.7rem; font-weight: 900; cursor: pointer; text-transform: uppercase; transition: transform 0.1s; pointer-events: auto; }
        #btn-jump-tape { background: var(--cyan); color: #000; box-shadow: 0 0 15px rgba(34, 211, 238, 0.4); }
        #btn-jump-tri { background: var(--pink); color: #000; box-shadow: 0 0 15px rgba(244, 114, 182, 0.4); }
        .btn-action:active { transform: scale(0.9); }

        #card { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(15, 23, 42, 0.95); border: 1px solid var(--pink); border-radius: 8px; box-shadow: 0 0 30px rgba(0,0,0,0.8); display: none; flex-direction: column; z-index: 40; backdrop-filter: blur(5px); }
        .card-header { font-size: 0.9rem; color: #000; font-weight: bold; text-align: center; padding: 10px; background: var(--pink); display: flex; justify-content: space-around; }
        .card-body { padding: 15px; display: flex; flex-direction: column; gap: 6px; }
        .data-row { display: flex; justify-content: space-between; align-items: center; }
        .data-lbl { color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; font-weight: bold; }
        .data-val { font-weight: bold; color: #fff; font-size: 0.9rem; }
        .cargo-val { color: var(--cyan); font-size: 1.4rem; font-weight: 900; }
        .factor-box { background: rgba(52, 211, 153, 0.1); border: 1px solid var(--green); padding: 8px; margin-top: 5px; text-align: center; border-radius: 4px; }
        .factor-val { color: #fff; font-size: 1.1rem; font-weight: bold; }

        canvas { display: block; width: 100%; height: 100%; }
    </style>
</head>
<body>

    <div id="hud">
        <div class="stat-box">ROW <span id="disp-row" style="color:#fff">--</span></div>
        <div class="stat-box">ZOOM <span id="disp-scale" style="color:#fff">1.0x</span></div>
    </div>

    <div class="action-tray">
        <button id="btn-jump-tri" class="btn-action" onclick="askJumpTri()">TRI ID</button>
        <button id="btn-jump-tape" class="btn-action" onclick="askJumpTape()">TAPE ID</button>
    </div>

    <div id="card" onclick="this.style.display='none'">
        <div class="card-header">
            <div>TAPE: <span id="c-tape">--</span></div>
            <div>TRI: <span id="c-tri">--</span></div>
        </div>
        <div class="card-body">
            <div class="data-row"><span class="data-lbl">Coordinate (k, b)</span><span class="data-val" id="c-coord">--</span></div>
            <div class="data-row"><span class="data-lbl" style="color:var(--gold)">ANCHOR (a)</span><span class="data-val" id="c-anchor" style="color:var(--gold)">--</span></div>
            <div style="border-top: 1px solid #334155; margin: 5px 0;"></div>
            <div class="data-row"><span class="data-lbl">CARGO (N)</span><span class="data-val cargo-val" id="c-val">--</span></div>
            <div class="factor-box"><div class="factor-val" id="c-factors">--</div></div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        let scale = 60, offsetX = window.innerWidth / 2, offsetY = 100;
        let selected = null;
        let evCache = [], prevDiff = -1, clickStartPos = {x:0, y:0};

        function init() {
            window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; draw(); });
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            canvas.addEventListener('pointerdown', ev => { evCache.push(ev); clickStartPos={x:ev.clientX, y:ev.clientY}; });
            canvas.addEventListener('pointermove', onPointerMove);
            canvas.addEventListener('pointerup', ev => { 
                const idx = evCache.findIndex(e => e.pointerId === ev.pointerId); 
                if (idx > -1) evCache.splice(idx, 1); 
                if (evCache.length < 2) prevDiff = -1; 
            });
            canvas.addEventListener('wheel', onWheel, {passive: false});
            canvas.addEventListener('click', onClick);
            requestAnimationFrame(draw);
        }

        // --- MATH CORE ---
        function bigSqrt(n) {
            if (n < 0n) return -1n;
            if (n < 2n) return n;
            let x = n, y = (x + 1n) / 2n;
            while (y < x) { x = y; y = (n / x + x) / 2n; }
            return x;
        }

        function getGridInfo(r, c) {
            const r_num = Number(r);
            const c_num = Number(c);
            const R = BigInt(r_num) + 1n; //
            const k = BigInt(r_num); //
            const b = BigInt(Math.abs(c_num)); //
            
            // Tape ID (Square based count)
            const tapeID = (R * R) - (R - 1n - BigInt(c_num));
            // Triangle ID (Sequential count)
            const triID = (k * (k + 1n)) / 2n + b; 
            
            const a = 2n * R - 1n; // Anchor
            const val = a * (a - (2n * b)); // Cargo
            
            let p1 = a, p2 = a - (2n * b);
            if (p1 < 0n) p1 = -p1; if (p2 < 0n) p2 = -p2;
            if (p1 > p2) { let t=p1; p1=p2; p2=t; }

            return { 
                r: r_num, c: c_num, tapeID, triID, a, gap: b, val, 
                factors: `${p1} Ã— ${p2}`, isCenter: (c_num === 0) 
            };
        }

        // --- NAVIGATION ---
        function askJumpTape() {
            let val = prompt("Enter TAPE ID (Square-based):");
            if (!val) return;
            try {
                let T = BigInt(val);
                let R = bigSqrt(T); if (R*R < T) R++;
                let r = Number(R) - 1;
                let c = Number((R - 1n) - (R * R - T));
                applyJump(r, c);
            } catch(e) { alert("Invalid ID"); }
        }

        function askJumpTri() {
            let val = prompt("Enter TRIANGLE ID (Linear-based):");
            if (!val) return;
            try {
                let T = BigInt(val);
                let kBig = (bigSqrt(8n * T + 1n) - 1n) / 2n;
                let anchor = (kBig * (kBig + 1n)) / 2n;
                let r = Number(kBig);
                let c = Number(T - anchor);
                applyJump(r, c);
            } catch(e) { alert("Invalid ID"); }
        }

        function applyJump(r, c) {
            offsetY = (canvas.height / 2) - (r * scale);
            offsetX = (canvas.width / 2) - (c * scale);
            let info = getGridInfo(r, c);
            selected = { r, c };
            showCard(info);
            draw();
        }

        // --- DRAW & INTERACTION ---
        function draw() {
            ctx.fillStyle = "#020617"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            let startRow = Math.max(0, Math.floor(-offsetY / scale));
            let endRow = startRow + Math.ceil(canvas.height / scale) + 1;
            
            document.getElementById('disp-row').innerText = startRow + 1;
            document.getElementById('disp-scale').innerText = (scale/60).toFixed(1) + "x";

            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.font = `bold ${Math.max(10, scale * 0.35)}px monospace`;

            for (let r = startRow; r < endRow; r++) {
                let y = offsetY + r * scale, R = r + 1, halfW = R - 1;
                for (let c = -halfW; c <= halfW; c++) {
                    let x = offsetX + c * scale;
                    if (x < -scale || x > canvas.width + scale) continue;
                    
                    let info = getGridInfo(r, c);
                    let isSel = (selected && selected.r === r && selected.c === c);
                    
                    ctx.fillStyle = info.isCenter ? "rgba(34, 211, 238, 0.05)" : "#0f172a";
                    if (isSel) ctx.fillStyle = "rgba(244, 114, 182, 0.2)";
                    ctx.fillRect(x - scale/2 + 1, y - scale/2 + 1, scale - 2, scale - 2);
                    
                    ctx.strokeStyle = isSel ? "#f472b6" : (info.isCenter ? "#22d3ee" : "#1e293b");
                    ctx.lineWidth = isSel ? 3 : 1;
                    ctx.strokeRect(x - scale/2 + 1, y - scale/2 + 1, scale - 2, scale - 2);

                    if (scale > 25) {
                        ctx.fillStyle = isSel ? "#fff" : (info.isCenter ? "#22d3ee" : "#64748b");
                        let label = info.tapeID.toString();
                        if (label.length > 6) label = ".." + label.slice(-4);
                        ctx.fillText(label, x, y);
                    }
                }
            }
        }

        function onPointerMove(ev) {
            const idx = evCache.findIndex(e => e.pointerId === ev.pointerId);
            if (idx > -1) evCache[idx] = ev;
            if (evCache.length === 1) { offsetX += ev.movementX; offsetY += ev.movementY; draw(); }
            else if (evCache.length === 2) {
                const curDiff = Math.hypot(evCache[0].clientX - evCache[1].clientX, evCache[0].clientY - evCache[1].clientY);
                if (prevDiff > 0) { scale = Math.max(5, Math.min(500, scale * (curDiff / prevDiff))); }
                prevDiff = curDiff; draw();
            }
        }

        function onWheel(ev) { 
            ev.preventDefault(); 
            const zoomFactor = ev.deltaY > 0 ? 0.9 : 1.1;
            scale = Math.max(5, Math.min(500, scale * zoomFactor)); 
            draw(); 
        }
        
        function onClick(e) {
            if (Math.hypot(e.clientX - clickStartPos.x, e.clientY - clickStartPos.y) > 5) return;
            let r = Math.floor((e.clientY - (offsetY - scale/2)) / scale);
            let c = Math.floor((e.clientX - (offsetX - scale/2)) / scale);
            if (r >= 0 && Math.abs(c) <= r) {
                let info = getGridInfo(r, c);
                selected = { r, c };
                showCard(info); draw();
            }
        }

        function showCard(info) {
            document.getElementById('card').style.display = 'flex';
            document.getElementById('c-tape').innerText = info.tapeID.toString();
            document.getElementById('c-tri').innerText = info.triID.toString();
            document.getElementById('c-coord').innerText = `k:${info.r}, b:${info.gap}`;
            document.getElementById('c-anchor').innerText = info.a.toString();
            document.getElementById('c-val').innerText = info.val.toString();
            document.getElementById('c-factors').innerText = info.factors;
        }

        init();
    </script>
</body>
</html>
