<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gnomon Ratchet v3.2: Bitshift Engine</title>
    <style>
        body { background: #020617; color: #e2e8f0; font-family: 'Courier New', monospace; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; width: 100%; max-width: 900px; margin-top: 20px; }
        .panel { background: #0f172a; padding: 20px; border: 1px solid #1e293b; border-radius: 8px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: flex; flex-direction: column; justify-content: space-between; }
        
        .label { color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        .value { font-size: 1.8rem; font-weight: bold; color: #fff; word-break: break-all; }
        .highlight { color: #22d3ee; }
        .pink { color: #f472b6; }
        .green { color: #4ade80; }
        
        .input-group { display: flex; flex-direction: column; gap: 5px; margin-top: 15px; }
        input { background: #1e293b; border: 1px solid #334155; color: #fff; padding: 10px; font-family: inherit; font-size: 1rem; text-align: center; border-radius: 4px; outline: none; width: 100%; box-sizing: border-box; }
        input:focus { border-color: #22d3ee; box-shadow: 0 0 5px rgba(34, 211, 238, 0.5); }

        .controls { display: flex; gap: 10px; margin: 30px 0; background: #1e293b; padding: 10px; border-radius: 50px; border: 1px solid #334155; }
        button { background: #334155; color: #fff; border: none; padding: 15px 30px; font-family: inherit; font-size: 1.2rem; cursor: pointer; border-radius: 40px; transition: all 0.2s; font-weight: bold; }
        button:hover { background: #22d3ee; color: #000; box-shadow: 0 0 15px #22d3ee; }
        
        .cargo-bay { width: 100%; max-width: 900px; background: #0b1120; border: 1px solid #22d3ee; border-radius: 8px; padding: 20px; margin-top: 20px; display: none; }
        .cargo-bay.active { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tape-display { width: 100%; max-width: 900px; background: #0f172a; padding: 20px; border-left: 4px solid #f472b6; margin-top: 20px; font-size: 0.9rem; white-space: pre-wrap; word-break: break-all; line-height: 1.5; }
    </style>
</head>
<body>

    <h1 style="border-bottom: 2px solid #22d3ee; padding-bottom: 10px;">GNOMON RATCHET v3.2</h1>
    <p style="color: #64748b; font-size: 0.8rem;">ENGINE: SIMILARITY BITSHIFT (NO SQUARES)</p>

    <div class="dashboard">
        <div class="panel">
            <div class="label">Row Index (k)</div>
            <div class="value" id="dispRow">0</div>
            <div class="input-group">
                <input type="text" id="inpRow" placeholder="Jump to Row..." onchange="jumpToRow(this.value)">
            </div>
        </div>

        <div class="panel" style="border-color: #f472b6;">
            <div class="label">Tape Start (Tn)</div>
            <div class="value pink" id="dispTape">0</div>
            <div class="input-group">
                <input type="text" id="inpTape" placeholder="Lookup Tape ID..." onchange="jumpToTape(this.value)">
            </div>
        </div>

        <div class="panel" style="border-color: #22d3ee;">
            <div class="label">Anchor (A)</div>
            <div class="value highlight" id="dispAnchor">1</div>
            <div class="label" style="margin-top:10px; color:#64748b;">(2k + 1)</div>
        </div>
    </div>

    <div id="cargoBay" class="cargo-bay">
        <div class="label" style="color:#22d3ee; border-bottom:1px solid #334155; padding-bottom:5px; margin-bottom:15px;">CARGO BAY: BITSHIFT LOOKUP</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr;">
            <div>
                <div class="label">TARGET ADDRESS</div>
                <div class="value" style="font-size:1.2rem; color:#f472b6;" id="cargoAddr">--</div>
            </div>
            <div style="text-align:right;">
                <div class="label">VALUE (N)</div>
                <div class="value green" style="font-size:1.5rem;" id="cargoVal">--</div>
            </div>
        </div>
        <div style="margin-top:15px; font-size:0.8rem; color:#94a3b8; font-family:monospace;">
            LOGIC: (Tn &lt;&lt; 3 | 1) - (Gap * Step)
        </div>
    </div>

    <div class="controls">
        <button onclick="crank(-1)">◀ PREV</button>
        <button onclick="crank(1)">NEXT ▶</button>
    </div>

    <div class="tape-display" id="logbook">
        SYSTEM READY. BITSHIFT ENGINE IDLE.
    </div>

    <script>
        // STATE (BigInt)
        let state = {
            k: 0n,      // Current Row
            Tn: 0n,     // Triangle Number (Start of Row)
            A: 1n       // Anchor Size (2k + 1)
        };

        function updateDisplay() {
            document.getElementById('dispRow').innerText = state.k.toString();
            document.getElementById('dispTape').innerText = state.Tn.toString();
            document.getElementById('dispAnchor').innerText = state.A.toString();
            
            // Visual Log
            document.getElementById('logbook').innerHTML = 
                `STATUS: LOCKED [ROW ${state.k}]\n` +
                `MEMORY ADDR (Tn): ${state.Tn}\n` +
                `FRAME SIZE (A):  ${state.A} (k << 1 | 1)`;
            
            document.getElementById('cargoBay').classList.remove('active');
        }

        // 1. THE CRANK (Pure Enumeration)
        function crank(direction) {
            if (direction === 1) {
                state.Tn += (state.k + 1n); // Tn = Tn + (k+1) is next start
                state.k += 1n;
                state.A += 2n;
            } else {
                if (state.k <= 0n) return;
                state.A -= 2n;
                state.k -= 1n;
                state.Tn -= (state.k + 1n);
            }
            updateDisplay();
        }

        // 2. JUMP TO ROW (Bitshift Calculation)
        function jumpToRow(val) {
            try {
                let k = BigInt(val);
                if (k < 0n) k = 0n;
                state.k = k;
                // Tn = k(k+1)/2 -> (k * (k+1)) >> 1
                state.Tn = (k * (k + 1n)) >> 1n;
                // A = (k << 1) | 1
                state.A = (k << 1n) | 1n;
                updateDisplay();
                document.getElementById('inpRow').value = ""; 
            } catch (e) { alert("Invalid Integer"); }
        }

        // 3. THE CARGO CALC (Similarity Bitshift - NO SQUARES)
        function calculateCargo(b) {
            // STEP 1: Get Spine Value using Similarity (Tn << 3 | 1)
            // Instead of A * A, we use the Tape ID similarity property.
            let spine = (state.Tn << 3n) | 1n;
            
            // STEP 2: Get Step Size (A << 1)
            let step = state.A << 1n;
            
            // STEP 3: Calculate Cargo
            let cargo = spine - (b * step);
            
            return { val: cargo, spine: spine, step: step };
        }

        // 4. JUMP TO TAPE ID (Lookup)
        function jumpToTape(val) {
            try {
                let targetT = BigInt(val);
                if (targetT < 0n) targetT = 0n;

                // A. Find Row (k) via Integer Sqrt approx
                let kApprox = sqrtBigInt(targetT << 1n); 
                let testTn = (kApprox * (kApprox + 1n)) >> 1n;
                
                // If the approximated start is after target, move back
                if (testTn > targetT) kApprox -= 1n;
                
                // Set State to this Row
                jumpToRow(kApprox);

                // B. Calculate Gap (Offset from Start)
                // Since state.Tn is the START of the row...
                let gap = targetT - state.Tn;
                
                // C. Calculate Cargo using Bitshift Logic
                let result = calculateCargo(gap);

                // D. Display
                let bay = document.getElementById('cargoBay');
                bay.classList.add('active');
                
                document.getElementById('cargoAddr').innerText = `ID ${targetT} (Gap ${gap})`;
                document.getElementById('cargoVal').innerText = result.val.toString();
                
                document.getElementById('inpTape').value = "";
                
            } catch (e) { console.error(e); alert("Invalid Integer"); }
        }

        // Fast Integer Sqrt
        function sqrtBigInt(n) {
            if (n < 2n) return n;
            let x = n;
            let y = (x + 1n) >> 1n;
            while (y < x) { x = y; y = (x + n / x) >> 1n; }
            return x;
        }

        updateDisplay();
    </script>
</body>
</html>
