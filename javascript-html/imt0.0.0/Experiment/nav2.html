<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GNOMON NAVIGATOR: DEAD RECKONING</title>
<style>
    :root {
        --bg: #020617;
        --panel: #0f172a; 
        --border: #1e293b;
        --cyan: #22d3ee; 
        --pink: #f472b6;
        --green: #34d399;
        --text: #e2e8f0;
    }
    body {
        background-color: var(--bg);
        color: var(--text);
        font-family: 'Courier New', Courier, monospace;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }

    /* --- HUD / CONTROLS --- */
    .controls {
        background: var(--panel);
        border-bottom: 2px solid var(--cyan);
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        z-index: 100;
        max-height: 40vh; /* Prevent header from taking too much space */
        overflow-y: auto;
    }
    .status-bar {
        font-size: 12px;
        color: var(--cyan);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
    }
    .input-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .divider {
        height: 1px;
        background: var(--border);
        margin: 5px 0;
    }
    input {
        background: rgba(0,0,0,0.3);
        border: 1px solid var(--border);
        color: #fff;
        padding: 10px;
        font-family: inherit;
        font-size: 16px;
        flex: 1;
        outline: none;
    }
    input:focus { border-color: var(--cyan); }
    
    button {
        background: var(--cyan);
        color: #000;
        border: none;
        padding: 10px 20px;
        font-weight: bold;
        cursor: pointer;
        text-transform: uppercase;
        font-family: inherit;
    }
    button:hover { background: #fff; }
    
    /* Secondary Buttons */
    button.secondary {
        background: transparent;
        border: 1px solid var(--pink);
        color: var(--pink);
    }
    button.secondary:hover { background: var(--pink); color: #000; }

    /* Dead Reckoning Button */
    button.reckoning {
        background: var(--pink);
        color: #000;
        border: none;
    }
    button.reckoning:hover { background: #fff; }

    /* --- THE HUD PANEL --- */
    #reckoningHUD {
        display: none; /* Hidden by default */
        background: #020617;
        border: 1px solid var(--pink);
        padding: 10px;
        font-size: 12px;
        margin-top: 5px;
        animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

    .hud-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 5px;
        text-align: center;
        margin-top: 5px;
    }
    .hud-channel {
        padding: 5px;
        border: 1px solid;
    }

    /* --- THE TAPE (LOGBOOK) --- */
    .tape-container {
        flex: 1;
        overflow-y: auto;
        padding: 0;
        position: relative;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    thead {
        position: sticky;
        top: 0;
        background: var(--bg);
        z-index: 10;
        box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    th {
        text-align: left;
        padding: 12px 15px;
        color: #64748b;
        font-size: 10px;
        letter-spacing: 1px;
        text-transform: uppercase;
        border-bottom: 1px solid var(--border);
    }
    td {
        padding: 8px 15px;
        border-bottom: 1px solid #1e293b;
        font-variant-numeric: tabular-nums;
    }
    tr:hover { background: rgba(34, 211, 238, 0.05); }

    /* Column Styling */
    .col-id { color: #64748b; width: 80px; }
    .col-smart { color: var(--cyan); font-weight: bold; width: 120px; }
    .col-val { color: #fff; font-weight: bold; }
    .col-factors { color: var(--pink); text-align: right; }

    /* Special Rows */
    .highlight { background: rgba(34, 211, 238, 0.15) !important; }
    .prime-row { background: rgba(244, 114, 182, 0.1) !important; color: var(--pink); }

    /* Loading / Messages */
    .msg-box { padding: 20px; text-align: center; color: #64748b; font-style: italic; }

</style>
</head>
<body>

    <div class="controls">
        <div class="status-bar">
            <span>System: IMT 0.0.6 (Dead Reckoning)</span>
            <span id="sysStatus">IDLE</span>
        </div>

        <div class="input-group">
            <input type="text" id="numInput" placeholder="Enter ID/Value (Old Scanner)">
            <button onclick="findNumber()">SCAN</button>
        </div>

        <div class="divider"></div>

        <div class="input-group">
            <input type="text" id="targetInput" placeholder="Enter Target Cargo (N)">
            <button class="reckoning" onclick="runDeadReckoning()">TRIANGULATE</button>
        </div>

        <div id="reckoningHUD">
            <div style="display:flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="color:var(--pink); font-weight:bold;">SIGNAL ACQUIRED</span>
                <span id="hudTarget" style="color:#fff;">N: --</span>
            </div>
            
            <div class="hud-grid">
                <div class="hud-channel" style="background: rgba(34, 211, 238, 0.1); border-color: var(--cyan);">
                    <div style="color:var(--cyan); font-weight:bold;">MOD 9</div>
                    <div id="hudMod9_Sig">Sig: --</div>
                    <div id="hudMod9_Step">Step: --</div>
                </div>

                <div class="hud-channel" style="background: rgba(244, 114, 182, 0.1); border-color: var(--pink);">
                    <div style="color:var(--pink); font-weight:bold;">MOD 5</div>
                    <div id="hudMod5_Sig">Sig: --</div>
                    <div id="hudMod5_Step">Step: --</div>
                </div>

                <div class="hud-channel" style="background: rgba(52, 211, 153, 0.1); border-color: var(--green);">
                    <div style="color:var(--green); font-weight:bold;">MOD 7</div>
                    <div id="hudMod7_Sig">Sig: --</div>
                    <div id="hudMod7_Step">Step: --</div>
                </div>
            </div>

            <div id="hudResult" style="margin-top: 8px; text-align: center; font-weight: bold; color: #fff; background: var(--border); padding: 5px;">
                READY
            </div>
        </div>

        <div class="divider"></div>

        <div class="input-group">
            <button class="secondary" onclick="loadTape(26)">Load Highway 53</button>
            <button class="secondary" onclick="loadTape(1)">Load Highway 3</button>
        </div>
    </div>

    <div class="tape-container">
        <table id="tapeTable">
            <thead>
                <tr>
                    <th>Tape ID</th>
                    <th>Smart ID (a.b)</th>
                    <th>Value (Cargo)</th>
                    <th style="text-align:right">Factors</th>
                </tr>
            </thead>
            <tbody id="tapeBody">
            </tbody>
        </table>
    </div>

<script>
    // --- ENGINE CORE (BigInt Math) ---

    // 1. Calculate Linear Tape ID
    // Formula: Triangle(Row) + Gap
    function getTapeID(row, gap) {
        const base = (row * (row + 1n)) / 2n;
        return base + gap;
    }

    // 2. The "Cruise Control" Generator (Standard)
    function loadTape(rowNum) {
        const tableBody = document.getElementById('tapeBody');
        tableBody.innerHTML = "";
        document.getElementById('sysStatus').innerText = `GENERATING ROW ${rowNum}...`;

        let row = BigInt(rowNum);
        let bigFactor = (row * 2n) + 1n; // P2
        let stepSize = bigFactor * 2n;
        let currentValue = bigFactor * bigFactor;
        
        let html = "";
        // Generate 100 entries
        for (let i = 0; i < 100; i++) {
            let smallFactor = currentValue / bigFactor;
            let anchor = (bigFactor + smallFactor) / 2n;
            let gap = (bigFactor - smallFactor) / 2n;

            let tapeID = getTapeID(row, gap);
            let smartID = `${anchor}.${gap}`;

            html += `
                <tr>
                    <td class="col-id">${tapeID}</td>
                    <td class="col-smart">${smartID}</td>
                    <td class="col-val">${currentValue}</td>
                    <td class="col-factors">${bigFactor} × ${smallFactor}</td>
                </tr>
            `;
            currentValue += stepSize;
        }
        
        tableBody.innerHTML = html;
        document.getElementById('sysStatus').innerText = `HIGHWAY ${bigFactor} LOADED`;
    }

    // 3. The Original "FindID" Scanner (Square Root Method)
    function findNumber() {
        const input = document.getElementById('numInput').value.trim();
        if (!input) return;
        const N = BigInt(input);
        const tableBody = document.getElementById('tapeBody');
        document.getElementById('sysStatus').innerText = `SCANNING FOR ${N}...`;
        tableBody.innerHTML = `<tr><td colspan="4" class="msg-box">Scanning Geometry...</td></tr>`;

        setTimeout(() => {
            let anchor = sqrtBigInt(N);
            if (anchor * anchor < N) anchor++; 

            let maxIterations = 200000; 
            let found = false;
            let residue = (anchor * anchor) - N;

            for (let i = 0; i < maxIterations; i++) {
                let gap = sqrtBigInt(residue);
                
                if (gap * gap === residue) {
                    let smallFactor = anchor - gap;
                    
                    if (smallFactor === 1n) {
                        // PRIME
                        tableBody.innerHTML = `
                            <tr class="prime-row highlight">
                                <td class="col-id">--</td>
                                <td class="col-smart">${anchor}.${gap}</td>
                                <td class="col-val">${N}</td>
                                <td class="col-factors">PRIME (1 × ${N})</td>
                            </tr>
                        `;
                        document.getElementById('sysStatus').innerText = `PRIME DETECTED`;
                        found = true;
                        break; 
                    } else {
                        // COMPOSITE
                        let bigFactor = anchor + gap;
                        let row = (bigFactor - 1n) / 2n;
                        let tapeID = getTapeID(row, gap);
                        tableBody.innerHTML = `
                            <tr class="highlight">
                                <td class="col-id">${tapeID}</td>
                                <td class="col-smart">${anchor}.${gap}</td>
                                <td class="col-val">${N}</td>
                                <td class="col-factors">${bigFactor} × ${smallFactor}</td>
                            </tr>
                        `;
                        document.getElementById('sysStatus').innerText = `TARGET ACQUIRED`;
                        found = true;
                        break;
                    }
                }
                residue += (anchor * 2n) + 1n;
                anchor++;
            }

            if (!found) {
                tableBody.innerHTML = `<tr><td colspan="4" class="msg-box">Limit Reached</td></tr>`;
            }
        }, 10);
    }

    // 4. NEW: DEAD RECKONING ENGINE (Triangulation)
    function runDeadReckoning() {
        const input = document.getElementById('targetInput').value.trim();
        if (!input) return;
        
        const N = BigInt(input);
        const hud = document.getElementById('reckoningHUD');
        hud.style.display = 'block';
        document.getElementById('hudTarget').innerText = `N: ${N}`;
        document.getElementById('hudResult').innerText = "CALCULATING INTERCEPT...";

        // A. GET SIGNALS
        const r9 = N % 9n;
        const r5 = N % 5n;
        const r7 = N % 7n;

        // B. UPDATE HUD VISUALS
        document.getElementById('hudMod9_Sig').innerText = `Rem: ${r9}`;
        document.getElementById('hudMod9_Step').innerText = `Slide: ${r9 / 2n} steps`; // Fixed +2 constant
        
        document.getElementById('hudMod5_Sig').innerText = `Rem: ${r5}`;
        document.getElementById('hudMod5_Step').innerText = `Scan...`;
        
        document.getElementById('hudMod7_Sig').innerText = `Rem: ${r7}`;
        document.getElementById('hudMod7_Step').innerText = `Scan...`;

        // C. RUN THE INTERSECTION (Mod 9 Ray Scan)
        // We check structural beams (Mod 9 Rays) to see if they hold the weight of N.
        
        setTimeout(() => {
            let found = false;
            let solution = null;

            // Scanning first 50,000 Mod 9 Rays (Gnomons 9, 18, 27...)
            // This is "Checking the Beams", not the Bricks.
            for (let g = 9n; g < 500000n; g += 9n) {
                
                let P2 = 2n * g - 1n; // The Floor Factor for this Gnomon
                
                // Divisibility Test (Is N supported by this Beam?)
                if (N % P2 === 0n) {
                    let P1 = N / P2;
                    
                    // We found it!
                    let row = (P2 - 1n) / 2n;
                    let gap = (P2 - P1) / 2n;
                    let tapeID = getTapeID(row, gap);

                    solution = { row, gap, tapeID, P2, P1 };
                    found = true;
                    break;
                }
            }

            // D. DISPLAY RESULT
            const resBox = document.getElementById('hudResult');
            if (found) {
                // Success State
                resBox.style.background = "rgba(52, 211, 153, 0.2)";
                resBox.style.color = "var(--green)";
                resBox.innerHTML = `
                    LOCKED: Row ${solution.row} | Gap ${solution.gap}<br>
                    <span style="font-size:10px; color:#fff;">(Matched on Beam P2=${solution.P2})</span><br>
                    <button onclick="loadTape(${solution.row})" style="margin-top:5px; padding:5px; background:var(--green); border:none; color:#000; font-weight:bold; cursor:pointer;">
                        JUMP TO TARGET
                    </button>
                `;
            } else {
                // Failure State
                resBox.style.background = "rgba(244, 114, 182, 0.2)";
                resBox.style.color = "var(--pink)";
                resBox.innerHTML = "NO STRUCTURAL LOCK<br><span style='font-size:10px; color:#fff;'>Try extended scan or check prime status</span>";
            }
        }, 50);
    }

    // Helper: BigInt Square Root
    function sqrtBigInt(n) {
        if (n < 0n) throw 'Negative';
        if (n < 2n) return n;
        let x = n;
        let y = (x + 1n) / 2n;
        while (y < x) {
            x = y;
            y = (x + n / x) / 2n;
        }
        return x;
    }

    // Initial Load
    loadTape(26);
</script>

</body>
</html>
